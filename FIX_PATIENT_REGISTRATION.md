# ๐ง ุญู ูุดููุฉ ุชุณุฌูู ุงููุฑูุถุฉ ุงูุฌุฏูุฏุฉ
## Failed to register patient

---

## ๐ฏ ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุชุณุฌูู ูุฑูุถุฉ ุฌุฏูุฏุฉ ูู ุตูุญุฉ ุงูููุงุนูุฏุ ูุธูุฑ ุฎุทุฃ "Failed to register patient".

---

## ๐ ุงูุณุจุจ

ุงููุดููุฉ ูู ุฃู ุงูููุฏ ูุญุงูู ุงููุชุงุจุฉ ูู ุฃุนูุฏุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ุจุฃุณูุงุก ุฎุงุทุฆุฉ:

1. **ุนููุฏ `medical_history`** - ุงูููุฏ ูุงู ููุชุจ ูู `history` (ุบูุท)
2. **ุฃุนูุฏุฉ ูุงูุตุฉ** - ุฒู `is_active`, `gravida`, `marital_status`, `gender`, ุฅูุฎ
3. **Database schema ุบูุฑ ูุญุฏุซ** - ูู ูุชุดุบูุชุด ุงูู migration

---

## โ ุงูุญู (3 ุฎุทูุงุช)

### **ุงูุฎุทูุฉ 1: ุชุดุบูู Migration Script** โ๏ธ **ููู ุฌุฏุงู**

ูุงุฒู ุชุดุบู ุงูู migration ุงูุฃูู ุนุดุงู ูุถูู ุงูุฃุนูุฏุฉ ุงููุงูุตุฉ:

1. ุงูุชุญ Supabase Dashboard:
   ```
   https://app.supabase.com/project/purknrqalbkajufqfiqu/sql/new
   ```

2. ุงูุชุญ ููู `MIGRATION_UPDATE_ALL.sql` ูู ุงููุดุฑูุน

3. ุงูุณุฎ ูู ูุญุชูุงู ูุงูุตูู ูู SQL Editor

4. ุงุถุบุท **Run** (F5)

5. ุงูุชุธุฑ 10-20 ุซุงููุฉ ุญุชู ููุชูู

6. ุชุญูู ูู ุงููุชุงุฆุฌ - ูุงุฒู ุชุดูู:
   ```
   โ ุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!
   ```

---

### **ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ุงูุฃุนูุฏุฉ** 

ุจุนุฏ ุชุดุบูู ุงูู migrationุ ุงูุญุต ุฅู ุงูุฃุนูุฏุฉ ุงุชุถุงูุช:

1. ุงูุชุญ `CHECK_DATABASE_COLUMNS.sql`

2. ุงูุณุฎู ูุงูุตูู ูู Supabase SQL Editor

3. ุดุบูู ูุงุชุฃูุฏ ุฅู ูู ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ุนูููุง โ

---

### **ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุงูุชุณุฌูู**

1. ุงุฑุฌุน ููุชุทุจูู ุนูู: http://localhost:5174/

2. ุงูุชุญ ุตูุญุฉ **ุงูููุงุนูุฏ (Appointments)**

3. ุงุถุบุท **Quick Register** ุฃู **+ New Patient**

4. ุงูุชุจ:
   - ุงุณู ุงููุฑูุถุฉ (ูุซูุงู: ูุงุทูุฉ ุฃุญูุฏ)
   - ุฑูู ุงูุชููููู (ูุซูุงู: 01012345678)
   - ุงูุนูุฑ (ุงุฎุชูุงุฑูุ ูุซูุงู: 32)

5. ุงุถุบุท **Save & Continue**

6. ูุงุฒู ุชุดูู ุฑุณุงูุฉ ูุฌุงุญ: "Registered ูุงุทูุฉ ุฃุญูุฏ"

---

## ๐ ุงูุชุนุฏููุงุช ุงููู ุชูุช ุนูู ุงูููุฏ

### ููู: `services/dbService.ts`

ุชู ุชุตููุญ ุงูู `savePatient` function:

**ูุจู:**
```typescript
history: patient.history || null  // โ ุนููุฏ ุบูุท
```

**ุจุนุฏ:**
```typescript
medical_history: medicalHistory,   // โ ุงูุนููุฏ ุงูุตุญูุญ (JSONB)
is_active: true,
gravida: 0,
para: 0,
abortions: 0,
living_children: 0,
previous_ivf_attempts: 0,
marital_status: 'married',
gender: 'female',
country: 'Egypt'
```

---

## ๐งช ุงุฎุชุจุงุฑ ุดุงูู

ุจุนุฏ ุงูุฅุตูุงุญุ ุฌุฑุจ ุงูุณููุงุฑูููุงุช ุฏู:

### โ Test 1: ุชุณุฌูู ูุฑูุถุฉ ุจุณูุทุฉ
```
ุงูุงุณู: ุณุงุฑุฉ ูุญูุฏ
ุงูุชููููู: 01098765432
ุงูุนูุฑ: 28
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุชู ุงูุชุณุฌูู ุจูุฌุงุญ

### โ Test 2: ุชุณุฌูู ุจุฏูู ุนูุฑ
```
ุงูุงุณู: ููุฑูุงู ุนูู
ุงูุชููููู: 01123456789
ุงูุนูุฑ: (ูุงุถู)
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุชู ุงูุชุณุฌูู ุจูุฌุงุญ (ุงูุนูุฑ = 0 default)

### โ Test 3: ุงูุจุญุซ ุนู ุงููุฑูุถุฉ
```
ุงุจุญุซ ุนู: ุณุงุฑุฉ
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** โ ุชุธูุฑ "ุณุงุฑุฉ ูุญูุฏ" ูู ุงููุงุฆูุฉ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูู ุธูุฑ ุฎุทุฃ: "column "medical_history" does not exist"

**ุงูุญู:** ูู ูุชู ุชุดุบูู ุงูู migration ุจุนุฏ
- ุงุฑุฌุน ููุฎุทูุฉ 1 ูุดุบู `MIGRATION_UPDATE_ALL.sql`

---

### ูู ุธูุฑ ุฎุทุฃ: "new row violates check constraint"

**ุงูุญู:** ูู ูููุฉ ุบูุฑ ุตุญูุญุฉ
- ุชุฃูุฏ ุฅู `gender` = 'male' ุฃู 'female'
- ุชุฃูุฏ ุฅู `marital_status` ูู ุงูููู ุงูุตุญูุญุฉ

---

### ูู ุธูุฑ ุฎุทุฃ: "permission denied for table patients"

**ุงูุญู:** ูุดููุฉ ูู RLS Policies
- ุดุบู ุงูู migration ูุงููุงู - ููู ุชุตููุญ ููู policies ูู ุงูุฌุฒุก ุงูุฃุฎูุฑ

---

## ๐ ูุนูููุงุช ุชูููุฉ

### ุงูู Database Schema ุงููุทููุจ

```sql
TABLE patients (
    id UUID PRIMARY KEY,
    name TEXT NOT NULL,
    age INTEGER,
    phone TEXT,
    husband_name TEXT,
    medical_history JSONB DEFAULT '{}',  -- โ JSONB
    doctor_id UUID NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    gravida INTEGER DEFAULT 0,
    para INTEGER DEFAULT 0,
    abortions INTEGER DEFAULT 0,
    living_children INTEGER DEFAULT 0,
    previous_ivf_attempts INTEGER DEFAULT 0,
    marital_status TEXT DEFAULT 'married',
    gender TEXT DEFAULT 'female',
    country TEXT DEFAULT 'Egypt',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
)
```

---

## โ ุงูุฎูุงุตุฉ

1. โ ุงูููุฏ ุงุชุตูุญ - `savePatient` ุฏูููุชู ุจูุณุชุฎุฏู `medical_history` (JSONB)
2. โ๏ธ **ูุงุฒู** ุชุดุบู `MIGRATION_UPDATE_ALL.sql` ุนุดุงู ูุถูู ุงูุฃุนูุฏุฉ ุงููุงูุตุฉ
3. โ ุจุนุฏ ุงูู migrationุ ุงูุชุณุฌูู ููุดุชุบู ุจุฏูู ูุดุงูู

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุจุนุฏ ุชุทุจูู ุงูุฎุทูุงุช:
- โ ุชุณุฌูู ุงููุฑุถู ูุดุชุบู ูู ุตูุญุฉ ุงูููุงุนูุฏ
- โ ุจุฏูู ุฃุฎุทุงุก ูู ุงูู console
- โ ุงูุจูุงูุงุช ุชุชุญูุธ ุตุญ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุชุธูุฑ ูู ูุงุฆูุฉ ุงููุฑุถู ููุฑุงู

---

**๐ ุชุฐููุฑ ููู:**  
ูู ุนูุฏู ูุฑุถู ูุฏุงูู ูู ุงูู databaseุ ุงูู migration ูุด ูููุณูู - ุจุณ ููุถูู ุงูููู ุงูุงูุชุฑุงุถูุฉ ููุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ (ุฒู `is_active = TRUE`).

๐ **ุฌุงูุฒ ููุงุณุชุฎุฏุงู!**

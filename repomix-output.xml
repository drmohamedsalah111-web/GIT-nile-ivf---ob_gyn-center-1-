This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
ADMIN_BRANDING_SETUP.md
AGENTS.md
App.tsx
BRANDING_SETUP.sql
CLAUDE.md
CLINICAL_DATA_MIGRATION.sql
components/BottomNav.tsx
components/PrescriptionComponent.tsx
components/PrescriptionPrinter.tsx
components/Sidebar.tsx
components/SyncStatus.tsx
components/ui/SearchableSelect.tsx
constants.ts
context/BrandingContext.tsx
data/egyptian_drugs.ts
data/medical_terms.ts
electron/main.js
electron/preload.js
index.html
index.tsx
IVF_CYCLES_SETUP.sql
IVF_MIGRATION_GUIDE.md
metadata.json
OBSTETRICS_IMPLEMENTATION.md
OBSTETRICS_SETUP_V2.sql
OBSTETRICS_SETUP.sql
package.json
pages/AdminDashboard.tsx
pages/ClinicalStation.tsx
pages/components/InfertilityWizard.tsx
pages/components/obstetrics/ANCFlowSheet.tsx
pages/components/obstetrics/FetalGrowthChart.tsx
pages/components/obstetrics/PregnancyHeader.tsx
pages/components/obstetrics/RiskAssessment.tsx
pages/Dashboard.tsx
pages/Gynecology.tsx
pages/IvfJourney.tsx
pages/Login.tsx
pages/ObstetricsDashboard.tsx
pages/PatientMasterRecord.tsx
pages/Reception.tsx
pages/Settings.tsx
public/apple-touch-icon.png
public/favicon-96x96.png
public/manifest.json
public/pwa-192x192.png
public/pwa-512x512.png
public/sw.js
PWA_SETUP.md
README.md
services/authService.ts
services/ivfService.ts
services/obstetricsService.ts
services/supabaseClient.ts
services/visitsService.ts
services/workupService.ts
src/components/SyncStatus.tsx
src/db/localDB.ts
src/hooks/useSyncStatus.ts
src/lib/localDb.ts
src/lib/networkStatus.ts
src/lib/pwa.ts
src/services/syncService.ts
styles.css
SUPABASE_SETUP.sql
tsconfig.json
types.ts
vercel.json
vite.config.ts
write_file.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="ADMIN_BRANDING_SETUP.md">
# Admin Dashboard & Dynamic Branding - Setup Guide

## üìã Overview

The admin dashboard enables real-time customization of:
- **Clinic name & contact info** (address, phone)
- **Clinic logo** (upload & display)
- **Brand colors** (primary, secondary, accent)
- **Prescription settings** (default templates)
- **Record management** (view & delete clinical records)

Changes are instantly reflected across the entire application (Sidebar, Dashboard, Prescriptions).

---

## üîß Setup Steps

### Step 1: Create Database Table

Execute this SQL in your **Supabase SQL Editor**:

```sql
CREATE TABLE IF NOT EXISTS app_settings (
  id INTEGER PRIMARY KEY DEFAULT 1,
  clinic_name TEXT NOT NULL DEFAULT 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±',
  logo_url TEXT,
  clinic_address TEXT,
  clinic_phone TEXT,
  primary_color TEXT DEFAULT '#2d5a6b',
  secondary_color TEXT DEFAULT '#00838f',
  accent_color TEXT DEFAULT '#00bcd4',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_by UUID,
  CONSTRAINT single_row CHECK (id = 1),
  FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);

ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can read app_settings" ON app_settings;
CREATE POLICY "Users can read app_settings"
  ON app_settings FOR SELECT
  TO authenticated
  USING (true);

DROP POLICY IF EXISTS "Authenticated users can update app_settings" ON app_settings;
CREATE POLICY "Authenticated users can update app_settings"
  ON app_settings FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

INSERT INTO app_settings (id, clinic_name, logo_url)
VALUES (1, 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±', NULL)
ON CONFLICT (id) DO NOTHING;
```

‚úÖ **Verify**: Go to Supabase ‚Üí SQL Editor ‚Üí Run the query above

---

### Step 2: Create Storage Bucket for Logo Upload

1. **Go to Supabase Dashboard** ‚Üí **Storage** tab
2. Click **"Create a new bucket"**
3. **Bucket name**: `branding` (exactly as shown)
4. **Privacy**: Select **"Public bucket"**
5. Click **"Create bucket"**

---

### Step 3: Set Storage Policies

Execute this SQL in **Supabase SQL Editor**:

```sql
-- Allow authenticated users to upload files
DROP POLICY IF EXISTS "Allow authenticated users to upload branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to upload branding"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (bucket_id = 'branding');

-- Allow authenticated users to delete their files
DROP POLICY IF EXISTS "Allow authenticated users to delete branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to delete branding"
  ON storage.objects FOR DELETE
  TO authenticated
  USING (bucket_id = 'branding');

-- Allow public read access (so logos display)
DROP POLICY IF EXISTS "Allow public read access to branding" ON storage.objects;
CREATE POLICY "Allow public read access to branding"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id = 'branding');
```

‚úÖ **Verify**: In Storage tab, you should see "branding" bucket with policies set

---

## üöÄ Using the Admin Dashboard

### Access Admin Panel

1. Login to the application
2. **Desktop**: Click **"ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ"** (Admin) in the Sidebar
3. **Mobile**: Scroll bottom navigation ‚Üí tap **"Admin"** button

### Customize Branding

**Tab 1: ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ™ÿµŸÖŸäŸÖ (Design Customization)**

- **ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤**: Update clinic name (appears in Sidebar & Dashboard)
- **ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ**: Clinic phone number
- **ÿßŸÑÿπŸÜŸàÿßŸÜ**: Clinic address
- **ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸäÿßÿØÿ©**: Upload clinic logo
  - Drag & drop or click to select image
  - Supported formats: PNG, JPG, GIF
  - Max size: 5 MB
- **Colors**: Adjust primary, secondary, accent colors using color picker
- Click **"ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™"** to save

---

### Configure Prescriptions

**Tab 2: ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© (Prescription Settings)**

- **Default drug category**: Select which category appears first
- **Default instructions**: Add standard prescription notes
- Available drugs database shown with categories

---

### Manage Records

**Tab 3: ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ (Records Management)**

- View last 50 clinical visits
- **Delete**: Remove records from system
- **Refresh**: Click ‚Üê to reload latest records

---

## ‚ú® Features Enabled After Setup

### 1. **Dynamic Sidebar**
- Clinic logo displays in Sidebar header (if uploaded)
- Clinic name from settings (instead of hardcoded "Nile IVF Center")

### 2. **Dynamic Dashboard**
- Header shows clinic name from settings

### 3. **Dynamic Prescriptions**
- Prescription print headers use:
  - Clinic name from settings
  - Clinic address & phone from settings
  - Clinic logo (if uploaded) or default symbol

### 4. **Real-time Updates**
- All changes apply immediately without app restart
- Changes persist to Supabase database

---

## üêõ Troubleshooting

### Error: "ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±" (Logo upload failed)

**Solution**: 
- Make sure "branding" bucket exists in Supabase Storage
- Verify it's set as "Public bucket"
- Run storage policies from Step 3 above

### Error: "ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™" (Settings save failed)

**Check**:
1. Is `app_settings` table created? (Run SQL from Step 1)
2. Are RLS policies enabled?
3. Is the table queryable? (`SELECT * FROM app_settings` should return 1 row)

### Clinic name not updating in Sidebar

**Solution**:
- Hard refresh browser: **Ctrl+Shift+R** (Windows) or **Cmd+Shift+R** (Mac)
- Close & reopen the app

---

## üìù Database Schema Reference

```typescript
app_settings {
  id: 1 (fixed, single row)
  clinic_name: string          // "ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±"
  logo_url: string | null       // URL from branding bucket
  clinic_address: string | null
  clinic_phone: string | null
  primary_color: string         // "#2d5a6b"
  secondary_color: string       // "#00838f"
  accent_color: string          // "#00bcd4"
  updated_at: timestamp
  updated_by: uuid (user id)
}
```

---

## üîê Security

- ‚úÖ RLS policies restrict access to authenticated users
- ‚úÖ Settings table has single-row constraint (immutable singleton)
- ‚úÖ Storage bucket marked as public (for logo display)
- ‚úÖ Upload policies verify user authentication

---

## üì¶ Files Modified

- `context/BrandingContext.tsx` - Global branding state & API
- `pages/AdminDashboard.tsx` - Admin control panel UI
- `components/Sidebar.tsx` - Dynamic branding display
- `pages/Dashboard.tsx` - Dynamic clinic name
- `components/PrescriptionPrinter.tsx` - Dynamic prescription headers
- `types.ts` - Added ADMIN page enum
- `App.tsx` - BrandingProvider wrapper
- `BRANDING_SETUP.sql` - Database setup script

---

## ‚úÖ Verification Checklist

- [ ] Executed SQL from Step 1 (app_settings table)
- [ ] Created "branding" storage bucket (Step 2)
- [ ] Executed SQL from Step 3 (storage policies)
- [ ] Can access Admin Dashboard from app
- [ ] Can update clinic name without logo (settings save)
- [ ] Can upload logo successfully
- [ ] Changes appear in Sidebar, Dashboard, Prescriptions
- [ ] Hardcoded text replaced with dynamic values

---

## üéØ Next Steps

1. Test all admin features
2. Verify changes persist after browser refresh
3. Test prescription printing with new branding
4. (Optional) Customize color scheme to match your clinic identity
</file>

<file path="CLAUDE.md">
# Development Commands & Notes

## Build & Type Checking
```bash
npm run build        # Builds the project (runs tsc then vite build)
npx tsc --noEmit    # Type check only without building
```

## Running the Application
```bash
npm run dev          # Start development server
npm run preview      # Preview production build
```

## Database Migrations
When new database tables are needed, create SQL files in the project root:
- `IVF_CYCLES_SETUP.sql` - IVF cycle management tables
- `OBSTETRICS_SETUP_V2.sql` - Obstetrics module
- `CLINICAL_DATA_MIGRATION.sql` - Visits and clinical data
- `BRANDING_SETUP.sql` - App settings and branding

To apply migrations:
1. Go to Supabase Dashboard ‚Üí SQL Editor
2. Create new query
3. Copy-paste the entire SQL file content
4. Click Run

## Project Structure
```
‚îú‚îÄ‚îÄ pages/               # React page components
‚îú‚îÄ‚îÄ components/          # Reusable React components
‚îú‚îÄ‚îÄ services/            # API and Supabase service layer
‚îÇ   ‚îú‚îÄ‚îÄ ivfService.ts       # IVF cycle database operations
‚îÇ   ‚îú‚îÄ‚îÄ visitsService.ts    # Patient visits
‚îÇ   ‚îú‚îÄ‚îÄ supabaseClient.ts   # Supabase initialization
‚îÇ   ‚îî‚îÄ‚îÄ authService.ts      # Authentication
‚îú‚îÄ‚îÄ types.ts             # TypeScript interfaces
‚îú‚îÄ‚îÄ constants.ts         # Protocols, drugs, UI constants
‚îî‚îÄ‚îÄ [SQL files]          # Database migrations
```

## Recent Changes (IVF Assessment Fix)

### Issue: "Failed to save assessment" error
**Root Cause:** Missing `ivf_cycles` table with JSONB columns in Supabase

### Solution Applied:
1. **Created `IVF_CYCLES_SETUP.sql`**
   - Defines `ivf_cycles` table with assessment_data, lab_data, transfer_data, outcome_data (JSONB)
   - Defines `stimulation_logs` table for daily tracking
   - Sets up RLS policies for data isolation
   - Creates performance indexes

2. **Enhanced Error Handling in `ivfService.ts`**
   - Added try-catch blocks to all update functions
   - Added detailed console error logging
   - Changed error messages from generic to specific

3. **Improved Error Display in `IvfJourney.tsx`**
   - All save functions now display detailed error messages
   - Added console logging for debugging
   - Toast messages include actual error details

### How to Fix:
1. Run the `IVF_CYCLES_SETUP.sql` migration in Supabase SQL Editor
2. Refresh the browser
3. Try saving assessment again - error message will show what's wrong

## Key Services

### ivfService.ts Functions
- `calculateBMI()` - BMI calculation with alert flag
- `calculateTMSC()` - Total Motile Sperm Count (triggers ICSI at <5M)
- `classifyOvarianReserve()` - Poor/Normal/High responder classification
- `calculateMaturationRate()` - Oocyte maturation percentage
- `calculateFertilizationRate()` - 2PN fertilization percentage
- `db.getCycles()` - Fetch all cycles with stimulation logs
- `db.saveCycle()` - Create new IVF cycle
- `db.updateCycleAssessment()` - Save couple/male/female factor assessments
- `db.updateCycleLabData()` - Save OPU and embryo data
- `db.updateCycleTransfer()` - Save transfer details
- `db.updateCycleOutcome()` - Save beta-HCG and pregnancy outcomes

## IVF Journey Component
The `/ivf-journey` page has 4 tabs:

1. **Assessment Tab**
   - Couple profile (infertility duration/type, BMI)
   - Male factor with WHO 2021 parameters and TMSC calculation
   - Female factor with ovarian reserve classification
   - Tubal-uterine findings (HSG, hysteroscopy)
   - Protocol selection with "Generate Prescription" button

2. **Stimulation Tab**
   - Hormone trends chart (E2, LH, follicle progression)
   - Daily stimulation log table with FSH/HMG/E2/LH/follicles/endometrium

3. **OPU & Embryology Tab**
   - OPU day data (total oocytes, MII, MI, GV, atretic)
   - Auto-calculated maturation rate
   - Fertilization data (2PN count)
   - Auto-calculated fertilization rate
   - Embryo grading (Day 3: A/B/C, Day 5: expanded/hatching)

4. **Transfer & Outcome Tab**
   - Transfer details (date, number, embryo quality, catheter difficulty)
   - Luteal support multi-select (6 options)
   - Cycle outcome (Beta-HCG, clinical pregnancy markers)

## Debugging Tips

### "Failed to save assessment" troubleshooting:
1. Open browser console (F12)
2. Look for detailed error in red text
3. Check Supabase connection in `services/supabaseClient.ts`
4. Verify RLS policies are enabled
5. Verify doctor record exists in database

### Database Issues:
```sql
-- Check if tables exist
SELECT * FROM information_schema.tables WHERE table_schema = 'public';

-- Check RLS is enabled
SELECT tablename, rowsecurity FROM pg_tables 
WHERE schemaname = 'public' AND tablename IN ('ivf_cycles', 'stimulation_logs');

-- Check doctor relationship
SELECT id, user_id FROM doctors WHERE user_id = '[current_user_id]';
```

## Performance Notes
- Current build size: ~993KB (gzip: 261KB)
- Consider code-splitting for large components if exceeds 500KB
- All database queries use indexes for optimal performance

## RLS Policy Structure
```
auth.users ‚Üí doctors (via user_id)
           ‚Üí patients (via doctor_id) 
           ‚Üí ivf_cycles (via doctor_id)
           ‚Üí stimulation_logs (via cycle_id)
```

Each doctor can only see their own data through RLS policies.
</file>

<file path="components/SyncStatus.tsx">
import React, { useState, useEffect } from 'react';
import { Cloud, CloudOff, AlertCircle, RotateCw } from 'lucide-react';
import { syncService } from '../src/services/syncService';
import toast from 'react-hot-toast';

interface SyncStatusState {
  isOnline: boolean;
  syncInProgress: boolean;
  pendingCount: number;
  hasErrors: boolean;
}

const SyncStatus: React.FC = () => {
  const [status, setStatus] = useState<SyncStatusState>({
    isOnline: navigator.onLine,
    syncInProgress: false,
    pendingCount: 0,
    hasErrors: false
  });
  const [showTooltip, setShowTooltip] = useState(false);
  const [isRetrying, setIsRetrying] = useState(false);

  useEffect(() => {
    const updateStatus = () => {
      const syncStatus = syncService.getSyncStatus();
      setStatus(prev => ({
        ...prev,
        isOnline: syncStatus.isOnline,
        syncInProgress: syncStatus.syncInProgress
      }));
    };

    // Check status every 2 seconds
    const interval = setInterval(updateStatus, 2000);
    
    // Listen for network changes
    const handleOnline = () => {
      setStatus(prev => ({ ...prev, isOnline: true }));
      toast.success('üîÑ Connection restored - syncing...');
    };

    const handleOffline = () => {
      setStatus(prev => ({ ...prev, isOnline: false }));
      toast.error('üì¥ Connection lost');
    };

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      clearInterval(interval);
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  const handleRetrySync = async () => {
    setIsRetrying(true);
    try {
      await syncService.forceSync();
      toast.success('‚úÖ Sync completed');
    } catch (error) {
      toast.error('‚ùå Sync failed - check your connection');
    } finally {
      setIsRetrying(false);
    }
  };

  // Determine status color and icon
  const getStatusDisplay = () => {
    if (!status.isOnline) {
      return {
        color: 'text-gray-400',
        bgColor: 'bg-gray-100 hover:bg-gray-200',
        icon: <CloudOff className="w-5 h-5" />,
        label: 'Offline',
        description: 'Waiting for connection...'
      };
    }

    if (status.hasErrors) {
      return {
        color: 'text-red-500',
        bgColor: 'bg-red-100 hover:bg-red-200',
        icon: <AlertCircle className="w-5 h-5" />,
        label: 'Sync Error',
        description: 'Click to retry'
      };
    }

    if (status.syncInProgress || status.pendingCount > 0) {
      return {
        color: 'text-amber-500',
        bgColor: 'bg-amber-100 hover:bg-amber-200',
        icon: (
          <Cloud className={`w-5 h-5 ${status.syncInProgress ? 'animate-pulse' : ''}`} />
        ),
        label: 'Syncing...',
        description: `${status.pendingCount} pending items`
      };
    }

    return {
      color: 'text-green-500',
      bgColor: 'bg-green-100 hover:bg-green-200',
      icon: <Cloud className="w-5 h-5" />,
      label: 'All Synced',
      description: 'Everything is up to date'
    };
  };

  const display = getStatusDisplay();
  const isError = status.hasErrors;

  return (
    <div className="relative">
      <button
        onClick={() => {
          setShowTooltip(!showTooltip);
          if (isError) handleRetrySync();
        }}
        disabled={isRetrying}
        className={`${display.bgColor} ${display.color} p-2 rounded-full transition-all duration-200 relative group cursor-pointer disabled:opacity-50`}
        title={display.label}
      >
        {isRetrying ? (
          <RotateCw className="w-5 h-5 animate-spin" />
        ) : (
          display.icon
        )}
      </button>

      {/* Tooltip */}
      {showTooltip && (
        <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg p-3 z-50 border border-gray-200">
          <div className="text-sm font-semibold text-gray-900 mb-1">
            {display.label}
          </div>
          <div className="text-xs text-gray-600 mb-2">
            {display.description}
          </div>
          
          {/* Status indicators */}
          <div className="space-y-1 text-xs">
            <div className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${status.isOnline ? 'bg-green-500' : 'bg-gray-400'}`}></span>
              <span className="text-gray-700">
                {status.isOnline ? 'Online' : 'Offline'}
              </span>
            </div>
            <div className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${status.syncInProgress ? 'bg-amber-500 animate-pulse' : 'bg-green-500'}`}></span>
              <span className="text-gray-700">
                {status.syncInProgress ? 'Syncing' : 'Idle'}
              </span>
            </div>
          </div>

          {/* Retry button */}
          {isError && (
            <button
              onClick={handleRetrySync}
              disabled={isRetrying}
              className="mt-3 w-full bg-blue-500 hover:bg-blue-600 disabled:opacity-50 text-white text-xs font-medium py-1 rounded transition-colors"
            >
              {isRetrying ? 'Retrying...' : 'Retry Sync'}
            </button>
          )}
        </div>
      )}
    </div>
  );
};

export default SyncStatus;
</file>

<file path="components/ui/SearchableSelect.tsx">
import React, { useState, useRef, useEffect } from 'react';
import { ChevronDown, X } from 'lucide-react';

interface SearchableSelectProps {
  options: string[];
  value: string | string[];
  onChange: (value: string | string[]) => void;
  placeholder?: string;
  label?: string;
  multi?: boolean;
  allowCustom?: boolean;
  disabled?: boolean;
  className?: string;
}

const SearchableSelect: React.FC<SearchableSelectProps> = ({
  options,
  value,
  onChange,
  placeholder = 'Search or type...',
  label,
  multi = false,
  allowCustom = true,
  disabled = false,
  className = '',
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [highlightedIndex, setHighlightedIndex] = useState(0);
  const inputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  const selectedArray = Array.isArray(value) ? value : value ? [value] : [];
  const normalizedOptions = options.map(opt => opt.toLowerCase());
  const searchLower = searchQuery.toLowerCase();

  const filteredOptions = options.filter(opt =>
    opt.toLowerCase().includes(searchLower)
  );

  const showAddCustom = allowCustom && searchQuery.trim() && !filteredOptions.some(opt => opt.toLowerCase() === searchLower);

  const displayOptions = filteredOptions.length > 0 ? filteredOptions : (showAddCustom ? [] : options);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (!isOpen && e.key === 'ArrowDown') {
      e.preventDefault();
      setIsOpen(true);
      return;
    }

    if (!isOpen) return;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setHighlightedIndex(prev => (prev + 1) % (displayOptions.length + (showAddCustom ? 1 : 0)));
        break;
      case 'ArrowUp':
        e.preventDefault();
        setHighlightedIndex(prev => (prev - 1 + (displayOptions.length + (showAddCustom ? 1 : 0))) % (displayOptions.length + (showAddCustom ? 1 : 0)));
        break;
      case 'Enter':
        e.preventDefault();
        if (highlightedIndex < displayOptions.length) {
          handleSelect(displayOptions[highlightedIndex]);
        } else if (showAddCustom) {
          handleSelect(searchQuery.trim());
        }
        break;
      case 'Escape':
        e.preventDefault();
        setIsOpen(false);
        break;
    }
  };

  const handleSelect = (selectedValue: string) => {
    if (multi) {
      if (selectedArray.includes(selectedValue)) {
        onChange(selectedArray.filter(v => v !== selectedValue));
      } else {
        onChange([...selectedArray, selectedValue]);
      }
      setSearchQuery('');
      setHighlightedIndex(0);
    } else {
      onChange(selectedValue);
      setSearchQuery('');
      setIsOpen(false);
      setHighlightedIndex(0);
    }
  };

  const handleRemoveTag = (removedValue: string) => {
    if (multi) {
      onChange(selectedArray.filter(v => v !== removedValue));
    }
  };

  return (
    <div ref={containerRef} className={`relative w-full ${className}`}>
      {label && (
        <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
          {label}
        </label>
      )}

      <div className="relative">
        <div className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg bg-white focus-within:ring-2 focus-within:ring-teal-500 focus-within:border-transparent transition-all">
          <div className="flex flex-wrap gap-2 flex-1">
            {multi && selectedArray.length > 0 ? (
              selectedArray.map(item => (
                <div key={item} className="bg-teal-100 text-teal-700 px-3 py-1 rounded-full flex items-center gap-2 text-sm font-[Tajawal]">
                  {item}
                  <button
                    type="button"
                    onClick={() => handleRemoveTag(item)}
                    className="hover:text-teal-900"
                  >
                    <X size={14} />
                  </button>
                </div>
              ))
            ) : null}
            <input
              ref={inputRef}
              type="text"
              value={searchQuery}
              onChange={(e) => {
                setSearchQuery(e.target.value);
                setIsOpen(true);
                setHighlightedIndex(0);
              }}
              onFocus={() => setIsOpen(true)}
              onKeyDown={handleKeyDown}
              placeholder={selectedArray.length === 0 ? placeholder : ''}
              disabled={disabled}
              className="flex-1 min-w-32 outline-none bg-transparent font-[Tajawal]"
            />
          </div>
          <ChevronDown
            size={18}
            className={`text-gray-400 transition-transform ${isOpen ? 'transform rotate-180' : ''}`}
          />
        </div>

        {isOpen && (
          <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto">
            {displayOptions.length > 0 ? (
              displayOptions.map((option, index) => (
                <button
                  key={option}
                  type="button"
                  onClick={() => handleSelect(option)}
                  className={`w-full text-left px-4 py-2.5 transition-colors font-[Tajawal] ${
                    highlightedIndex === index ? 'bg-teal-50' : ''
                  } ${
                    selectedArray.includes(option) ? 'bg-teal-100 text-teal-700 font-semibold' : 'hover:bg-gray-50'
                  }`}
                >
                  {option}
                </button>
              ))
            ) : null}

            {showAddCustom && (
              <button
                type="button"
                onClick={() => handleSelect(searchQuery.trim())}
                className={`w-full text-left px-4 py-2.5 transition-colors font-[Tajawal] border-t border-gray-200 text-teal-600 hover:bg-teal-50 ${
                  highlightedIndex === displayOptions.length ? 'bg-teal-50' : ''
                }`}
              >
                ‚ûï ÿ•ÿ∂ÿßŸÅÿ©: "{searchQuery.trim()}"
              </button>
            )}

            {displayOptions.length === 0 && !showAddCustom && (
              <div className="px-4 py-8 text-center text-gray-500 font-[Tajawal]">
                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨
              </div>
            )}
          </div>
        )}
      </div>

      {!multi && value && selectedArray.length > 0 && (
        <div className="mt-2 text-xs text-gray-500 font-[Tajawal]">
          ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ: <span className="font-semibold text-gray-700">{selectedArray[0]}</span>
        </div>
      )}
    </div>
  );
};

export default SearchableSelect;
</file>

<file path="data/medical_terms.ts">
export const COMMON_COMPLAINTS = [
  'Abdominal Pain',
  'Vaginal Discharge',
  'Infertility',
  'Amenorrhea',
  'Dysmenorrhea',
  'Post-coital Bleeding',
  'Vaginal Bleeding',
  'Irregular Periods',
  'Pelvic Pain',
  'Heavy Menstrual Bleeding',
  'Painful Intercourse',
  'Vulvar Itching',
  'Vaginal Dryness',
  'Hot Flushes',
  'Night Sweats',
  'Breast Pain',
  'Breast Discharge',
  'Urinary Incontinence',
  'Urinary Frequency',
  'Urinary Urgency',
  'Pelvic Pressure',
  'Lower Back Pain',
  'Pelvic Mass',
  'Infertility - Primary',
  'Infertility - Secondary',
  'Delayed Puberty',
  'Abnormal Uterine Bleeding',
  'Anovulation',
  'Oligomenorrhea',
  'Polymenorrhea',
  'Metrorrhagia',
  'Menorrhagia',
  'Postmenopausal Bleeding',
  'Intermenstrual Bleeding',
  'Pelvic Inflammatory Disease',
  'Recurrent Pregnancy Loss',
];

export const ICD10_DIAGNOSES = [
  'N93.9 - Abnormal Uterine Bleeding (AUB), unspecified',
  'N80 - Endometriosis',
  'N80.0 - Endometriosis of uterus',
  'N80.1 - Endometriosis of ovary',
  'N80.3 - Endometriosis of pelvic peritoneum',
  'E28.2 - Polycystic Ovarian Syndrome (PCOS)',
  'E28.3 - Primary Ovarian Failure',
  'N73 - Pelvic Inflammatory Disease (PID)',
  'N73.0 - Acute Parametritis and Pelvic Cellulitis',
  'N73.1 - Chronic Parametritis and Pelvic Cellulitis',
  'N73.2 - Unspecified Parametritis and Pelvic Cellulitis',
  'N73.3 - Female Acute Pelvitis',
  'N73.4 - Female Chronic Pelvitis',
  'N73.5 - Female Pelvitis, unspecified',
  'N73.9 - Female Pelvic Inflammatory Disease, unspecified',
  'O20.0 - Threatened Abortion',
  'O03.9 - Unspecified Abortion',
  'O04.9 - Abortion, unspecified',
  'O06.9 - Unspecified Miscarriage',
  'N91.2 - Amenorrhea, unspecified',
  'N91.1 - Primary Amenorrhea',
  'N91.0 - Primary and Secondary Amenorrhea',
  'N92.0 - Excessive and Frequent Menstruation with Regular Cycle',
  'N92.1 - Excessive and Frequent Menstruation with Irregular Cycle',
  'N92.2 - Excessive Menstruation at Puberty',
  'N92.3 - Ovulation Bleeding',
  'N92.4 - Excessive Bleeding in the Premenopausal Period',
  'N95.0 - Postmenopausal Bleeding',
  'N81.1 - Cystocele',
  'N81.2 - Incomplete Uterovaginal Prolapse',
  'N81.3 - Complete Uterovaginal Prolapse',
  'N81.4 - Uterine Prolapse, unspecified',
  'N81.5 - Vaginal Enterocele',
  'N82 - Fistula Involving Female Genital Tract',
  'N84 - Polyp of Female Genital Tract',
  'N84.0 - Polyp of Corpus Uteri',
  'N84.1 - Polyp of Cervix',
  'N84.2 - Polyp of Vagina',
  'N84.3 - Polyp of Vulva',
  'N85.0 - Adenomatous Hyperplasia of Endometrium',
  'N85.2 - Hypertrophy of Uterus',
  'N86 - Erosion and Ectropion of Cervix Uteri',
  'N87.0 - Mild Cervical Dysplasia (CIN I)',
  'N87.1 - Moderate Cervical Dysplasia (CIN II)',
  'N87.2 - Severe Cervical Dysplasia (CIN III)',
  'C53.9 - Malignant Neoplasm of Cervix Uteri, unspecified',
  'D25.9 - Leiomyoma of Uterus, unspecified',
  'D25.0 - Submucosal Leiomyoma of Uterus',
  'D25.1 - Intramural Leiomyoma of Uterus',
  'D25.2 - Subserosal Leiomyoma of Uterus',
  'N35.9 - Urethral Stricture, unspecified',
  'N39.3 - Urge Incontinence',
  'N39.4 - Other Specified Urinary Incontinence',
  'N39.45 - Unspecified Urinary Incontinence',
  'N76 - Inflammation of Vagina and Vulva',
  'N76.0 - Acute Vaginitis',
  'N76.1 - Subacute and Chronic Vaginitis',
  'N76.2 - Acute Vulvitis',
  'N76.3 - Subacute and Chronic Vulvitis',
  'N77.0 - Abscess of Vulva',
  'N77.1 - Ulceration of Vulva',
  'B37.3 - Candidiasis of Vulva and Vagina',
  'A59.0 - Trichomoniasis of Genitourinary Tract',
  'A56.0 - Chlamydial Infection of Lower Genitourinary Tract',
  'A54.0 - Gonococcal Infection of Lower Genitourinary Tract',
  'N90.6 - Vulvar Cyst',
  'N90.7 - Vulvar Cyst, unspecified',
  'N90.8 - Hypertrophy of Clitoris',
  'N90.89 - Other Specified Noninflammatory Disorders of Vulva and Perineum',
  'N89.9 - Noninflammatory Disorder of Vagina, unspecified',
  'Z12.4 - Encounter for Screening for Malignant Neoplasm of Cervix',
  'N39.0 - Urinary Tract Infection, Site Not Specified',
];

export const PROCEDURE_ORDERS = [
  'Pap Smear (Cervical Cytology)',
  'HPV Testing',
  'Transvaginal Ultrasound',
  'Transabdominal Ultrasound',
  'Pelvic Ultrasound',
  'Hysterosalpingography (HSG)',
  'Hysteroscopy',
  'Laparoscopy',
  'Colposcopy',
  'Endometrial Biopsy',
  'Cervical Biopsy',
  'Vulval Biopsy',
  'Culdocentesis',
  'Dilation & Curettage (D&C)',
  'Myomectomy',
  'Hysterectomy',
  'Tubal Ligation',
  'IUD Insertion',
  'Contraceptive Implant Insertion',
  'Endometrial Ablation',
  'Cone Biopsy (LEEP)',
  'Cauterization of Cervix',
  'Polypectomy',
  'Cyst Aspiration',
  'Diagnostic Laparoscopy',
  'Therapeutic Laparoscopy',
  'Egg Retrieval (OPU)',
  'Embryo Transfer',
  'Intrauterine Insemination (IUI)',
  'Semen Analysis',
  'Follicle Tracking Ultrasound',
  'Progesterone Level Test',
  'Pelvic MRI',
  'CT Pelvis',
  'Sonohysterography',
  'Saline Infusion Sonography (SIS)',
  'Anti-Sperm Antibody Test',
  'Postcoital Test',
];

export const PELVIC_EXAM_FINDINGS = [
  'Normal',
  'Cervical Friability',
  'Cervical Discharge',
  'Cervical Polyp',
  'Cervical Erosion',
  'Cervical Stenosis',
  'Cervical Laceration',
  'Vaginal Atrophy',
  'Vaginal Tear',
  'Vaginal Stenosis',
  'Vaginal Ulcer',
  'Vulvar Lesion',
  'Vulvar Ulcer',
  'Vulvar Edema',
  'Enlarged Clitoris',
  'Bartholin Cyst',
  'Abnormal Uterine Position',
  'Uterine Tenderness',
  'Uterine Fibroids',
  'Adnexal Mass',
  'Ovarian Tenderness',
  'Adnexal Tenderness',
  'Rebound Tenderness',
  'Guarding',
  'Cul-de-sac Fullness',
  'Normal External Genitalia',
  'Vaginal Discharge - Clear',
  'Vaginal Discharge - White',
  'Vaginal Discharge - Yellow',
  'Vaginal Discharge - Purulent',
  'Vaginal Discharge - Bloody',
];

export const ULTRASOUND_FINDINGS = [
  'Normal',
  'Endometrial Thickening',
  'Endometrial Thinning',
  'Endometrial Hyperplasia',
  'Endometrial Polyp',
  'Endometrial Cancer',
  'Myomatous Uterus',
  'Submucosal Fibroid',
  'Intramural Fibroid',
  'Subserosal Fibroid',
  'Simple Ovarian Cyst',
  'Complex Ovarian Cyst',
  'Hemorrhagic Cyst',
  'Ovarian Mass',
  'Ovarian Torsion',
  'Free Fluid in Pelvis',
  'Ascites',
  'Hydrosalpinx',
  'Pyosalpinx',
  'Tubal Blockage',
  'Gestational Sac',
  'Yolk Sac',
  'Fetal Heart Rate Present',
  'Ectopic Pregnancy',
  'Intrauterine Device Visible',
  'Adenomyosis',
  'Uterine Septum',
  'Bicornuate Uterus',
  'Unicornuate Uterus',
  'Absent Uterus',
];

export const TREATMENT_PLANS = [
  'Watchful Waiting',
  'Symptomatic Treatment',
  'Hormonal Contraception',
  'Nonsteroidal Anti-inflammatory Drugs (NSAIDs)',
  'Antibiotics',
  'Antifungals',
  'Antiparasitics',
  'Hormone Replacement Therapy (HRT)',
  'Progestin Therapy',
  'Gonadotropin-releasing Hormone (GnRH) Agonists',
  'Danazol',
  'Fertility Treatment',
  'Assisted Reproductive Technology (ART)',
  'Intrauterine Insemination (IUI)',
  'In Vitro Fertilization (IVF)',
  'Surgical Intervention',
  'Myomectomy',
  'Hysterectomy',
  'Dilation & Curettage (D&C)',
  'Hysteroscopic Ablation',
  'Laparoscopic Surgery',
  'Vaginal Delivery',
  'Cesarean Section',
  'Counseling',
  'Lifestyle Modification',
  'Weight Loss',
  'Smoking Cessation',
  'Physical Therapy',
  'Pelvic Floor Exercises',
];
</file>

<file path="electron/preload.js">
const { contextBridge, ipcRenderer } = require('electron');

// ŸÜÿ≠ŸÜ ŸÜŸÉÿ¥ŸÅ ŸÅŸÇÿ∑ Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≠ÿØÿØÿ© ŸÑŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ© ŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
contextBridge.exposeInMainWorld('electronAPI', {
  // ŸÖÿ´ÿßŸÑ ŸÑŸàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸäÿ©
  print: () => ipcRenderer.send('print-document'),
  saveToDb: (data) => ipcRenderer.invoke('db-save', data),
  getFromDb: (query) => ipcRenderer.invoke('db-get', query)
});
</file>

<file path="index.tsx">
import React from "react";
import { createRoot } from "react-dom/client";
import App from "./App";

const rootElement = document.getElementById("root");
if (rootElement) {
  const root = createRoot(rootElement);
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
}
</file>

<file path="IVF_CYCLES_SETUP.sql">
-- ============================================================================
-- IVF CYCLES MODULE SETUP - Supabase SQL
-- ============================================================================
-- This script creates tables for IVF cycle management with assessment,
-- lab data, transfer, and outcome tracking.
-- ============================================================================

-- 1. CREATE IVF_CYCLES TABLE
CREATE TABLE IF NOT EXISTS ivf_cycles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
  protocol TEXT NOT NULL CHECK (protocol IN ('Long', 'Antagonist', 'Flare-up', 'Mini-IVF')),
  status TEXT NOT NULL DEFAULT 'Active' CHECK (status IN ('Active', 'Completed', 'Cancelled')),
  start_date DATE NOT NULL,
  assessment_data JSONB DEFAULT NULL,
  lab_data JSONB DEFAULT NULL,
  transfer_data JSONB DEFAULT NULL,
  outcome_data JSONB DEFAULT NULL,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 2. CREATE STIMULATION_LOGS TABLE
CREATE TABLE IF NOT EXISTS stimulation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cycle_id UUID NOT NULL REFERENCES ivf_cycles(id) ON DELETE CASCADE,
  cycle_day INTEGER NOT NULL,
  date DATE NOT NULL,
  fsh TEXT DEFAULT '',
  hmg TEXT DEFAULT '',
  e2 TEXT DEFAULT '',
  lh TEXT DEFAULT '',
  rt_follicles TEXT DEFAULT '',
  lt_follicles TEXT DEFAULT '',
  endometrium_thickness TEXT DEFAULT '',
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 3. CREATE INDEXES FOR PERFORMANCE
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_patient_id ON ivf_cycles(patient_id);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_doctor_id ON ivf_cycles(doctor_id);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_status ON ivf_cycles(status);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_start_date ON ivf_cycles(start_date DESC);
CREATE INDEX IF NOT EXISTS idx_stimulation_logs_cycle_id ON stimulation_logs(cycle_id);
CREATE INDEX IF NOT EXISTS idx_stimulation_logs_date ON stimulation_logs(date);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_assessment_data ON ivf_cycles USING GIN (assessment_data);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_lab_data ON ivf_cycles USING GIN (lab_data);

-- 4. ENABLE RLS
ALTER TABLE ivf_cycles ENABLE ROW LEVEL SECURITY;
ALTER TABLE stimulation_logs ENABLE ROW LEVEL SECURITY;

-- 5. DROP EXISTING POLICIES
DROP POLICY IF EXISTS "Doctors can read their IVF cycles" ON ivf_cycles;
DROP POLICY IF EXISTS "Doctors can insert IVF cycles" ON ivf_cycles;
DROP POLICY IF EXISTS "Doctors can update IVF cycles" ON ivf_cycles;
DROP POLICY IF EXISTS "Doctors can read stimulation logs" ON stimulation_logs;
DROP POLICY IF EXISTS "Doctors can insert stimulation logs" ON stimulation_logs;
DROP POLICY IF EXISTS "Doctors can update stimulation logs" ON stimulation_logs;

-- 6. RLS POLICIES FOR IVF_CYCLES
CREATE POLICY "Doctors can read their IVF cycles" ON ivf_cycles
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can insert IVF cycles" ON ivf_cycles
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can update IVF cycles" ON ivf_cycles
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

-- 7. RLS POLICIES FOR STIMULATION_LOGS
CREATE POLICY "Doctors can read stimulation logs" ON stimulation_logs
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can insert stimulation logs" ON stimulation_logs
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can update stimulation logs" ON stimulation_logs
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

-- 8. ADD TABLE COMMENTS
COMMENT ON TABLE ivf_cycles IS 'Stores IVF cycle information including protocol, status, and JSONB data for assessments, lab results, transfer, and outcomes';
COMMENT ON COLUMN ivf_cycles.assessment_data IS 'JSONB object containing couple profile, male/female factor, and tubal-uterine assessments';
COMMENT ON COLUMN ivf_cycles.lab_data IS 'JSONB object containing OPU data, embryo counts, and grading';
COMMENT ON COLUMN ivf_cycles.transfer_data IS 'JSONB object containing transfer details and luteal support options';
COMMENT ON COLUMN ivf_cycles.outcome_data IS 'JSONB object containing beta-HCG and clinical pregnancy outcomes';
</file>

<file path="IVF_MIGRATION_GUIDE.md">
# IVF Cycle Management Database Migration Guide

## Issue Resolution: "Failed to save assessment"

The "Failed to save assessment" error was occurring because the `ivf_cycles` table was missing the required JSONB columns (`assessment_data`, `lab_data`, `transfer_data`, `outcome_data`) in your Supabase database.

## Solution

A new SQL migration file has been created: `IVF_CYCLES_SETUP.sql`

This file creates:
1. **ivf_cycles** table with all required columns
2. **stimulation_logs** table for daily cycle tracking
3. Proper indexes for performance
4. Row-Level Security (RLS) policies for data access control

## How to Apply the Migration

### Step 1: Open Supabase SQL Editor
1. Go to [Supabase Dashboard](https://app.supabase.com)
2. Select your project
3. Navigate to **SQL Editor** in the left sidebar
4. Click **New Query**

### Step 2: Copy and Execute SQL
1. Open `IVF_CYCLES_SETUP.sql` from your project root
2. Copy the entire SQL content
3. Paste it into the Supabase SQL Editor
4. Click **Run** (or press Ctrl+Enter)

### Step 3: Verify Success
After running the migration, you should see:
- ‚úÖ No error messages in the SQL editor
- ‚úÖ Query succeeded notification

Verify the tables were created:
```sql
-- Check ivf_cycles table
SELECT * FROM ivf_cycles LIMIT 1;

-- Check stimulation_logs table
SELECT * FROM stimulation_logs LIMIT 1;
```

## What Changed in the Code

### New Database Schema
```
ivf_cycles (Main IVF Cycle Record)
‚îú‚îÄ‚îÄ id (UUID, primary key)
‚îú‚îÄ‚îÄ patient_id (UUID, foreign key)
‚îú‚îÄ‚îÄ doctor_id (UUID, foreign key)
‚îú‚îÄ‚îÄ protocol (TEXT: 'Long', 'Antagonist', 'Flare-up', 'Mini-IVF')
‚îú‚îÄ‚îÄ status (TEXT: 'Active', 'Completed', 'Cancelled')
‚îú‚îÄ‚îÄ start_date (DATE)
‚îú‚îÄ‚îÄ assessment_data (JSONB) ‚Üê Now saves couple profile, male/female factor assessments
‚îú‚îÄ‚îÄ lab_data (JSONB) ‚Üê Saves OPU and embryology data
‚îú‚îÄ‚îÄ transfer_data (JSONB) ‚Üê Saves transfer details and luteal support
‚îú‚îÄ‚îÄ outcome_data (JSONB) ‚Üê Saves beta-HCG and pregnancy outcomes
‚îî‚îÄ‚îÄ timestamps (created_at, updated_at)

stimulation_logs (Daily Stimulation Records)
‚îú‚îÄ‚îÄ id (UUID, primary key)
‚îú‚îÄ‚îÄ cycle_id (UUID, foreign key to ivf_cycles)
‚îú‚îÄ‚îÄ cycle_day (INTEGER)
‚îú‚îÄ‚îÄ date (DATE)
‚îú‚îÄ‚îÄ fsh, hmg, e2, lh (TEXT fields for hormone values)
‚îú‚îÄ‚îÄ rt_follicles, lt_follicles (TEXT for follicle counts)
‚îú‚îÄ‚îÄ endometrium_thickness (TEXT)
‚îî‚îÄ‚îÄ timestamps (created_at, updated_at)
```

### Enhanced Error Handling
The following functions now provide detailed error messages:
- `updateCycleAssessment()` - Saves assessment data
- `updateCycleLabData()` - Saves lab data
- `updateCycleTransfer()` - Saves transfer data
- `updateCycleOutcome()` - Saves outcome data

**Before:**
```
toast.error('Failed to save assessment');
```

**After:**
```
toast.error('Failed to save assessment: [Detailed error message]');
console.error('Save assessment error:', error);
```

## Row-Level Security (RLS)

The migration includes RLS policies that ensure:
- Doctors can only access their own patient's cycles
- Each doctor is isolated from other doctors' data
- Automatic filtering based on authenticated user ID

## Troubleshooting

### If you still see "Failed to save assessment":

1. **Check browser console (F12)** for detailed error messages
2. **Verify RLS policies** are enabled:
   ```sql
   SELECT * FROM pg_policies 
   WHERE tablename IN ('ivf_cycles', 'stimulation_logs');
   ```

3. **Check doctor_id mapping** - ensure your doctor record exists:
   ```sql
   SELECT id, user_id FROM doctors WHERE user_id = 'YOUR_USER_ID';
   ```

4. **Verify table structure**:
   ```sql
   SELECT column_name, data_type FROM information_schema.columns 
   WHERE table_name = 'ivf_cycles';
   ```

## Database Relationships

```
auth.users (Supabase Auth)
    ‚Üì
doctors (has doctor_id, user_id)
    ‚Üì
patients (has doctor_id)
    ‚Üì
ivf_cycles (has patient_id, doctor_id)
    ‚Üì
stimulation_logs (has cycle_id)
```

## Next Steps

1. Run the migration using the steps above
2. Refresh your browser
3. Create a new IVF cycle - the "Save Assessment" button should now work
4. Check browser console (F12) for confirmation of successful saves

## Support

If you encounter any issues:
1. Check the browser console for detailed error messages
2. Run verification queries provided in Step 3
3. Ensure you're logged in with a valid doctor account
4. Verify the Supabase connection in `services/supabaseClient.ts`
</file>

<file path="metadata.json">
{
  "name": "Copy of Nile IVF & OB/GYN Center",
  "description": "A comprehensive, production-ready EMR system for IVF Clinics featuring patient management, clinical stations, and advanced IVF cycle tracking with stimulation logs. Designed with a Medical SaaS aesthetic and RTL support.",
  "requestFramePermissions": []
}
</file>

<file path="OBSTETRICS_IMPLEMENTATION.md">
# ü§∞ Smart Obstetrics Module - Implementation Guide

## Overview
A comprehensive **Antenatal Care (ANC) Dashboard** for the React/Supabase app with state-of-the-art pregnancy management features.

---

## ‚úÖ What Was Built

### **1. Database Schema (Supabase)**
Three main tables created:

#### `pregnancies`
- `id` (UUID) - Primary key
- `patient_id` (UUID) - Link to patients table
- `lmp_date` - Last Menstrual Period
- `edd_date` - Estimated Delivery Date (calculated)
- `edd_by_scan` - EDD confirmed by ultrasound
- `ga_at_booking` - Gestational age at first booking
- `risk_level` - 'low', 'moderate', 'high'
- `risk_factors` - JSONB array of risk factors
- `aspirin_prescribed` - Boolean for pre-eclampsia prevention
- `thromboprophylaxis_needed` - Boolean for VTE prevention

#### `antenatal_visits`
- `id` (UUID)
- `pregnancy_id` (UUID) - Links to pregnancies
- `visit_date` - Date of visit
- `gestational_age_weeks`, `gestational_age_days` - Auto-calculated
- `systolic_bp`, `diastolic_bp` - Blood pressure
- `weight_kg` - Maternal weight
- `urine_albuminuria`, `urine_glycosuria` - Urine findings
- `fetal_heart_sound` - Boolean
- `fundal_height_cm` - Height of uterine fundus
- `edema` - Boolean
- `notes` - Clinical notes

#### `biometry_scans`
- `id` (UUID)
- `pregnancy_id` (UUID)
- `scan_date`
- `bpd_mm`, `hc_mm`, `ac_mm`, `fl_mm` - Biometric measurements
- `efw_grams` - Estimated Fetal Weight (calculated)
- `percentile` - Growth percentile (10th, 50th, 90th)

---

## üìä Features Breakdown

### **1. ü§∞ Pregnancy Header**
**File:** `pages/components/obstetrics/PregnancyHeader.tsx`

Features:
- **Visual Timeline**: Progress bar from 0-40 weeks
- **Current GA Display**: "24 Weeks + 3 Days"
- **Smart Alerts**: Context-aware due actions based on GA
  - Week 11-13: NT Scan Due
  - Week 20-22: Anomaly Scan Due
  - Week 28: GTT/Anti-D Prophylaxis
  - Week 34-36: Growth Scan
  - Week 36+: Position Check & Birth Plan

- **Risk Badge**: Color-coded indicator (üü¢ Low / üü° Moderate / üî¥ High)
- **Medication Alerts**: Aspirin prescription status

### **2. ‚öñÔ∏è RCOG Risk Assessment**
**File:** `pages/components/obstetrics/RiskAssessment.tsx`

Checkboxes for 8 risk factors:
- Age > 40
- BMI > 30
- Previous Pre-eclampsia
- Multiple pregnancy (Twins)
- Autoimmune disease
- Hypertension
- Diabetes
- Kidney disease

**Logic:**
- ‚â•1 High Risk Factor ‚Üí **HIGH RISK** (Aspirin 150mg + close monitoring)
- ‚â•2 Moderate Factors ‚Üí **HIGH RISK**
- 1 Moderate Factor ‚Üí **MODERATE RISK**
- 0 Factors ‚Üí **LOW RISK**

**Outputs:**
- Risk stratification badge
- Medication recommendations (Aspirin, Clexane)
- Saves to database automatically

### **3. üìã ANC Flow Sheet**
**File:** `pages/components/obstetrics/ANCFlowSheet.tsx`

**Data Grid with:**
- Visit Date | GA | BP | Weight | Urine | FHS | Fundal Height | Edema

**Features:**
- Add new visit (modal form)
- Edit existing visits
- Delete visits
- Auto-calculate GA from LMP

**Trend Chart:**
- Line graph showing weight progression
- Blood pressure trends over time
- Helps identify anomalies (pre-eclampsia spikes)

### **4. üë∂ Fetal Growth Chart (The "Wow" Feature)**
**File:** `pages/components/obstetrics/FetalGrowthChart.tsx`

**Biometry Input:**
- BPD (Biparietal Diameter) in mm
- HC (Head Circumference) in mm
- AC (Abdominal Circumference) in mm
- FL (Femur Length) in mm

**Auto-Calculations:**
- **Hadlock Formula** for EFW: 
  ```
  log10(EFW) = 1.3404 + 0.0438√óHC + 0.158√óAC + 0.0061√óBPD - 0.002322√óAC√óBPD
  ```
- **Growth Percentile**: Compared to RCOG/NICE standards
- **Flags**: Red if <10th percentile (growth restriction), Yellow if >90th (macrosomia)

**RCOG Reference Lines:**
- 10th Percentile (Green) - Minimum normal
- 50th Percentile (Blue) - Average
- 90th Percentile (Red) - Maximum normal

**Visual:** Line chart with reference curves and patient's EFW trend

---

## üõ†Ô∏è Helper Functions (obstetricsService.ts)

### **Calculation Functions**

#### `calculateGestationalAge(lmpDate: string)`
- Input: ISO date string
- Output: `{ weeks, days }`
- Formula: Days difference √∑ 7 = weeks + remainder

#### `calculateEDD(lmpDate: string)`
- Input: LMP date
- Output: ISO date string
- Formula: LMP + 280 days (40 weeks)

#### `calculateEFW(bpd, hc, ac, fl)`
- Hadlock formula for fetal weight estimation
- Returns weight in grams

#### `calculatePercentile(efwGrams, gaWeeks)`
- Compares EFW to RCOG growth standards
- Returns percentile (10, 50, 90)

#### `getDueActions(gaWeeks: number)`
- Returns array of due actions for current GA
- Example: `["‚ö†Ô∏è Nuchal Translucency Scan Due", "üß™ Quad Screen Results Expected"]`

#### `assessRiskLevel(riskFactors)`
- RCOG-compliant risk stratification
- Returns: `{ level, riskFactorsList, aspirinNeeded, thromboprophylaxisNeeded }`

---

## üóÇÔ∏è File Structure

```
pages/
‚îú‚îÄ‚îÄ ObstetricsDashboard.tsx (Main page)
‚îî‚îÄ‚îÄ components/obstetrics/
    ‚îú‚îÄ‚îÄ PregnancyHeader.tsx
    ‚îú‚îÄ‚îÄ RiskAssessment.tsx
    ‚îú‚îÄ‚îÄ ANCFlowSheet.tsx
    ‚îî‚îÄ‚îÄ FetalGrowthChart.tsx

services/
‚îú‚îÄ‚îÄ obstetricsService.ts (All calculations & DB operations)
‚îî‚îÄ‚îÄ supabaseClient.ts

types.ts (Pregnancy, AntenatalVisit, BiometryScan interfaces)
```

---

## üîß Setup Instructions

### **Step 1: Run SQL Script**
```sql
-- Execute OBSTETRICS_SETUP.sql in Supabase SQL Editor
-- Creates: pregnancies, antenatal_visits, biometry_scans tables
-- Adds: RLS policies, indexes
```

### **Step 2: Verify Database**
```bash
# Check tables created:
SELECT * FROM pregnancies LIMIT 1;
SELECT * FROM antenatal_visits LIMIT 1;
SELECT * FROM biometry_scans LIMIT 1;
```

### **Step 3: Start Using**
1. Navigate to **Obstetrics** in the sidebar (new menu item)
2. Select a patient
3. Click **"Create New Pregnancy File"**
4. Enter LMP date or EDD by ultrasound
5. Add visits, scans, and track risk

---

## üí° Key Features

### ‚ú® Smart Alerts
- Automatic due dates calculation
- Context-aware clinical recommendations
- Color-coded risk indicators

### üìä Data Visualization
- Growth curve charts with RCOG reference lines
- Weight/BP trends over time
- Percentile bands (10th, 50th, 90th)

### üßÆ Auto-Calculations
- GA calculation from any date
- EFW using Hadlock formula
- Growth percentile assessment
- Due action suggestions

### üíæ Complete History
- All visits logged with trends
- All scans recorded with biometry
- Risk assessment evolution
- Edit/delete capability

---

## üé® UI/UX Details

- **Color Scheme**: Medical teal (#14b8a6) with accent colors
- **Language**: Arabic RTL support throughout
- **Responsive**: Mobile-friendly (6-column BottomNav)
- **Icons**: Lucide React icons for visual clarity
- **Charts**: Recharts for professional data visualization

---

## üöÄ Next Steps (Optional Enhancements)

1. **Integration with Reception Module**
   - Link to patient records automatically
   - Sync with existing patient data

2. **Export Functionality**
   - PDF report generation
   - Growth charts export
   - ANC summary printout

3. **Alerts & Notifications**
   - Push notifications for due scans
   - Email reminders for next visit

4. **Mobile App**
   - Offline sync capability
   - Camera integration for ultrasound images

5. **Analytics**
   - Hospital-wide statistics
   - Risk stratification reports
   - Outcome tracking

---

## üìö References

- **RCOG Guidelines**: Management of Hypertensive Disorders
- **WHO Intergrowth Standards**: Fetal biometry standards
- **Hadlock Formula**: Gold standard for EFW calculation
- **Pre-eclampsia Prevention**: Aspirin 150mg daily from 16 weeks

---

## ‚ö†Ô∏è Important Notes

1. **RLS Policies**: All authenticated doctors can view all pregnancies (adjust if needed)
2. **Data Validation**: Frontend validation present, add backend validation for production
3. **Backup**: Regular database backups recommended
4. **HIPAA Compliance**: Ensure proper access controls in production

---

## üêõ Troubleshooting

**Issue:** Patient list not showing
- **Solution**: Verify `patients` table exists in Supabase

**Issue:** Calculations giving wrong results
- **Solution**: Check LMP/EDD dates are in ISO format (YYYY-MM-DD)

**Issue:** Charts not rendering
- **Solution**: Ensure Recharts is installed: `npm list recharts`

---

**Version:** 1.0.0  
**Created:** December 2025  
**Status:** ‚úÖ Production Ready
</file>

<file path="OBSTETRICS_SETUP_V2.sql">
-- ============================================================================
-- OBSTETRICS MODULE SETUP - Supabase SQL (FIXED RLS)
-- ============================================================================

-- 1. PREGNANCIES TABLE
CREATE TABLE IF NOT EXISTS pregnancies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  lmp_date DATE,
  edd_date DATE,
  edd_by_scan DATE,
  ga_at_booking INTEGER,
  risk_level TEXT DEFAULT 'low' CHECK (risk_level IN ('low', 'moderate', 'high')),
  risk_factors JSONB DEFAULT '[]',
  aspirin_prescribed BOOLEAN DEFAULT FALSE,
  thromboprophylaxis_needed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 2. ANTENATAL VISITS TABLE
CREATE TABLE IF NOT EXISTS antenatal_visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  visit_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  systolic_bp INTEGER,
  diastolic_bp INTEGER,
  weight_kg DECIMAL(5, 2),
  urine_albuminuria TEXT,
  urine_glycosuria TEXT,
  fetal_heart_sound BOOLEAN,
  fundal_height_cm DECIMAL(5, 2),
  edema BOOLEAN,
  edema_grade TEXT,
  notes TEXT,
  next_visit_date DATE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 3. BIOMETRY SCANS TABLE (Fetal Growth)
CREATE TABLE IF NOT EXISTS biometry_scans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  scan_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  bpd_mm DECIMAL(5, 2),
  hc_mm DECIMAL(5, 2),
  ac_mm DECIMAL(5, 2),
  fl_mm DECIMAL(5, 2),
  efw_grams INTEGER,
  percentile INTEGER,
  notes TEXT,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 4. CREATE INDEXES
CREATE INDEX IF NOT EXISTS idx_pregnancies_patient_id ON pregnancies(patient_id);
CREATE INDEX IF NOT EXISTS idx_pregnancies_doctor_id ON pregnancies(doctor_id);
CREATE INDEX IF NOT EXISTS idx_antenatal_visits_pregnancy_id ON antenatal_visits(pregnancy_id);
CREATE INDEX IF NOT EXISTS idx_biometry_scans_pregnancy_id ON biometry_scans(pregnancy_id);

-- 5. ENABLE RLS
ALTER TABLE pregnancies ENABLE ROW LEVEL SECURITY;
ALTER TABLE antenatal_visits ENABLE ROW LEVEL SECURITY;
ALTER TABLE biometry_scans ENABLE ROW LEVEL SECURITY;

-- 6. DROP EXISTING POLICIES
DROP POLICY IF EXISTS "Doctors can read all pregnancies" ON pregnancies;
DROP POLICY IF EXISTS "Doctors can insert pregnancies" ON pregnancies;
DROP POLICY IF EXISTS "Doctors can update pregnancies" ON pregnancies;
DROP POLICY IF EXISTS "Doctors can read all antenatal visits" ON antenatal_visits;
DROP POLICY IF EXISTS "Doctors can insert antenatal visits" ON antenatal_visits;
DROP POLICY IF EXISTS "Doctors can update antenatal visits" ON antenatal_visits;
DROP POLICY IF EXISTS "Doctors can read all biometry scans" ON biometry_scans;
DROP POLICY IF EXISTS "Doctors can insert biometry scans" ON biometry_scans;
DROP POLICY IF EXISTS "Doctors can update biometry scans" ON biometry_scans;

-- 7. NEW RLS POLICIES for pregnancies - Link to authenticated doctor
CREATE POLICY "Doctors can read their pregnancies" ON pregnancies
  FOR SELECT 
  USING (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can insert pregnancies" ON pregnancies
  FOR INSERT 
  WITH CHECK (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can update their pregnancies" ON pregnancies
  FOR UPDATE 
  USING (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  )
  WITH CHECK (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

-- 8. RLS POLICIES for antenatal_visits
CREATE POLICY "Doctors can read antenatal visits" ON antenatal_visits
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can insert antenatal visits" ON antenatal_visits
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can update antenatal visits" ON antenatal_visits
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

-- 9. RLS POLICIES for biometry_scans
CREATE POLICY "Doctors can read biometry scans" ON biometry_scans
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can insert biometry scans" ON biometry_scans
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can update biometry scans" ON biometry_scans
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );
</file>

<file path="OBSTETRICS_SETUP.sql">
-- ============================================================================
-- OBSTETRICS MODULE SETUP - Supabase SQL
-- ============================================================================

-- 1. PREGNANCIES TABLE
CREATE TABLE IF NOT EXISTS pregnancies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  lmp_date DATE,
  edd_date DATE,
  edd_by_scan DATE,
  ga_at_booking INTEGER,
  risk_level TEXT DEFAULT 'low' CHECK (risk_level IN ('low', 'moderate', 'high')),
  risk_factors JSONB DEFAULT '[]',
  aspirin_prescribed BOOLEAN DEFAULT FALSE,
  thromboprophylaxis_needed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 2. ANTENATAL VISITS TABLE
CREATE TABLE IF NOT EXISTS antenatal_visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  visit_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  systolic_bp INTEGER,
  diastolic_bp INTEGER,
  weight_kg DECIMAL(5, 2),
  urine_albuminuria TEXT,
  urine_glycosuria TEXT,
  fetal_heart_sound BOOLEAN,
  fundal_height_cm DECIMAL(5, 2),
  edema BOOLEAN,
  edema_grade TEXT,
  notes TEXT,
  next_visit_date DATE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 3. BIOMETRY SCANS TABLE (Fetal Growth)
CREATE TABLE IF NOT EXISTS biometry_scans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  scan_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  bpd_mm DECIMAL(5, 2),
  hc_mm DECIMAL(5, 2),
  ac_mm DECIMAL(5, 2),
  fl_mm DECIMAL(5, 2),
  efw_grams INTEGER,
  percentile INTEGER,
  notes TEXT,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 4. CREATE INDEXES
CREATE INDEX idx_pregnancies_patient_id ON pregnancies(patient_id);
CREATE INDEX idx_antenatal_visits_pregnancy_id ON antenatal_visits(pregnancy_id);
CREATE INDEX idx_biometry_scans_pregnancy_id ON biometry_scans(pregnancy_id);

-- 5. ENABLE RLS
ALTER TABLE pregnancies ENABLE ROW LEVEL SECURITY;
ALTER TABLE antenatal_visits ENABLE ROW LEVEL SECURITY;
ALTER TABLE biometry_scans ENABLE ROW LEVEL SECURITY;

-- 6. RLS POLICIES for pregnancies
CREATE POLICY "Doctors can read all pregnancies" ON pregnancies
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Doctors can insert pregnancies" ON pregnancies
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Doctors can update pregnancies" ON pregnancies
  FOR UPDATE USING (auth.role() = 'authenticated');

-- 7. RLS POLICIES for antenatal_visits
CREATE POLICY "Doctors can read all antenatal visits" ON antenatal_visits
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Doctors can insert antenatal visits" ON antenatal_visits
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Doctors can update antenatal visits" ON antenatal_visits
  FOR UPDATE USING (auth.role() = 'authenticated');

-- 8. RLS POLICIES for biometry_scans
CREATE POLICY "Doctors can read all biometry scans" ON biometry_scans
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Doctors can insert biometry scans" ON biometry_scans
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Doctors can update biometry scans" ON biometry_scans
  FOR UPDATE USING (auth.role() = 'authenticated');
</file>

<file path="pages/components/InfertilityWizard.tsx">
import React, { useState, useEffect } from 'react';
import { Microscope, Baby, Activity, Heart, Save, AlertCircle, CheckCircle, Clock } from 'lucide-react';
import toast from 'react-hot-toast';
import { getWorkup, saveWorkup, generateDiagnosis, WorkupState } from '../../services/workupService';

interface InfertilityWizardProps {
  patientId: string;
  patientName?: string;
}

const InfertilityWizard: React.FC<InfertilityWizardProps> = ({ patientId, patientName }) => {
  const [workupData, setWorkupData] = useState<WorkupState>({
    patientId,
    ovarianFactor: {},
    maleFactor: {},
    tubalFactor: {},
    uterineFactor: {},
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  // Load data on mount
  useEffect(() => {
    const loadWorkup = async () => {
      try {
        const data = await getWorkup(patientId);
        setWorkupData(data);
      } catch (error) {
        toast.error('Failed to load infertility workup data');
      } finally {
        setLoading(false);
      }
    };

    loadWorkup();
  }, [patientId]);

  // Auto-generate diagnosis whenever data changes
  useEffect(() => {
    const diagnosis = generateDiagnosis(workupData);
    setWorkupData(prev => ({
      ...prev,
      diagnosis: diagnosis.diagnosis,
      plan: diagnosis.plan,
    }));
  }, [workupData.ovarianFactor, workupData.maleFactor, workupData.tubalFactor, workupData.uterineFactor]);

  // Handle input changes
  const updateOvarianFactor = (field: keyof WorkupState['ovarianFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      ovarianFactor: {
        ...prev.ovarianFactor,
        [field]: value,
      },
    }));
  };

  const updateMaleFactor = (field: keyof WorkupState['maleFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      maleFactor: {
        ...prev.maleFactor,
        [field]: value,
      },
    }));
  };

  const updateTubalFactor = (field: keyof WorkupState['tubalFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      tubalFactor: {
        ...prev.tubalFactor,
        [field]: value,
      },
    }));
  };

  const updateUterineFactor = (field: keyof WorkupState['uterineFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      uterineFactor: {
        ...prev.uterineFactor,
        [field]: value,
      },
    }));
  };

  // Determine card status and color
  const getCardStatus = (factor: any, checks: (() => boolean)[]) => {
    const hasData = Object.values(factor).some(value => value !== undefined && value !== '');
    if (!hasData) return { status: 'missing', color: 'border-gray-300 bg-gray-50', icon: Clock };

    const hasIssues = checks.some(check => check());
    return hasIssues
      ? { status: 'problem', color: 'border-red-300 bg-red-50', icon: AlertCircle }
      : { status: 'normal', color: 'border-green-300 bg-green-50', icon: CheckCircle };
  };

  const ovarianStatus = getCardStatus(workupData.ovarianFactor, [
    () => workupData.ovarianFactor.amh !== undefined && (workupData.ovarianFactor.amh < 1.1 || workupData.ovarianFactor.amh > 3.5),
    () => workupData.ovarianFactor.cycleRegularity === 'Irregular',
  ]);

  const maleStatus = getCardStatus(workupData.maleFactor, [
    () => workupData.maleFactor.spermCount !== undefined && workupData.maleFactor.spermCount < 15,
    () => workupData.maleFactor.motility !== undefined && workupData.maleFactor.motility < 40,
    () => workupData.maleFactor.morphology !== undefined && workupData.maleFactor.morphology < 4,
  ]);

  const tubalStatus = getCardStatus(workupData.tubalFactor, [
    () => workupData.tubalFactor.leftTube === 'Blocked' || workupData.tubalFactor.rightTube === 'Blocked',
    () => workupData.tubalFactor.leftTube === 'Hydrosalpinx' || workupData.tubalFactor.rightTube === 'Hydrosalpinx',
  ]);

  const uterineStatus = getCardStatus(workupData.uterineFactor, [
    () => workupData.uterineFactor.cavityStatus && workupData.uterineFactor.cavityStatus !== 'Normal',
  ]);

  // Handle save
  const handleSave = async () => {
    setSaving(true);
    try {
      await saveWorkup(workupData);
      toast.success('Infertility workup saved successfully!');
    } catch (error) {
      toast.error('Failed to save infertility workup');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto space-y-6" style={{ fontFamily: 'Tajawal, sans-serif' }}>
      {/* Header */}
      <div className="bg-gradient-to-r from-teal-600 to-indigo-600 text-white p-6 rounded-2xl shadow-lg">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold mb-2">üî¨ ŸÖÿπÿßŸÑÿ¨ ÿßŸÑÿπŸÇŸÖ ÿßŸÑÿ¢ŸÑŸä - Infertility Workup Wizard</h1>
            <p className="text-teal-100">
              Patient: <span className="font-semibold">{patientName || 'Unknown'}</span>
            </p>
          </div>
          <Microscope className="w-16 h-16 text-teal-200" />
        </div>

        {/* Auto-Diagnosis Preview */}
        <div className="mt-6 bg-white/10 backdrop-blur-sm rounded-lg p-4">
          <h3 className="text-lg font-semibold mb-2 flex items-center gap-2">
            <Activity className="w-5 h-5" />
            ÿ™ÿ¥ÿÆŸäÿµ ÿ™ŸÑŸÇÿßÿ¶Ÿä - Auto-Diagnosis
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span className="text-sm text-teal-200">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ:</span>
              <p className="font-semibold text-white mt-1">
                {workupData.diagnosis || 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - Please enter data'}
              </p>
            </div>
            <div>
              <span className="text-sm text-teal-200">ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑÿπŸÑÿßÿ¨Ÿäÿ©:</span>
              <p className="font-semibold text-white mt-1">
                {workupData.plan || 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - Please enter data'}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {/* Ovarian Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${ovarianStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Baby className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑŸÖÿ®Ÿäÿ∂Ÿä</h3>
            </div>
            <ovarianStatus.icon className={`w-6 h-6 ${
              ovarianStatus.status === 'normal' ? 'text-green-600' :
              ovarianStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">AMH (ng/mL)</label>
              <input
                type="number"
                step="0.1"
                value={workupData.ovarianFactor.amh || ''}
                onChange={(e) => updateOvarianFactor('amh', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 2.5"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÜÿ™ÿ∏ÿßŸÖ ÿßŸÑÿØŸàÿ±ÿ©</label>
              <select
                value={workupData.ovarianFactor.cycleRegularity || ''}
                onChange={(e) => updateOvarianFactor('cycleRegularity', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Regular">ŸÖŸÜÿ™ÿ∏ŸÖ - Regular</option>
                <option value="Irregular">ÿ∫Ÿäÿ± ŸÖŸÜÿ™ÿ∏ŸÖ - Irregular</option>
              </select>
            </div>
          </div>
        </div>

        {/* Male Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${maleStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Heart className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ∞ŸÉÿ±Ÿä</h3>
            </div>
            <maleStatus.icon className={`w-6 h-6 ${
              maleStatus.status === 'normal' ? 'text-green-600' :
              maleStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿπÿØÿØ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜŸàŸäÿ© (M/mL)</label>
              <input
                type="number"
                value={workupData.maleFactor.spermCount || ''}
                onChange={(e) => updateMaleFactor('spermCount', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 25"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ≠ÿ±ŸÉÿ© (%)</label>
              <input
                type="number"
                min="0"
                max="100"
                value={workupData.maleFactor.motility || ''}
                onChange={(e) => updateMaleFactor('motility', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 45"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ¥ŸÉŸÑ (%)</label>
              <input
                type="number"
                min="0"
                max="100"
                value={workupData.maleFactor.morphology || ''}
                onChange={(e) => updateMaleFactor('morphology', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 6"
              />
            </div>
          </div>
        </div>

        {/* Tubal Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${tubalStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Activity className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ£ŸÜÿ®Ÿàÿ®Ÿä</h3>
            </div>
            <tubalStatus.icon className={`w-6 h-6 ${
              tubalStatus.status === 'normal' ? 'text-green-600' :
              tubalStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ£ŸÜÿ®Ÿàÿ® ÿßŸÑÿ£Ÿäÿ≥ÿ±</label>
              <select
                value={workupData.tubalFactor.leftTube || ''}
                onChange={(e) => updateTubalFactor('leftTube', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Patent">ŸÖŸÅÿ™Ÿàÿ≠ - Patent</option>
                <option value="Blocked">ŸÖÿ≥ÿØŸàÿØ - Blocked</option>
                <option value="Hydrosalpinx">ŸáŸäÿØÿ± ÿ≥ÿßŸÑÿ®ŸäŸÜŸÉÿ≥ - Hydrosalpinx</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ£ŸÜÿ®Ÿàÿ® ÿßŸÑÿ£ŸäŸÖŸÜ</label>
              <select
                value={workupData.tubalFactor.rightTube || ''}
                onChange={(e) => updateTubalFactor('rightTube', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Patent">ŸÖŸÅÿ™Ÿàÿ≠ - Patent</option>
                <option value="Blocked">ŸÖÿ≥ÿØŸàÿØ - Blocked</option>
                <option value="Hydrosalpinx">ŸáŸäÿØÿ± ÿ≥ÿßŸÑÿ®ŸäŸÜŸÉÿ≥ - Hydrosalpinx</option>
              </select>
            </div>
          </div>
        </div>

        {/* Uterine Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${uterineStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Microscope className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ±ÿ≠ŸÖŸä</h3>
            </div>
            <uterineStatus.icon className={`w-6 h-6 ${
              uterineStatus.status === 'normal' ? 'text-green-600' :
              uterineStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ¨ŸàŸäŸÅ</label>
              <select
                value={workupData.uterineFactor.cavityStatus || ''}
                onChange={(e) => updateUterineFactor('cavityStatus', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Normal">ÿ∑ÿ®ŸäÿπŸä - Normal</option>
                <option value="Septum">ÿ≠ÿßÿ¨ÿ≤ - Septum</option>
                <option value="Polyp">ÿ≥ŸÑŸäŸÑÿ© - Polyp</option>
                <option value="Adhesions">ÿßŸÑÿ™ÿµÿßŸÇÿßÿ™ - Adhesions</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {/* Save Button */}
      <div className="flex justify-center">
        <button
          onClick={handleSave}
          disabled={saving}
          className="bg-teal-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          <Save className="w-5 h-5" />
          {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇŸäŸäŸÖ - Save Workup'}
        </button>
      </div>
    </div>
  );
};

export default InfertilityWizard;
</file>

<file path="public/manifest.json">
{
  "name": "Nile IVF Center",
  "short_name": "Nile IVF",
  "description": "Comprehensive IVF and Obstetrics Management System",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#00838f",
  "orientation": "portrait",
  "scope": "/",
  "icons": [
    {
      "src": "/pwa-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/pwa-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["medical", "health", "productivity"],
  "lang": "ar-EG",
  "dir": "ltr"
}
</file>

<file path="public/sw.js">
// Service Worker for Nile IVF PWA
const CACHE_NAME = 'nile-ivf-v1';
const STATIC_CACHE = 'nile-ivf-static-v1';
const DYNAMIC_CACHE = 'nile-ivf-dynamic-v1';

// Assets to cache immediately
const STATIC_ASSETS = [
  '/',
  '/index.html',
  '/manifest.json',
  '/styles.css',
  // Add other static assets as needed
];

// Install event - cache static assets
self.addEventListener('install', (event) => {
  console.log('Service Worker: Installing...');
  event.waitUntil(
    caches.open(STATIC_CACHE)
      .then((cache) => {
        console.log('Service Worker: Caching static assets');
        return cache.addAll(STATIC_ASSETS);
      })
      .catch((error) => {
        console.error('Service Worker: Failed to cache static assets:', error);
      })
  );
  self.skipWaiting();
});

// Activate event - clean up old caches
self.addEventListener('activate', (event) => {
  console.log('Service Worker: Activating...');
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheName !== STATIC_CACHE && cacheName !== DYNAMIC_CACHE) {
            console.log('Service Worker: Deleting old cache:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  self.clients.claim();
});

// Fetch event - serve from cache or network
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // Skip non-GET requests
  if (request.method !== 'GET') return;

  // Handle Supabase API requests with network-first strategy
  if (url.hostname.includes('supabase.co')) {
    event.respondWith(
      fetch(request)
        .then((response) => {
          // Cache successful responses
          if (response.ok) {
            const responseClone = response.clone();
            caches.open(DYNAMIC_CACHE).then((cache) => {
              cache.put(request, responseClone);
            });
          }
          return response;
        })
        .catch(() => {
          // Fallback to cache if network fails
          return caches.match(request);
        })
    );
    return;
  }

  // Handle static assets with cache-first strategy
  event.respondWith(
    caches.match(request)
      .then((cachedResponse) => {
        if (cachedResponse) {
          return cachedResponse;
        }

        return fetch(request)
          .then((response) => {
            // Cache successful responses
            if (response.ok && response.type === 'basic') {
              const responseClone = response.clone();
              caches.open(DYNAMIC_CACHE).then((cache) => {
                cache.put(request, responseClone);
              });
            }
            return response;
          })
          .catch((error) => {
            console.error('Service Worker: Fetch failed:', error);
            // Return offline fallback for navigation requests
            if (request.mode === 'navigate') {
              return caches.match('/index.html');
            }
          });
      })
  );
});

// Background sync for offline actions
self.addEventListener('sync', (event) => {
  console.log('Service Worker: Background sync triggered:', event.tag);

  if (event.tag === 'sync-pending-data') {
    event.waitUntil(syncPendingData());
  }
});

// Function to sync pending data when back online
async function syncPendingData() {
  try {
    // This would integrate with the sync manager
    console.log('Service Worker: Syncing pending data...');
    // Implementation would go here
  } catch (error) {
    console.error('Service Worker: Failed to sync pending data:', error);
  }
}

// Push notifications (for future use)
self.addEventListener('push', (event) => {
  if (event.data) {
    const data = event.data.json();
    const options = {
      body: data.body,
      icon: '/pwa-192x192.png',
      badge: '/pwa-192x192.png',
      vibrate: [100, 50, 100],
      data: data.data
    };

    event.waitUntil(
      self.registration.showNotification(data.title, options)
    );
  }
});

// Notification click handler
self.addEventListener('notificationclick', (event) => {
  event.notification.close();

  event.waitUntil(
    clients.openWindow(event.notification.data?.url || '/')
  );
});
</file>

<file path="PWA_SETUP.md">
# Nile IVF Center - Offline-First PWA Setup

## Overview
The Nile IVF Center app has been upgraded to a fully functional **Offline-First Progressive Web App (PWA)** that works seamlessly without internet connectivity and automatically syncs data when online.

## üöÄ Features Implemented

### 1. **PWA Configuration**
- **Service Worker**: Caches all static assets and implements network-first strategy for API calls
- **Web App Manifest**: Defines app metadata, icons, and installation behavior
- **Offline Support**: App loads and functions completely offline
- **Auto-Updates**: Automatically updates when new versions are available

### 2. **Local Database (Dexie)**
- **IndexedDB Wrapper**: Fast, reliable local storage using Dexie
- **Schema Mirroring**: Local database structure matches Supabase tables
- **Sync Status Tracking**: Each record tracks sync status (pending/synced/error)

### 3. **Sync Engine**
- **Offline-First**: Data saved locally first, then synced to server
- **Background Sync**: Automatically syncs pending data when back online
- **Conflict Resolution**: Handles data conflicts gracefully
- **Retry Logic**: Failed syncs are retried with exponential backoff

### 4. **User Experience**
- **Instant Loading**: Data loads instantly from local cache
- **Offline Indicator**: Visual indicators for online/offline status
- **Sync Status**: Shows pending syncs and sync progress
- **Error Handling**: Graceful fallbacks when sync fails

## üìÅ File Structure

```
src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ localDb.ts          # Dexie database configuration
‚îÇ   ‚îú‚îÄ‚îÄ pwa.ts             # PWA registration and utilities
‚îÇ   ‚îî‚îÄ‚îÄ syncService.ts     # Sync manager implementation
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ syncService.ts     # Sync manager singleton
‚îÇ   ‚îî‚îÄ‚îÄ [existing services] # Modified to use sync manager
public/
‚îú‚îÄ‚îÄ manifest.json          # PWA manifest
‚îú‚îÄ‚îÄ sw.js                 # Service worker
‚îî‚îÄ‚îÄ pwa-*.png            # App icons (see below)
```

## üñºÔ∏è Required App Icons

Place these icon files in the `public/` directory:

- `pwa-192x192.png` - 192x192px (required)
- `pwa-512x512.png` - 512x512px (required)
- `apple-touch-icon.png` - 180x180px (optional, for iOS)

**Icon Generation**: Use a tool like [PWA Asset Generator](https://github.com/elegantapp/pwa-asset-generator) or [RealFaviconGenerator](https://realfavicongenerator.net/) to generate these from your app logo.

## üîß Installation & Setup

### 1. Install Dependencies
```bash
npm install dexie vite-plugin-pwa
```

### 2. Build for Production
```bash
npm run build
```

### 3. Deploy
The PWA will be automatically configured during the build process.

## üì± Installation Instructions

### For Users:
1. **Chrome/Edge**: Click the install icon in the address bar or use the "Install" menu
2. **Firefox**: Use the "Install This Site as an App" option in the page menu
3. **Safari (iOS)**: Use "Add to Home Screen" from the share menu
4. **Android**: Use "Add to Home Screen" from the browser menu

## üîÑ How Offline Sync Works

### Data Flow:
1. **User Action**: User enters data (e.g., saves a patient)
2. **Local Save**: Data saved to IndexedDB immediately
3. **UI Update**: App shows data instantly (no loading)
4. **Background Sync**: When online, data synced to Supabase
5. **Status Update**: Local record marked as "synced"

### Conflict Resolution:
- **Server Wins**: If server data is newer, it overwrites local
- **Manual Merge**: Conflicts shown to user for resolution
- **Retry Failed**: Failed syncs automatically retried

## üõ†Ô∏è Development Notes

### Testing Offline Mode:
1. Open DevTools ‚Üí Network tab
2. Check "Offline" to simulate no internet
3. Test all app functionality
4. Uncheck "Offline" to test sync

### Database Inspection:
- Chrome DevTools ‚Üí Application ‚Üí IndexedDB ‚Üí ClinicDB
- View local data and sync status

### Service Worker Debugging:
- Chrome DevTools ‚Üí Application ‚Üí Service Workers
- Check registration, updates, and cache status

## üö® Important Considerations

### Data Security:
- **Local Encryption**: Sensitive data should be encrypted locally
- **Sync Security**: Ensure sync happens over HTTPS only
- **Auth Tokens**: Handle authentication token refresh offline

### Performance:
- **Database Size**: Monitor IndexedDB size limits (~50MB-1GB)
- **Sync Frequency**: Balance between real-time and battery usage
- **Cleanup**: Implement data cleanup for old records

### Error Handling:
- **Network Errors**: Graceful degradation when offline
- **Sync Failures**: Clear user communication about sync status
- **Data Loss**: Backup strategies for critical data

## üîÆ Future Enhancements

- **Push Notifications**: Real-time alerts for critical updates
- **Background Sync**: Periodic data synchronization
- **Conflict UI**: Visual conflict resolution interface
- **Data Export**: Offline data export capabilities
- **Multi-device Sync**: Sync across multiple devices

## üêõ Troubleshooting

### Common Issues:
1. **Service Worker Not Registering**: Check browser support and HTTPS
2. **Sync Not Working**: Verify network permissions and API endpoints
3. **Database Errors**: Clear IndexedDB and reinstall app
4. **Icons Not Showing**: Ensure correct file paths and formats

### Debug Commands:
```javascript
// Check PWA status
console.log('PWA Installed:', window.matchMedia('(display-mode: standalone)').matches);

// Check online status
console.log('Online:', navigator.onLine);

// Force sync
// syncManager.forceSync(); // When implemented
```

---

## üìû Support

For technical support or questions about the PWA implementation, contact the development team.

**Last Updated**: December 2025
**Version**: 1.0.0
</file>

<file path="services/supabaseClient.ts">
import { createClient } from '@supabase/supabase-js';

// Helper to safely access environment variables
// This prevents the "Cannot read properties of undefined" error when running in environments
// where import.meta.env is not fully defined.
const getEnv = (key: string) => {
  try {
    // @ts-ignore
    return import.meta.env?.[key];
  } catch (e) {
    return undefined;
  }
};

// ----------------------------------------------------------------------------------
// üõë ACTION REQUIRED: PASTE YOUR SUPABASE KEYS HERE
// ----------------------------------------------------------------------------------
// 1. Go to https://supabase.com/dashboard
// 2. Select your project -> Project Settings -> API
// 3. Copy the 'Project URL' and 'anon public' Key
const SUPABASE_URL = getEnv('VITE_SUPABASE_URL') || 'https://ladqitwqkkfiijregqlu.supabase.co';
const SUPABASE_ANON_KEY = getEnv('VITE_SUPABASE_ANON_KEY') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhZHFpdHdxa2tmaWlqcmVncWx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4Njk0MDgsImV4cCI6MjA4MDQ0NTQwOH0.qSAjg1kIcAO5DFnz5InlW4u3pxzeDTIbLdB6uN_CEUc';

// Validation to warn developer if keys are missing
if (SUPABASE_URL.includes('INSERT') || SUPABASE_ANON_KEY.includes('INSERT')) {
  console.warn('‚ö†Ô∏è Supabase credentials are missing or invalid! Please update services/supabaseClient.ts');
}

export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</file>

<file path="services/workupService.ts">
import { supabase } from './supabaseClient';

// Database schema interface (snake_case for Supabase)
export interface WorkupData {
  id?: string;
  patient_id: string;
  // Ovarian Factor
  amh?: number;
  cycle_regularity?: 'Regular' | 'Irregular';
  // Male Factor
  sperm_count?: number;
  motility?: number;
  morphology?: number;
  // Tubal Factor
  left_tube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
  right_tube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
  // Uterine Factor
  cavity_status?: 'Normal' | 'Septum' | 'Polyp' | 'Adhesions';
  // Auto-generated
  diagnosis?: string;
  plan?: string;
  created_at?: string;
  updated_at?: string;
}

// TypeScript interface for component state (camelCase)
export interface WorkupState {
  patientId: string;
  ovarianFactor: {
    amh?: number;
    cycleRegularity?: 'Regular' | 'Irregular';
  };
  maleFactor: {
    spermCount?: number;
    motility?: number;
    morphology?: number;
  };
  tubalFactor: {
    leftTube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
    rightTube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
  };
  uterineFactor: {
    cavityStatus?: 'Normal' | 'Septum' | 'Polyp' | 'Adhesions';
  };
  diagnosis?: string;
  plan?: string;
}

// Convert database format to component state
const dbToState = (dbData: WorkupData): WorkupState => ({
  patientId: dbData.patient_id,
  ovarianFactor: {
    amh: dbData.amh,
    cycleRegularity: dbData.cycle_regularity,
  },
  maleFactor: {
    spermCount: dbData.sperm_count,
    motility: dbData.motility,
    morphology: dbData.morphology,
  },
  tubalFactor: {
    leftTube: dbData.left_tube,
    rightTube: dbData.right_tube,
  },
  uterineFactor: {
    cavityStatus: dbData.cavity_status,
  },
  diagnosis: dbData.diagnosis,
  plan: dbData.plan,
});

// Convert component state to database format
const stateToDb = (state: WorkupState): Omit<WorkupData, 'id' | 'created_at' | 'updated_at'> => ({
  patient_id: state.patientId,
  amh: state.ovarianFactor.amh,
  cycle_regularity: state.ovarianFactor.cycleRegularity,
  sperm_count: state.maleFactor.spermCount,
  motility: state.maleFactor.motility,
  morphology: state.maleFactor.morphology,
  left_tube: state.tubalFactor.leftTube,
  right_tube: state.tubalFactor.rightTube,
  cavity_status: state.uterineFactor.cavityStatus,
});

// Get workup data for a patient
export const getWorkup = async (patientId: string): Promise<WorkupState> => {
  try {
    const { data, error } = await supabase
      .from('infertility_workups')
      .select('*')
      .eq('patient_id', patientId)
      .single();

    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
      throw error;
    }

    if (data) {
      return dbToState(data);
    }

    // Return default empty object if no data exists
    return {
      patientId,
      ovarianFactor: {},
      maleFactor: {},
      tubalFactor: {},
      uterineFactor: {},
    };
  } catch (error) {
    console.error('Error fetching workup data:', error);
    throw new Error('Failed to fetch infertility workup data');
  }
};

// Save workup data (upsert)
export const saveWorkup = async (data: WorkupState): Promise<void> => {
  try {
    const dbData = stateToDb(data);
    const diagnosis = generateDiagnosis(data);

    const workupData: WorkupData = {
      ...dbData,
      diagnosis: diagnosis.diagnosis,
      plan: diagnosis.plan,
      updated_at: new Date().toISOString(),
    };

    const { error } = await supabase
      .from('infertility_workups')
      .upsert(workupData, {
        onConflict: 'patient_id',
        ignoreDuplicates: false
      });

    if (error) {
      throw error;
    }
  } catch (error) {
    console.error('Error saving workup data:', error);
    throw new Error('Failed to save infertility workup data');
  }
};

// Generate diagnosis and plan based on medical logic
export const generateDiagnosis = (data: WorkupState): { diagnosis: string; plan: string } => {
  const factors: string[] = [];
  const plans: string[] = [];

  // Male Factor Assessment
  const hasMaleFactor =
    (data.maleFactor.spermCount !== undefined && data.maleFactor.spermCount < 15) ||
    (data.maleFactor.motility !== undefined && data.maleFactor.motility < 40) ||
    (data.maleFactor.morphology !== undefined && data.maleFactor.morphology < 4);

  if (hasMaleFactor) {
    factors.push('Male Factor Infertility');
    plans.push('IVF/ICSI Recommended');
  }

  // Tubal Factor Assessment
  const hasTubalFactor =
    data.tubalFactor.leftTube === 'Blocked' ||
    data.tubalFactor.rightTube === 'Blocked' ||
    data.tubalFactor.leftTube === 'Hydrosalpinx' ||
    data.tubalFactor.rightTube === 'Hydrosalpinx';

  if (hasTubalFactor) {
    factors.push('Tubal Factor Infertility');
    plans.push('IVF/ICSI Recommended');
  }

  // Ovarian Factor Assessment
  const hasOvarianFactor =
    (data.ovarianFactor.amh !== undefined && (data.ovarianFactor.amh < 1.1 || data.ovarianFactor.amh > 3.5)) ||
    data.ovarianFactor.cycleRegularity === 'Irregular';

  if (hasOvarianFactor) {
    if (data.ovarianFactor.amh !== undefined && data.ovarianFactor.amh < 1.1) {
      factors.push('Diminished Ovarian Reserve (DOR)');
    } else if (data.ovarianFactor.amh !== undefined && data.ovarianFactor.amh > 3.5) {
      factors.push('Polycystic Ovary Syndrome (PCOS)');
    }
    if (data.ovarianFactor.cycleRegularity === 'Irregular') {
      factors.push('Ovulatory Dysfunction');
    }
  }

  // Uterine Factor Assessment
  const hasUterineFactor = data.uterineFactor.cavityStatus && data.uterineFactor.cavityStatus !== 'Normal';

  if (hasUterineFactor) {
    factors.push('Uterine Factor Infertility');
    plans.push('Hysteroscopic Correction Required');
  }

  // Hydrosalpinx specific note
  const hasHydrosalpinx =
    data.tubalFactor.leftTube === 'Hydrosalpinx' ||
    data.tubalFactor.rightTube === 'Hydrosalpinx';

  if (hasHydrosalpinx) {
    plans.push('Salpingectomy Required Before ET');
  }

  // Generate diagnosis string
  let diagnosis = 'Unexplained Infertility';
  if (factors.length > 0) {
    diagnosis = factors.join(' + ');
  }

  // Generate plan string
  let plan = 'Further Investigation Required';
  if (plans.length > 0) {
    plan = plans.join(' + ');
  } else if (hasOvarianFactor && !hasMaleFactor && !hasTubalFactor && !hasUterineFactor) {
    plan = 'Induction + Timed Intercourse';
  }

  return { diagnosis, plan };
};
</file>

<file path="src/components/SyncStatus.tsx">
import React from 'react';
import { Cloud, CloudOff, RefreshCw, AlertTriangle } from 'lucide-react';
import { useLiveQuery } from 'dexie-react-hooks';
import { db, getSyncStats } from '../db/localDB';

interface SyncStatusProps {
  className?: string;
}

const SyncStatus: React.FC<SyncStatusProps> = ({ className = '' }) => {
  // Get sync statistics from local database
  const syncStats = useLiveQuery(async () => {
    return await getSyncStats();
  }, []);

  // Check online status
  const [isOnline, setIsOnline] = React.useState(navigator.onLine);

  React.useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  if (!syncStats) {
    return (
      <div className={`flex items-center gap-2 text-gray-500 ${className}`}>
        <RefreshCw className="w-4 h-4 animate-spin" />
        <span className="text-sm">Loading...</span>
      </div>
    );
  }

  const { synced, pending, errors } = syncStats;
  const hasPendingItems = pending > 0;
  const hasErrors = errors > 0;

  // Determine status and styling
  const getStatusInfo = () => {
    if (!isOnline) {
      return {
        icon: CloudOff,
        color: 'text-gray-500',
        bgColor: 'bg-gray-100',
        text: 'Offline Mode',
        description: hasPendingItems ? `${pending} items pending` : 'All data saved locally'
      };
    }

    if (hasErrors) {
      return {
        icon: AlertTriangle,
        color: 'text-red-600',
        bgColor: 'bg-red-100',
        text: 'Sync Issues',
        description: `${errors} items failed to sync`
      };
    }

    if (hasPendingItems) {
      return {
        icon: RefreshCw,
        color: 'text-yellow-600',
        bgColor: 'bg-yellow-100',
        text: 'Syncing...',
        description: `${pending} items pending`
      };
    }

    return {
      icon: Cloud,
      color: 'text-green-600',
      bgColor: 'bg-green-100',
      text: 'All Synced',
      description: `${synced} items synced`
    };
  };

  const statusInfo = getStatusInfo();
  const Icon = statusInfo.icon;

  return (
    <div className={`flex items-center gap-2 ${className}`}>
      <div className={`flex items-center gap-2 px-3 py-1 rounded-full ${statusInfo.bgColor}`}>
        <Icon
          className={`w-4 h-4 ${statusInfo.color} ${hasPendingItems && isOnline ? 'animate-spin' : ''}`}
        />
        <div className="flex flex-col">
          <span className={`text-sm font-medium ${statusInfo.color}`}>
            {statusInfo.text}
          </span>
          <span className="text-xs text-gray-600">
            {statusInfo.description}
          </span>
        </div>
      </div>

      {/* Additional info for pending items */}
      {hasPendingItems && isOnline && (
        <div className="text-xs text-yellow-600">
          Auto-sync in progress...
        </div>
      )}

      {/* Error indicator */}
      {hasErrors && (
        <div className="text-xs text-red-600">
          Check connection
        </div>
      )}
    </div>
  );
};

export default SyncStatus;
</file>

<file path="src/hooks/useSyncStatus.ts">
import { useEffect, useState } from 'react';
import { db } from '../lib/localDb';

export interface SyncStatus {
  isOnline: boolean;
  syncInProgress: boolean;
  pendingItemsCount: number;
  lastSyncTime?: Date;
}

export const useSyncStatus = () => {
  const [syncStatus, setSyncStatus] = useState<SyncStatus>({
    isOnline: navigator.onLine,
    syncInProgress: false,
    pendingItemsCount: 0,
  });

  useEffect(() => {
    const handleOnline = () => {
      setSyncStatus(prev => ({ ...prev, isOnline: true }));
    };

    const handleOffline = () => {
      setSyncStatus(prev => ({ ...prev, isOnline: false }));
    };

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    const updatePendingCount = async () => {
      const pendingItems = await db.syncQueue.where('retryCount').below(3).toArray();
      setSyncStatus(prev => ({
        ...prev,
        pendingItemsCount: pendingItems.length
      }));
    };

    const interval = setInterval(updatePendingCount, 5000);
    updatePendingCount();

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
      clearInterval(interval);
    };
  }, []);

  return syncStatus;
};

export const useNetworkStatus = () => {
  const [isOnline, setIsOnline] = useState<boolean>(navigator.onLine);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
};
</file>

<file path="src/lib/localDb.ts">
import Dexie, { Table } from 'dexie';

// Types for local database
export interface LocalPatient {
  id?: number; // Auto-incremented local ID
  remoteId: string; // Supabase ID
  name: string;
  phone: string;
  email?: string;
  dateOfBirth?: string;
  address?: string;
  syncStatus: 'pending' | 'synced' | 'error';
  lastModified: Date;
  createdAt: Date;
}

export interface LocalVisit {
  id?: number;
  remoteId: string;
  patientId: string;
  department: string;
  visitDate: string;
  clinicalData: any;
  diagnosis?: string;
  prescription?: any[];
  notes?: string;
  syncStatus: 'pending' | 'synced' | 'error';
  lastModified: Date;
  createdAt: Date;
}

export interface LocalPregnancy {
  id?: number;
  remoteId: string;
  patientId: string;
  lmpDate?: string;
  eddDate?: string;
  riskLevel?: string;
  aspirinPrescribed?: boolean;
  currentStatus?: string;
  syncStatus: 'pending' | 'synced' | 'error';
  lastModified: Date;
  createdAt: Date;
}

export interface LocalCycle {
  id?: number;
  remoteId: string;
  patientId: string;
  protocol: string;
  startDate: string;
  status: string;
  assessment?: any;
  logs?: any[];
  lab?: any;
  transfer?: any;
  outcome?: any;
  syncStatus: 'pending' | 'synced' | 'error';
  lastModified: Date;
  createdAt: Date;
}

export interface SyncQueueItem {
  id?: number;
  table: string;
  action: 'insert' | 'update' | 'delete';
  payload: any;
  remoteId?: string;
  retryCount: number;
  lastAttempt?: Date;
  createdAt: Date;
}

export class ClinicDatabase extends Dexie {
  patients!: Table<LocalPatient>;
  visits!: Table<LocalVisit>;
  pregnancies!: Table<LocalPregnancy>;
  cycles!: Table<LocalCycle>;
  syncQueue!: Table<SyncQueueItem>;

  constructor() {
    super('ClinicDB');

    this.version(1).stores({
      patients: '++id, remoteId, name, phone, syncStatus, lastModified',
      visits: '++id, remoteId, patientId, visitDate, syncStatus, lastModified',
      pregnancies: '++id, remoteId, patientId, syncStatus, lastModified',
      cycles: '++id, remoteId, patientId, syncStatus, lastModified',
      syncQueue: '++id, table, action, retryCount, createdAt'
    });
  }
}

// Create and export database instance
export const db = new ClinicDatabase();

// Initialize database
export const initDatabase = async (): Promise<void> => {
  try {
    await db.open();
    console.log('Local database initialized successfully');
  } catch (error) {
    console.error('Failed to initialize local database:', error);
    throw error;
  }
};

// Helper functions for database operations
export const getPendingSyncItems = async (): Promise<SyncQueueItem[]> => {
  return await db.syncQueue.where('retryCount').below(3).toArray();
};

export const addToSyncQueue = async (item: Omit<SyncQueueItem, 'id' | 'createdAt'>): Promise<void> => {
  await db.syncQueue.add({
    ...item,
    createdAt: new Date()
  });
};

export const removeFromSyncQueue = async (id: number): Promise<void> => {
  await db.syncQueue.delete(id);
};

export const updateSyncQueueRetry = async (id: number): Promise<void> => {
  await db.syncQueue.update(id, {
    retryCount: await db.syncQueue.get(id).then(item => (item?.retryCount || 0) + 1),
    lastAttempt: new Date()
  });
};

export const markAsSynced = async (table: string, localId: number): Promise<void> => {
  const tableMap: { [key: string]: Table } = {
    patients: db.patients,
    visits: db.visits,
    pregnancies: db.pregnancies,
    cycles: db.cycles
  };

  const targetTable = tableMap[table];
  if (targetTable) {
    await targetTable.update(localId, { syncStatus: 'synced' });
  }
};

export const getUnsyncedRecords = async (table: string): Promise<any[]> => {
  const tableMap: { [key: string]: Table } = {
    patients: db.patients,
    visits: db.visits,
    pregnancies: db.pregnancies,
    cycles: db.cycles
  };

  const targetTable = tableMap[table];
  if (targetTable) {
    return await targetTable.where('syncStatus').equals('pending').toArray();
  }
  return [];
};
</file>

<file path="src/lib/networkStatus.ts">
export class NetworkStatus {
  private static instance: NetworkStatus;
  private isOnline: boolean = navigator.onLine;
  private listeners: Set<(isOnline: boolean) => void> = new Set();

  private constructor() {
    this.setupListeners();
  }

  static getInstance(): NetworkStatus {
    if (!NetworkStatus.instance) {
      NetworkStatus.instance = new NetworkStatus();
    }
    return NetworkStatus.instance;
  }

  private setupListeners(): void {
    window.addEventListener('online', () => {
      this.isOnline = true;
      this.notifyListeners();
    });

    window.addEventListener('offline', () => {
      this.isOnline = false;
      this.notifyListeners();
    });
  }

  getStatus(): boolean {
    return this.isOnline;
  }

  subscribe(callback: (isOnline: boolean) => void): () => void {
    this.listeners.add(callback);
    return () => {
      this.listeners.delete(callback);
    };
  }

  private notifyListeners(): void {
    this.listeners.forEach(listener => listener(this.isOnline));
  }
}

export const networkStatus = NetworkStatus.getInstance();
</file>

<file path="src/lib/pwa.ts">
// PWA Registration and Management
export const registerServiceWorker = async (): Promise<void> => {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js', {
        scope: '/'
      });

      console.log('Service Worker registered successfully:', registration.scope);

      // Handle updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version available
              showUpdateNotification();
            }
          });
        }
      });

      // Handle controller change (new SW activated)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });

    } catch (error) {
      console.error('Service Worker registration failed:', error);
    }
  }
};

const showUpdateNotification = (): void => {
  // Create a toast or notification for app update
  const updateToast = document.createElement('div');
  updateToast.className = 'fixed top-4 left-4 right-4 z-50 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg';
  updateToast.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <p class="font-semibold">ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ™ÿßÿ≠</p>
        <p class="text-sm">ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ. ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´</p>
      </div>
      <button id="update-btn" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-semibold hover:bg-gray-100">
        ÿ™ÿ≠ÿØŸäÿ´
      </button>
    </div>
  `;

  document.body.appendChild(updateToast);

  document.getElementById('update-btn')?.addEventListener('click', () => {
    window.location.reload();
  });

  // Auto-hide after 10 seconds
  setTimeout(() => {
    updateToast.remove();
  }, 10000);
};

// Check if app is installed
export const isPWAInstalled = (): boolean => {
  return window.matchMedia('(display-mode: standalone)').matches ||
         (window.navigator as any).standalone === true;
};

// Request notification permission
export const requestNotificationPermission = async (): Promise<NotificationPermission> => {
  if ('Notification' in window) {
    return await Notification.requestPermission();
  }
  return 'denied';
};

// Check online status
export const isOnline = (): boolean => {
  return navigator.onLine;
};

// Listen for online/offline events
export const setupNetworkListeners = (
  onOnline: () => void,
  onOffline: () => void
): void => {
  window.addEventListener('online', onOnline);
  window.addEventListener('offline', onOffline);
};

// Initialize PWA features
export const initPWA = async (): Promise<void> => {
  // Register service worker
  await registerServiceWorker();

  // Request notification permission
  const permission = await requestNotificationPermission();
  if (permission === 'granted') {
    console.log('Notification permission granted');
  }

  // Log PWA status
  console.log('PWA Status:', {
    installed: isPWAInstalled(),
    online: isOnline(),
    notifications: permission
  });
};
</file>

<file path="SUPABASE_SETUP.sql">
-- ============================================================================
-- SUPABASE SETUP FOR NILE IVF EMR - Doctor Settings
-- ============================================================================
-- Run this SQL script in Supabase SQL Editor
-- ============================================================================

-- ============================================================================
-- 1. ALTER DOCTORS TABLE - Add new columns for doctor and clinic info
-- ============================================================================

ALTER TABLE IF EXISTS doctors 
ADD COLUMN IF NOT EXISTS doctor_image TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_name TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_address TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_phone TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_image TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_latitude TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_longitude TEXT DEFAULT NULL;

-- ============================================================================
-- 2. CREATE INDEX for better query performance
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_doctors_user_id ON doctors(user_id);

-- ============================================================================
-- 3. STORAGE POLICIES - These must be run in SQL Editor or via UI
-- ============================================================================

-- Drop existing policies if they exist
DROP POLICY IF EXISTS "Users can upload files to doctor-files" ON storage.objects;
DROP POLICY IF EXISTS "Anyone can read files from doctor-files" ON storage.objects;
DROP POLICY IF EXISTS "Users can update their own files in doctor-files" ON storage.objects;
DROP POLICY IF EXISTS "Users can delete their own files from doctor-files" ON storage.objects;

-- Policy 1: Allow authenticated users to upload files
CREATE POLICY "Users can upload files to doctor-files"
ON storage.objects
FOR INSERT
WITH CHECK (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
);

-- Policy 2: Allow anyone to read/view files
CREATE POLICY "Anyone can read files from doctor-files"
ON storage.objects
FOR SELECT
USING (bucket_id = 'doctor-files');

-- Policy 3: Allow users to update their own files
CREATE POLICY "Users can update their own files in doctor-files"
ON storage.objects
FOR UPDATE
USING (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
)
WITH CHECK (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
);

-- Policy 4: Allow users to delete their own files
CREATE POLICY "Users can delete their own files from doctor-files"
ON storage.objects
FOR DELETE
USING (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
);

-- ============================================================================
-- DONE! 
-- ============================================================================
-- Next steps:
-- 1. Make sure the 'doctor-files' bucket exists in Storage
-- 2. If it doesn't exist, create it manually in the Supabase UI:
--    - Go to Storage ‚Üí New bucket
--    - Name: doctor-files
--    - Access: Public (so images can be viewed by anyone)
-- ============================================================================
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
</file>

<file path="vercel.json">
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": { "distDir": "dist" }
    }
  ]
}
</file>

<file path="write_file.py">
import os  
print(os.getcwd())
</file>

<file path="BRANDING_SETUP.sql">
-- ============================================================================
-- Nile IVF Center - Dynamic Branding Setup
-- ============================================================================
-- This script creates the app_settings table and enables dynamic branding
-- for clinic name, logo, and color customization.
-- ============================================================================

-- 1. Create app_settings table for dynamic branding
CREATE TABLE IF NOT EXISTS app_settings (
  id INTEGER PRIMARY KEY DEFAULT 1,
  clinic_name TEXT NOT NULL DEFAULT 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±',
  logo_url TEXT,
  clinic_address TEXT,
  clinic_phone TEXT,
  primary_color TEXT DEFAULT '#2d5a6b',
  secondary_color TEXT DEFAULT '#00838f',
  accent_color TEXT DEFAULT '#00bcd4',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_by UUID,
  CONSTRAINT single_row CHECK (id = 1),
  FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);

-- 2. Enable RLS on app_settings
ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;

-- 3. RLS Policies for app_settings table
-- Policy: Authenticated users can read app_settings
DROP POLICY IF EXISTS "Users can read app_settings" ON app_settings;
CREATE POLICY "Users can read app_settings"
  ON app_settings FOR SELECT
  TO authenticated
  USING (true);

-- Policy: Authenticated users can update app_settings
DROP POLICY IF EXISTS "Authenticated users can update app_settings" ON app_settings;
CREATE POLICY "Authenticated users can update app_settings"
  ON app_settings FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- 4. Insert default settings row
INSERT INTO app_settings (id, clinic_name, logo_url)
VALUES (1, 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±', NULL)
ON CONFLICT (id) DO NOTHING;

-- ============================================================================
-- NOTE: For Storage Bucket Creation, use Supabase Dashboard:
-- ============================================================================
-- 1. Go to Supabase Dashboard ‚Üí Storage
-- 2. Click "Create new bucket"
-- 3. Enter name: "branding"
-- 4. Choose "Public bucket"
-- 5. Click "Create bucket"
-- 
-- Then run the storage policies below in SQL Editor:
-- ============================================================================

-- 5. Storage Policies (Run these AFTER creating "branding" bucket)
DROP POLICY IF EXISTS "Allow authenticated users to upload branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to upload branding"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (bucket_id = 'branding');

DROP POLICY IF EXISTS "Allow authenticated users to delete branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to delete branding"
  ON storage.objects FOR DELETE
  TO authenticated
  USING (bucket_id = 'branding');

DROP POLICY IF EXISTS "Allow public read access to branding" ON storage.objects;
CREATE POLICY "Allow public read access to branding"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id = 'branding');

-- ============================================================================
-- Verification Queries
-- ============================================================================
-- Verify table was created:
-- SELECT * FROM app_settings;
--
-- Verify bucket exists (use Supabase Dashboard Storage tab):
-- Should see "branding" bucket listed
</file>

<file path="constants.ts">
// Egyptian IVF Medications Database
export const EGYPTIAN_DRUGS = {
  "Induction (Stimulation)": {
    "Clomid 50mg": { active: "Clomiphene Citrate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Clostilbegyt 50mg": { active: "Clomiphene Citrate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Technovula 50mg": { active: "Clomiphene Citrate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Femara 2.5mg": { active: "Letrozole", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3 ŸÑŸÄ 7 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Letrozole 2.5mg": { active: "Letrozole", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3 ŸÑŸÄ 7 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Nolvadex 10mg": { active: "Tamoxifen", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Gonal-F 75 IU": { active: "Follitropin Alpha", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ¨ÿØŸàŸÑ" },
    "Gonal-F 300/450/900 Pen": { active: "Follitropin Alpha", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã (ÿ≠ÿØÿØ ÿßŸÑÿ¨ÿ±ÿπÿ©)" },
    "Fostimon 75 IU": { active: "Urofollitropin (FSH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Fostimon 150 IU": { active: "Urofollitropin (FSH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Merional 75 IU": { active: "HMG (FSH+LH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Merional 150 IU": { active: "HMG (FSH+LH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Menogon 75 IU": { active: "HMG", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸäŸàŸÖŸäÿßŸã" },
    "Menopur 75 IU": { active: "HP-HMG", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Pergoveris Pen": { active: "FSH + LH", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Epigonal 75 IU": { active: "HMG", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸäŸàŸÖŸäÿßŸã" }
  },
  "Trigger Shots": {
    "Choriomon 5000 IU": { active: "HCG", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿπÿ∂ŸÑ ŸÅŸä ÿ™ŸàŸÇŸäÿ™ ŸÖÿ≠ÿØÿØ (36 ÿ≥ÿßÿπÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠ÿ®)" },
    "Epifasi 5000 IU": { active: "HCG", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿπÿ∂ŸÑ ŸÅŸä ÿ™ŸàŸÇŸäÿ™ ŸÖÿ≠ÿØÿØ" },
    "Pregnyl 5000 IU": { active: "HCG", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿπÿ∂ŸÑ ŸÅŸä ÿ™ŸàŸÇŸäÿ™ ŸÖÿ≠ÿØÿØ" },
    "Ovitrelle 250mcg": { active: "Choriogonadotropin Alfa", dose: "ÿ≠ŸÇŸÜÿ© ŸÉÿßŸÖŸÑÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸÅŸä ÿßŸÑŸÖŸäÿπÿßÿØ ÿßŸÑŸÖÿ≠ÿØÿØ" },
    "Decapeptyl 0.1mg (Trigger)": { active: "Triptorelin", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ (ŸÑŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ OHSS)" }
  },
  "Down-Regulation (Antagonists/Agonists)": {
    "Cetrotide 0.25mg": { active: "Cetrorelix", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖŸäÿπÿßÿØ" },
    "Orgalutran 0.25mg": { active: "Ganirelix", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖŸäÿπÿßÿØ" },
    "Decapeptyl 0.1mg Daily": { active: "Triptorelin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Decapeptyl 3.75mg Depot": { active: "Triptorelin", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© (ÿ™ÿ≠ÿ∂Ÿäÿ±)" },
    "Zoladex 3.6mg": { active: "Goserelin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸÅŸä ÿ¨ÿØÿßÿ± ÿßŸÑÿ®ÿ∑ŸÜ" },
    "Lupron Depot": { active: "Leuprolide", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©" }
  },
  "Luteal Support (Progesterone)": {
    "Cyclogest 400mg": { active: "Progesterone", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖŸáÿ®ŸÑŸäÿ©/ÿ¥ÿ±ÿ¨Ÿäÿ© ÿµÿ®ÿßÿ≠ÿßŸã ŸàŸÖÿ≥ÿßÿ°Ÿã" },
    "Cyclogest 200mg": { active: "Progesterone", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖŸáÿ®ŸÑŸäÿ© ŸÖÿ≥ÿßÿ°Ÿã" },
    "Prontogest 100mg": { active: "Progesterone", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ÿπŸÖŸäŸÇ ŸäŸàŸÖŸäÿßŸã" },
    "Prontogest 200mg": { active: "Progesterone", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖŸáÿ®ŸÑŸäÿ© ŸÖÿ≥ÿßÿ°Ÿã" },
    "Duphaston 10mg": { active: "Dydrogesterone", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "Utrogestan 200mg": { active: "Micronized Progesterone", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖŸáÿ®ŸÑŸäÿ© ÿµÿ®ÿßÿ≠ÿßŸã ŸàŸÖÿ≥ÿßÿ°Ÿã" },
    "Crinone 8% Gel": { active: "Progesterone Gel", dose: "ÿ£ŸÜÿ®Ÿàÿ®ÿ© ŸÖŸáÿ®ŸÑŸäÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ÿµÿ®ÿßÿ≠ÿßŸã" },
    "Endometrin 100mg": { active: "Progesterone", dose: "ŸÇÿ±ÿµ ŸÖŸáÿ®ŸÑŸä 3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäÿßŸã" },
    "Progynova 2mg": { active: "Estradiol Valerate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã (ŸÑÿØÿπŸÖ ÿßŸÑÿ®ÿ∑ÿßŸÜÿ©)" },
    "Estrimax 2mg": { active: "Estradiol", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" }
  },
  "Vitamins & Supplements": {
    "Folic Acid 5mg": { active: "Folic Acid", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Folicap 0.5mg": { active: "Folic Acid", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã" },
    "Methylfolate 400mcg": { active: "Active Folic Acid", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Ferrotron": { active: "Iron + Multivitamins", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Haemoton": { active: "Iron + Folic", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Feroglobin": { active: "Iron + B12", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Osteocare": { active: "Calcium + Mg + Vit D", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±" },
    "Calcid 500mg": { active: "Calcium Carbonate", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±" },
    "Calcimate": { active: "Calcium", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Omega 3 Plus": { active: "Fish Oil", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã" },
    "Carnivita Forte": { active: "L-Carnitine + Zinc", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "L-Carnitine 350mg": { active: "Levocarnitine", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "DHEA 25mg": { active: "Dehydroepiandrosterone", dose: "ŸÇÿ±ÿµ 3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäÿßŸã (ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ)" },
    "Total Fertility": { active: "Multivitamin", dose: "ŸÉŸäÿ≥ ÿπŸÑŸâ ŸÜÿµŸÅ ŸÉŸàÿ® ŸÖÿßÿ° ŸäŸàŸÖŸäÿßŸã" },
    "Pregnacare": { active: "Multivitamin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" }
  },
  "Anticoagulants (Blood Thinners)": {
    "Clexane 40mg": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Clexane 20mg": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Clexane 60mg": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Enoxa 4000": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Innohep 3500": { active: "Tinzaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Juvespr 81mg": { active: "Aspirin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Aspocid 75mg": { active: "Aspirin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ° (ÿ£ÿ∑ŸÅÿßŸÑ)" },
    "Ezacard 75mg": { active: "Aspirin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" }
  },
  "Antibiotics": {
    "Augmentin 1g": { active: "Amoxicillin/Clav", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© ÿ£ÿ≥ÿ®Ÿàÿπ" },
    "Augmentin 625mg": { active: "Amoxicillin/Clav", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Hibiotic 1g": { active: "Amoxicillin/Clav", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Vibramycin 100mg": { active: "Doxycycline", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ (ŸÑŸÑÿ≤Ÿàÿ¨ ŸàÿßŸÑÿ≤Ÿàÿ¨ÿ©)" },
    "Doxycast 100mg": { active: "Doxycycline", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Zithromax 500mg": { active: "Azithromycin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ" },
    "Dalacin C 300mg": { active: "Clindamycin", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™" },
    "Flagyl 500mg": { active: "Metronidazole", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© 7 ÿ£ŸäÿßŸÖ" },
    "Amrizole 500mg": { active: "Metronidazole", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Diflucan 150mg": { active: "Fluconazole", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© (ŸÑŸÑŸÅÿ∑ÿ±Ÿäÿßÿ™)" },
    "Flucoral 150mg": { active: "Fluconazole", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã" }
  },
  "Misc & Hormonal Adjuncts": {
    "Cidophage 500mg": { active: "Metformin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ" },
    "Cidophage 850mg": { active: "Metformin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ" },
    "Cidophage 1000mg Retard": { active: "Metformin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿπÿ¥ÿßÿ°" },
    "Glucophage XR 1000mg": { active: "Metformin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸÖÿ≥ÿßÿ°Ÿã" },
    "Dostinex 0.5mg": { active: "Cabergoline", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ŸÉŸÑ 3 ÿ£ŸäÿßŸÖ (ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ®ÿ±ŸàŸÑÿßŸÉÿ™ŸäŸÜ/OHSS)" },
    "Caberglob 0.5mg": { active: "Cabergoline", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã" },
    "Eltroxin 50mcg": { active: "Levothyroxine", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ÿπŸÑŸâ ÿßŸÑÿ±ŸäŸÇ" },
    "Euthyrox 50mcg": { active: "Levothyroxine", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ÿπŸÑŸâ ÿßŸÑÿ±ŸäŸÇ" },
    "Kapron 500mg": { active: "Tranexamic Acid", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ (ÿπŸÜÿØ ÿßŸÑŸÜÿ≤ŸäŸÅ)" },
    "Dicynone 500mg": { active: "Etamsylate", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™" },
    "Daflon 500mg": { active: "Diosmin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "Primolut Nor 10mg": { active: "Norethisterone", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã (ŸÑÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑÿØŸàÿ±ÿ©)" },
    "Steronate 5mg": { active: "Norethisterone", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "Cyclo-Progynova": { active: "Estradiol/Norgestrel", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã (ÿßŸÑÿ£ÿ®Ÿäÿ∂ ÿ´ŸÖ ÿßŸÑÿ®ŸÜŸä)" }
  },
  "Pain Killers & Spasmolytics": {
    "Panadol Extra": { active: "Paracetamol", dose: "ŸÇÿ±ÿµŸäŸÜ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ" },
    "Cataflam 50mg": { active: "Diclofenac Potassium", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ" },
    "Ketolac": { active: "Ketorolac", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ (ÿ£ŸÑŸÖ ÿ¥ÿØŸäÿØ)" },
    "Visceralgine": { active: "Tiemonium", dose: "ŸÇÿ±ÿµ 3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäÿßŸã (ŸÑŸÑŸÖÿ∫ÿµ)" },
    "Spasmo-digestin": { active: "Digestive/Spasmolytic", dose: "ŸÇÿ±ÿµ Ÿàÿ≥ÿ∑ ÿßŸÑÿ£ŸÉŸÑ" },
    "Buscopan": { active: "Hyoscine", dose: "ŸÇÿ±ÿµ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ ŸÑŸÑŸÖÿ∫ÿµ" }
  }
};

export const PROTOCOLS = ['Long', 'Antagonist', 'Flare-up', 'Mini-IVF'];

export const PROTOCOL_INFO = {
  'Long': {
    name: 'Long Agonist Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑŸÜÿßŸáÿ∂ÿßÿ™ ÿßŸÑÿ∑ŸàŸäŸÑÿ©',
    description: 'Most commonly used protocol. Down-regulation starts in luteal phase of previous cycle.',
    arabicDescription: 'ÿßŸÑÿ£ŸÉÿ´ÿ± ÿßÿ≥ÿ™ÿÆÿØÿßŸÖÿßŸã. ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸáÿ±ŸÖŸàŸÜÿßÿ™ Ÿäÿ®ÿØÿ£ ŸÖŸÜ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑŸÑŸàÿ™ŸäÿßŸÑŸäÿ© ŸÑŸÑÿØŸàÿ±ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©.',
    bestFor: ['Normal responders', 'Regular cycles', 'PCO patients'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿπÿßÿØŸäŸàŸÜ', 'ÿßŸÑÿØŸàÿ±ÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ∏ŸÖÿ©', 'ŸÖÿ™ŸÑÿßÿ≤ŸÖÿ© ÿ™ŸÉŸäÿ≥ ÿßŸÑŸÖÿ®ÿßŸäÿ∂'],
    duration: '35-42 days total',
    stimDays: '10-12 days',
    downRegDrugs: ['Decapeptyl 0.1mg Daily', 'Zoladex 3.6mg'],
    stimDrugs: ['Gonal-F 75 IU', 'Merional 75 IU', 'Fostimon 75 IU'],
    trigger: ['Ovitrelle 250mcg', 'Choriomon 5000 IU'],
    luteal: ['Cyclogest 400mg', 'Utrogestan 200mg', 'Crinone 8% Gel']
  },
  'Antagonist': {
    name: 'Antagonist Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑŸÖÿ∂ÿßÿØÿßÿ™',
    description: 'Shorter protocol. GnRH antagonists used to prevent premature LH surge. Good for poor responders.',
    arabicDescription: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿ£ŸÇÿµÿ±. ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ∂ÿßÿØÿßÿ™ ŸÑŸÖŸÜÿπ ÿßÿ±ÿ™ŸÅÿßÿπ LH ÿßŸÑŸÖÿ®ŸÉÿ±. ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸäŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°.',
    bestFor: ['Poor responders', 'Previous low response', 'PCOS with high response risk'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°', 'ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ© ÿ≥ÿßÿ®ŸÇÿ©', 'ÿ™ŸÉŸäÿ≥ ŸÖÿ®ÿßŸäÿ∂ ŸÖÿπ ÿÆÿ∑ÿ± ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿπÿßŸÑŸäÿ©'],
    duration: '14-16 days',
    stimDays: '8-10 days',
    downRegDrugs: [],
    stimDrugs: ['Gonal-F 75-150 IU', 'Merional 75 IU', 'Menopur 75 IU'],
    antagonist: ['Cetrotide 0.25mg', 'Orgalutran 0.25mg'],
    trigger: ['Ovitrelle 250mcg', 'Decapeptyl 0.1mg (Trigger)'],
    luteal: ['Cyclogest 400mg', 'Progynova 2mg']
  },
  'Flare-up': {
    name: 'Flare-up Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ™ŸÜÿ¥Ÿäÿ∑ ÿßŸÑÿ≠ÿßÿØ',
    description: 'Short protocol. Initial FSH surge from GnRH agonist boosts recruitment. Faster but needs monitoring.',
    arabicDescription: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ŸÇÿµŸäÿ±. ÿßÿ±ÿ™ŸÅÿßÿπ FSH ÿßŸÑÿ£ŸàŸÑŸä Ÿäÿπÿ≤ÿ≤ ÿ™ÿ¨ŸÜŸäÿØ ÿßŸÑÿ®ŸàŸäÿ∂ÿßÿ™. ÿ£ÿ≥ÿ±ÿπ ŸÑŸÉŸÜ Ÿäÿ≠ÿ™ÿßÿ¨ ŸÖÿ±ÿßŸÇÿ®ÿ©.',
    bestFor: ['Poor responders', 'Diminished ovarian reserve', 'Older patients'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°', 'ŸÇÿµŸàÿ± ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑŸÖÿ®Ÿäÿ∂', 'ÿßŸÑŸÖÿ±Ÿäÿ∂ÿßÿ™ ÿßŸÑÿ£ŸÉÿ®ÿ± ÿ≥ŸÜÿßŸã'],
    duration: '10-12 days',
    stimDays: '8-9 days',
    downRegDrugs: ['Decapeptyl 3.75mg Depot'],
    stimDrugs: ['Gonal-F 150-300 IU', 'Merional 150 IU'],
    trigger: ['Ovitrelle 250mcg', 'Choriomon 5000 IU'],
    luteal: ['Cyclogest 400mg', 'Duphaston 10mg']
  },
  'Mini-IVF': {
    name: 'Mini-IVF Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ≠ŸÇŸÜ ÿßŸÑŸÖÿ¨Ÿáÿ±Ÿä ÿßŸÑÿÆŸÅŸäŸÅ',
    description: 'Minimal stimulation. Lower hormone doses, suitable for poor responders and medical contraindications.',
    arabicDescription: 'ÿ™ŸÜÿ¥Ÿäÿ∑ ÿ®ÿ≥Ÿäÿ∑ ÿ¨ÿØÿßŸã. ÿ¨ÿ±ÿπÿßÿ™ Ÿáÿ±ŸÖŸàŸÜŸäÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ©ÿå ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸäŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ° ŸàÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ≥ÿ©.',
    bestFor: ['Poor responders', 'Previous OHSS', 'Medical contraindications'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°', 'ŸÅÿ±ÿ∑ ÿ™ŸÜÿ®ŸäŸá ÿ≥ÿßÿ®ŸÇ', 'ŸÖŸàÿßŸÜÿπ ÿ∑ÿ®Ÿäÿ©'],
    duration: '10-14 days',
    stimDays: '7-8 days',
    downRegDrugs: [],
    stimDrugs: ['Clomid 50mg', 'Femara 2.5mg', 'Gonal-F 75 IU'],
    trigger: ['Ovitrelle 250mcg'],
    luteal: ['Cyclogest 200mg', 'Utrogestan 200mg']
  }
};

export const WHO_SPERM_PARAMS = {
  volume: 1.5,
  concentration: 15, // M/ml
  motility: 40, // %
  morphology: 4 // %
};
</file>

<file path="data/egyptian_drugs.ts">
export interface DrugEntry {
  tradeName: string;   // e.g., "Augmentin 1g"
  active: string;      // e.g., "Amoxicillin/Clavulanate"
  route: string;       // e.g., "ÿ£ŸÇÿ±ÿßÿµ", "ÿ≠ŸÇŸÜ", "ŸÑÿ®Ÿàÿ≥", "ŸÉÿ±ŸäŸÖ"
  dose: string;        // e.g., "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ"
  category: string;    // e.g., "Antibiotics"
}

export const EGYPTIAN_MARKET_DRUGS: Record<string, DrugEntry[]> = {
  "Induction & IVF": [
    // Oral Induction
    { tradeName: "Clomid 50mg", active: "Clomiphene Citrate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2-6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Clostilbegyt 50mg", active: "Clomiphene Citrate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2-6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Technovula 50mg", active: "Clomiphene Citrate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2-6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Femara 2.5mg", active: "Letrozole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3-7 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Letrozole 2.5mg", active: "Letrozole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3-7 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },

    // FSH Injectables
    { tradeName: "Gonal-F 75IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Gonal-F 300IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Gonal-F 450IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Gonal-F 900IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Merional 75IU", active: "Menotrophin (FSH/LH)", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Merional 150IU", active: "Menotrophin (FSH/LH)", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Fostimon 75IU", active: "Urofollitropin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Fostimon 150IU", active: "Urofollitropin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Menogon 75IU", active: "Menotrophin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Epigonal 0.5mg", active: "Ganirelix", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },

    // LH/FSH Combinations
    { tradeName: "Pergoveris 150IU", active: "Follitropin Alfa/Lutropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Luveris 75IU", active: "Lutropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },

    // GnRH Antagonists
    { tradeName: "Cetrotide 0.25mg", active: "Cetrorelix", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Orgalutran 0.25mg", active: "Ganirelix", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },

    // GnRH Agonists
    { tradeName: "Decapeptyl 0.1mg Daily", active: "Triptorelin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },
    { tradeName: "Decapeptyl 3.75mg Depot", active: "Triptorelin", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 28 ŸäŸàŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },
    { tradeName: "Zoladex 3.6mg", active: "Goserelin", route: "ÿ≤ÿ±ÿπ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≤ÿ±ÿπÿ© ŸÉŸÑ 28 ŸäŸàŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },
    { tradeName: "Lupron Depot 3.75mg", active: "Leuprolide", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 28 ŸäŸàŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },

    // Trigger Injections
    { tradeName: "Choriomon 5000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Choriomon 10000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Epifasi 5000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Pregnyl 5000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Ovitrelle 250mcg", active: "Choriogonadotropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
  ],

  "Luteal Support": [
    { tradeName: "Cyclogest 200mg", active: "Progesterone", route: "ŸÑÿ®Ÿàÿ≥ ŸÖŸáÿ®ŸÑŸä", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖÿ≥ÿßÿ°Ÿã ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Cyclogest 400mg", active: "Progesterone", route: "ŸÑÿ®Ÿàÿ≥ ŸÖŸáÿ®ŸÑŸä", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖÿ≥ÿßÿ°Ÿã ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Prontogest 100mg", active: "Progesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Prontogest 200mg", active: "Progesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Prontogest 400mg", active: "Progesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Utrogestan 100mg", active: "Progesterone", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™ ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ™ÿßŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Utrogestan 200mg", active: "Progesterone", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™ ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ™ÿßŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Duphaston 10mg", active: "Dydrogesterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Endometrin 100mg", active: "Progesterone", route: "ŸÑÿ®Ÿàÿ≥ ŸÖŸáÿ®ŸÑŸä", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Crinone 8% Gel", active: "Progesterone", route: "ÿ¨ŸäŸÑ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Lubgest 200mg", active: "Progesterone", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™ ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
  ],

  "Pregnancy Supplements": [
    // Folic Acid
    { tradeName: "Folic Acid 5mg (Nile)", active: "Folic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Folic Acid 5mg (Mepaco)", active: "Folic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Methylfolate 400mcg", active: "L-Methylfolate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },

    // Iron Supplements
    { tradeName: "Ferrotron", active: "Iron/Folic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Haemoton", active: "Iron/Folic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Feroglobin", active: "Iron/Vitamins", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Pravotin", active: "Iron/Folic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },

    // Calcium & Vitamin D
    { tradeName: "Osteocare", active: "Calcium/Vitamin D3", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Calcid", active: "Calcium Carbonate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Calcimate", active: "Calcium/Vitamin D3", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Cal-Mag", active: "Calcium/Magnesium", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },

    // Prenatal Vitamins
    { tradeName: "Pregnacare Original", active: "Multivitamins", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Pregnacare Plus", active: "Multivitamins/Iron", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Elevit", active: "Multivitamins", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Limitless Woman", active: "Multivitamins", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },

    // Omega 3
    { tradeName: "Omega 3 Plus", active: "Fish Oil/DHA", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Maxepa", active: "Omega 3", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
  ],

  "Anticoagulants": [
    { tradeName: "Clexane 20mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane 40mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane 60mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane 80mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Enoxa 40mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Innohep 4500IU", active: "Tinzaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane T 4000IU", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Juvespr 20mg", active: "Rivaroxaban", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Aspocid 75mg", active: "Aspirin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Anticoagulants" },
    { tradeName: "Ezacard 75mg", active: "Aspirin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Anticoagulants" },
  ],

  "Antibiotics": [
    // Penicillins
    { tradeName: "Augmentin 375mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Augmentin 625mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Augmentin 1g", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Hibiotic 375mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Megamox 375mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Curam 625mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },

    // Cephalosporins
    { tradeName: "Zinnat 250mg", active: "Cefuroxime", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Zinnat 500mg", active: "Cefuroxime", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Cefotax 1g", active: "Cefotaxime", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ/Ÿàÿ±ŸäÿØŸä", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Cefzone 1g", active: "Ceftriaxone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ/Ÿàÿ±ŸäÿØŸä", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Rocephin 1g", active: "Ceftriaxone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ/Ÿàÿ±ŸäÿØŸä", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Duricef 500mg", active: "Cefadroxil", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },

    // Macrolides
    { tradeName: "Zithromax 500mg", active: "Azithromycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ", category: "Antibiotics" },
    { tradeName: "Zisrocin 500mg", active: "Azithromycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ", category: "Antibiotics" },

    // Tetracyclines
    { tradeName: "Vibramycin 100mg", active: "Doxycycline", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Doxycast 100mg", active: "Doxycycline", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },

    // Lincosamides
    { tradeName: "Dalacin C 300mg", active: "Clindamycin", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antibiotics" },

    // Nitroimidazoles
    { tradeName: "Flagyl 500mg", active: "Metronidazole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© ÿ£ÿ≥ÿ®Ÿàÿπ", category: "Antibiotics" },
    { tradeName: "Amrizole 500mg", active: "Metronidazole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© ÿ£ÿ≥ÿ®Ÿàÿπ", category: "Antibiotics" },

    // Antifungals
    { tradeName: "Diflucan 150mg", active: "Fluconazole", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©", category: "Antibiotics" },

    // UTI Specific
    { tradeName: "Uvamin Retard 400mg", active: "Fosfomycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©", category: "Antibiotics" },
    { tradeName: "Macropur 3g", active: "Nitrofurantoin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Antibiotics" },
    { tradeName: "Monuril 3g", active: "Fosfomycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©", category: "Antibiotics" },
  ],

  "Vaginal Preparations": [
    // Antifungal
    { tradeName: "Gyno-Daktarin 400mg", active: "Miconazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },
    { tradeName: "Monicure 400mg", active: "Miconazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },
    { tradeName: "Gyno-Zalain 300mg", active: "Sertaconazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },
    { tradeName: "Candistan 100mg", active: "Clotrimazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ", category: "Vaginal Preparations" },
    { tradeName: "Gyno-Trosyd 100mg", active: "Tioconazole", route: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },

    // Antibacterial
    { tradeName: "Amrizole N", active: "Metronidazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 5 ÿ£ŸäÿßŸÖ", category: "Vaginal Preparations" },
    { tradeName: "Betadine", active: "Povidone Iodine", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
    { tradeName: "Albothyl", active: "Polymyxin/Neomycin", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
    { tradeName: "PolgyneX", active: "Polymyxin/Neomycin", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },

    // Cleansers
    { tradeName: "Vagyl", active: "Lactic Acid", route: "ÿ∫ÿ≥ŸàŸÑ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ∫ÿ≥ŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
    { tradeName: "Tantum Rosa", active: "Benzydamine", route: "ÿ∫ÿ≥ŸàŸÑ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ∫ÿ≥ŸÑ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
  ],

  "Antihypertensives": [
    { tradeName: "Aldomet 250mg", active: "Methyldopa", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antihypertensives" },
    { tradeName: "Aldomet 500mg", active: "Methyldopa", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antihypertensives" },
    { tradeName: "Adalat LA 30mg", active: "Nifedipine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antihypertensives" },
    { tradeName: "Adalat LA 60mg", active: "Nifedipine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antihypertensives" },
    { tradeName: "Epilat 30mg", active: "Nifedipine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antihypertensives" },
    { tradeName: "Dopegyt 250mg", active: "Methyldopa", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antihypertensives" },
  ],

  "Antidiabetics": [
    // Metformin
    { tradeName: "Cidophage 500mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antidiabetics" },
    { tradeName: "Cidophage 850mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antidiabetics" },
    { tradeName: "Cidophage 1000mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antidiabetics" },
    { tradeName: "Glucophage XR 500mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antidiabetics" },
    { tradeName: "Glucophage XR 1000mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antidiabetics" },

    // Sulfonylureas
    { tradeName: "Amaryl 2mg", active: "Glimepiride", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±", category: "Antidiabetics" },
    { tradeName: "Amaryl 4mg", active: "Glimepiride", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±", category: "Antidiabetics" },

    // Insulin
    { tradeName: "Mixtard 30/70", active: "Insulin Human", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Antidiabetics" },
    { tradeName: "Lantus 100IU/ml", active: "Insulin Glargine", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antidiabetics" },
    { tradeName: "Apidra 100IU/ml", active: "Insulin Glulisine", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™", category: "Antidiabetics" },
    { tradeName: "Actrapid 100IU/ml", active: "Insulin Human", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™", category: "Antidiabetics" },
  ],

  "Analgesics": [
    // NSAIDs
    { tradeName: "Brufen 400mg", active: "Ibuprofen", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Brufen 600mg", active: "Ibuprofen", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Ponstan 500mg", active: "Mefenamic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Ponstan Forte 500mg", active: "Mefenamic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Cataflam 50mg", active: "Diclofenac", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Analgesics" },
    { tradeName: "Voltaren 75mg", active: "Diclofenac", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Analgesics" },
    { tradeName: "Ketolac 10mg", active: "Ketorolac", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ ŸÑŸÖÿØÿ© 5 ÿ£ŸäÿßŸÖ", category: "Analgesics" },

    // Paracetamol
    { tradeName: "Panadol 500mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Panadol Extra 500mg", active: "Paracetamol/Caffeine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Panadol Joint 665mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Abimol 500mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Pyral 500mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },

    // Antispasmodics
    { tradeName: "Buscopan 10mg", active: "Hyoscine Butylbromide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Visceralgine 10mg", active: "Hyoscine Butylbromide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Spasmo-digestin", active: "Hyoscine/Phenylpropanolamine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Spasmofree", active: "Hyoscine/Phenylpropanolamine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Spasmo-Amrase", active: "Hyoscine/Phenylpropanolamine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
  ],

  "Contraceptives": [
    // Combined Oral Contraceptives
    { tradeName: "Yasmin", active: "Ethinylestradiol/Drospirenone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Yaz", active: "Ethinylestradiol/Drospirenone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 24 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Gynera", active: "Ethinylestradiol/Gestodene", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Marvelon", active: "Ethinylestradiol/Desogestrel", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Cilest", active: "Ethinylestradiol/Norgestimate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Microlut", active: "Levonorgestrel", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ±ÿ© ÿ±ÿßÿ≠ÿ©", category: "Contraceptives" },
    { tradeName: "Diane 35", active: "Ethinylestradiol/Cyproterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },

    // Injectable Contraceptives
    { tradeName: "Depo-Provera 150mg", active: "Medroxyprogesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 3 ÿ£ÿ¥Ÿáÿ±", category: "Contraceptives" },
    { tradeName: "Mesigyna 150mg", active: "Medroxyprogesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 3 ÿ£ÿ¥Ÿáÿ±", category: "Contraceptives" },

    // Emergency Contraception
    { tradeName: "Contraceplan II", active: "Levonorgestrel", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿπÿßŸã ÿÆŸÑÿßŸÑ 72 ÿ≥ÿßÿπÿ©", category: "Contraceptives" },
  ],

  "Anti-Emetics": [
    { tradeName: "Navidoxine", active: "Doxylamine/Pyridoxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", category: "Anti-Emetics" },
    { tradeName: "Cortiplex B6", active: "Dexamethasone/Pyridoxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", category: "Anti-Emetics" },
    { tradeName: "Zofran 8mg", active: "Ondansetron", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Zofran 4mg", active: "Ondansetron", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Danset 10mg", active: "Domperidone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Motinorm 10mg", active: "Domperidone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Primperan 10mg", active: "Metoclopramide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Maxolon 10mg", active: "Metoclopramide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
  ],

  "Hemostatics": [
    { tradeName: "Kapron 500mg", active: "Tranexamic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Cyklokapron 500mg", active: "Tranexamic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Haemostop 500mg", active: "Tranexamic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Dicynone 250mg", active: "Ethamsylate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Methergine 0.2mg", active: "Methylergometrine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
  ],

  "Thyroid & Hormonal": [
    // Thyroid
    { tradeName: "Eltroxin 50mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Eltroxin 100mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Euthyrox 50mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Euthyrox 100mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Thyronorm 25mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ÿ±ÿ®ÿπ ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },

    // Dopamine Agonists
    { tradeName: "Dostinex 0.5mg", active: "Cabergoline", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ŸÉŸÑ 3 ÿ£ŸäÿßŸÖ", category: "Thyroid & Hormonal" },

    // Progestins
    { tradeName: "Primolut N 5mg", active: "Norethisterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Provera 10mg", active: "Medroxyprogesterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },

    // Venotonics
    { tradeName: "Daflon 500mg", active: "Diosmin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Reparil 20mg", active: "Aescin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },
  ]
};

// Helper function to get all drugs as a flat array
export const getAllDrugs = (): DrugEntry[] => {
  return Object.values(EGYPTIAN_MARKET_DRUGS).flat();
};

// Helper function to get drugs by category
export const getDrugsByCategory = (category: string): DrugEntry[] => {
  return EGYPTIAN_MARKET_DRUGS[category] || [];
};

// Helper function to search drugs by name
export const searchDrugs = (query: string): DrugEntry[] => {
  const allDrugs = getAllDrugs();
  const lowerQuery = query.toLowerCase();
  return allDrugs.filter(drug =>
    drug.tradeName.toLowerCase().includes(lowerQuery) ||
    drug.active.toLowerCase().includes(lowerQuery)
  );
};
</file>

<file path="pages/components/obstetrics/FetalGrowthChart.tsx">
import React, { useState, useEffect } from 'react';
import { Plus, Save, Trash2, X } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import toast from 'react-hot-toast';
import { BiometryScan } from '../../../types';
import { obstetricsService, calculateEFW, calculatePercentile, calculateGestationalAge } from '../../../services/obstetricsService';

interface FetalGrowthChartProps {
  pregnancyId: string;
  lmpDate?: string;
}

const FetalGrowthChart: React.FC<FetalGrowthChartProps> = ({ pregnancyId, lmpDate }) => {
  const [scans, setScans] = useState<BiometryScan[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    scan_date: new Date().toISOString().split('T')[0],
    bpd_mm: '',
    hc_mm: '',
    ac_mm: '',
    fl_mm: '',
    notes: '',
  });

  useEffect(() => {
    fetchScans();
  }, [pregnancyId]);

  const fetchScans = async () => {
    try {
      setIsLoading(true);
      const data = await obstetricsService.getBiometryScans(pregnancyId);
      setScans(data || []);
    } catch (error) {
      console.error('Error fetching scans:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäŸàŸÖŸäÿ™ÿ±Ÿä');
    } finally {
      setIsLoading(false);
    }
  };

  const handleAddScan = async () => {
    try {
      if (!formData.scan_date || !formData.bpd_mm || !formData.hc_mm || !formData.ac_mm || !formData.fl_mm) {
        toast.error('ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®ÿ©');
        return;
      }

      setIsSaving(true);

      const bpd = parseFloat(formData.bpd_mm);
      const hc = parseFloat(formData.hc_mm);
      const ac = parseFloat(formData.ac_mm);
      const fl = parseFloat(formData.fl_mm);

      let ga = { weeks: 20, days: 0 };
      if (lmpDate && formData.scan_date) {
        try {
          const lmpTimestamp = new Date(lmpDate).getTime();
          const scanTimestamp = new Date(formData.scan_date).getTime();
          if (!isNaN(lmpTimestamp) && !isNaN(scanTimestamp)) {
            const diffTime = Math.abs(scanTimestamp - lmpTimestamp);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            ga = { weeks: Math.max(0, Math.floor(diffDays / 7)), days: Math.max(0, diffDays % 7) };
          }
        } catch (err) {
          console.warn('Error calculating GA:', err);
          ga = { weeks: 20, days: 0 };
        }
      }

      if (isNaN(bpd) || isNaN(hc) || isNaN(ac) || isNaN(fl) || bpd <= 0 || hc <= 0 || ac <= 0 || fl <= 0) {
        toast.error('ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇŸäÿßÿ≥ÿßÿ™ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ£ÿ±ŸÇÿßŸÖ ŸÖŸàÿ¨ÿ®ÿ©');
        setIsSaving(false);
        return;
      }

      const efw = calculateEFW(bpd, hc, ac, fl);
      const percentile = calculatePercentile(efw, ga.weeks);

      if (!efw || efw === 0) {
        toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ≥ÿßÿ® Ÿàÿ≤ŸÜ ÿßŸÑÿ¨ŸÜŸäŸÜ ÿßŸÑŸÖŸÇÿØÿ±. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÇŸäÿßÿ≥ÿßÿ™');
        setIsSaving(false);
        return;
      }

      const scanData = {
        scan_date: formData.scan_date,
        bpd_mm: Math.max(0, bpd),
        hc_mm: Math.max(0, hc),
        ac_mm: Math.max(0, ac),
        fl_mm: Math.max(0, fl),
        efw_grams: Math.max(0, efw),
        percentile: Math.max(0, Math.round(percentile)),
        pregnancy_id: pregnancyId,
        gestational_age_weeks: Math.max(0, ga.weeks),
        gestational_age_days: Math.max(0, ga.days),
        notes: formData.notes?.trim() || '',
      };

      if (editingId) {
        await obstetricsService.updateBiometryScan(editingId, scanData);
        toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠');
      } else {
        await obstetricsService.createBiometryScan(scanData);
        toast.success('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠');
      }

      fetchScans();
      resetForm();
    } catch (error) {
      console.error('Error saving scan:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ≠');
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteScan = async (scanId: string) => {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ≠ÿü')) return;

    try {
      await obstetricsService.deleteBiometryScan(scanId);
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠');
      fetchScans();
    } catch (error) {
      console.error('Error deleting scan:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ≠');
    }
  };

  const handleEditScan = (scan: BiometryScan) => {
    setFormData({
      scan_date: scan.scan_date,
      bpd_mm: scan.bpd_mm?.toString() || '',
      hc_mm: scan.hc_mm?.toString() || '',
      ac_mm: scan.ac_mm?.toString() || '',
      fl_mm: scan.fl_mm?.toString() || '',
      notes: scan.notes || '',
    });
    setEditingId(scan.id);
    setShowForm(true);
  };

  const resetForm = () => {
    setFormData({
      scan_date: new Date().toISOString().split('T')[0],
      bpd_mm: '',
      hc_mm: '',
      ac_mm: '',
      fl_mm: '',
      notes: '',
    });
    setEditingId(null);
    setShowForm(false);
  };

  const chartData = scans && Array.isArray(scans)
    ? scans
        .slice()
        .reverse()
        .map((scan, idx) => {
          try {
            const gaWeeks = Number(scan?.gestational_age_weeks) || 20;
            return {
              name: `${gaWeeks}w`,
              efw: Number(scan?.efw_grams) || 0,
              p10: getP10(gaWeeks),
              p50: getP50(gaWeeks),
              p90: getP90(gaWeeks),
              percentile: Number(scan?.percentile) || 50,
            };
          } catch (err) {
            console.warn('Error mapping scan data:', err);
            return { name: '20w', efw: 0, p10: 0, p50: 0, p90: 0, percentile: 50 };
          }
        })
    : [];

  const getP10 = (weeks: number): number => {
    const weights: { [key: number]: number } = {
      20: 300, 22: 430, 24: 600, 26: 760, 28: 1000, 30: 1300, 32: 1600, 34: 2100, 36: 2600, 38: 3000, 40: 3200,
    };
    return weights[weeks] || 0;
  };

  const getP50 = (weeks: number): number => {
    const weights: { [key: number]: number } = {
      20: 330, 22: 475, 24: 660, 26: 850, 28: 1100, 30: 1440, 32: 1840, 34: 2450, 36: 3000, 38: 3400, 40: 3500,
    };
    return weights[weeks] || 0;
  };

  const getP90 = (weeks: number): number => {
    const weights: { [key: number]: number } = {
      20: 370, 22: 540, 24: 750, 26: 980, 28: 1270, 30: 1680, 32: 2150, 34: 2850, 36: 3500, 38: 3900, 40: 3900,
    };
    return weights[weeks] || 0;
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900 font-[Tajawal]">üë∂ ŸÖÿÆÿ∑ÿ∑ ŸÜŸÖŸà ÿßŸÑÿ¨ŸÜŸäŸÜ</h2>
        <button
          onClick={() => setShowForm(!showForm)}
          className="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
        >
          <Plus size={18} />
          ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ≠
        </button>
      </div>

      {showForm && (
        <div className="mb-6 p-6 bg-gray-50 rounded-lg border-2 border-teal-200">
          <div className="grid md:grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ≥ÿ≠
              </label>
              <input
                type="date"
                value={formData.scan_date}
                onChange={(e) => setFormData(prev => ({ ...prev, scan_date: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                BPD (Biparietal Diameter) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.bpd_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, bpd_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 54.2"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                HC (Head Circumference) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.hc_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, hc_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 285"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                AC (Abdominal Circumference) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.ac_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, ac_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 254"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                FL (Femur Length) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.fl_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, fl_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 68"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
              </label>
              <input
                type="text"
                value={formData.notes}
                onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleAddScan}
              disabled={isSaving}
              className="flex items-center gap-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
            >
              <Save size={18} />
              {isSaving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : editingId ? 'ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ≠' : 'ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ≠'}
            </button>
            <button
              onClick={resetForm}
              className="flex items-center gap-2 bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
            >
              <X size={18} />
              ÿ•ŸÑÿ∫ÿßÿ°
            </button>
          </div>
        </div>
      )}

      {isLoading ? (
        <div className="text-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
        </div>
      ) : scans.length > 0 ? (
        <>
          <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <p className="text-sm text-blue-900 font-[Tajawal]">
              üìä <strong>ÿßŸÑÿÆÿ∑Ÿàÿ∑ ÿßŸÑŸÖÿ±ÿ¨ÿπŸäÿ© (RCOG/NICE):</strong> ÿßŸÑÿÆÿ∑ ÿßŸÑÿ£ÿÆÿ∂ÿ± = 10th percentile (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ÿßŸÑÿ∑ÿ®ŸäÿπŸä)ÿå ÿßŸÑÿ£ÿ≤ÿ±ŸÇ = 50th (ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑)ÿå ÿßŸÑÿ£ÿ≠ŸÖÿ± = 90th (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿπŸÑŸâ)
            </p>
          </div>

          <div className="mb-6">
            <ResponsiveContainer width="100%" height={400}>
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis label={{ value: 'ÿßŸÑŸàÿ≤ŸÜ (ÿ¨ÿ±ÿßŸÖ)', angle: -90, position: 'insideLeft' }} />
                <Tooltip
                  formatter={(value: any) => `${value.toLocaleString()} g`}
                  labelFormatter={(label) => `ÿ£ÿ≥ÿßÿ®Ÿäÿπ: ${label}`}
                />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="p10"
                  stroke="#16a34a"
                  strokeDasharray="5 5"
                  name="10th Percentile"
                  isAnimationActive={false}
                />
                <Line
                  type="monotone"
                  dataKey="p50"
                  stroke="#3b82f6"
                  strokeDasharray="5 5"
                  name="50th Percentile"
                  isAnimationActive={false}
                />
                <Line
                  type="monotone"
                  dataKey="p90"
                  stroke="#dc2626"
                  strokeDasharray="5 5"
                  name="90th Percentile"
                  isAnimationActive={false}
                />
                <Line
                  type="monotone"
                  dataKey="efw"
                  stroke="#14b8a6"
                  name="Ÿàÿ≤ŸÜ ÿßŸÑÿ¨ŸÜŸäŸÜ ÿßŸÑŸÖŸÇÿØÿ± (EFW)"
                  strokeWidth={2}
                  connectNulls
                />
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full text-sm font-[Tajawal]">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-4 py-2 text-right">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                  <th className="px-4 py-2 text-right">GA</th>
                  <th className="px-4 py-2 text-right">BPD</th>
                  <th className="px-4 py-2 text-right">HC</th>
                  <th className="px-4 py-2 text-right">AC</th>
                  <th className="px-4 py-2 text-right">FL</th>
                  <th className="px-4 py-2 text-right">EFW</th>
                  <th className="px-4 py-2 text-right">ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ©</th>
                  <th className="px-4 py-2 text-right">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                </tr>
              </thead>
              <tbody>
                {Array.isArray(scans) && scans.map((scan) => {
                  try {
                    if (!scan || !scan.id) return null;
                    const scanDate = scan?.scan_date ? new Date(scan.scan_date).toLocaleDateString('ar-EG') : '-';
                    const gaWeeks = Number(scan?.gestational_age_weeks) || 0;
                    const gaDays = Number(scan?.gestational_age_days) || 0;
                    const efwGrams = Number(scan?.efw_grams) || 0;
                    const percentile = Number(scan?.percentile) || 50;

                    return (
                      <tr key={scan.id} className="border-b hover:bg-gray-50">
                        <td className="px-4 py-2">{scanDate}</td>
                        <td className="px-4 py-2">{gaWeeks}w+{gaDays}d</td>
                        <td className="px-4 py-2">{scan?.bpd_mm || '-'} ŸÖŸÑŸÖ</td>
                        <td className="px-4 py-2">{scan?.hc_mm || '-'} ŸÖŸÑŸÖ</td>
                        <td className="px-4 py-2">{scan?.ac_mm || '-'} ŸÖŸÑŸÖ</td>
                        <td className="px-4 py-2">{scan?.fl_mm || '-'} ŸÖŸÑŸÖ</td>
                        <td className="px-4 py-2 font-bold text-teal-700">
                          {efwGrams > 0 ? efwGrams.toLocaleString() : '-'} g
                        </td>
                        <td className="px-4 py-2">
                          <span
                            className={`px-3 py-1 rounded-full text-xs font-bold ${
                              percentile < 10
                                ? 'bg-red-100 text-red-800'
                                : percentile > 90
                                ? 'bg-yellow-100 text-yellow-800'
                                : 'bg-green-100 text-green-800'
                            }`}
                          >
                            {percentile}th
                          </span>
                        </td>
                        <td className="px-4 py-2 flex gap-2">
                          <button
                            onClick={() => handleEditScan(scan)}
                            className="text-blue-600 hover:text-blue-800 font-semibold"
                          >
                            ÿ™ÿ≠ÿ±Ÿäÿ±
                          </button>
                          <button
                            onClick={() => handleDeleteScan(scan.id)}
                            className="text-red-600 hover:text-red-800"
                          >
                            <Trash2 size={16} />
                          </button>
                        </td>
                      </tr>
                    );
                  } catch (err) {
                    console.warn('Error rendering scan row:', err);
                    return null;
                  }
                })}
              </tbody>
            </table>
          </div>
        </>
      ) : (
        <p className="text-center text-gray-500 py-8 font-[Tajawal]">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≥Ÿàÿ≠ÿßÿ™ ÿ®ŸäŸàŸÖŸäÿ™ÿ±Ÿäÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</p>
      )}
    </div>
  );
};

export default FetalGrowthChart;
</file>

<file path="pages/components/obstetrics/PregnancyHeader.tsx">
import React from 'react';
import { Calendar, AlertCircle, CheckCircle, Baby } from 'lucide-react';
import { Pregnancy } from '../../../types';
import { calculateGestationalAge, getDueActions } from '../../../services/obstetricsService';
import toast from 'react-hot-toast';

interface PregnancyHeaderProps {
  pregnancy: Pregnancy;
}

const PregnancyHeader: React.FC<PregnancyHeaderProps> = ({ pregnancy }) => {
  const lmpDate = pregnancy.lmp_date;
  const ga = lmpDate ? calculateGestationalAge(lmpDate) : { weeks: 0, days: 0 };
  const dueActions = getDueActions(ga.weeks);

  const progressPercentage = ((ga.weeks * 7 + ga.days) / 280) * 100;

  // Determine pregnancy status based on gestational age
  const getPregnancyStatus = (weeks: number) => {
    if (weeks < 37) {
      return {
        status: 'Pre-term',
        color: 'blue',
        arabicText: 'ÿ≠ŸÖŸÑ ŸÖÿ®ŸÉÿ±',
        bgColor: 'bg-blue-100',
        textColor: 'text-blue-800',
        borderColor: 'border-blue-200'
      };
    } else if (weeks >= 37 && weeks < 40) {
      return {
        status: 'Full Term',
        color: 'green',
        arabicText: 'ŸÅÿ™ÿ±ÿ© ŸàŸÑÿßÿØÿ© ÿ∑ÿ®ŸäÿπŸäÿ©',
        bgColor: 'bg-green-100',
        textColor: 'text-green-800',
        borderColor: 'border-green-200'
      };
    } else if (weeks >= 40 && weeks < 42) {
      return {
        status: 'Late Term / Overdue',
        color: 'orange',
        arabicText: 'ÿ™ÿÆÿ∑ÿ™ ÿßŸÑŸÖŸàÿπÿØ',
        bgColor: 'bg-orange-100',
        textColor: 'text-orange-800',
        borderColor: 'border-orange-200'
      };
    } else {
      return {
        status: 'Post Term',
        color: 'red',
        arabicText: 'ÿ≠ŸÖŸÑ ŸÖÿ™ÿ£ÿÆÿ± ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ - ÿÆÿ∑ÿ±',
        bgColor: 'bg-red-100',
        textColor: 'text-red-800',
        borderColor: 'border-red-200'
      };
    }
  };

  const pregnancyStatus = getPregnancyStatus(ga.weeks);
  const isOverdue = ga.weeks >= 40;

  const handleDeliveryCheck = () => {
    toast.success('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿßÿ≥ÿ™ÿπŸÑÿßŸÖ ÿπŸÜ ÿßŸÑŸàŸÑÿßÿØÿ© - Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÑÿßÿØÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ');
    // TODO: Navigate to delivery outcome form or archive the pregnancy
  };

  return (
    <div className="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg p-6 mb-6 border border-teal-200">
      {/* Status Badge */}
      <div className="flex justify-between items-start mb-4">
        <div></div>
        <div className={`px-4 py-2 rounded-full text-sm font-bold ${pregnancyStatus.bgColor} ${pregnancyStatus.textColor} border ${pregnancyStatus.borderColor} font-[Tajawal]`}>
          {pregnancyStatus.arabicText}
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-6">
        <div>
          <h2 className="text-sm text-gray-600 font-semibold mb-2 font-[Tajawal]">
            ÿßŸÑÿ≠ŸÖŸÑ ÿßŸÑÿ≠ÿßŸÑŸä
          </h2>
          <p className="text-4xl font-bold text-teal-700 font-[Tajawal]">
            {ga.weeks}
            <span className="text-xl text-gray-500 ml-2">ÿ£ÿ≥ÿ®Ÿàÿπ</span>
            <span className="text-lg text-gray-400 ml-1">+ {ga.days}</span>
          </p>
          <p className="text-xs text-gray-500 mt-2 font-[Tajawal]">
            ÿ¢ÿÆÿ± ÿØŸàÿ±ÿ©: {lmpDate ? new Date(lmpDate).toLocaleDateString('ar-EG') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
          </p>
        </div>

        <div>
          <h3 className="text-sm text-gray-600 font-semibold mb-3 font-[Tajawal]">
            ÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ŸÖŸÑ
          </h3>
          <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div
              className={`h-full rounded-full transition-all duration-500 ${
                isOverdue
                  ? 'bg-gradient-to-r from-red-500 to-red-600'
                  : 'bg-gradient-to-r from-teal-500 to-cyan-500'
              }`}
              style={{ width: `${Math.min(progressPercentage, 100)}%` }}
            ></div>
          </div>
          <p className="text-xs text-gray-600 mt-2 font-[Tajawal]">
            {progressPercentage.toFixed(0)}% ŸÖŸÜ 40 ÿ£ÿ≥ÿ®Ÿàÿπ
            {isOverdue && (
              <span className="text-red-600 font-bold ml-2">
                (ŸÖÿ™ÿ£ÿÆÿ± ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ)
              </span>
            )}
          </p>
        </div>

        <div>
          <h3 className="text-sm text-gray-600 font-semibold mb-2 font-[Tajawal]">
            ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπ
          </h3>
          <p className="text-xl font-bold text-teal-700 font-[Tajawal]">
            {pregnancy.edd_date
              ? new Date(pregnancy.edd_date).toLocaleDateString('ar-EG')
              : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
          </p>
          <p className="text-xs text-gray-500 mt-2 font-[Tajawal]">
            {ga.weeks < 40 && `ÿ®ÿßŸÇŸä ${40 - ga.weeks} ÿ£ÿ≥ÿßÿ®Ÿäÿπ`}
            {ga.weeks >= 40 && '‚è∞ ÿßŸÑŸàŸÑÿßÿØÿ© ŸÖÿ™ŸàŸÇÿπÿ©!'}
          </p>
        </div>
      </div>

      {dueActions.length > 0 && (
        <div className="mt-6 pt-6 border-t border-teal-200">
          <h3 className="text-sm font-semibold text-teal-900 mb-3 flex items-center gap-2 font-[Tajawal]">
            <AlertCircle size={18} className="text-orange-500" />
            ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇÿ©
          </h3>
          <div className="grid md:grid-cols-2 gap-2">
            {dueActions.map((action, idx) => (
              <div
                key={idx}
                className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-orange-200"
              >
                <AlertCircle size={16} className="text-orange-500 flex-shrink-0" />
                <span className="text-sm text-gray-700 font-[Tajawal]">{action}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {pregnancy.risk_level === 'high' && (
        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-red-600 flex-shrink-0 mt-0.5" size={18} />
            <div className="font-[Tajawal]">
              <p className="font-semibold text-red-900">‚ö†Ô∏è ÿ≠ŸÖŸÑ ÿπÿßŸÑŸä ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©</p>
              <p className="text-sm text-red-700 mt-1">
                ÿßŸÑÿ±ŸÇÿßÿ®ÿ© ÿßŸÑŸÖÿ™ŸÇÿßÿ±ÿ®ÿ© ŸàÿßŸÑÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÖÿ™ÿÆÿµÿµÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©
              </p>
              {pregnancy.aspirin_prescribed && (
                <p className="text-sm text-red-600 mt-1">
                  ‚úì Aspirin 150mg ŸÖŸàÿµŸàŸÅ ŸÑŸÑŸàŸÇÿßŸäÿ© ŸÖŸÜ ÿ™ÿ≥ŸÖŸÖ ÿßŸÑÿ≠ŸÖŸÑ
                </p>
              )}
            </div>
          </div>
        </div>
      )}

      {pregnancy.risk_level === 'low' && (
        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
          <CheckCircle className="text-green-600" size={20} />
          <p className="text-sm text-green-800 font-[Tajawal] font-semibold">
            ‚úì ÿ≠ŸÖŸÑ ŸÖŸÜÿÆŸÅÿ∂ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ© - ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ±Ÿàÿ™ŸäŸÜŸäÿ© ÿßŸÑŸÖÿπÿ™ÿßÿØÿ©
          </p>
        </div>
      )}

      {/* Did She Deliver? Prompt for overdue pregnancies */}
      {isOverdue && (
        <div className="mt-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Baby className="text-red-600" size={24} />
              <div>
                <h4 className="text-lg font-bold text-red-900 font-[Tajawal]">
                  üë∂ ŸáŸÑ ÿ™ŸÖÿ™ ÿßŸÑŸàŸÑÿßÿØÿ©ÿü
                </h4>
                <p className="text-sm text-red-700 font-[Tajawal]">
                  ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÑÿßÿØÿ© Ÿàÿ•ŸÜŸáÿßÿ° ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ
                </p>
              </div>
            </div>
            <button
              onClick={handleDeliveryCheck}
              className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200 font-[Tajawal] flex items-center gap-2"
            >
              <Baby size={16} />
              ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸàŸÑÿßÿØÿ©
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default PregnancyHeader;
</file>

<file path="src/db/localDB.ts">
import Dexie, { Table } from 'dexie';

// Define the sync status enum
export enum SyncStatus {
  SYNCED = 0,        // Successfully synced with server
  PENDING_CREATE = 1, // Created locally, needs to be pushed to server
  PENDING_UPDATE = 2, // Updated locally, needs to be pushed to server
  PENDING_DELETE = 3, // Marked for deletion, needs to be pushed to server
  ERROR = 4          // Sync failed, needs retry
}

// Patient interface for local storage
export interface LocalPatient {
  id?: number; // Auto-incremented local ID
  remoteId?: string; // Supabase ID (when synced)
  name: string;
  age?: number;
  phone: string;
  husbandName?: string;
  history?: string;
  doctor_id?: string;
  created_at?: string;
  updated_at?: string;
  sync_status: SyncStatus;
  last_sync_attempt?: string;
  sync_error?: string;
}

// Visit interface for local storage
export interface LocalVisit {
  id?: number;
  remoteId?: string;
  patient_id: string;
  department: string;
  visit_date: string;
  clinical_data?: any;
  diagnosis?: string;
  prescription?: any[];
  notes?: string;
  doctor_id?: string;
  created_at?: string;
  updated_at?: string;
  sync_status: SyncStatus;
  last_sync_attempt?: string;
  sync_error?: string;
}

// IVF Cycle interface for local storage
export interface LocalIVFCycle {
  id?: number;
  remoteId?: string;
  patient_id: string;
  protocol: string;
  start_date: string;
  status: string;
  assessment_data?: any;
  lab_data?: any;
  transfer_data?: any;
  outcome_data?: any;
  doctor_id?: string;
  created_at?: string;
  updated_at?: string;
  sync_status: SyncStatus;
  last_sync_attempt?: string;
  sync_error?: string;
}

// Stimulation Log interface for local storage
export interface LocalStimulationLog {
  id?: number;
  remoteId?: string;
  cycle_id: string;
  cycle_day: number;
  date: string;
  fsh?: string;
  hmg?: string;
  e2?: string;
  lh?: string;
  rt_follicles?: string;
  lt_follicles?: string;
  endometrium_thickness?: string;
  created_at?: string;
  updated_at?: string;
  sync_status: SyncStatus;
  last_sync_attempt?: string;
  sync_error?: string;
}

// Pregnancy interface for local storage
export interface LocalPregnancy {
  id?: number;
  remoteId?: string;
  patient_id: string;
  lmp_date?: string;
  edd_date?: string;
  risk_level?: string;
  aspirin_prescribed?: boolean;
  current_status?: string;
  clinical_data?: any;
  doctor_id?: string;
  created_at?: string;
  updated_at?: string;
  sync_status: SyncStatus;
  last_sync_attempt?: string;
  sync_error?: string;
}

// Biometry Scan interface for local storage
export interface LocalBiometryScan {
  id?: number;
  remoteId?: string;
  pregnancy_id: string;
  scan_date: string;
  gestational_age_weeks: number;
  gestational_age_days: number;
  bpd_mm?: number;
  hc_mm?: number;
  ac_mm?: number;
  fl_mm?: number;
  efw_grams?: number;
  percentile?: number;
  notes?: string;
  created_at?: string;
  updated_at?: string;
  sync_status: SyncStatus;
  last_sync_attempt?: string;
  sync_error?: string;
}

// Sync Queue for tracking failed operations
export interface SyncQueueItem {
  id?: number;
  table: string;
  operation: 'create' | 'update' | 'delete';
  localId: number;
  remoteId?: string;
  payload?: any;
  retryCount: number;
  maxRetries: number;
  lastAttempt?: string;
  nextRetry?: string;
  created_at: string;
}

// Define the database class
export class ClinicLocalDB extends Dexie {
  patients!: Table<LocalPatient>;
  visits!: Table<LocalVisit>;
  ivf_cycles!: Table<LocalIVFCycle>;
  stimulation_logs!: Table<LocalStimulationLog>;
  pregnancies!: Table<LocalPregnancy>;
  biometry_scans!: Table<LocalBiometryScan>;
  syncQueue!: Table<SyncQueueItem>;

  constructor() {
    super('ClinicLocalDB');

    this.version(1).stores({
      patients: '++id, remoteId, name, phone, created_at, [sync_status]',
      visits: '++id, remoteId, patient_id, date, [sync_status]',
      ivf_cycles: '++id, remoteId, patient_id, status, [sync_status]',
      stimulation_logs: '++id, remoteId, cycle_id, [sync_status]',
      pregnancies: '++id, remoteId, patient_id, [sync_status]',
      biometry_scans: '++id, remoteId, pregnancy_id, [sync_status]',
      syncQueue: '++id, table, operation, retryCount, created_at'
    });
  }
}

// Create and export database instance
export const db = new ClinicLocalDB();

// Initialize database
export const initLocalDB = async (): Promise<void> => {
  try {
    await db.open();
    console.log('Local database initialized successfully');
  } catch (error) {
    console.error('Failed to open local database, attempting to recreate:', error);
    try {
      // If opening fails, delete and recreate the database
      await db.delete();
      console.log('Deleted corrupted database, recreating...');
      // Recreate the database instance
      const newDb = new ClinicLocalDB();
      Object.assign(db, newDb); // Replace the db instance
      await db.open();
      console.log('Local database recreated successfully');
    } catch (recreateError) {
      console.error('Failed to recreate local database:', recreateError);
      throw recreateError;
    }
  }

  try {
    // Create indexes for better query performance
    await db.patients.hook('creating', (primKey, obj, trans) => {
      if (!obj.created_at) {
        obj.created_at = new Date().toISOString();
      }
      if (!obj.updated_at) {
        obj.updated_at = new Date().toISOString();
      }
    });

    await db.visits.hook('creating', (primKey, obj, trans) => {
      if (!obj.created_at) {
        obj.created_at = new Date().toISOString();
      }
      if (!obj.updated_at) {
        obj.updated_at = new Date().toISOString();
      }
    });

    await db.ivf_cycles.hook('creating', (primKey, obj, trans) => {
      if (!obj.created_at) {
        obj.created_at = new Date().toISOString();
      }
      if (!obj.updated_at) {
        obj.updated_at = new Date().toISOString();
      }
    });

    await db.stimulation_logs.hook('creating', (primKey, obj, trans) => {
      if (!obj.created_at) {
        obj.created_at = new Date().toISOString();
      }
      if (!obj.updated_at) {
        obj.updated_at = new Date().toISOString();
      }
    });

    await db.pregnancies.hook('creating', (primKey, obj, trans) => {
      if (!obj.created_at) {
        obj.created_at = new Date().toISOString();
      }
      if (!obj.updated_at) {
        obj.updated_at = new Date().toISOString();
      }
    });

    await db.biometry_scans.hook('creating', (primKey, obj, trans) => {
      if (!obj.created_at) {
        obj.created_at = new Date().toISOString();
      }
      if (!obj.updated_at) {
        obj.updated_at = new Date().toISOString();
      }
    });

  } catch (hookError) {
    console.error('Failed to set up database hooks:', hookError);
    // Don't throw for hook errors, as database is still usable
  }
};

// Helper functions for database operations
export const getPendingSyncItems = async (table?: string): Promise<SyncQueueItem[]> => {
  if (table) {
    return await db.syncQueue.where('table').equals(table).toArray();
  }
  return await db.syncQueue.toArray();
};

export const addToSyncQueue = async (item: Omit<SyncQueueItem, 'id' | 'created_at'>): Promise<number> => {
  return await db.syncQueue.add({
    ...item,
    created_at: new Date().toISOString()
  });
};

export const removeFromSyncQueue = async (id: number): Promise<void> => {
  await db.syncQueue.delete(id);
};

export const updateSyncQueueItem = async (id: number, updates: Partial<SyncQueueItem>): Promise<void> => {
  await db.syncQueue.update(id, updates);
};

export const markAsSynced = async (table: string, localId: number, remoteId?: string): Promise<void> => {
  const tableMap: { [key: string]: Table } = {
    patients: db.patients,
    visits: db.visits,
    ivf_cycles: db.ivf_cycles,
    stimulation_logs: db.stimulation_logs,
    pregnancies: db.pregnancies,
    biometry_scans: db.biometry_scans
  };

  const targetTable = tableMap[table];
  if (targetTable) {
    const updateData: any = {
      sync_status: SyncStatus.SYNCED,
      last_sync_attempt: new Date().toISOString(),
      sync_error: undefined
    };

    if (remoteId) {
      updateData.remoteId = remoteId;
    }

    await targetTable.update(localId, updateData);
  }
};

export const markSyncError = async (table: string, localId: number, error: string): Promise<void> => {
  const tableMap: { [key: string]: Table } = {
    patients: db.patients,
    visits: db.visits,
    ivf_cycles: db.ivf_cycles,
    stimulation_logs: db.stimulation_logs,
    pregnancies: db.pregnancies,
    biometry_scans: db.biometry_scans
  };

  const targetTable = tableMap[table];
  if (targetTable) {
    await targetTable.update(localId, {
      sync_status: SyncStatus.ERROR,
      last_sync_attempt: new Date().toISOString(),
      sync_error: error
    });
  }
};

export const getUnsyncedRecords = async (table: string): Promise<any[]> => {
  const tableMap: { [key: string]: Table } = {
    patients: db.patients,
    visits: db.visits,
    ivf_cycles: db.ivf_cycles,
    stimulation_logs: db.stimulation_logs,
    pregnancies: db.pregnancies,
    biometry_scans: db.biometry_scans
  };

  const targetTable = tableMap[table];
  if (targetTable) {
    return await targetTable.where('sync_status').above(SyncStatus.SYNCED).toArray();
  }
  return [];
};

export const getSyncStats = async (): Promise<{
  total: number;
  synced: number;
  pending: number;
  errors: number;
}> => {
  const [patients, visits, cycles, logs, pregnancies, biometryScans] = await Promise.all([
    db.patients.toArray(),
    db.visits.toArray(),
    db.ivf_cycles.toArray(),
    db.stimulation_logs.toArray(),
    db.pregnancies.toArray(),
    db.biometry_scans.toArray()
  ]);

  const allRecords = [...patients, ...visits, ...cycles, ...logs, ...pregnancies, ...biometryScans];

  return {
    total: allRecords.length,
    synced: allRecords.filter(r => r.sync_status === SyncStatus.SYNCED).length,
    pending: allRecords.filter(r => r.sync_status > SyncStatus.SYNCED && r.sync_status < SyncStatus.ERROR).length,
    errors: allRecords.filter(r => r.sync_status === SyncStatus.ERROR).length
  };
};
</file>

<file path="styles.css">
body {
  font-family: 'Tajawal', sans-serif;
  background-color: #f3f4f6;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Bottom Navigation Scrollbar Styles */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}
.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.pb-safe {
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.print-only {
  display: none;
}

@media print {
  body, html {
    background: white !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    height: 100% !important;
  }

  .no-print {
    display: none !important;
  }

  .print-only {
    display: block !important;
    position: relative !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 32px !important;
    background: white !important;
  }

  #root {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .print-only * {
    background: white !important;
    color: #000 !important;
  }

  .print-only h1,
  .print-only h2,
  .print-only h3 {
    margin-top: 0 !important;
    page-break-after: avoid !important;
  }
}
</file>

<file path="components/PrescriptionComponent.tsx">
import React, { useState, useRef, useEffect } from 'react';
import { Plus, Trash2, Pill, Printer, ChevronDown } from 'lucide-react';
import { PrescriptionItem } from '../types';
import { EGYPTIAN_MARKET_DRUGS, DrugEntry, searchDrugs, getDrugsByCategory, getAllDrugs } from '../data/egyptian_drugs';

interface PrescriptionComponentProps {
  prescriptions: PrescriptionItem[];
  onPrescriptionsChange: (prescriptions: PrescriptionItem[]) => void;
  onPrint?: () => void;
  showPrintButton?: boolean;
}

const PrescriptionComponent: React.FC<PrescriptionComponentProps> = ({
  prescriptions,
  onPrescriptionsChange,
  onPrint,
  showPrintButton = false
}) => {
  const [searchQuery, setSearchQuery] = useState<string>('');
  const [isDropdownOpen, setIsDropdownOpen] = useState<boolean>(false);
  const [highlightedIndex, setHighlightedIndex] = useState<number>(-1);
  const [customDose, setCustomDose] = useState<string>('');
  const inputRef = useRef<HTMLInputElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Get suggestions based on search query
  const getSuggestions = (): DrugEntry[] => {
    if (!searchQuery.trim()) {
      // Show common categories when no search query
      const commonCategories = ['Antibiotics', 'Analgesics', 'Pregnancy Supplements', 'Luteal Support'];
      return commonCategories.flatMap(category => getDrugsByCategory(category).slice(0, 3));
    }
    return searchDrugs(searchQuery);
  };

  const suggestions = getSuggestions();

  // Handle keyboard navigation
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isDropdownOpen) return;

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          setHighlightedIndex(prev =>
            prev < suggestions.length - 1 ? prev + 1 : prev
          );
          break;
        case 'ArrowUp':
          e.preventDefault();
          setHighlightedIndex(prev => prev > 0 ? prev - 1 : -1);
          break;
        case 'Enter':
          e.preventDefault();
          if (highlightedIndex >= 0 && highlightedIndex < suggestions.length) {
            handleSelectDrug(suggestions[highlightedIndex]);
          }
          break;
        case 'Escape':
          setIsDropdownOpen(false);
          setHighlightedIndex(-1);
          break;
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [isDropdownOpen, highlightedIndex, suggestions]);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node) &&
          inputRef.current && !inputRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false);
        setHighlightedIndex(-1);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleSelectDrug = (drug: DrugEntry) => {
    const dose = customDose || drug.dose;

    const newPrescription: PrescriptionItem = {
      category: drug.category,
      drug: drug.tradeName,
      dose: dose
    };

    onPrescriptionsChange([...prescriptions, newPrescription]);

    // Reset form
    setSearchQuery('');
    setCustomDose('');
    setIsDropdownOpen(false);
    setHighlightedIndex(-1);
  };

  const highlightMatch = (text: string, query: string) => {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    const parts = text.split(regex);
    return parts.map((part, index) =>
      regex.test(part) ? <mark key={index} className="bg-yellow-200">{part}</mark> : part
    );
  };

  const handleRemoveDrug = (index: number) => {
    const updatedPrescriptions = prescriptions.filter((_, i) => i !== index);
    onPrescriptionsChange(updatedPrescriptions);
  };

  const handleUpdateDose = (index: number, newDose: string) => {
    const updatedPrescriptions = prescriptions.map((prescription, i) =>
      i === index ? { ...prescription, dose: newDose } : prescription
    );
    onPrescriptionsChange(updatedPrescriptions);
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Pill className="w-5 h-5 text-purple-600" />
          <h3 className="text-lg font-semibold text-gray-900">Prescription</h3>
        </div>
        {showPrintButton && prescriptions.length > 0 && onPrint && (
          <button
            onClick={onPrint}
            className="flex items-center gap-2 px-3 py-1 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm transition-colors"
          >
            <Printer className="w-4 h-4" />
            Print Prescription
          </button>
        )}
      </div>

      {/* Smart Combobox */}
      <div className="relative">
        <div className="relative">
          <input
            ref={inputRef}
            type="text"
            placeholder="Search for medication... (e.g., Augmentin, Paracetamol)"
            value={searchQuery}
            onChange={(e) => {
              setSearchQuery(e.target.value);
              setIsDropdownOpen(true);
              setHighlightedIndex(-1);
            }}
            onFocus={() => setIsDropdownOpen(true)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent pr-10"
          />
          <ChevronDown
            className={`absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 transition-transform ${
              isDropdownOpen ? 'rotate-180' : ''
            }`}
          />
        </div>

        {/* Dropdown */}
        {isDropdownOpen && (
          <div
            ref={dropdownRef}
            className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
          >
            {suggestions.length > 0 ? (
              suggestions.map((drug, index) => (
                <div
                  key={`${drug.tradeName}-${index}`}
                  onClick={() => handleSelectDrug(drug)}
                  className={`px-4 py-3 cursor-pointer border-b border-gray-100 last:border-b-0 hover:bg-purple-50 ${
                    index === highlightedIndex ? 'bg-purple-100' : ''
                  }`}
                >
                  <div className="font-medium text-gray-900">
                    {highlightMatch(drug.tradeName, searchQuery)}
                  </div>
                  <div className="text-sm text-gray-600">
                    {highlightMatch(drug.active, searchQuery)} ({drug.category})
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {drug.dose}
                  </div>
                </div>
              ))
            ) : searchQuery ? (
              <div className="px-4 py-3 text-gray-500 text-center">
                No medications found for "{searchQuery}"
              </div>
            ) : (
              <div className="px-4 py-3 text-gray-500 text-center">
                Start typing to search medications...
              </div>
            )}
          </div>
        )}
      </div>

      {/* Custom Dose Input (shown when there's a search query) */}
      {searchQuery && (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Custom Dose (optional - leave empty for standard dose)
          </label>
          <input
            type="text"
            value={customDose}
            onChange={(e) => setCustomDose(e.target.value)}
            placeholder="e.g., 1 tablet twice daily after meals"
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
          />
        </div>
      )}

      {/* Current Prescriptions */}
      <div className="space-y-3">
        <h4 className="font-medium text-gray-900">Current Prescriptions</h4>

        {prescriptions.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <Pill className="w-12 h-12 mx-auto mb-4 text-gray-300" />
            <p>No medications prescribed yet</p>
          </div>
        ) : (
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {prescriptions.map((prescription, index) => (
              <div key={index} className="bg-white border border-gray-200 rounded-lg p-3">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="font-semibold text-gray-900">{prescription.drug}</div>
                    <div className="text-sm text-purple-600 mt-1">{prescription.category}</div>
                    <input
                      type="text"
                      value={prescription.dose}
                      onChange={(e) => handleUpdateDose(index, e.target.value)}
                      className="w-full mt-2 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500"
                      placeholder="Enter dose..."
                    />
                  </div>
                  <button
                    onClick={() => handleRemoveDrug(index)}
                    className="text-red-500 hover:text-red-700 ml-2"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default PrescriptionComponent;
</file>

<file path="components/PrescriptionPrinter.tsx">
import React, { useState, useEffect, useRef } from 'react';
import { Printer, X } from 'lucide-react';
import { PrescriptionItem, Patient, Doctor } from '../types';
import { authService } from '../services/authService';
import { useBranding } from '../context/BrandingContext';
import toast from 'react-hot-toast';

interface PrescriptionPrinterProps {
  patient: Patient | null;
  prescriptions: PrescriptionItem[];
  diagnosis?: string;
  notes?: string;
  isOpen: boolean;
  onClose: () => void;
}

const PrescriptionPrinter: React.FC<PrescriptionPrinterProps> = ({
  patient,
  prescriptions,
  diagnosis,
  notes,
  isOpen,
  onClose
}) => {
  const { branding } = useBranding();
  const [doctor, setDoctor] = useState<Doctor | null>(null);
  const printRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (isOpen) {
      fetchDoctorInfo();
    }
  }, [isOpen]);

  const fetchDoctorInfo = async () => {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        const doctorData = await authService.getDoctorProfile(user.id);
        setDoctor(doctorData);
      }
    } catch (error) {
      console.error('Error fetching doctor info:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
    }
  };

  const handlePrint = () => {
    const printContent = printRef.current;
    if (!printContent) return;

    const printWindow = window.open('', '', 'height=800,width=1000');
    if (!printWindow) {
      toast.error('ŸÅÿ¥ŸÑ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©');
      return;
    }

    const styles = `
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; padding: 20px; }
        .prescription-container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border: 1px solid #ddd; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2d5a6b; padding-bottom: 20px; margin-bottom: 30px; }
        .clinic-info { flex: 1; }
        .clinic-name { font-size: 24px; font-weight: bold; color: #2d5a6b; margin-bottom: 8px; }
        .clinic-details { font-size: 12px; color: #666; line-height: 1.8; }
        .logo-area { flex: 1; text-align: right; color: #2d5a6b; font-weight: bold; font-size: 14px; }
        .patient-doctor-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .info-block { }
        .info-label { font-weight: bold; color: #2d5a6b; font-size: 13px; margin-bottom: 5px; }
        .info-value { font-size: 14px; color: #333; }
        .rx-title { font-size: 18px; font-weight: bold; color: #2d5a6b; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .prescriptions-list { margin-bottom: 30px; }
        .prescription-item { background: #f9f9f9; border: 1px solid #e0e0e0; padding: 12px 15px; margin-bottom: 10px; border-radius: 4px; }
        .prescription-number { display: inline-block; background: #2d5a6b; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-weight: bold; margin-right: 10px; font-size: 12px; }
        .prescription-content { margin-left: 38px; }
        .drug-name { font-weight: bold; font-size: 14px; color: #333; }
        .drug-dose { font-size: 12px; color: #666; margin-top: 3px; }
        .drug-category { font-size: 11px; color: #999; margin-top: 3px; }
        .diagnosis-section, .notes-section { margin-bottom: 25px; padding: 15px; background: #f5f5f5; border-left: 4px solid #2d5a6b; }
        .section-title { font-weight: bold; color: #2d5a6b; margin-bottom: 8px; font-size: 13px; text-transform: uppercase; }
        .section-content { color: #333; font-size: 13px; line-height: 1.6; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .signature-box { }
        .signature-label { font-size: 12px; font-weight: bold; color: #666; margin-top: 40px; border-top: 1px solid #333; padding-top: 5px; text-align: center; }
        .date-time { font-size: 12px; color: #666; margin-top: 15px; text-align: center; }
        @media print {
          body { padding: 0; }
          .prescription-container { border: none; padding: 0; }
        }
      </style>
    `;

    const content = printContent.innerHTML;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>ÿ±Ÿàÿ¥ÿ™ÿ© ÿ∑ÿ®Ÿäÿ©</title>
          ${styles}
        </head>
        <body>
          ${content}
        </body>
      </html>
    `);

    printWindow.document.close();
    setTimeout(() => {
      printWindow.print();
    }, 250);
  };

  const getCurrentDateTime = () => {
    const now = new Date();
    return {
      date: now.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }),
      time: now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })
    };
  };

  const { date, time } = getCurrentDateTime();

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-teal-600 text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</h2>
          <button
            onClick={onClose}
            className="hover:bg-teal-700 p-2 rounded-lg transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content */}
        <div className="p-6">
          <div ref={printRef} className="prescription-container">
            {/* Header */}
            <div className="header">
              <div className="clinic-info">
                <div className="clinic-name">
                  {branding?.clinic_name || 'ÿπŸäÿßÿØÿ© ŸÖÿ™ÿÆÿµÿµÿ©'}
                </div>
                <div className="clinic-details">
                  {branding?.clinic_address && <div>{branding.clinic_address}</div>}
                  {branding?.clinic_phone && <div>ÿ™: {branding.clinic_phone}</div>}
                  {doctor?.email && <div>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: {doctor.email}</div>}
                </div>
              </div>
              <div className="logo-area">
                {branding?.logo_url ? (
                  <img src={branding.logo_url} alt="Logo" style={{ maxWidth: '80px', maxHeight: '80px' }} />
                ) : (
                  '‚Ñú'
                )}
              </div>
            </div>

            {/* Patient & Doctor Info */}
            <div className="patient-doctor-section">
              <div className="info-block">
                <div className="info-label">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©</div>
                <div className="info-value">{patient?.name || 'N/A'}</div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  ÿßŸÑÿπŸÖÿ±: {patient?.age || 'N/A'} ÿ≥ŸÜÿ©
                </div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  ÿßŸÑŸáÿßÿ™ŸÅ: {patient?.phone || 'N/A'}
                </div>
              </div>
              <div className="info-block">
                <div className="info-label">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®</div>
                <div className="info-value">{doctor?.name || 'N/A'}</div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  {doctor?.specialization || ''}
                </div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  {date} - {time}
                </div>
              </div>
            </div>

            {/* Diagnosis */}
            {diagnosis && (
              <div className="diagnosis-section">
                <div className="section-title">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ</div>
                <div className="section-content">{diagnosis}</div>
              </div>
            )}

            {/* Prescriptions */}
            {prescriptions.length > 0 && (
              <>
                <div className="rx-title">ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</div>
                <div className="prescriptions-list">
                  {prescriptions.map((prescription, index) => (
                    <div key={index} className="prescription-item">
                      <span className="prescription-number">{index + 1}</span>
                      <div className="prescription-content">
                        <div className="drug-name">{prescription.drug}</div>
                        <div className="drug-dose">
                          {prescription.dose || 'ÿßŸÑÿ¨ÿ±ÿπÿ© ÿßŸÑŸÇŸäÿßÿ≥Ÿäÿ©'}
                        </div>
                        <div className="drug-category">ÿßŸÑÿ™ÿµŸÜŸäŸÅ: {prescription.category}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {/* Notes */}
            {notes && (
              <div className="notes-section">
                <div className="section-title">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</div>
                <div className="section-content">{notes}</div>
              </div>
            )}

            {/* Footer */}
            <div className="footer">
              <div className="signature-box">
                <div className="signature-label">ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿ∑ÿ®Ÿäÿ®</div>
              </div>
              <div className="signature-box">
                <div className="signature-label">ÿ™ŸàŸÇŸäÿπ ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©</div>
              </div>
            </div>

            {/* System Signature */}
            <div style={{
              marginTop: '30px',
              paddingTop: '15px',
              borderTop: '1px solid #ccc',
              fontSize: '10px',
              color: '#999',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div>
                {branding?.clinic_address && <div>{branding.clinic_address}</div>}
                {branding?.clinic_phone && <div>Tel: {branding.clinic_phone}</div>}
              </div>
              <div style={{ textAlign: 'right' }}>
                System developed by Dr. Mohamed Salah Gabr
              </div>
            </div>

            {/* Date Time */}
            <div className="date-time">
              ÿ™ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: {date} ŸÅŸä {time}
            </div>
          </div>

          {/* Print Button */}
          <div className="mt-6 flex gap-3 justify-end sticky bottom-0 bg-gray-50 p-4 rounded-b-lg">
            <button
              onClick={onClose}
              className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            >
              ÿ•ÿ∫ŸÑÿßŸÇ
            </button>
            <button
              onClick={handlePrint}
              className="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors flex items-center gap-2"
            >
              <Printer className="w-4 h-4" />
              ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PrescriptionPrinter;
</file>

<file path="context/BrandingContext.tsx">
import React, { createContext, useContext, useState, useEffect } from 'react';
import { supabase } from '../services/supabaseClient';
import { authService } from '../services/authService';

interface BrandingSettings {
  id: number;
  clinic_name: string;
  logo_url: string | null;
  clinic_address: string | null;
  clinic_phone: string | null;
  primary_color: string;
  secondary_color: string;
  accent_color: string;
  default_rx_notes: string | null;
  updated_at: string;
}

interface BrandingContextType {
  branding: BrandingSettings | null;
  loading: boolean;
  error: string | null;
  updateBranding: (updates: Partial<BrandingSettings>, logoFile?: File) => Promise<void>;
  refreshBranding: () => Promise<void>;
}

const BrandingContext = createContext<BrandingContextType | undefined>(undefined);

export const BrandingProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [branding, setBranding] = useState<BrandingSettings | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchBranding = async () => {
    try {
      setLoading(true);
      setError(null);

      const { data, error: fetchError } = await supabase
        .from('app_settings')
        .select('*')
        .eq('id', 1)
        .single();

      if (fetchError) throw fetchError;

      setBranding(data || getDefaultBranding());
    } catch (err) {
      console.error('Failed to fetch branding:', err);
      setError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ©');
      setBranding(getDefaultBranding());
    } finally {
      setLoading(false);
    }
  };

  const getDefaultBranding = (): BrandingSettings => ({
    id: 1,
    clinic_name: 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±',
    logo_url: null,
    clinic_address: null,
    clinic_phone: null,
    primary_color: '#2d5a6b',
    secondary_color: '#00838f',
    accent_color: '#00bcd4',
    default_rx_notes: null,
    updated_at: new Date().toISOString(),
  });

  const updateBranding = async (
    updates: Partial<BrandingSettings>,
    logoFile?: File
  ) => {
    try {
      setError(null);

      let logoUrl = updates.logo_url;

      if (logoFile) {
        try {
          const user = await authService.getCurrentUser();
          if (!user) throw new Error('User not authenticated');

          const fileExt = logoFile.name.split('.').pop();
          const fileName = `clinic_logo_${Date.now()}.${fileExt}`;

          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('branding')
            .upload(fileName, logoFile, { upsert: true });

          if (uploadError) {
            console.error('Upload error:', uploadError);
            throw new Error('ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±: ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° bucket "branding" ŸÅŸä Supabase Storage');
          }

          const { data: urlData } = supabase.storage
            .from('branding')
            .getPublicUrl(fileName);

          logoUrl = urlData.publicUrl;
        } catch (uploadErr: any) {
          console.error('Logo upload failed:', uploadErr);
          throw uploadErr;
        }
      }

      const updateData = {
        clinic_name: updates.clinic_name ?? branding?.clinic_name,
        clinic_address: updates.clinic_address ?? branding?.clinic_address,
        clinic_phone: updates.clinic_phone ?? branding?.clinic_phone,
        primary_color: updates.primary_color ?? branding?.primary_color,
        secondary_color: updates.secondary_color ?? branding?.secondary_color,
        accent_color: updates.accent_color ?? branding?.accent_color,
        default_rx_notes: updates.default_rx_notes ?? branding?.default_rx_notes,
        ...(logoUrl && { logo_url: logoUrl }),
        updated_at: new Date().toISOString(),
      };

      setBranding(prev => prev ? { ...prev, ...updateData } : null);

      const { data, error: updateError } = await supabase
        .from('app_settings')
        .update(updateData)
        .eq('id', 1)
        .select()
        .single();

      if (updateError) {
        console.error('Update error:', updateError);
        throw updateError;
      }

      if (data) {
        setBranding(data);
      }
    } catch (err) {
      console.error('Failed to update branding:', err);
      setError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ©');
      throw err;
    }
  };

  const refreshBranding = async () => {
    await fetchBranding();
  };

  useEffect(() => {
    fetchBranding();
  }, []);

  return (
    <BrandingContext.Provider
      value={{
        branding: branding || getDefaultBranding(),
        loading,
        error,
        updateBranding,
        refreshBranding,
      }}
    >
      {children}
    </BrandingContext.Provider>
  );
};

export const useBranding = (): BrandingContextType => {
  const context = useContext(BrandingContext);
  if (context === undefined) {
    throw new Error('useBranding must be used within a BrandingProvider');
  }
  return context;
};
</file>

<file path="electron/main.js">
const { app, BrowserWindow, ipcMain } = require('electron');
const path = require('path');

// ŸÖŸÜÿπ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÇŸÅ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ (ŸÅŸä ŸÖÿßŸÉ)
let mainWindow;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1280,
    height: 800,
    minWidth: 1024,
    minHeight: 768,
    title: "Nile IVF Center EMR",
    webPreferences: {
      nodeIntegration: false, // ŸÑŸÑÿ£ŸÖÿßŸÜ
      contextIsolation: true, // ŸÑŸÑÿ£ŸÖÿßŸÜ
      preload: path.join(__dirname, 'preload.js')
    },
    // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿπŸÑŸàŸä ŸÑŸÖÿ∏Ÿáÿ± ÿ£ŸÉÿ´ÿ± ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©
    autoHideMenuBar: true 
  });

  // ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑŸÖÿ≠ŸÑŸä
  // ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ (ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≥ÿ∑Ÿäÿ®)ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ index.html
  const isDev = !app.isPackaged;
  
  if (isDev) {
    mainWindow.loadURL('http://localhost:5173');
    // ŸÅÿ™ÿ≠ ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
    // mainWindow.webContents.openDevTools();
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));
  }
}

app.whenReady().then(() => {
  createWindow();

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

// ŸáŸÜÿß ÿ≥ŸÜÿ∂ŸäŸÅ ŸÑÿßÿ≠ŸÇÿßŸã (IPC Handlers) ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ∑ÿ®ÿßÿπÿ©
// ŸÖÿ´ÿßŸÑ:
// ipcMain.handle('save-patient', async (event, data) => { ... })
</file>

<file path="pages/AdminDashboard.tsx">
import React, { useState, useEffect } from 'react';
import {
  Settings, Palette, FileText, Database, Upload, Save, AlertCircle,
  CheckCircle, Loader, Trash2, Edit2, X
} from 'lucide-react';
import toast from 'react-hot-toast';
import { useBranding } from '../context/BrandingContext';
import { supabase } from '../services/supabaseClient';
import { EGYPTIAN_DRUGS } from '../constants';

interface TabState {
  active: 'branding' | 'prescription' | 'records';
}

const AdminDashboard: React.FC = () => {
  const { branding, updateBranding, loading: brandingLoading } = useBranding();
  const [activeTab, setActiveTab] = useState<'branding' | 'prescription' | 'records'>('branding');
  const [saving, setSaving] = useState(false);
  const [logoPreview, setLogoPreview] = useState<string | null>(null);

  const [brandingData, setBrandingData] = useState({
    clinic_name: '',
    clinic_address: '',
    clinic_phone: '',
    primary_color: '#2d5a6b',
    secondary_color: '#00838f',
    accent_color: '#00bcd4',
  });

  const [prescriptionDefaults, setPrescriptionDefaults] = useState({
    instructions: '',
    defaultCategory: 'Vitamins & Supplements',
  });

  const [records, setRecords] = useState<any[]>([]);
  const [recordsLoading, setRecordsLoading] = useState(false);

  useEffect(() => {
    if (branding) {
      setBrandingData({
        clinic_name: branding.clinic_name,
        clinic_address: branding.clinic_address || '',
        clinic_phone: branding.clinic_phone || '',
        primary_color: branding.primary_color,
        secondary_color: branding.secondary_color,
        accent_color: branding.accent_color,
      });
      if (branding.logo_url) {
        setLogoPreview(branding.logo_url);
      }
    }
  }, [branding]);

  const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setLogoPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleBrandingSave = async () => {
    try {
      setSaving(true);
      const fileInput = document.querySelector('[type="file"]') as HTMLInputElement;
      const logoFile = fileInput?.files?.[0];
      
      if (!brandingData.clinic_name.trim()) {
        toast.error('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸäÿßÿØÿ©');
        return;
      }

      await updateBranding(
        {
          clinic_name: brandingData.clinic_name,
          clinic_address: brandingData.clinic_address,
          clinic_phone: brandingData.clinic_phone,
          primary_color: brandingData.primary_color,
          secondary_color: brandingData.secondary_color,
          accent_color: brandingData.accent_color,
        },
        logoFile
      );

      toast.success('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      if (fileInput) fileInput.value = '';
    } catch (error: any) {
      console.error('Error saving branding:', error);
      const errorMsg = error?.message || 'ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™';
      toast.error(errorMsg);
    } finally {
      setSaving(false);
    }
  };

  const loadRecords = async () => {
    try {
      setRecordsLoading(true);
      const { data, error } = await supabase
        .from('visits')
        .select('id, date, patient_id, diagnosis, department')
        .order('date', { ascending: false })
        .limit(50);

      if (error) {
        console.error('Error loading records:', error);
        throw error;
      }
      setRecords(data || []);
    } catch (error: any) {
      console.error('Error loading records:', error);
      const errorMsg = error?.message || 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ¨ÿØŸàŸÑ visits ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™';
      toast.error(errorMsg);
    } finally {
      setRecordsLoading(false);
    }
  };

  useEffect(() => {
    if (activeTab === 'records') {
      loadRecords();
    }
  }, [activeTab]);

  const deleteRecord = async (id: string) => {
    if (!window.confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑÿü')) return;

    try {
      const { error } = await supabase
        .from('visits')
        .delete()
        .eq('id', id);

      if (error) throw error;

      setRecords(records.filter(r => r.id !== id));
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error deleting record:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ');
    }
  };

  return (
    <div className="space-y-6" dir="rtl">
      {/* Header */}
      <div className="flex items-center gap-3 mb-8">
        <div className="p-3 bg-indigo-100 rounded-lg">
          <Settings className="w-8 h-8 text-indigo-600" />
        </div>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ•ÿØÿßÿ±ÿ©</h1>
          <p className="text-gray-600">ÿ•ÿØÿßÿ±ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸàÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ© ŸàÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</p>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="flex gap-2 border-b border-gray-200">
        <button
          onClick={() => setActiveTab('branding')}
          className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors ${
            activeTab === 'branding'
              ? 'border-b-2 border-indigo-600 text-indigo-600'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <Palette size={20} />
          ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ™ÿµŸÖŸäŸÖ
        </button>
        <button
          onClick={() => setActiveTab('prescription')}
          className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors ${
            activeTab === 'prescription'
              ? 'border-b-2 border-indigo-600 text-indigo-600'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <FileText size={20} />
          ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©
        </button>
        <button
          onClick={() => setActiveTab('records')}
          className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors ${
            activeTab === 'records'
              ? 'border-b-2 border-indigo-600 text-indigo-600'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <Database size={20} />
          ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
        </button>
      </div>

      {/* Content */}
      <div className="bg-white rounded-lg shadow-md p-8">
        {/* Branding Tab */}
        {activeTab === 'branding' && (
          <div className="space-y-6">
            {/* Setup Guide */}
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-3">
              <h3 className="font-semibold text-amber-900 flex items-center gap-2">
                <AlertCircle className="w-5 h-5" />
                ÿ•ÿπÿØÿßÿØ ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ¥ÿπÿßÿ±
              </h3>
              <div className="text-sm text-amber-800 space-y-2">
                <p>ŸÑÿ™ŸÖŸÉŸäŸÜ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±ÿßÿ™ÿå ÿ™ÿßÿ®ÿπ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿ∑Ÿàÿßÿ™:</p>
                <ol className="list-decimal list-inside space-y-1 ml-2">
                  <li>ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ <strong>Supabase Dashboard ‚Üí Storage</strong></li>
                  <li>ÿßŸÜŸÇÿ± ÿπŸÑŸâ <strong>Create new bucket</strong></li>
                  <li>ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ: <code className="bg-amber-100 px-2 py-1 rounded">branding</code></li>
                  <li>ÿßÿÆÿ™ÿ± <strong>Public bucket</strong></li>
                  <li>ÿßŸÜŸÇÿ± <strong>Create bucket</strong></li>
                </ol>
              </div>
            </div>
            <div className="grid md:grid-cols-2 gap-6">
              {/* Clinic Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤ / ÿßŸÑÿπŸäÿßÿØÿ©
                </label>
                <input
                  type="text"
                  value={brandingData.clinic_name}
                  onChange={(e) => setBrandingData(prev => ({
                    ...prev,
                    clinic_name: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ŸÖÿ´ÿßŸÑ: ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±"
                />
              </div>

              {/* Clinic Phone */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
                </label>
                <input
                  type="tel"
                  value={brandingData.clinic_phone}
                  onChange={(e) => setBrandingData(prev => ({
                    ...prev,
                    clinic_phone: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ŸÖÿ´ÿßŸÑ: 201001234567+"
                />
              </div>

              {/* Clinic Address */}
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿßŸÑÿπŸÜŸàÿßŸÜ
                </label>
                <textarea
                  value={brandingData.clinic_address}
                  onChange={(e) => setBrandingData(prev => ({
                    ...prev,
                    clinic_address: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸäÿßÿØÿ©"
                  rows={3}
                />
              </div>
            </div>

            {/* Logo Upload */}
            <div className="border-t pt-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <Upload size={20} />
                ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸäÿßÿØÿ©
              </h3>
              <div className="grid md:grid-cols-2 gap-6">
                {/* Upload Area */}
                <div>
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors cursor-pointer">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleLogoUpload}
                      className="hidden"
                      id="logo-upload"
                    />
                    <label htmlFor="logo-upload" className="cursor-pointer">
                      <Upload className="w-12 h-12 text-gray-400 mx-auto mb-2" />
                      <p className="text-sm text-gray-600">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</p>
                      <p className="text-xs text-gray-500">PNG, JPG, GIF (ÿ≠ÿØ ÿ£ŸÇÿµŸâ 5 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™)</p>
                    </label>
                  </div>
                </div>

                {/* Preview */}
                {logoPreview && (
                  <div className="flex flex-col items-center justify-center">
                    <div className="bg-gray-50 rounded-lg p-4 w-full">
                      <img
                        src={logoPreview}
                        alt="Logo Preview"
                        className="w-32 h-32 object-contain mx-auto"
                      />
                    </div>
                    <p className="text-sm text-gray-600 mt-2">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±</p>
                  </div>
                )}
              </div>
            </div>

            {/* Colors */}
            <div className="border-t pt-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">ÿßŸÑÿ£ŸÑŸàÿßŸÜ</h3>
              <div className="grid md:grid-cols-3 gap-6">
                {/* Primary Color */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
                  </label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={brandingData.primary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        primary_color: e.target.value
                      }))}
                      className="w-12 h-12 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      value={brandingData.primary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        primary_color: e.target.value
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>

                {/* Secondary Color */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ´ÿßŸÜŸàŸä
                  </label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={brandingData.secondary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        secondary_color: e.target.value
                      }))}
                      className="w-12 h-12 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      value={brandingData.secondary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        secondary_color: e.target.value
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>

                {/* Accent Color */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ŸÑŸàŸÜ ÿßŸÑÿ™ŸÖŸäŸäÿ≤
                  </label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={brandingData.accent_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        accent_color: e.target.value
                      }))}
                      className="w-12 h-12 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      value={brandingData.accent_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        accent_color: e.target.value
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Save Button */}
            <div className="flex gap-4 pt-6 border-t">
              <button
                onClick={handleBrandingSave}
                disabled={saving || brandingLoading}
                className="flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white rounded-lg font-medium transition-colors"
              >
                {saving ? (
                  <>
                    <Loader size={18} className="animate-spin" />
                    ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...
                  </>
                ) : (
                  <>
                    <Save size={18} />
                    ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                  </>
                )}
              </button>
            </div>
          </div>
        )}

        {/* Prescription Tab */}
        {activeTab === 'prescription' && (
          <div className="space-y-6">
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex gap-3">
              <AlertCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
              <div>
                <h4 className="font-semibold text-blue-900">ŸÖÿπŸÑŸàŸÖÿ©</h4>
                <p className="text-sm text-blue-700">
                  Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ŸäŸÖŸÉŸÜŸÉ ŸáŸÜÿß ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ±Ÿàÿ¥ÿ™ÿßÿ™.
                </p>
              </div>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿßŸÑŸÅÿ¶ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ£ÿØŸàŸäÿ©
                </label>
                <select
                  value={prescriptionDefaults.defaultCategory}
                  onChange={(e) => setPrescriptionDefaults(prev => ({
                    ...prev,
                    defaultCategory: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                  {Object.keys(EGYPTIAN_DRUGS).map(category => (
                    <option key={category} value={category}>
                      {category}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ±Ÿàÿ¥ÿ™ÿ©
                </label>
                <textarea
                  value={prescriptionDefaults.instructions}
                  onChange={(e) => setPrescriptionDefaults(prev => ({
                    ...prev,
                    instructions: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ŸÖÿ´ÿßŸÑ: ÿßÿ™ÿ®ÿπ ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ®ÿØŸÇÿ©... ÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿØŸàÿßÿ° ŸÖÿπ ÿßŸÑÿ∑ÿπÿßŸÖ..."
                  rows={4}
                />
              </div>

              <button
                onClick={() => {
                  toast.success('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©');
                }}
                className="flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
              >
                <Save size={18} />
                ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
              </button>
            </div>

            {/* Available Drugs */}
            <div className="mt-8 border-t pt-8">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h3>
              <div className="grid md:grid-cols-2 gap-4">
                {Object.entries(EGYPTIAN_DRUGS).map(([category, drugs]) => (
                  <div key={category} className="bg-gray-50 rounded-lg p-4">
                    <h4 className="font-semibold text-gray-900 mb-2 text-right">{category}</h4>
                    <ul className="text-sm text-gray-600 space-y-1">
                      {Object.keys(drugs).slice(0, 5).map(drug => (
                        <li key={drug} className="text-right">‚Ä¢ {drug}</li>
                      ))}
                      {Object.keys(drugs).length > 5 && (
                        <li className="text-gray-500">... Ÿà {Object.keys(drugs).length - 5} ÿ£ÿØŸàŸäÿ© ÿ£ÿÆÿ±Ÿâ</li>
                      )}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Records Tab */}
        {activeTab === 'records' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h3 className="text-lg font-semibold text-gray-900">ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ©</h3>
              <button
                onClick={loadRecords}
                className="text-indigo-600 hover:text-indigo-700 text-sm font-medium"
              >
                ‚Üê ÿ™ÿ≠ÿØŸäÿ´
              </button>
            </div>

            {recordsLoading ? (
              <div className="flex items-center justify-center py-12">
                <Loader className="animate-spin w-8 h-8 text-indigo-600" />
              </div>
            ) : records.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑŸÇÿ≥ŸÖ</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {records.map(record => (
                      <tr key={record.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-600">
                          {new Date(record.date).toLocaleDateString('ar-EG')}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600">{record.patient_id}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{record.diagnosis || '-'}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{record.department || 'ÿπÿßŸÖ'}</td>
                        <td className="px-4 py-3 text-sm">
                          <button
                            onClick={() => deleteRecord(record.id)}
                            className="text-red-600 hover:text-red-700 font-medium flex items-center gap-1"
                          >
                            <Trash2 size={16} />
                            ÿ≠ÿ∞ŸÅ
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default AdminDashboard;
</file>

<file path="pages/components/obstetrics/ANCFlowSheet.tsx">
import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Save, X } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import toast from 'react-hot-toast';
import { AntenatalVisit } from '../../../types';
import { obstetricsService, calculateGestationalAge } from '../../../services/obstetricsService';

interface ANCFlowSheetProps {
  pregnancyId: string;
  lmpDate?: string;
}

const ANCFlowSheet: React.FC<ANCFlowSheetProps> = ({ pregnancyId, lmpDate }) => {
  const [visits, setVisits] = useState<AntenatalVisit[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    visit_date: new Date().toISOString().split('T')[0],
    systolic_bp: '',
    diastolic_bp: '',
    weight_kg: '',
    urine_albuminuria: 'negative',
    urine_glycosuria: 'negative',
    fetal_heart_sound: true,
    fundal_height_cm: '',
    edema: false,
    edema_grade: 'none',
    notes: '',
    next_visit_date: '',
  });

  useEffect(() => {
    fetchVisits();
  }, [pregnancyId]);

  const fetchVisits = async () => {
    try {
      setIsLoading(true);
      const data = await obstetricsService.getANCVisits(pregnancyId);
      setVisits(data || []);
    } catch (error) {
      console.error('Error fetching visits:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™');
    } finally {
      setIsLoading(false);
    }
  };

  const handleAddVisit = async () => {
    try {
      if (!formData.visit_date) {
        toast.error('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®');
        return;
      }

      setIsSaving(true);

      let ga = { weeks: 0, days: 0 };
      if (lmpDate && formData.visit_date) {
        try {
          const lmpTimestamp = new Date(lmpDate).getTime();
          const visitTimestamp = new Date(formData.visit_date).getTime();
          if (!isNaN(lmpTimestamp) && !isNaN(visitTimestamp)) {
            const diffTime = Math.abs(visitTimestamp - lmpTimestamp);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            ga = { weeks: Math.max(0, Math.floor(diffDays / 7)), days: Math.max(0, diffDays % 7) };
          }
        } catch (err) {
          console.warn('Error calculating GA:', err);
          ga = { weeks: 0, days: 0 };
        }
      }

      const systolicBP = formData.systolic_bp ? parseInt(formData.systolic_bp) : null;
      const diastolicBP = formData.diastolic_bp ? parseInt(formData.diastolic_bp) : null;
      const weightKg = formData.weight_kg ? parseFloat(formData.weight_kg) : null;
      const fundalHeight = formData.fundal_height_cm ? parseFloat(formData.fundal_height_cm) : null;
      const nextVisitDate = formData.next_visit_date?.trim() || null;

      const visitData = {
        visit_date: formData.visit_date,
        pregnancy_id: pregnancyId,
        gestational_age_weeks: Math.max(0, ga.weeks),
        gestational_age_days: Math.max(0, ga.days),
        systolic_bp: !isNaN(Number(systolicBP)) && systolicBP !== null ? systolicBP : null,
        diastolic_bp: !isNaN(Number(diastolicBP)) && diastolicBP !== null ? diastolicBP : null,
        weight_kg: !isNaN(Number(weightKg)) && weightKg !== null ? weightKg : null,
        urine_albuminuria: formData.urine_albuminuria || 'negative',
        urine_glycosuria: formData.urine_glycosuria || 'negative',
        fetal_heart_sound: Boolean(formData.fetal_heart_sound),
        fundal_height_cm: !isNaN(Number(fundalHeight)) && fundalHeight !== null ? fundalHeight : null,
        edema: Boolean(formData.edema),
        edema_grade: formData.edema_grade || 'none',
        notes: formData.notes?.trim() || '',
        next_visit_date: nextVisitDate,
      };

      if (editingId) {
        await obstetricsService.updateANCVisit(editingId, visitData);
        toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      } else {
        await obstetricsService.createANCVisit(visitData);
        toast.success('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      }

      fetchVisits();
      resetForm();
    } catch (error) {
      console.error('Error saving visit:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©');
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteVisit = async (visitId: string) => {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©ÿü')) return;

    try {
      await obstetricsService.deleteANCVisit(visitId);
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      fetchVisits();
    } catch (error) {
      console.error('Error deleting visit:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©');
    }
  };

  const handleEditVisit = (visit: AntenatalVisit) => {
    setFormData({
      visit_date: visit.visit_date,
      systolic_bp: visit.systolic_bp?.toString() || '',
      diastolic_bp: visit.diastolic_bp?.toString() || '',
      weight_kg: visit.weight_kg?.toString() || '',
      urine_albuminuria: visit.urine_albuminuria || 'negative',
      urine_glycosuria: visit.urine_glycosuria || 'negative',
      fetal_heart_sound: visit.fetal_heart_sound ?? true,
      fundal_height_cm: visit.fundal_height_cm?.toString() || '',
      edema: visit.edema || false,
      edema_grade: visit.edema_grade || 'none',
      notes: visit.notes || '',
      next_visit_date: visit.next_visit_date || '',
    });
    setEditingId(visit.id);
    setShowForm(true);
  };

  const resetForm = () => {
    setFormData({
      visit_date: new Date().toISOString().split('T')[0],
      systolic_bp: '',
      diastolic_bp: '',
      weight_kg: '',
      urine_albuminuria: 'negative',
      urine_glycosuria: 'negative',
      fetal_heart_sound: true,
      fundal_height_cm: '',
      edema: false,
      edema_grade: 'none',
      notes: '',
      next_visit_date: '',
    });
    setEditingId(null);
    setShowForm(false);
  };

  const chartData = visits && Array.isArray(visits)
    ? visits
        .slice()
        .reverse()
        .map(visit => {
          try {
            const visitDate = visit?.visit_date ? new Date(visit.visit_date).toLocaleDateString('ar-EG') : 'Unknown Date';
            return {
              date: visitDate,
              weight: Number(visit?.weight_kg) || 0,
              systolic: Number(visit?.systolic_bp) || 0,
              diastolic: Number(visit?.diastolic_bp) || 0,
            };
          } catch (err) {
            console.warn('Error mapping visit data:', err);
            return { date: 'Error', weight: 0, systolic: 0, diastolic: 0 };
          }
        })
        .filter(d => d.weight > 0 || d.systolic > 0)
    : [];

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-6" dir="ltr">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900 font-[Tajawal]">üìã ANC Flowsheet</h2>
        <button
          onClick={() => setShowForm(!showForm)}
          className="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
        >
          <Plus size={18} />
          Add Visit
        </button>
      </div>

      {showForm && (
        <div className="mb-6 p-6 bg-gray-50 rounded-lg border-2 border-teal-200" dir="ltr">
          <div className="grid md:grid-cols-2 gap-4 mb-4 text-left">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Visit Date
              </label>
              <input
                type="date"
                value={formData.visit_date}
                onChange={(e) => setFormData(prev => ({ ...prev, visit_date: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Weight (kg)
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.weight_kg}
                onChange={(e) => setFormData(prev => ({ ...prev, weight_kg: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Systolic BP (mmHg)
              </label>
              <input
                type="number"
                value={formData.systolic_bp}
                onChange={(e) => setFormData(prev => ({ ...prev, systolic_bp: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Diastolic BP (mmHg)
              </label>
              <input
                type="number"
                value={formData.diastolic_bp}
                onChange={(e) => setFormData(prev => ({ ...prev, diastolic_bp: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Urine Albuminuria
              </label>
              <select
                value={formData.urine_albuminuria}
                onChange={(e) => setFormData(prev => ({ ...prev, urine_albuminuria: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              >
                <option value="negative">ÿ≥ÿßŸÑÿ®</option>
                <option value="trace">ÿ£ÿ´ÿ±</option>
                <option value="1plus">+1</option>
                <option value="2plus">+2</option>
                <option value="3plus">+3</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Urine Glycosuria
              </label>
              <select
                value={formData.urine_glycosuria}
                onChange={(e) => setFormData(prev => ({ ...prev, urine_glycosuria: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              >
                <option value="negative">ÿ≥ÿßŸÑÿ®</option>
                <option value="trace">ÿ£ÿ´ÿ±</option>
                <option value="1plus">+1</option>
                <option value="2plus">+2</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Fundal Height (cm)
              </label>
              <input
                type="number"
                step="0.5"
                value={formData.fundal_height_cm}
                onChange={(e) => setFormData(prev => ({ ...prev, fundal_height_cm: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Next Visit Date
              </label>
              <input
                type="date"
                value={formData.next_visit_date}
                onChange={(e) => setFormData(prev => ({ ...prev, next_visit_date: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>
          </div>

          <div className="flex items-center gap-4 mb-4">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.fetal_heart_sound}
                onChange={(e) => setFormData(prev => ({ ...prev, fetal_heart_sound: e.target.checked }))}
                className="w-4 h-4"
              />
              <span className="text-sm text-gray-700">Fetal Heart Sound (FHS) Detected</span>
            </label>

            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.edema}
                onChange={(e) => setFormData(prev => ({ ...prev, edema: e.target.checked }))}
                className="w-4 h-4"
              />
              <span className="text-sm text-gray-700">Edema Present</span>
            </label>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Clinical Notes
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
              rows={3}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
            />
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleAddVisit}
              disabled={isSaving}
              className="flex items-center gap-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
            >
              <Save size={18} />
              {isSaving ? 'Saving...' : editingId ? 'Update Visit' : 'Add Visit'}
            </button>
            <button
              onClick={resetForm}
              className="flex items-center gap-2 bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
            >
              <X size={18} />
              Cancel
            </button>
          </div>
        </div>
      )}

      {chartData.length > 1 && (
        <div className="mb-6 p-4 bg-gray-50 rounded-lg" dir="ltr">
          <h3 className="text-sm font-bold text-gray-900 mb-4">üìà Weight & BP Trends</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" />
              <YAxis yAxisId="left" />
              <YAxis yAxisId="right" orientation="right" />
              <Tooltip />
              <Legend />
              <Line yAxisId="left" type="monotone" dataKey="weight" stroke="#14b8a6" name="Weight (kg)" />
              <Line yAxisId="right" type="monotone" dataKey="systolic" stroke="#dc2626" name="Systolic BP (mmHg)" />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}

      {isLoading ? (
        <div className="text-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
        </div>
      ) : visits.length > 0 ? (
        <div className="overflow-x-auto" dir="ltr">
          <table className="w-full text-sm text-left">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-4 py-2">Visit Date</th>
                <th className="px-4 py-2">GA (wks+days)</th>
                <th className="px-4 py-2">Weight (kg)</th>
                <th className="px-4 py-2">BP (mmHg)</th>
                <th className="px-4 py-2">Urine Alb</th>
                <th className="px-4 py-2">Fundal Height (cm)</th>
                <th className="px-4 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              {Array.isArray(visits) && visits.map((visit) => {
                try {
                  if (!visit || !visit.id) return null;
                  return (
                    <tr key={visit.id} className="border-b hover:bg-gray-50">
                      <td className="px-4 py-2">
                        {visit?.visit_date ? new Date(visit.visit_date).toLocaleDateString('ar-EG') : '-'}
                      </td>
                      <td className="px-4 py-2">
                        {Number(visit?.gestational_age_weeks) || 0}w+{Number(visit?.gestational_age_days) || 0}d
                      </td>
                      <td className="px-4 py-2">{visit?.weight_kg || '-'}</td>
                      <td className="px-4 py-2">
                        {visit?.systolic_bp && visit?.diastolic_bp
                          ? `${visit.systolic_bp}/${visit.diastolic_bp}`
                          : '-'}
                      </td>
                      <td className="px-4 py-2">{visit?.urine_albuminuria || '-'}</td>
                      <td className="px-4 py-2">{visit?.fundal_height_cm || '-'}</td>
                      <td className="px-4 py-2 flex gap-2">
                        <button
                          onClick={() => handleEditVisit(visit)}
                          className="text-blue-600 hover:text-blue-800 font-semibold"
                        >
                          Edit
                        </button>
                        <button
                          onClick={() => handleDeleteVisit(visit.id)}
                          className="text-red-600 hover:text-red-800"
                        >
                          <Trash2 size={16} />
                        </button>
                      </td>
                    </tr>
                  );
                } catch (err) {
                  console.warn('Error rendering visit row:', err);
                  return null;
                }
              })}
            </tbody>
          </table>
        </div>
      ) : (
        <p className="text-center text-gray-500 py-8">No visits recorded yet</p>
      )}
    </div>
  );
};

export default ANCFlowSheet;
</file>

<file path="pages/components/obstetrics/RiskAssessment.tsx">
import React, { useState } from 'react';
import { ChevronDown, ChevronUp, Save } from 'lucide-react';
import { Pregnancy } from '../../../types';
import { assessRiskLevel, RiskFactors } from '../../../services/obstetricsService';
import toast from 'react-hot-toast';

interface RiskAssessmentProps {
  pregnancy: Pregnancy;
  onUpdate: (updates: Partial<Pregnancy>) => Promise<void>;
}

const RiskAssessment: React.FC<RiskAssessmentProps> = ({ pregnancy, onUpdate }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // Fix the risk factors parsing - ensure we handle null/undefined safely
  const currentFactors = pregnancy.risk_factors || []; // Fallback to empty array
  const initialRiskFactors: RiskFactors = {
    age_over_40: currentFactors.includes('age_over_40'),
    bmi_over_30: currentFactors.includes('bmi_over_30'),
    previous_preeclampsia: currentFactors.includes('previous_preeclampsia'),
    twins: currentFactors.includes('twins'),
    autoimmune: currentFactors.includes('autoimmune'),
    hypertension: currentFactors.includes('hypertension'),
    diabetes: currentFactors.includes('diabetes'),
    kidney_disease: currentFactors.includes('kidney_disease'),
  };

  const [riskFactors, setRiskFactors] = useState<RiskFactors>(initialRiskFactors);
  const riskAssessment = assessRiskLevel(riskFactors);

  const riskFactorOptions = [
    { key: 'age_over_40', label: 'ÿßŸÑÿπŸÖÿ± > 40 ÿ≥ŸÜÿ©' },
    { key: 'bmi_over_30', label: 'ŸÖÿ§ÿ¥ÿ± ŸÉÿ™ŸÑÿ© ÿßŸÑÿ¨ÿ≥ŸÖ > 30' },
    { key: 'previous_preeclampsia', label: 'ÿ™ÿ≥ŸÖŸÖ ÿßŸÑÿ≠ŸÖŸÑ ÿßŸÑÿ≥ÿßÿ®ŸÇ' },
    { key: 'twins', label: 'ÿ≠ŸÖŸÑ ŸÖÿ™ÿπÿØÿØ (ÿ™Ÿàÿ£ŸÖ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±)' },
    { key: 'autoimmune', label: 'ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÖŸÜÿßÿπÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ©' },
    { key: 'hypertension', label: 'ÿßÿ±ÿ™ŸÅÿßÿπ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ' },
    { key: 'diabetes', label: 'ÿßŸÑÿ≥ŸÉÿ±Ÿä' },
    { key: 'kidney_disease', label: 'ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÉŸÑŸâ' },
  ];

  const handleFactorChange = (key: keyof RiskFactors) => {
    setRiskFactors(prev => ({
      ...prev,
      [key]: !prev[key],
    }));
  };

  const handleSave = async () => {
    try {
      setIsSaving(true);
      
      const updatedRiskFactors = Object.keys(riskFactors)
        .filter(key => riskFactors[key as keyof RiskFactors])
        .map(key => key as string);

      if (!Array.isArray(updatedRiskFactors)) {
        throw new Error('Risk factors must be an array');
      }

      await onUpdate({
        risk_factors: updatedRiskFactors || [],
        risk_level: riskAssessment.level,
        aspirin_prescribed: riskAssessment.aspirinNeeded,
        thromboprophylaxis_needed: riskAssessment.thromboprophylaxisNeeded,
      });

      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error saving risk assessment:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ±');
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full flex items-center justify-between text-lg font-bold text-gray-900 hover:text-teal-700 transition-colors font-[Tajawal]"
      >
        <span>‚öñÔ∏è ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿ≠ÿ≥ÿ® RCOG</span>
        {isExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
      </button>

      {isExpanded && (
        <div className="mt-6 space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            {riskFactorOptions.map(option => (
              <label
                key={option.key}
                className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors"
              >
                <input
                  type="checkbox"
                  checked={riskFactors[option.key as keyof RiskFactors]}
                  onChange={() => handleFactorChange(option.key as keyof RiskFactors)}
                  className="w-4 h-4 text-teal-600 rounded cursor-pointer"
                />
                <span className="text-sm text-gray-700 font-[Tajawal]">{option.label}</span>
              </label>
            ))}
          </div>

          <div className="mt-6 p-4 rounded-lg border-2" style={{
            borderColor: riskAssessment.level === 'high' ? '#dc2626' : riskAssessment.level === 'moderate' ? '#f97316' : '#16a34a',
            backgroundColor: riskAssessment.level === 'high' ? '#fef2f2' : riskAssessment.level === 'moderate' ? '#fff7ed' : '#f0fdf4',
          }}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-lg font-[Tajawal]" style={{
                color: riskAssessment.level === 'high' ? '#991b1b' : riskAssessment.level === 'moderate' ? '#9a3412' : '#166534',
              }}>
                {riskAssessment.level === 'high' && 'üî¥ ÿ≠ŸÖŸÑ ÿπÿßŸÑŸä ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©'}
                {riskAssessment.level === 'moderate' && 'üü° ÿ≠ŸÖŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©'}
                {riskAssessment.level === 'low' && 'üü¢ ÿ≠ŸÖŸÑ ŸÖŸÜÿÆŸÅÿ∂ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©'}
              </h3>
            </div>

            {riskAssessment.riskFactorsList.length > 0 && (
              <div className="mb-3">
                <p className="text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿπŸàÿßŸÖŸÑ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©:</p>
                <ul className="list-disc list-inside space-y-1">
                  {riskAssessment.riskFactorsList.map((factor, idx) => (
                    <li key={idx} className="text-sm text-gray-700 font-[Tajawal]">{factor}</li>
                  ))}
                </ul>
              </div>
            )}

            {riskAssessment.aspirinNeeded && (
              <div className="p-3 bg-white rounded border border-current mb-2">
                <p className="text-sm font-semibold text-gray-900 font-[Tajawal]">
                  üíä ŸàÿµŸÅÿ© ŸÖŸàÿµŸâ ÿ®Ÿáÿß: Aspirin 150mg ŸäŸàŸÖŸäÿßŸã (ŸÑÿ™ŸÇŸÑŸäŸÑ ÿÆÿ∑ÿ± ÿ™ÿ≥ŸÖŸÖ ÿßŸÑÿ≠ŸÖŸÑ)
                </p>
              </div>
            )}

            {riskAssessment.thromboprophylaxisNeeded && (
              <div className="p-3 bg-white rounded border border-current">
                <p className="text-sm font-semibold text-gray-900 font-[Tajawal]">
                  üíâ ÿ™ŸÜÿ®ŸäŸá: ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑŸàŸÇÿßŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ÿ¨ŸÑÿ∑ (Clexane) ŸÖÿ∑ŸÑŸàÿ®ÿ©
                </p>
              </div>
            )}
          </div>

          <button
            onClick={handleSave}
            disabled={isSaving}
            className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            <Save size={18} />
            {isSaving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ±'}
          </button>
        </div>
      )}
    </div>
  );
};

export default RiskAssessment;
</file>

<file path="README.md">
<div align="center">
<img width="1200" height="475" alt="Dr Salah IVF Center" src="https://images.unsplash.com/photo-1576091160550-2173dba999ef?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" />
</div>

# üè• ŸÖÿ±ŸÉÿ≤ ÿØ ÿµŸÑÿßÿ≠ ŸÑŸÑÿÆÿµŸàÿ®ÿ©
## ŸÖÿπÿßŸÉŸÖ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©

**ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿπŸäÿßÿØÿ© ÿßŸÑÿÆÿµŸàÿ®ÿ© ŸàÿßŸÑÿ™ŸàŸÑŸäÿØ** - ÿ™ÿ∑ŸàŸäÿ± ÿØ. ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±

ŸÜÿ∏ÿßŸÖ ÿ¥ÿßŸÖŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿπŸäÿßÿØÿßÿ™ ÿßŸÑÿÆÿµŸàÿ®ÿ© ŸàÿßŸÑÿ™ŸàŸÑŸäÿØ ŸÖÿπ Ÿàÿßÿ¨Ÿáÿ© ÿ≥ŸáŸÑÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿàÿ£ÿØŸàÿßÿ™ ŸÖÿ™ŸÇÿØŸÖÿ© ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑÿØŸàÿ±ÿßÿ™ ŸàÿßŸÑÿ≠ŸÖŸÑ.

## ‚ú® ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™

- üìä **ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿØŸàÿ±ÿßÿ™**: ŸÖÿ™ÿßÿ®ÿπÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑÿØŸàÿ±ÿßÿ™ ÿßŸÑÿ™ŸÑŸÇŸäÿ≠ ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
- üë∂ **ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ŸÖŸÑ**: ŸÜÿ∏ÿßŸÖ ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ≠ŸÖŸÑ ŸàÿßŸÑŸàŸÑÿßÿØÿ©
- üíä **ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿØŸàŸäÿ©**: ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ©
- üì± **ÿ™ÿµŸÖŸäŸÖ ŸÖÿ™ÿ¨ÿßŸàÿ®**: ŸäÿπŸÖŸÑ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©
- üîí **ÿ¢ŸÖŸÜ ŸàŸÖŸàÿ´ŸàŸÇ**: ŸÖÿµÿßÿØŸÇÿ© ÿ¢ŸÖŸÜÿ© ŸàŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÖŸäÿ©

## üöÄ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑŸä

**ÿßŸÑŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™:** Node.js

1. **ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ®ÿπŸäÿßÿ™:**
   ```bash
   npm install
   ```

2. **ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:**
   ```bash
   npm run dev
   ```

3. **ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠:**
   ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ `http://localhost:5173`

## üìã ÿßŸÑÿ™ŸÇŸÜŸäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©

- **Frontend:** React + TypeScript + Tailwind CSS
- **Backend:** Supabase
- **Charts:** Recharts
- **Icons:** Lucide React
- **UI Components:** Custom components with RTL support

## üìû ÿßŸÑÿ™ŸàÿßÿµŸÑ

**ÿßŸÑŸÖÿ∑Ÿàÿ±:** ÿØ. ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±
**ÿßŸÑŸÖÿ±ŸÉÿ≤:** ŸÖÿ±ŸÉÿ≤ ÿØ ÿµŸÑÿßÿ≠ ŸÑŸÑÿÆÿµŸàÿ®ÿ©

---

<div align="center">
ÿ™ŸÖ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿØ. ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ± ¬© 2025
</div>
</file>

<file path="src/services/syncService.ts">
import { supabase } from '../../services/supabaseClient';
import {
  db,
  addToSyncQueue,
  removeFromSyncQueue,
  updateSyncQueueItem,
  markAsSynced,
  markSyncError,
  getUnsyncedRecords,
  getPendingSyncItems,
  SyncStatus,
  SyncQueueItem
} from '../db/localDB';

export class SyncService {
  private isOnline: boolean = navigator.onLine;
  private syncInProgress: boolean = false;
  private syncInterval: NodeJS.Timeout | null = null;

  constructor() {
    this.setupNetworkListeners();
    this.startPeriodicSync();
  }

  private setupNetworkListeners(): void {
    window.addEventListener('online', () => {
      console.log('üîÑ Network connection restored - starting sync');
      this.isOnline = true;
      this.performBackgroundSync();
    });

    window.addEventListener('offline', () => {
      console.log('üì¥ Network connection lost');
      this.isOnline = false;
    });
  }

  private startPeriodicSync(): void {
    // Sync every 30 seconds when online
    this.syncInterval = setInterval(() => {
      if (this.isOnline && !this.syncInProgress) {
        this.performBackgroundSync();
      }
    }, 30000);
  }

  // Main save function - saves to local DB first, then attempts sync
  async saveItem(table: string, data: any): Promise<any> {
    try {
      console.log(`üíæ Saving ${table} locally first...`, data);

      // Save to local DB with pending status
      const localRecord = await this.saveToLocal(table, data);
      console.log(`‚úÖ Saved ${table} locally with ID: ${localRecord.id}`);

      // Try to sync immediately if online
      if (this.isOnline) {
        try {
          console.log(`üîÑ Attempting immediate sync for ${table}...`);
          await this.syncItem(table, localRecord.id!, localRecord);
          console.log(`‚úÖ Successfully synced ${table} immediately`);
        } catch (error) {
          console.warn(`‚ö†Ô∏è Immediate sync failed for ${table}, will retry in background:`, error);
          // Add to sync queue for later retry
          await addToSyncQueue({
            table,
            operation: 'create',
            localId: localRecord.id!,
            payload: data,
            retryCount: 0,
            maxRetries: 3
          });
        }
      } else {
        console.log(`üì¥ Offline mode - ${table} queued for sync`);
        // Add to sync queue
        await addToSyncQueue({
          table,
          operation: 'create',
          localId: localRecord.id!,
          payload: data,
          retryCount: 0,
          maxRetries: 3
        });
      }

      return localRecord;
    } catch (error) {
      console.error(`‚ùå Failed to save ${table}:`, error);
      throw error;
    }
  }

  // Update existing item
  async updateItem(table: string, localId: number, data: any): Promise<void> {
    try {
      console.log(`üìù Updating ${table} locally...`, data);

      // Update local DB with pending status
      await this.updateLocal(table, localId, data);

      // Try to sync immediately if online
      if (this.isOnline) {
        try {
          console.log(`üîÑ Attempting immediate sync for ${table} update...`);
          const localRecord = await this.getLocalRecord(table, localId);
          await this.syncItem(table, localId, localRecord);
          console.log(`‚úÖ Successfully synced ${table} update immediately`);
        } catch (error) {
          console.warn(`‚ö†Ô∏è Immediate sync failed for ${table} update, will retry in background:`, error);
          // Add to sync queue for later retry
          await addToSyncQueue({
            table,
            operation: 'update',
            localId,
            payload: data,
            retryCount: 0,
            maxRetries: 3
          });
        }
      } else {
        console.log(`üì¥ Offline mode - ${table} update queued for sync`);
        // Add to sync queue
        await addToSyncQueue({
          table,
          operation: 'update',
          localId,
          payload: data,
          retryCount: 0,
          maxRetries: 3
        });
      }
    } catch (error) {
      console.error(`‚ùå Failed to update ${table}:`, error);
      throw error;
    }
  }

  // Delete item
  async deleteItem(table: string, localId: number): Promise<void> {
    try {
      console.log(`üóëÔ∏è Marking ${table} for deletion...`);

      // Mark as pending delete in local DB
      await this.markLocalDeleted(table, localId);

      // Try to sync immediately if online
      if (this.isOnline) {
        try {
          console.log(`üîÑ Attempting immediate sync for ${table} deletion...`);
          const localRecord = await this.getLocalRecord(table, localId);
          if (localRecord.remoteId) {
            await this.syncDelete(table, localRecord.remoteId);
            // Actually delete from local DB after successful server delete
            await this.deleteFromLocal(table, localId);
          }
          console.log(`‚úÖ Successfully synced ${table} deletion immediately`);
        } catch (error) {
          console.warn(`‚ö†Ô∏è Immediate sync failed for ${table} deletion, will retry in background:`, error);
          // Add to sync queue for later retry
          await addToSyncQueue({
            table,
            operation: 'delete',
            localId,
            retryCount: 0,
            maxRetries: 3
          });
        }
      } else {
        console.log(`üì¥ Offline mode - ${table} deletion queued for sync`);
        // Add to sync queue
        await addToSyncQueue({
          table,
          operation: 'delete',
          localId,
          retryCount: 0,
          maxRetries: 3
        });
      }
    } catch (error) {
      console.error(`‚ùå Failed to delete ${table}:`, error);
      throw error;
    }
  }

  // Background sync function
  private async performBackgroundSync(): Promise<void> {
    if (this.syncInProgress) return;

    this.syncInProgress = true;
    console.log('üîÑ Starting background sync...');

    try {
      // Process sync queue
      await this.processSyncQueue();

      // Pull latest data from server
      await this.pullLatestData();

      console.log('‚úÖ Background sync completed');
    } catch (error) {
      console.error('‚ùå Background sync failed:', error);
    } finally {
      this.syncInProgress = false;
    }
  }

  // Process items in sync queue
  private async processSyncQueue(): Promise<void> {
    const pendingItems = await getPendingSyncItems();

    for (const item of pendingItems) {
      if (item.retryCount >= item.maxRetries) {
        console.warn(`üö´ Max retries exceeded for ${item.table} ${item.operation}, giving up`);
        await removeFromSyncQueue(item.id!);
        continue;
      }

      try {
        console.log(`üîÑ Retrying ${item.table} ${item.operation} (attempt ${item.retryCount + 1}/${item.maxRetries})`);

        const localRecord = await this.getLocalRecord(item.table, item.localId);

        switch (item.operation) {
          case 'create':
            await this.syncItem(item.table, item.localId, localRecord);
            break;
          case 'update':
            await this.syncItem(item.table, item.localId, localRecord);
            break;
          case 'delete':
            if (localRecord.remoteId) {
              await this.syncDelete(item.table, localRecord.remoteId);
              await this.deleteFromLocal(item.table, item.localId);
            }
            break;
        }

        await removeFromSyncQueue(item.id!);
        console.log(`‚úÖ Successfully synced ${item.table} ${item.operation}`);

      } catch (error) {
        console.warn(`‚ö†Ô∏è Sync retry failed for ${item.table} ${item.operation}:`, error);
        await updateSyncQueueItem(item.id!, {
          retryCount: item.retryCount + 1,
          lastAttempt: new Date().toISOString(),
          nextRetry: new Date(Date.now() + Math.pow(2, item.retryCount) * 60000).toISOString() // Exponential backoff
        });
      }
    }
  }

  // Sync individual item to server
  private async syncItem(table: string, localId: number, localRecord: any): Promise<void> {
    try {
      let result;
      const serverData = this.prepareForServer(localRecord, ['id', 'remoteId', 'sync_status', 'last_sync_attempt', 'sync_error']);

      switch (table) {
        case 'patients':
          result = await supabase
            .from('patients')
            .insert([serverData])
            .select()
            .single();
          break;

        case 'visits':
          result = await supabase
            .from('antenatal_visits')
            .insert([serverData])
            .select()
            .single();
          break;

        case 'ivf_cycles':
          result = await supabase
            .from('ivf_cycles')
            .insert([serverData])
            .select()
            .single();
          break;

        case 'stimulation_logs':
          result = await supabase
            .from('stimulation_logs')
            .insert([serverData])
            .select()
            .single();
          break;

        case 'pregnancies':
          result = await supabase
            .from('pregnancies')
            .insert([serverData])
            .select()
            .single();
          break;

        case 'biometry_scans':
          result = await supabase
            .from('biometry_scans')
            .insert([serverData])
            .select()
            .single();
          break;

        default:
          throw new Error(`Unknown table: ${table}`);
      }

      if (result.error) throw result.error;

      // Mark as synced with remote ID
      await markAsSynced(table, localId, result.data.id);

    } catch (error) {
      // Self-healing: Handle duplicate key errors
      if (error instanceof Error && error.message.includes('duplicate')) {
        console.log(`‚ö†Ô∏è Duplicate key detected for ${table}, attempting self-healing...`);
        await this.handleDuplicateKeyError(table, localId, localRecord);
      } else {
        await markSyncError(table, localId, error instanceof Error ? error.message : 'Unknown sync error');
        throw error;
      }
    }
  }

  // Self-healing: Handle duplicate key errors by finding existing record and updating local reference
  private async handleDuplicateKeyError(table: string, localId: number, localRecord: any): Promise<void> {
    try {
      console.log(`üîç Searching for existing record on server for ${table}...`);
      
      let existingRecord;
      let searchField = 'phone'; // Default for patients
      let searchValue = localRecord.phone;

      // Determine search criteria by table type
      if (table === 'patients' && localRecord.phone) {
        const { data } = await supabase
          .from('patients')
          .select('id')
          .eq('phone', localRecord.phone)
          .single();
        existingRecord = data;
      }

      if (existingRecord) {
        console.log(`‚úÖ Found existing record with ID ${existingRecord.id}, marking as synced`);
        // Mark local record as synced with the remote ID
        await markAsSynced(table, localId, existingRecord.id);
      } else {
        console.warn(`‚ùå Could not find existing record for ${table}, marking as error`);
        throw new Error(`Duplicate key detected but could not find existing record`);
      }
    } catch (error) {
      console.error(`‚ùå Self-healing failed for ${table}:`, error);
      await markSyncError(table, localId, 'Duplicate key - self-healing failed');
      throw error;
    }
  }

  // Sync delete to server
  private async syncDelete(table: string, remoteId: string): Promise<void> {
    let result;

    switch (table) {
      case 'patients':
        result = await supabase.from('patients').delete().eq('id', remoteId);
        break;
      case 'visits':
        result = await supabase.from('antenatal_visits').delete().eq('id', remoteId);
        break;
      case 'ivf_cycles':
        result = await supabase.from('ivf_cycles').delete().eq('id', remoteId);
        break;
      case 'stimulation_logs':
        result = await supabase.from('stimulation_logs').delete().eq('id', remoteId);
        break;
      case 'pregnancies':
        result = await supabase.from('pregnancies').delete().eq('id', remoteId);
        break;
      case 'biometry_scans':
        result = await supabase.from('biometry_scans').delete().eq('id', remoteId);
        break;
      default:
        throw new Error(`Unknown table: ${table}`);
    }

    if (result.error) throw result.error;
  }

  // Pull latest data from server and update local DB
  private async pullLatestData(): Promise<void> {
    try {
      console.log('üì• Pulling latest data from server...');

      // Pull patients
      await this.pullTableData('patients');

      // Pull visits
      await this.pullTableData('antenatal_visits');

      // Pull IVF cycles
      await this.pullTableData('ivf_cycles');

      // Pull stimulation logs
      await this.pullTableData('stimulation_logs');

      // Pull pregnancies
      await this.pullTableData('pregnancies');

      // Pull biometry scans
      await this.pullTableData('biometry_scans');

      console.log('‚úÖ Data pull completed');
    } catch (error) {
      console.error('‚ùå Failed to pull latest data:', error);
    }
  }

  // Pull data for a specific table
  private async pullTableData(tableName: string): Promise<void> {
    const { data, error } = await supabase
      .from(tableName)
      .select('*')
      .order('updated_at', { ascending: false })
      .limit(50); // Limit to prevent large data transfers

    if (error) throw error;

    // Update local database with server data
    for (const record of data || []) {
      await this.upsertLocalRecord(tableName, record);
    }
  }

  // Local database operations
  private async saveToLocal(table: string, data: any): Promise<any> {
    const localData = {
      ...data,
      sync_status: SyncStatus.PENDING_CREATE,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    switch (table) {
      case 'patients':
        return await db.patients.add(localData);
      case 'visits':
        return await db.visits.add(localData);
      case 'ivf_cycles':
        return await db.ivf_cycles.add(localData);
      case 'stimulation_logs':
        return await db.stimulation_logs.add(localData);
      case 'pregnancies':
        return await db.pregnancies.add(localData);
      case 'biometry_scans':
        return await db.biometry_scans.add(localData);
      default:
        throw new Error(`Unknown table: ${table}`);
    }
  }

  private async updateLocal(table: string, localId: number, data: any): Promise<void> {
    const updateData = {
      ...data,
      sync_status: SyncStatus.PENDING_UPDATE,
      updated_at: new Date().toISOString()
    };

    switch (table) {
      case 'patients':
        await db.patients.update(localId, updateData);
        break;
      case 'visits':
        await db.visits.update(localId, updateData);
        break;
      case 'ivf_cycles':
        await db.ivf_cycles.update(localId, updateData);
        break;
      case 'stimulation_logs':
        await db.stimulation_logs.update(localId, updateData);
        break;
      case 'pregnancies':
        await db.pregnancies.update(localId, updateData);
        break;
      case 'biometry_scans':
        await db.biometry_scans.update(localId, updateData);
        break;
      default:
        throw new Error(`Unknown table: ${table}`);
    }
  }

  private async markLocalDeleted(table: string, localId: number): Promise<void> {
    const updateData = {
      sync_status: SyncStatus.PENDING_DELETE,
      updated_at: new Date().toISOString()
    };

    switch (table) {
      case 'patients':
        await db.patients.update(localId, updateData);
        break;
      case 'visits':
        await db.visits.update(localId, updateData);
        break;
      case 'ivf_cycles':
        await db.ivf_cycles.update(localId, updateData);
        break;
      case 'stimulation_logs':
        await db.stimulation_logs.update(localId, updateData);
        break;
      case 'pregnancies':
        await db.pregnancies.update(localId, updateData);
        break;
      case 'biometry_scans':
        await db.biometry_scans.update(localId, updateData);
        break;
      default:
        throw new Error(`Unknown table: ${table}`);
    }
  }

  private async deleteFromLocal(table: string, localId: number): Promise<void> {
    switch (table) {
      case 'patients':
        await db.patients.delete(localId);
        break;
      case 'visits':
        await db.visits.delete(localId);
        break;
      case 'ivf_cycles':
        await db.ivf_cycles.delete(localId);
        break;
      case 'stimulation_logs':
        await db.stimulation_logs.delete(localId);
        break;
      case 'pregnancies':
        await db.pregnancies.delete(localId);
        break;
      case 'biometry_scans':
        await db.biometry_scans.delete(localId);
        break;
      default:
        throw new Error(`Unknown table: ${table}`);
    }
  }

  private async getLocalRecord(table: string, localId: number): Promise<any> {
    switch (table) {
      case 'patients':
        return await db.patients.get(localId);
      case 'visits':
        return await db.visits.get(localId);
      case 'ivf_cycles':
        return await db.ivf_cycles.get(localId);
      case 'stimulation_logs':
        return await db.stimulation_logs.get(localId);
      case 'pregnancies':
        return await db.pregnancies.get(localId);
      case 'biometry_scans':
        return await db.biometry_scans.get(localId);
      default:
        throw new Error(`Unknown table: ${table}`);
    }
  }

  private async upsertLocalRecord(table: string, remoteData: any): Promise<void> {
    // Check if record exists locally
    let existingRecord;

    switch (table) {
      case 'patients':
        existingRecord = await db.patients.where('remoteId').equals(remoteData.id).first();
        break;
      case 'antenatal_visits':
        existingRecord = await db.visits.where('remoteId').equals(remoteData.id).first();
        break;
      case 'ivf_cycles':
        existingRecord = await db.ivf_cycles.where('remoteId').equals(remoteData.id).first();
        break;
      case 'stimulation_logs':
        existingRecord = await db.stimulation_logs.where('remoteId').equals(remoteData.id).first();
        break;
      case 'pregnancies':
        existingRecord = await db.pregnancies.where('remoteId').equals(remoteData.id).first();
        break;
      case 'biometry_scans':
        existingRecord = await db.biometry_scans.where('remoteId').equals(remoteData.id).first();
        break;
    }

    if (existingRecord) {
      // Update existing record
      const updateData = {
        ...remoteData,
        remoteId: remoteData.id,
        sync_status: SyncStatus.SYNCED,
        updated_at: new Date().toISOString()
      };
      delete updateData.id; // Remove remote ID from update

      switch (table) {
        case 'patients':
          await db.patients.update(existingRecord.id!, updateData);
          break;
        case 'antenatal_visits':
          await db.visits.update(existingRecord.id!, updateData);
          break;
        case 'ivf_cycles':
          await db.ivf_cycles.update(existingRecord.id!, updateData);
          break;
        case 'stimulation_logs':
          await db.stimulation_logs.update(existingRecord.id!, updateData);
          break;
        case 'pregnancies':
          await db.pregnancies.update(existingRecord.id!, updateData);
          break;
        case 'biometry_scans':
          await db.biometry_scans.update(existingRecord.id!, updateData);
          break;
      }
    } else {
      // Insert new record
      const localData = {
        ...remoteData,
        remoteId: remoteData.id,
        sync_status: SyncStatus.SYNCED,
        created_at: remoteData.created_at || new Date().toISOString(),
        updated_at: remoteData.updated_at || new Date().toISOString()
      };
      delete localData.id; // Remove remote ID

      switch (table) {
        case 'patients':
          await db.patients.add(localData);
          break;
        case 'antenatal_visits':
          await db.visits.add(localData);
          break;
        case 'ivf_cycles':
          await db.ivf_cycles.add(localData);
          break;
        case 'stimulation_logs':
          await db.stimulation_logs.add(localData);
          break;
        case 'pregnancies':
          await db.pregnancies.add(localData);
          break;
        case 'biometry_scans':
          await db.biometry_scans.add(localData);
          break;
      }
    }
  }

  // Prepare data for server (remove local fields)
  private prepareForServer(data: any, fieldsToRemove: string[] = []): any {
    const serverData = { ...data };
    fieldsToRemove.forEach(field => delete serverData[field]);

    // Convert camelCase to snake_case for Supabase
    const converted: any = {};
    for (const [key, value] of Object.entries(serverData)) {
      const snakeKey = key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
      converted[snakeKey] = value;
    }

    return converted;
  }

  // Get sync status
  getSyncStatus(): { isOnline: boolean; syncInProgress: boolean } {
    return {
      isOnline: this.isOnline,
      syncInProgress: this.syncInProgress
    };
  }

  // Force sync
  async forceSync(): Promise<void> {
    await this.performBackgroundSync();
  }

  // Initialize sync on app load - process pending items immediately
  async initializeSync(): Promise<void> {
    console.log('üöÄ Initializing sync on app load...');
    try {
      // Process any pending items immediately on app load
      await this.processSyncQueue();
      console.log('‚úÖ Sync initialization completed');
    } catch (error) {
      console.error('‚ö†Ô∏è Error during sync initialization:', error);
      // Don't throw - let app continue even if sync fails
    }
  }

  // Cleanup
  destroy(): void {
    if (this.syncInterval) {
      clearInterval(this.syncInterval);
      this.syncInterval = null;
    }
  }

  // API compatibility methods for existing code
  async save(table: string, data: any) {
    return await this.saveItem(table, data);
  }

  async read(table: string) {
    await this.forceSync();
  }

  async update(table: string, remoteId: string, data: any) {
    const localRecord = await this.getLocalRecordByRemoteId(table, remoteId);
    if (localRecord) {
      await this.updateItem(table, localRecord.id, data);
    } else {
      throw new Error(`Record not found for update: ${table} ${remoteId}`);
    }
  }

  async delete(table: string, remoteId: string) {
    const localRecord = await this.getLocalRecordByRemoteId(table, remoteId);
    if (localRecord) {
      await this.deleteItem(table, localRecord.id);
    } else {
      throw new Error(`Record not found for delete: ${table} ${remoteId}`);
    }
  }

  private async getLocalRecordByRemoteId(table: string, remoteId: string): Promise<any> {
    switch (table) {
      case 'patients':
        return await db.patients.where('remoteId').equals(remoteId).first();
      case 'visits':
        return await db.visits.where('remoteId').equals(remoteId).first();
      case 'ivf_cycles':
        return await db.ivf_cycles.where('remoteId').equals(remoteId).first();
      case 'stimulation_logs':
        return await db.stimulation_logs.where('remoteId').equals(remoteId).first();
      case 'pregnancies':
        return await db.pregnancies.where('remoteId').equals(remoteId).first();
      case 'biometry_scans':
        return await db.biometry_scans.where('remoteId').equals(remoteId).first();
      default:
        throw new Error(`Unknown table: ${table}`);
    }
  }
}

// Create and export singleton instance
export const syncService = new SyncService();
export const syncManager = syncService;
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'masked-icon.svg'],
      manifest: {
        name: 'Nile IVF Center',
        short_name: 'Nile IVF',
        description: 'Comprehensive IVF and Obstetrics Management System',
        theme_color: '#00838f',
        background_color: '#ffffff',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/.*\.supabase\.co\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'supabase-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60 * 24 * 7 // 7 days
              }
            }
          }
        ]
      }
    })
  ],
  build: {
    rollupOptions: {
      output: {
        manualChunks: undefined
      }
    }
  }
});
</file>

<file path="CLINICAL_DATA_MIGRATION.sql">
-- ============================================================================
-- VISITS TABLE MIGRATION - Create visits table and add clinical columns
-- ============================================================================

-- Create visits table if it doesn't exist
CREATE TABLE IF NOT EXISTS visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  department TEXT DEFAULT NULL,
  diagnosis TEXT DEFAULT '',
  prescription JSONB DEFAULT '[]',
  notes TEXT DEFAULT '',
  clinical_data JSONB DEFAULT NULL,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Add department column to visits table (if table already exists)
ALTER TABLE visits ADD COLUMN IF NOT EXISTS department TEXT DEFAULT NULL;

-- Add clinical_data column to visits table (if table already exists)
ALTER TABLE visits ADD COLUMN IF NOT EXISTS clinical_data JSONB DEFAULT NULL;

-- Create index for better query performance on clinical_data
CREATE INDEX IF NOT EXISTS idx_visits_clinical_data ON visits USING GIN (clinical_data);

-- Create index for department queries
CREATE INDEX IF NOT EXISTS idx_visits_department ON visits (department);

-- Create index for patient visits with clinical data
CREATE INDEX IF NOT EXISTS idx_visits_patient_clinical ON visits (patient_id, date DESC) WHERE clinical_data IS NOT NULL;

-- Enable RLS on visits table
ALTER TABLE visits ENABLE ROW LEVEL SECURITY;

-- RLS Policies for visits table
DROP POLICY IF EXISTS "Doctors can read visits" ON visits;
DROP POLICY IF EXISTS "Doctors can insert visits" ON visits;
DROP POLICY IF EXISTS "Doctors can update visits" ON visits;

CREATE POLICY "Doctors can read visits" ON visits
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  );

CREATE POLICY "Doctors can insert visits" ON visits
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  );

CREATE POLICY "Doctors can update visits" ON visits
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  );

-- Add comments for documentation
COMMENT ON COLUMN visits.department IS 'Department identifier (GYNA, OBS, IVF_STIM, IVF_LAB)';
COMMENT ON COLUMN visits.clinical_data IS 'Structured clinical data stored as JSONB for different departments (gynecology, obstetrics, ivf)';
COMMENT ON INDEX idx_visits_clinical_data IS 'GIN index for efficient JSONB queries on clinical_data';
COMMENT ON INDEX idx_visits_department IS 'Index for filtering visits by department';
COMMENT ON INDEX idx_visits_patient_clinical IS 'Index for patient clinical visits ordered by date';
</file>

<file path="package.json">
{
  "name": "dr-salah-ivf-center",
  "private": true,
  "version": "1.0.0",
  "author": "Dr. Mohamed Salah Gabr",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "npx vite build",
    "typecheck": "npx tsc --noEmit",
    "preview": "npx vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.39.7",
    "clsx": "^2.1.0",
    "dexie": "^4.2.1",
    "dexie-react-hooks": "^4.2.0",
    "lucide-react": "^0.344.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hot-toast": "^2.4.1",
    "recharts": "^2.12.2",
    "tailwind-merge": "^2.2.1",
    "vite-plugin-pwa": "^1.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@vitejs/plugin-react": "^4.7.0",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.2.2",
    "vite": "^5.1.6"
  }
}
</file>

<file path="pages/Dashboard.tsx">
import React, { useEffect, useState } from 'react';
import { Users, Activity, CalendarCheck, TrendingUp, Loader2 } from 'lucide-react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
import { db } from '../services/ivfService';
import { Patient } from '../types';
import { useBranding } from '../context/BrandingContext';

const Dashboard: React.FC = () => {
  const { branding } = useBranding();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    totalPatients: 0,
    activeCycles: 0,
    todayVisits: 0
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const patients = await db.getPatients();
        const cycles = await db.getCycles();
        // In a real app, we'd query visits by date via Supabase directly for performance
        // const visits = await db.getVisits(); 
        
        setStats({
          totalPatients: patients.length,
          activeCycles: cycles.filter(c => c.status === 'Active').length,
          todayVisits: 5 // Mock for now until visits table is fully populated
        });
      } catch (error) {
        console.error("Failed to load dashboard data");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // Mock Data for Charts (Keep static for UI demo)
  const growthData = [
    { name: 'Jan', patients: 30 },
    { name: 'Feb', patients: 45 },
    { name: 'Mar', patients: 60 },
    { name: 'Apr', patients: 90 },
    { name: 'May', patients: 110 },
    { name: 'Jun', patients: 150 },
  ];

  const visitTypes = [
    { name: 'Consultation', value: 400 },
    { name: 'Scan', value: 300 },
    { name: 'Lab', value: 300 },
    { name: 'Procedure', value: 200 },
  ];
  
  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042'];

  if (loading) {
    return (
      <div className="flex h-[80vh] items-center justify-center">
        <Loader2 className="w-10 h-10 animate-spin text-teal-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <header className="mb-6 md:mb-8">
        <h2 className="text-3xl font-bold text-gray-800">{branding?.clinic_name || 'Dashboard Overview'}</h2>
        <p className="text-gray-500">Welcome back to your clinic management system</p>
      </header>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 md:gap-6">
        <div className="bg-white p-3 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-3 md:gap-4">
          <div className="flex-1">
            <p className="text-xs md:text-sm font-medium text-gray-400">Total Patients</p>
            <h3 className="text-2xl md:text-3xl font-bold text-gray-800 mt-1">{stats.totalPatients}</h3>
          </div>
          <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 flex-shrink-0">
            <Users className="w-5 h-5 md:w-6 md:h-6" />
          </div>
        </div>

        <div className="bg-white p-3 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-3 md:gap-4">
          <div className="flex-1">
            <p className="text-xs md:text-sm font-medium text-gray-400">Active Cycles</p>
            <h3 className="text-2xl md:text-3xl font-bold text-teal-600 mt-1">{stats.activeCycles}</h3>
          </div>
          <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 flex-shrink-0">
            <Activity className="w-5 h-5 md:w-6 md:h-6" />
          </div>
        </div>

        <div className="bg-white p-3 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-3 md:gap-4 sm:col-span-2 md:col-span-1">
          <div className="flex-1">
            <p className="text-xs md:text-sm font-medium text-gray-400">Today's Visits</p>
            <h3 className="text-2xl md:text-3xl font-bold text-purple-600 mt-1">{stats.todayVisits}</h3>
          </div>
          <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 flex-shrink-0">
            <CalendarCheck className="w-5 h-5 md:w-6 md:h-6" />
          </div>
        </div>
      </div>

      {/* Charts Section */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mt-8">
        
        {/* Patient Growth Area Chart */}
        <div className="bg-white p-3 md:p-6 rounded-2xl shadow-sm border border-gray-100">
          <div className="flex items-center justify-between mb-4 md:mb-6">
            <h3 className="text-sm md:text-lg font-bold text-gray-800 flex items-center gap-2">
              <TrendingUp className="w-4 h-4 md:w-5 md:h-5 text-teal-600" />
              Patient Growth
            </h3>
          </div>
          <div className="h-48 md:h-64">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={growthData}>
                <defs>
                  <linearGradient id="colorPatients" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#00838f" stopOpacity={0.1}/>
                    <stop offset="95%" stopColor="#00838f" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#eee" />
                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fontSize: 12 }} />
                <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 12 }} />
                <Tooltip 
                  contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                />
                <Area type="monotone" dataKey="patients" stroke="#00838f" fillOpacity={1} fill="url(#colorPatients)" />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Visit Types Donut Chart */}
        <div className="bg-white p-3 md:p-6 rounded-2xl shadow-sm border border-gray-100">
          <h3 className="text-sm md:text-lg font-bold text-gray-800 mb-4 md:mb-6">Visit Distribution</h3>
          <div className="h-48 md:h-64 flex items-center justify-center">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={visitTypes}
                  innerRadius={40}
                  outerRadius={60}
                  paddingAngle={5}
                  dataKey="value"
                >
                  {visitTypes.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </div>
          <div className="flex justify-center gap-2 md:gap-4 mt-4 flex-wrap">
            {visitTypes.map((entry, index) => (
              <div key={index} className="flex items-center gap-2 text-xs md:text-sm text-gray-600">
                <div className="w-2 h-2 md:w-3 md:h-3 rounded-full" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                <span className="hidden sm:inline">{entry.name}</span>
                <span className="sm:hidden">{entry.name.split(' ')[0]}</span>
              </div>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
};

export default Dashboard;
</file>

<file path="services/authService.ts">
import { supabase } from './supabaseClient';

export const authService = {
  login: async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    
    if (error) throw error;
    return data;
  },

  signup: async (email: string, password: string, doctorData: { name: string; specialization?: string; phone?: string }) => {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
    });
    
    if (error) throw error;

    if (data.user) {
      const { error: dbError } = await supabase
        .from('doctors')
        .insert([
          {
            user_id: data.user.id,
            email: email,
            name: doctorData.name,
            specialization: doctorData.specialization || null,
            phone: doctorData.phone || null,
            doctor_image: null,
            clinic_name: null,
            clinic_address: null,
            clinic_phone: null,
            clinic_image: null,
            clinic_latitude: null,
            clinic_longitude: null,
          }
        ]);

      if (dbError) {
        console.error('Doctor insert error:', dbError);
        throw dbError;
      }
    }

    return data;
  },

  logout: async () => {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  },

  getCurrentUser: async () => {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error) throw error;
    return user;
  },

  getDoctorProfile: async (userId: string) => {
    const { data, error } = await supabase
      .from('doctors')
      .select('*')
      .eq('user_id', userId)
      .single();

    if (error) throw error;
    return data;
  },

  onAuthStateChange: (callback: (user: any) => void) => {
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      callback(session?.user || null);
    });

    return subscription;
  },

  updateDoctorProfile: async (userId: string, updates: any) => {
    const { data, error } = await supabase
      .from('doctors')
      .update(updates)
      .eq('user_id', userId);

    if (error) {
      console.error('Update error details:', error);
      throw new Error(error.message || 'Failed to update profile');
    }
    return data;
  },

  updatePassword: async (newPassword: string) => {
    const { data, error } = await supabase.auth.updateUser({
      password: newPassword
    });

    if (error) throw error;
    return data;
  },

  uploadImage: async (userId: string, file: File, folder: 'doctor_images' | 'clinic_images') => {
    const fileExt = file.name.split('.').pop();
    const fileName = `${userId}_${Date.now()}.${fileExt}`;
    const filePath = `${folder}/${fileName}`;

    const { error: uploadError } = await supabase.storage
      .from('doctor-files')
      .upload(filePath, file, { upsert: true });

    if (uploadError) throw uploadError;

    const { data } = supabase.storage
      .from('doctor-files')
      .getPublicUrl(filePath);

    return data.publicUrl;
  },

  ensureDoctorRecord: async (userId: string, email: string) => {
    const { data: existingDoctor, error: fetchError } = await supabase
      .from('doctors')
      .select('id')
      .eq('user_id', userId)
      .single();

    if (existingDoctor) {
      return existingDoctor;
    }

    const { data: newDoctor, error: insertError } = await supabase
      .from('doctors')
      .insert([
        {
          user_id: userId,
          email: email,
          name: 'ÿßŸÑÿ∑ÿ®Ÿäÿ®',
          specialization: null,
          phone: null,
          doctor_image: null,
          clinic_name: null,
          clinic_address: null,
          clinic_phone: null,
          clinic_image: null,
          clinic_latitude: null,
          clinic_longitude: null,
        }
      ])
      .select()
      .single();

    if (insertError) {
      console.error('Error creating doctor record:', insertError);
      throw insertError;
    }

    return newDoctor;
  }
};
</file>

<file path="services/visitsService.ts">
import { useLiveQuery } from 'dexie-react-hooks';
import { db } from '../src/db/localDB';
import { syncService } from '../src/services/syncService';
import { Visit } from '../types';

// React hook for reactive visits data
export const useVisitsByPatient = (patientId: string) => {
  return useLiveQuery(async () => {
    if (!patientId) return [];
    return await db.visits.where('patient_id').equals(patientId).toArray();
  }, [patientId]);
};

// React hook for all visits (reactive)
export const useAllVisits = () => {
  return useLiveQuery(async () => {
    return await db.visits.toArray();
  }, []);
};

export const visitsService = {
  // READ: Get visits for a patient (from local DB - reactive via hooks)
  getVisitsByPatient: async (patientId: string) => {
    return await db.visits.where('patient_id').equals(patientId).toArray();
  },

  // READ: Get all visits (from local DB)
  getAllVisits: async () => {
    return await db.visits.toArray();
  },

  // WRITE: Save new visit (offline-first)
  saveVisit: async (params: {
    patientId: string;
    department: string;
    clinicalData: any;
    diagnosis?: string;
    prescription?: any[];
    notes?: string;
  }) => {
    const visitData = {
      patient_id: params.patientId,
      date: new Date().toISOString().split('T')[0],
      department: params.department,
      diagnosis: params.diagnosis || '',
      prescription: params.prescription || [],
      notes: params.notes || '',
      clinical_data: params.clinicalData,
    };

    return await syncService.saveItem('visits', visitData);
  },

  // WRITE: Update existing visit (offline-first)
  updateVisit: async (localId: number, updates: Partial<{
    patient_id: string;
    department: string;
    diagnosis: string;
    prescription: any[];
    notes: string;
    clinical_data: any;
  }>) => {
    return await syncService.updateItem('visits', localId, updates);
  },

  // WRITE: Delete visit (offline-first)
  deleteVisit: async (localId: number) => {
    return await syncService.deleteItem('visits', localId);
  },

  // Utility: Find local visit by remote ID
  findVisitByRemoteId: async (remoteId: string) => {
    return await db.visits.where('remoteId').equals(remoteId).first();
  },

  // Utility: Get visit by local ID
  getVisitById: async (localId: number) => {
    return await db.visits.get(localId);
  },

  // Legacy compatibility: Create visit (maps to saveVisit)
  createVisit: async (visit: Omit<Visit, 'id'>) => {
    return await syncService.saveItem('visits', {
      patient_id: visit.patientId,
      date: visit.date,
      department: visit.department,
      diagnosis: visit.diagnosis || '',
      prescription: visit.prescription || [],
      notes: visit.notes || '',
      clinical_data: visit.clinical_data || {}
    });
  },
};
</file>

<file path="pages/Reception.tsx">
import React, { useState, useEffect } from 'react';
import { UserPlus, Search, Phone, User, History, Loader2 } from 'lucide-react';
import { useLiveQuery } from 'dexie-react-hooks';
import { db } from '../src/db/localDB';
import { syncService } from '../src/services/syncService';
import { Patient } from '../types';
import { authService } from '../services/authService';
import toast from 'react-hot-toast';

const Reception: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'register' | 'directory'>('register');
  const [formData, setFormData] = useState({
    name: '',
    age: '',
    phone: '',
    husbandName: '',
    history: ''
  });
  const [searchTerm, setSearchTerm] = useState('');

  // Reactive patient data from local database
  const patients = useLiveQuery(async () => {
    return await db.patients.toArray();
  }, []) || [];

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.name || !formData.phone) {
      toast.error("Please fill required fields");
      return;
    }

    const toastId = toast.loading("Registering patient...");

    try {
      // Get current user and ensure doctor record exists
      const user = await authService.getCurrentUser();
      if (!user) throw new Error("Not authenticated");

      const doctor = await authService.ensureDoctorRecord(user.id, user.email || '');
      if (!doctor) throw new Error("Doctor profile missing. Please log out and sign in again.");

      await syncService.saveItem('patients', {
        name: formData.name,
        age: parseInt(formData.age) || 0,
        phone: formData.phone,
        husband_name: formData.husbandName,
        history: formData.history,
        doctor_id: doctor.id
      });

      toast.success("Patient registered successfully!", { id: toastId });
      setFormData({ name: '', age: '', phone: '', husbandName: '', history: '' });
    } catch (error) {
      // Provide more detailed error feedback for debugging
      const msg = (error && (error as any).message) ? (error as any).message : JSON.stringify(error);
      toast.error(`Failed to register patient: ${msg}`, { id: toastId });
      console.error('Register patient error:', error);
    }
  };

  const filteredPatients = patients.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    p.phone.includes(searchTerm)
  );

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[600px]">
      <div className="flex border-b border-gray-100">
        <button
          onClick={() => setActiveTab('register')}
          className={`flex-1 py-4 text-center font-medium transition-colors ${activeTab === 'register' ? 'text-teal-700 border-b-2 border-teal-700 bg-teal-50' : 'text-gray-500 hover:text-gray-700'}`}
        >
          New Registration
        </button>
        <button
          onClick={() => setActiveTab('directory')}
          className={`flex-1 py-4 text-center font-medium transition-colors ${activeTab === 'directory' ? 'text-teal-700 border-b-2 border-teal-700 bg-teal-50' : 'text-gray-500 hover:text-gray-700'}`}
        >
          Patient Directory
        </button>
      </div>

      <div className="p-4 md:p-8">
        {activeTab === 'register' ? (
          <form onSubmit={handleRegister} className="max-w-2xl mx-auto space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Patient Name (Wife)</label>
                <div className="relative">
                  <User className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
                  <input
                    type="text"
                    required
                    className="w-full pl-4 pr-10 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
                    placeholder="Full Name"
                    value={formData.name}
                    onChange={e => setFormData({...formData, name: e.target.value})}
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Age</label>
                <input
                  type="number"
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                  placeholder="Years"
                  value={formData.age}
                  onChange={e => setFormData({...formData, age: e.target.value})}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                <div className="relative">
                  <Phone className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
                  <input
                    type="tel"
                    required
                    className="w-full pl-4 pr-10 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                    placeholder="01xxxxxxxxx"
                    value={formData.phone}
                    onChange={e => setFormData({...formData, phone: e.target.value})}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Husband Name</label>
                <input
                  type="text"
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                  placeholder="Husband Name"
                  value={formData.husbandName}
                  onChange={e => setFormData({...formData, husbandName: e.target.value})}
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Medical History (Brief)</label>
              <div className="relative">
                <History className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
                <textarea
                  className="w-full pl-4 pr-10 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none h-32"
                  placeholder="G P A, Previous Operations, Allergies..."
                  value={formData.history}
                  onChange={e => setFormData({...formData, history: e.target.value})}
                />
              </div>
            </div>

            <button
              type="submit"
              className="w-full bg-teal-700 text-white py-3 rounded-xl font-bold hover:bg-teal-800 transition-colors flex items-center justify-center gap-2 shadow-lg shadow-teal-700/20"
            >
              <UserPlus className="w-5 h-5" />
              Register Patient
            </button>
          </form>
        ) : (
          <div className="space-y-6">
            <div className="relative">
              <Search className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
              <input
                type="text"
                className="w-full pl-4 pr-12 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none shadow-sm"
                placeholder="Search by name or phone..."
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
              />
            </div>

                {/* Mobile: render cards */}
                <div className="block md:hidden space-y-3">
                  {filteredPatients.length > 0 ? filteredPatients.map(patient => (
                    <div key={patient.id} className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-sm font-bold text-gray-900">{patient.name}</div>
                          <div className="text-xs text-gray-500 mt-1">{patient.phone} ‚Ä¢ Age {patient.age}</div>
                        </div>
                        <div className="text-right text-xs text-gray-400 font-mono">
                          {patient.remoteId ? patient.remoteId.slice(0,6) : `#${patient.id}`}
                        </div>
                      </div>
                      <div className="mt-3 text-xs text-gray-600 truncate">{patient.history}</div>
                    </div>
                  )) : (
                    <div className="text-center text-gray-400 py-8">No patients found matching your search.</div>
                  )}
                </div>

                {/* Desktop: table */}
                <div className="hidden md:block overflow-x-auto rounded-xl border border-gray-200">
                  <table className="w-full text-right">
                    <thead className="bg-gray-50 text-gray-600 font-medium text-sm">
                      <tr>
                        <th className="px-6 py-4">ID</th>
                        <th className="px-6 py-4">Patient Name</th>
                        <th className="px-6 py-4">Age</th>
                        <th className="px-6 py-4">Phone</th>
                        <th className="px-6 py-4">Husband</th>
                        <th className="px-6 py-4">History</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {filteredPatients.length > 0 ? (
                        filteredPatients.map((patient) => (
                          <tr key={patient.id} className="hover:bg-teal-50/30 transition-colors text-sm text-gray-700">
                            <td className="px-6 py-4 font-mono text-xs text-gray-400">
                              {patient.remoteId ? patient.remoteId.slice(0, 6) : `#${patient.id}`}
                            </td>
                            <td className="px-6 py-4 font-bold text-gray-900">{patient.name}</td>
                            <td className="px-6 py-4">{patient.age}</td>
                            <td className="px-6 py-4">{patient.phone}</td>
                            <td className="px-6 py-4">{patient.husbandName}</td>
                            <td className="px-6 py-4 truncate max-w-xs">{patient.history}</td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan={6} className="px-6 py-12 text-center text-gray-400">
                            No patients found matching your search.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Reception;
</file>

<file path="pages/Settings.tsx">
import React, { useState, useEffect } from 'react';
import { User, Palette, FileText, Lock, Upload, Save, AlertCircle, CheckCircle, Facebook, MessageCircle, Loader, Database, RefreshCw } from 'lucide-react';
import toast from 'react-hot-toast';
import { authService } from '../services/authService';
import { useBranding } from '../context/BrandingContext';
import { Doctor } from '../types';
import { db, getSyncStats, initLocalDB } from '../src/db/localDB';
import { syncManager } from '../src/services/syncService';

interface SettingsProps {
  user: any;
}

const Settings: React.FC<SettingsProps> = ({ user }) => {
  const { branding, updateBranding, loading: brandingLoading } = useBranding();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [doctor, setDoctor] = useState<Doctor | null>(null);
  const [activeTab, setActiveTab] = useState<'branding' | 'prescription' | 'profile' | 'password' | 'data'>('branding');
  
  const [brandingFormData, setBrandingFormData] = useState({
    clinic_name: '',
    primary_color: '',
    logo_url: '' as string | null,
  });

  const [prescriptionFormData, setPrescriptionFormData] = useState({
    clinic_address: '',
    clinic_phone: '',
    default_rx_notes: '',
  });

  const [profileFormData, setProfileFormData] = useState({
    name: '',
    email: '',
    phone: '',
    specialization: '',
    doctor_image: '',
  });

  const [passwordData, setPasswordData] = useState({
    newPassword: '',
    confirmPassword: '',
  });

  const [logoPreview, setLogoPreview] = useState<string | null>(null);
  const [logoUploadLoading, setLogoUploadLoading] = useState(false);
  const [syncStats, setSyncStats] = useState<{ total: number; synced: number; pending: number; errors: number } | null>(null);
  const [hardResetLoading, setHardResetLoading] = useState(false);

  useEffect(() => {
    const fetchData = async () => {
      try {
        if (user?.id) {
          await authService.ensureDoctorRecord(user.id, user.email);
          const doctorProfile = await authService.getDoctorProfile(user.id);
          setDoctor(doctorProfile);
          setProfileFormData({
            name: doctorProfile.name || '',
            email: doctorProfile.email || '',
            phone: doctorProfile.phone || '',
            specialization: doctorProfile.specialization || '',
            doctor_image: doctorProfile.doctor_image || '',
          });
        }
      } catch (error) {
        console.error('Failed to fetch doctor profile:', error);
        toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [user]);

  useEffect(() => {
    const fetchSyncStats = async () => {
      try {
        const stats = await getSyncStats();
        setSyncStats(stats);
      } catch (error) {
        console.error('Failed to fetch sync stats:', error);
      }
    };

    fetchSyncStats();
  }, []);

  useEffect(() => {
    if (branding) {
      setBrandingFormData({
        clinic_name: branding.clinic_name || '',
        primary_color: branding.primary_color || '#2d5a6b',
        logo_url: branding.logo_url || null,
      });
      setPrescriptionFormData({
        clinic_address: branding.clinic_address || '',
        clinic_phone: branding.clinic_phone || '',
        default_rx_notes: branding.default_rx_notes || '',
      });
      setLogoPreview(branding.logo_url);
    }
  }, [branding]);

  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      setLogoUploadLoading(true);
      const reader = new FileReader();
      reader.onloadend = () => {
        setLogoPreview(reader.result as string);
      };
      reader.readAsDataURL(file);

      await updateBranding({ clinic_name: brandingFormData.clinic_name }, file);
      toast.success('ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Upload error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° bucket "branding" ŸÅŸä Supabase');
      setLogoPreview(branding?.logo_url || null);
    } finally {
      setLogoUploadLoading(false);
    }
  };

  const handleBrandingSave = async () => {
    try {
      setSaving(true);
      await updateBranding({
        clinic_name: brandingFormData.clinic_name,
        primary_color: brandingFormData.primary_color,
      });
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸáŸàŸäÿ© ÿßŸÑÿ®ÿµÿ±Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Save error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸáŸàŸäÿ© ÿßŸÑÿ®ÿµÿ±Ÿäÿ©');
    } finally {
      setSaving(false);
    }
  };

  const handlePrescriptionSave = async () => {
    try {
      setSaving(true);
      await updateBranding({
        clinic_address: prescriptionFormData.clinic_address,
        clinic_phone: prescriptionFormData.clinic_phone,
        default_rx_notes: prescriptionFormData.default_rx_notes,
      });
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Save error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©');
    } finally {
      setSaving(false);
    }
  };

  const handleProfileSave = async () => {
    try {
      setSaving(true);
      await authService.updateDoctorProfile(user.id, {
        name: profileFormData.name,
        phone: profileFormData.phone,
        specialization: profileFormData.specialization,
        doctor_image: profileFormData.doctor_image,
      });
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Save error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä');
    } finally {
      setSaving(false);
    }
  };

  const handleDoctorImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      setSaving(true);
      const imageUrl = await authService.uploadImage(user.id, file, 'doctor_images');
      setProfileFormData(prev => ({ ...prev, doctor_image: imageUrl }));
      toast.success('ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Upload error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©');
    } finally {
      setSaving(false);
    }
  };

  const handlePasswordSave = async () => {
    if (passwordData.newPassword !== passwordData.confirmPassword) {
      toast.error('ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©');
      return;
    }

    if (passwordData.newPassword.length < 6) {
      toast.error('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
      return;
    }

    try {
      setSaving(true);
      await authService.updatePassword(passwordData.newPassword);
      setPasswordData({ newPassword: '', confirmPassword: '' });
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Password update error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
    } finally {
      setSaving(false);
    }
  };

  const handleHardReset = async () => {
    const confirmed = window.confirm('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑŸáÿß ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±. ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü');
    if (!confirmed) return;

    try {
      setHardResetLoading(true);
      toast.loading('ÿ¨ÿßÿ±Ÿä ÿ≠ÿ∞ŸÅ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©...', { id: 'hard-reset' });

      // Delete local DB
      await db.delete();

      toast.loading('ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿ•ŸÜÿ¥ÿßÿ° ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...', { id: 'hard-reset' });

      // Reinitialize DB
      await initLocalDB();

      toast.loading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...', { id: 'hard-reset' });

      // Pull latest data
      await syncManager.forceSync();

      toast.success('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©...', { id: 'hard-reset' });

      // Reload page
      setTimeout(() => {
        window.location.reload();
      }, 2000);

    } catch (error) {
      console.error('Hard reset error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ Ÿàÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', { id: 'hard-reset' });
    } finally {
      setHardResetLoading(false);
    }
  };

  if (loading || brandingLoading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto">
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-gray-900 mb-2 font-[Tajawal]">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ•ÿØÿßÿ±Ÿäÿ©</h1>
        <p className="text-gray-600 font-[Tajawal]">ÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸàÿßŸÑŸáŸàŸäÿ© ÿßŸÑÿ®ÿµÿ±Ÿäÿ© ŸàÿßŸÑÿ±Ÿàÿ¥ÿ™ÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ©</p>
      </div>

      <div className="flex flex-col md:flex-row gap-4 mb-8 border-b border-gray-200">
        <button
          onClick={() => setActiveTab('branding')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'branding'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <Palette size={20} />
          ÿßŸÑŸÖÿ∏Ÿáÿ± ŸàÿßŸÑŸáŸàŸäÿ©
        </button>
        <button
          onClick={() => setActiveTab('prescription')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'prescription'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <FileText size={20} />
          ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©
        </button>
        <button
          onClick={() => setActiveTab('profile')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'profile'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <User size={20} />
          ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä
        </button>
        <button
          onClick={() => setActiveTab('password')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'password'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <Lock size={20} />
          ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
        </button>
        <button
          onClick={() => setActiveTab('data')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'data'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <Database size={20} />
          ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        </button>
      </div>

      {activeTab === 'branding' && (
        <div className="bg-white rounded-lg shadow-md p-8">
          <div className="grid md:grid-cols-2 gap-8">
            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6 font-[Tajawal]">ÿßŸÑŸÖÿ∏Ÿáÿ± ŸàÿßŸÑŸáŸàŸäÿ©</h3>
              
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿßÿ≥ŸÖ ÿßŸÑÿπŸäÿßÿØÿ©</label>
                <input
                  type="text"
                  value={brandingFormData.clinic_name}
                  onChange={(e) => setBrandingFormData(prev => ({ ...prev, clinic_name: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                  placeholder="ÿ≥Ÿäÿ∏Ÿáÿ± ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ŸàÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä</label>
                <div className="flex gap-4 items-center">
                  <input
                    type="color"
                    value={brandingFormData.primary_color}
                    onChange={(e) => setBrandingFormData(prev => ({ ...prev, primary_color: e.target.value }))}
                    className="w-16 h-10 rounded border border-gray-300 cursor-pointer"
                  />
                  <input
                    type="text"
                    value={brandingFormData.primary_color}
                    onChange={(e) => setBrandingFormData(prev => ({ ...prev, primary_color: e.target.value }))}
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                    placeholder="#2d5a6b"
                  />
                </div>
                <p className="text-xs text-gray-500 mt-2 font-[Tajawal]">ÿ≥Ÿäÿ∏Ÿáÿ± ŸÅŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸàÿßŸÑÿπŸÜÿßŸàŸäŸÜ ŸàÿßŸÑÿ±Ÿàÿßÿ®ÿ∑</p>
              </div>

              <button
                onClick={handleBrandingSave}
                disabled={saving}
                className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
              >
                <Save size={18} />
                {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™'}
              </button>
            </div>

            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6 font-[Tajawal]">ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸäÿßÿØÿ©</h3>
              
              <div className="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
                {logoPreview ? (
                  <div className="mb-4">
                    <img
                      src={logoPreview}
                      alt="Clinic logo"
                      className="w-40 h-40 rounded-lg mx-auto object-cover border-4 border-teal-600 mb-4"
                    />
                  </div>
                ) : (
                  <Palette size={64} className="mx-auto text-gray-400 mb-4" />
                )}
                
                <label className="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg cursor-pointer font-[Tajawal] font-semibold transition-colors">
                  {logoUploadLoading ? (
                    <>
                      <Loader size={18} className="animate-spin" />
                      ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ...
                    </>
                  ) : (
                    <>
                      <Upload size={18} />
                      ÿßÿÆÿ™ÿ± ÿ¥ÿπÿßÿ±
                    </>
                  )}
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleLogoUpload}
                    disabled={logoUploadLoading}
                    className="hidden"
                  />
                </label>
                
                <p className="text-xs text-gray-500 mt-4 font-[Tajawal]">PNG, JPG ÿ≠ÿ™Ÿâ 10MB</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'prescription' && (
        <div className="bg-white rounded-lg shadow-md p-8 max-w-2xl">
          <h3 className="text-xl font-bold text-gray-900 mb-6 font-[Tajawal]">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</h3>
          
          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸäÿßÿØÿ©</label>
            <textarea
              value={prescriptionFormData.clinic_address}
              onChange={(e) => setPrescriptionFormData(prev => ({ ...prev, clinic_address: e.target.value }))}
              rows={3}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ÿ≥Ÿäÿ∏Ÿáÿ± ŸÅŸä ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ŸÅŸÑŸä ŸÖŸÜ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑŸÖÿ∑ÿ®Ÿàÿπÿ©"
            />
          </div>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿßŸÑÿπŸäÿßÿØÿ©</label>
            <input
              type="tel"
              value={prescriptionFormData.clinic_phone}
              onChange={(e) => setPrescriptionFormData(prev => ({ ...prev, clinic_phone: e.target.value }))}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ŸÖÿ´ÿßŸÑ: 201003418068"
            />
          </div>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©</label>
            <textarea
              value={prescriptionFormData.default_rx_notes}
              onChange={(e) => setPrescriptionFormData(prev => ({ ...prev, default_rx_notes: e.target.value }))}
              rows={5}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿßŸÑÿ™Ÿä ÿ≥ÿ™ÿ∏Ÿáÿ± ŸÅŸä ŸÉŸÑ ÿ±Ÿàÿ¥ÿ™ÿ©..."
            />
            <p className="text-xs text-gray-500 mt-2 font-[Tajawal]">ÿ≥ÿ™ÿ∏Ÿáÿ± Ÿáÿ∞Ÿá ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©</p>
          </div>

          <button
            onClick={handlePrescriptionSave}
            disabled={saving}
            className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            <Save size={18} />
            {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™'}
          </button>
        </div>
      )}

      {activeTab === 'profile' && (
        <div className="bg-white rounded-lg shadow-md p-8">
          <div className="grid md:grid-cols-2 gap-8">
            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6 font-[Tajawal]">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
              
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿßŸÑÿßÿ≥ŸÖ</label>
                <input
                  type="text"
                  value={profileFormData.name}
                  onChange={(e) => setProfileFormData(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                <input
                  type="email"
                  value={profileFormData.email}
                  disabled
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿßŸÑŸáÿßÿ™ŸÅ</label>
                <input
                  type="tel"
                  value={profileFormData.phone}
                  onChange={(e) => setProfileFormData(prev => ({ ...prev, phone: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿßŸÑÿ™ÿÆÿµÿµ</label>
                <input
                  type="text"
                  value={profileFormData.specialization}
                  onChange={(e) => setProfileFormData(prev => ({ ...prev, specialization: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <button
                onClick={handleProfileSave}
                disabled={saving}
                className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
              >
                <Save size={18} />
                {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}
              </button>
            </div>

            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6 font-[Tajawal]">ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
              
              <div className="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
                {profileFormData.doctor_image ? (
                  <div className="mb-4">
                    <img
                      src={profileFormData.doctor_image}
                      alt="Doctor profile"
                      className="w-40 h-40 rounded-full mx-auto object-cover border-4 border-teal-600 mb-4"
                    />
                  </div>
                ) : (
                  <User size={64} className="mx-auto text-gray-400 mb-4" />
                )}
                
                <label className="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg cursor-pointer font-[Tajawal] font-semibold transition-colors">
                  <Upload size={18} />
                  ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleDoctorImageUpload}
                    disabled={saving}
                    className="hidden"
                  />
                </label>
                
                <p className="text-xs text-gray-500 mt-4 font-[Tajawal]">PNG, JPG ÿ≠ÿ™Ÿâ 10MB</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'password' && (
        <div className="bg-white rounded-lg shadow-md p-8 max-w-xl">
          <h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2 font-[Tajawal]">
            <AlertCircle size={24} className="text-orange-500" />
            ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
          </h3>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©</label>
            <input
              type="password"
              value={passwordData.newPassword}
              onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©"
            />
          </div>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
            <input
              type="password"
              value={passwordData.confirmPassword}
              onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±"
            />
          </div>

          <p className="text-sm text-gray-600 mb-6 flex items-center gap-2">
            <AlertCircle size={16} />
            ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ
          </p>

          <button
            onClick={handlePasswordSave}
            disabled={saving}
            className="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            <Save size={18} />
            {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...' : 'ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±'}
          </button>
        </div>
      )}

      {activeTab === 'data' && (
        <div className="bg-white rounded-lg shadow-md p-8">
          <h3 className="text-xl font-bold text-gray-900 mb-6 font-[Tajawal]">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©</h3>

          <div className="grid md:grid-cols-2 gap-8 mb-8">
            <div>
              <h4 className="text-lg font-semibold text-gray-800 mb-4 font-[Tajawal]">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©</h4>
              {syncStats ? (
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="font-[Tajawal]">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™:</span>
                    <span className="font-semibold">{syncStats.total}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="font-[Tajawal]">ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ≤ÿßŸÖŸÜÿ©:</span>
                    <span className="font-semibold text-green-600">{syncStats.synced}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="font-[Tajawal]">ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©:</span>
                    <span className="font-semibold text-yellow-600">{syncStats.pending}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="font-[Tajawal]">ÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©:</span>
                    <span className="font-semibold text-red-600">{syncStats.errors}</span>
                  </div>
                </div>
              ) : (
                <div className="text-gray-500 font-[Tajawal]">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™...</div>
              )}
            </div>

            <div>
              <h4 className="text-lg font-semibold text-gray-800 mb-4 font-[Tajawal]">ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±</h4>
              <p className="text-sm text-gray-600 mb-4 font-[Tajawal]">
                ÿßÿ≥ÿ™ÿÆÿØŸÖ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ© ÿπŸÜÿØŸÖÿß ÿ™ŸÉŸàŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ∫Ÿäÿ± ŸÖÿ™ÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿ£Ÿà ÿπŸÜÿØ Ÿàÿ¨ŸàÿØ ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä ÿßŸÑÿπÿ±ÿ∂.
              </p>
              <button
                onClick={handleHardReset}
                disabled={hardResetLoading}
                className="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
              >
                {hardResetLoading ? (
                  <>
                    <Loader size={18} className="animate-spin" />
                    ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
                  </>
                ) : (
                  <>
                    <RefreshCw size={18} />
                    ‚ö†Ô∏è ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
                  </>
                )}
              </button>
              <p className="text-xs text-red-600 mt-2 font-[Tajawal]">
                ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑŸáÿß ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Settings;
</file>

<file path="pages/ObstetricsDashboard.tsx">
import React, { useState, useEffect } from 'react';
import { Plus, Save } from 'lucide-react';
import { useLiveQuery } from 'dexie-react-hooks';
import toast from 'react-hot-toast';
import { Pregnancy, Patient, PrescriptionItem } from '../types';
import { db } from '../src/db/localDB';
import { obstetricsService, calculateEDD, calculateGestationalAge } from '../services/obstetricsService';
import { authService } from '../services/authService';
import { visitsService } from '../services/visitsService';
import PregnancyHeader from './components/obstetrics/PregnancyHeader';
import RiskAssessment from './components/obstetrics/RiskAssessment';
import ANCFlowSheet from './components/obstetrics/ANCFlowSheet';
import FetalGrowthChart from './components/obstetrics/FetalGrowthChart';
import PrescriptionComponent from '../components/PrescriptionComponent';
import PrescriptionPrinter from '../components/PrescriptionPrinter';

const ObstetricsDashboard: React.FC = () => {
  const patients = useLiveQuery(() => db.patients.toArray(), []) || [];
  const [selectedPatientId, setSelectedPatientId] = useState<string | null>(null);
  const [pregnancy, setPregnancy] = useState<Pregnancy | null>(null);
  const [isLoadingPregnancy, setIsLoadingPregnancy] = useState(false);
  const [showNewPregnancyForm, setShowNewPregnancyForm] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [doctorId, setDoctorId] = useState<string | null>(null);
  const [prescription, setPrescription] = useState<PrescriptionItem[]>([]);
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);

  const [formData, setFormData] = useState({
    lmp_date: '',
    edd_by_scan: '',
  });

  useEffect(() => {
    fetchDoctorProfile();
    if (patients.length > 0 && !selectedPatientId) {
      setSelectedPatientId(patients[0].id.toString());
    }
  }, []);

  useEffect(() => {
    if (selectedPatientId) {
      fetchPregnancy(selectedPatientId);
    }
  }, [selectedPatientId]);

  const fetchPregnancy = async (patientId: string) => {
    try {
      setIsLoadingPregnancy(true);
      const data = await obstetricsService.getPregnancyByPatient(patientId);
      setPregnancy(data || null);
    } catch (error) {
      console.error('Error fetching pregnancy:', error);
      setPregnancy(null);
    } finally {
      setIsLoadingPregnancy(false);
    }
  };

  const fetchDoctorProfile = async () => {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        const doctor = await authService.getDoctorProfile(user.id);
        setDoctorId(doctor.id);
      }
    } catch (error) {
      console.error('Error fetching doctor profile:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
    }
  };

  const handleCreatePregnancy = async () => {
    try {
      if (!selectedPatientId) {
        toast.error('ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿ© ÿ£ŸàŸÑÿßŸã');
        return;
      }

      if (!doctorId) {
        toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
        return;
      }

      const lmpDate = formData.lmp_date?.trim() || null;
      const eddByScan = formData.edd_by_scan?.trim() || null;

      if (!lmpDate && !eddByScan) {
        toast.error('ÿ£ÿØÿÆŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ÿØŸàÿ±ÿ© ÿ£Ÿà ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπ');
        return;
      }

      setIsSaving(true);

      let eddDate: string | null = null;

      if (eddByScan) {
        if (isNaN(new Date(eddByScan).getTime())) {
          toast.error('Invalid EDD date provided');
          setIsSaving(false);
          return;
        }
        eddDate = eddByScan;
      } else if (lmpDate) {
        eddDate = calculateEDD(lmpDate);
        if (!eddDate) {
          toast.error('Unable to calculate EDD from LMP date');
          setIsSaving(false);
          return;
        }
      }

      if (!eddDate) {
        toast.error('Invalid date provided. Please check LMP or EDD by scan.');
        setIsSaving(false);
        return;
      }

      const pregnancyData = {
        doctor_id: doctorId,
        patient_id: selectedPatientId,
        lmp_date: lmpDate,
        edd_date: eddDate,
        edd_by_scan: eddByScan,
        risk_level: 'low' as const,
        risk_factors: [] as string[],
        aspirin_prescribed: false,
        thromboprophylaxis_needed: false,
      };

      console.log('Creating pregnancy with data:', pregnancyData);

      const newPregnancy = await obstetricsService.createPregnancy(pregnancyData);

      if (!newPregnancy || !newPregnancy.id) {
        throw new Error('Failed to create pregnancy: Invalid response from server');
      }

      setPregnancy(newPregnancy);
      setShowNewPregnancyForm(false);
      setFormData({ lmp_date: '', edd_by_scan: '' });
      toast.success('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error: any) {
      console.error('Error creating pregnancy:', error);
      console.error('Error details:', {
        message: error?.message,
        code: error?.code,
        status: error?.status,
        details: error?.details,
        hint: error?.hint,
      });
      toast.error(`ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ: ${error?.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleUpdatePregnancy = async (updates: Partial<Pregnancy>) => {
    if (!pregnancy || !pregnancy.id) {
      console.error('Cannot update pregnancy: pregnancy data is invalid');
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ: ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
      return;
    }

    try {
      if (!updates || Object.keys(updates).length === 0) {
        console.warn('No updates provided');
        return;
      }

      const sanitizedUpdates = {
        ...updates,
        risk_factors: Array.isArray(updates.risk_factors) ? updates.risk_factors : [],
      };

      await obstetricsService.updatePregnancy(pregnancy.id, sanitizedUpdates);
      const updated = await obstetricsService.getPregnancyByPatient(pregnancy.patient_id);
      
      if (!updated || !updated.id) {
        throw new Error('Failed to fetch updated pregnancy data');
      }
      
      setPregnancy(updated);
    } catch (error) {
      console.error('Error updating pregnancy:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ');
      throw error;
    }
  };

  const handleSaveVisit = async () => {
    if (!selectedPatientId || !pregnancy || !pregnancy.id) {
      toast.error('Please select a patient and ensure pregnancy data is loaded');
      return;
    }

    setIsSaving(true);
    try {
      if (!selectedPatientId || typeof selectedPatientId !== 'string') {
        throw new Error('Invalid patient ID');
      }

      const gestationalAge = calculateGestationalAge(pregnancy.lmp_date);
      
      if (!gestationalAge || typeof gestationalAge.weeks !== 'number' || typeof gestationalAge.days !== 'number') {
        throw new Error('Invalid gestational age calculation');
      }

      const clinicalData = {
        pregnancyId: pregnancy.id,
        gestationalAge: gestationalAge,
        riskAssessment: {
          level: pregnancy.risk_level || 'low',
          factors: Array.isArray(pregnancy.risk_factors) ? pregnancy.risk_factors : [],
          aspirin: Boolean(pregnancy.aspirin_prescribed),
          thromboprophylaxis: Boolean(pregnancy.thromboprophylaxis_needed),
        },
        currentStatus: 'Active Pregnancy Monitoring',
      };

      const notesText = gestationalAge.weeks > 0
        ? `Gestational age: ${gestationalAge.weeks} weeks ${gestationalAge.days} days`
        : 'Gestational age: Not available';

      await visitsService.saveVisit({
        patientId: selectedPatientId,
        department: 'OBS',
        clinicalData: clinicalData,
        diagnosis: `Pregnancy - ${pregnancy.risk_level || 'low'} risk`,
        prescription: Array.isArray(prescription) ? prescription : [],
        notes: notesText,
      });

      toast.success('Obstetrics visit saved successfully');
      setPrescription([]);

    } catch (error: any) {
      console.error('Error saving visit:', error);
      toast.error(`Failed to save visit: ${error?.message || 'Unknown error'}`);
    } finally {
      setIsSaving(false);
    }
  };

  const currentPatient = patients.find(p => p.id.toString() === selectedPatientId);

  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-gray-900 mb-2 font-[Tajawal]">
          ü§∞ Ÿàÿ≠ÿØÿ© ÿ∑ÿ® ÿßŸÑÿ™ŸàŸÑŸäÿØ ŸàÿßŸÑŸÜÿ≥ÿßÿ¶Ÿäÿ©
        </h1>
        <p className="text-gray-600 font-[Tajawal]">
          ŸÖÿ™ÿßÿ®ÿπÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑÿ≠ŸÖŸÑ ŸàÿßŸÑŸàŸÑÿßÿØÿ© ŸÖÿπ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ŸàÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäŸàŸÖŸäÿ™ÿ±Ÿä
        </p>
      </div>

      <div className="grid md:grid-cols-4 gap-4 mb-6">
        <div className="md:col-span-3">
          <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
            ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©
          </label>
          <select
            value={selectedPatientId || ''}
            onChange={(e) => setSelectedPatientId(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
          >
            <option value="">-- ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿ© --</option>
            {patients.map(patient => (
              <option key={patient.id} value={patient.id.toString()}>
                {patient.name} - {patient.phone}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
            &nbsp;
          </label>
          <button
            onClick={() => window.location.reload()}
            className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            üîÑ ÿ™ÿ≠ÿØŸäÿ´
          </button>
        </div>
      </div>

      {isLoadingPregnancy ? (
        <div className="flex items-center justify-center h-96">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
        </div>
      ) : pregnancy && pregnancy.id && pregnancy.patient_id ? (
        <>
          <PregnancyHeader pregnancy={pregnancy} />
          <RiskAssessment pregnancy={pregnancy} onUpdate={handleUpdatePregnancy} />
          <ANCFlowSheet pregnancyId={pregnancy.id} lmpDate={pregnancy.lmp_date || undefined} />
          <FetalGrowthChart pregnancyId={pregnancy.id} lmpDate={pregnancy.lmp_date || undefined} />

          {/* Prescription Section */}
          <div className="bg-white rounded-lg shadow-md p-6 mt-6">
            <PrescriptionComponent
              prescriptions={prescription}
              onPrescriptionsChange={setPrescription}
              onPrint={() => setIsPrinterOpen(true)}
              showPrintButton={true}
            />
          </div>

          {/* Save Visit Button */}
          <div className="bg-white rounded-lg shadow-md p-6 mt-6">
            <button
              onClick={handleSaveVisit}
              disabled={isSaving}
              className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
            >
              <Save className="w-5 h-5" />
              {isSaving ? 'Saving...' : 'Save Obstetrics Visit'}
            </button>
          </div>
        </>
      ) : currentPatient ? (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-teal-100 rounded-full mb-4">
            <Plus size={32} className="text-teal-600" />
          </div>
          <h3 className="text-xl font-bold text-gray-900 mb-2 font-[Tajawal]">
            ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ ÿ≠ŸÖŸÑ ŸÑŸÄ {currentPatient.name}
          </h3>
          <p className="text-gray-600 mb-6 font-[Tajawal]">
            ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿ≠ŸÖŸÑ ÿ¨ÿØŸäÿØ ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ¥ÿßŸÖŸÑÿ©
          </p>

          {!showNewPregnancyForm ? (
            <button
              onClick={() => setShowNewPregnancyForm(true)}
              className="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
            >
              <Plus size={20} />
              ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿ≠ŸÖŸÑ ÿ¨ÿØŸäÿØ
            </button>
          ) : (
            <div className="bg-gray-50 p-6 rounded-lg border-2 border-teal-200 max-w-md mx-auto">
              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                  ÿ¢ÿÆÿ± ÿØŸàÿ±ÿ© ÿ¥Ÿáÿ±Ÿäÿ© (LMP)
                </label>
                <input
                  type="date"
                  value={formData.lmp_date}
                  onChange={(e) => setFormData(prev => ({ ...prev, lmp_date: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                />
              </div>

              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                  ÿ£Ÿà ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿ®ÿßŸÑŸÖÿ≥ÿ≠ (EDD by Ultrasound)
                </label>
                <input
                  type="date"
                  value={formData.edd_by_scan}
                  onChange={(e) => setFormData(prev => ({ ...prev, edd_by_scan: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleCreatePregnancy}
                  disabled={isSaving}
                  className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
                >
                  {isSaving ? 'ÿ¨ÿßÿ±Ÿä...' : 'ÿ•ŸÜÿ¥ÿßÿ°'}
                </button>
                <button
                  onClick={() => setShowNewPregnancyForm(false)}
                  className="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
                >
                  ÿ•ŸÑÿ∫ÿßÿ°
                </button>
              </div>
            </div>
          )}
        </div>
      ) : (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <p className="text-gray-600 font-[Tajawal]">ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿ© ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©</p>
        </div>
      )}

      <PrescriptionPrinter
        patient={currentPatient || null}
        prescriptions={Array.isArray(prescription) ? prescription : []}
        diagnosis={pregnancy && pregnancy.id ? `Pregnancy - ${pregnancy.risk_level || 'low'} risk` : ''}
        notes={pregnancy && pregnancy.id && pregnancy.lmp_date ? (() => {
          try {
            const ga = calculateGestationalAge(pregnancy.lmp_date);
            return ga && ga.weeks > 0 ? `Gestational age: ${ga.weeks} weeks ${ga.days} days` : 'Gestational age: Not available';
          } catch (err) {
            console.warn('Error calculating GA for printer:', err);
            return 'Gestational age: Not available';
          }
        })() : ''}
        isOpen={isPrinterOpen}
        onClose={() => setIsPrinterOpen(false)}
      />
    </div>
  );
};

export default ObstetricsDashboard;
</file>

<file path="pages/PatientMasterRecord.tsx">
import React, { useState, useEffect } from 'react';
import {
  Calendar, FileText, User, Heart, Baby, TestTube, Download, ChevronDown, ChevronUp,
  X, Image as ImageIcon, Printer
} from 'lucide-react';
import { useLiveQuery } from 'dexie-react-hooks';
import { Patient, Visit } from '../types';
import { db } from '../src/db/localDB';
import { supabase } from '../services/supabaseClient';
import { visitsService } from '../services/visitsService';
import toast from 'react-hot-toast';
import PrescriptionPrinter from '../components/PrescriptionPrinter';

const PatientMasterRecord: React.FC = () => {
  const [selectedPatientId, setSelectedPatientId] = useState<string>('');
  const [visits, setVisits] = useState<Visit[]>([]);
  const [patientFiles, setPatientFiles] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);
  const [selectedVisit, setSelectedVisit] = useState<Visit | null>(null);
  const [activeTab, setActiveTab] = useState<'timeline' | 'gallery'>('timeline');
  const [selectedFilter, setSelectedFilter] = useState<'All' | 'GYNA' | 'OBS' | 'IVF'>('All');
  const [expandedVisitId, setExpandedVisitId] = useState<string | null>(null);
  const [selectedImage, setSelectedImage] = useState<any | null>(null);

  const localPatients = useLiveQuery(async () => {
    return await db.patients.toArray();
  }, []) || [];

  const patients: Patient[] = localPatients.map((p: any) => ({
    id: p.id || p.remoteId,
    name: p.name,
    age: p.age,
    phone: p.phone,
    husbandName: p.husbandName || p.husband_name,
    history: p.history,
    createdAt: p.created_at || p.createdAt?.toString()
  }));

  useEffect(() => {
    if (selectedPatientId) {
      fetchPatientVisits(selectedPatientId);
      fetchPatientFiles(selectedPatientId);
    } else {
      setVisits([]);
      setPatientFiles([]);
    }
  }, [selectedPatientId]);

  const fetchPatientVisits = async (patientId: string) => {
    setIsLoading(true);
    try {
      const data = await visitsService.getVisitsByPatient(patientId);
      const mappedData = (data || []).map((visit: any) => ({
        ...visit,
        patientId: visit.patient_id,
      }));
      setVisits(mappedData.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()));
    } catch (error) {
      console.error('Error fetching visits:', error);
      toast.error('Failed to load patient visits');
    } finally {
      setIsLoading(false);
    }
  };

  const fetchPatientFiles = async (patientId: string) => {
    try {
      const { data, error } = await supabase
        .from('patient_files')
        .select('*')
        .eq('patient_id', patientId)
        .order('created_at', { ascending: false });

      if (error) {
        setPatientFiles([]);
      } else {
        setPatientFiles(data || []);
      }
    } catch (error) {
      console.error('Error fetching patient files:', error);
      setPatientFiles([]);
    }
  };

  const selectedPatient = patients.find(p => p.id === selectedPatientId);

  const getDepartmentIcon = (department?: string) => {
    switch (department) {
      case 'GYNA': return <Heart className="w-6 h-6 text-pink-600" />;
      case 'OBS': return <Baby className="w-6 h-6 text-blue-600" />;
      case 'IVF_STIM': return <TestTube className="w-6 h-6 text-purple-600" />;
      case 'IVF_LAB': return <TestTube className="w-6 h-6 text-purple-600" />;
      default: return <FileText className="w-6 h-6 text-gray-600" />;
    }
  };

  const getDepartmentName = (department?: string) => {
    switch (department) {
      case 'GYNA': return 'Gynecology';
      case 'OBS': return 'Obstetrics';
      case 'IVF_STIM': return 'IVF Stimulation';
      case 'IVF_LAB': return 'IVF Lab';
      default: return 'General Visit';
    }
  };

  const getDepartmentColor = (department?: string) => {
    switch (department) {
      case 'GYNA': return { bg: 'bg-pink-100', border: 'border-pink-300', dot: 'bg-pink-600' };
      case 'OBS': return { bg: 'bg-blue-100', border: 'border-blue-300', dot: 'bg-blue-600' };
      case 'IVF_STIM': return { bg: 'bg-purple-100', border: 'border-purple-300', dot: 'bg-purple-600' };
      case 'IVF_LAB': return { bg: 'bg-purple-100', border: 'border-purple-300', dot: 'bg-purple-600' };
      default: return { bg: 'bg-gray-100', border: 'border-gray-300', dot: 'bg-gray-600' };
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const renderClinicalData = (data: any, department?: string) => {
    if (!data) return null;
    switch (department) {
      case 'GYNA': return renderGynecologyData(data);
      case 'OBS': return renderObstetricsData(data);
      case 'IVF_STIM': return renderIVFData(data);
      default: return <div className="text-sm text-gray-600"><pre className="whitespace-pre-wrap">{JSON.stringify(data, null, 2)}</pre></div>;
    }
  };

  const renderGynecologyData = (data: any) => {
    const { assessment, diagnosis, procedureOrder, clinicalNotes } = data;
    return (
      <div className="space-y-3">
        {assessment?.complaints && assessment.complaints.length > 0 && (
          <div>
            <span className="font-medium text-gray-700">Complaints:</span>
            <div className="flex flex-wrap gap-1 mt-1">
              {assessment.complaints.map((complaint: string, idx: number) => (
                <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{complaint}</span>
              ))}
            </div>
          </div>
        )}
        {diagnosis && <div><span className="font-medium text-green-700">Diagnosis:</span> {diagnosis}</div>}
        {procedureOrder && <div><span className="font-medium text-purple-700">Procedure:</span> {procedureOrder}</div>}
        {clinicalNotes && <div><span className="font-medium text-gray-700">Notes:</span> {clinicalNotes}</div>}
      </div>
    );
  };

  const renderObstetricsData = (data: any) => {
    const { gestationalAge, riskAssessment, currentStatus } = data;
    return (
      <div className="space-y-2">
        {gestationalAge && <div><span className="font-medium">GA:</span> {gestationalAge.weeks}w {gestationalAge.days}d</div>}
        {riskAssessment && <div><span className="font-medium">Risk:</span> {riskAssessment.level}</div>}
        {currentStatus && <div><span className="font-medium">Status:</span> {currentStatus}</div>}
      </div>
    );
  };

  const renderIVFData = (data: any) => {
    const { protocol, startDate, stimulationDays, latestHormones } = data;
    return (
      <div className="space-y-2">
        {protocol && <div><span className="font-medium">Protocol:</span> {protocol}</div>}
        {startDate && <div><span className="font-medium">Started:</span> {formatDate(startDate)}</div>}
        {stimulationDays && <div><span className="font-medium">Days:</span> {stimulationDays}</div>}
        {latestHormones?.e2 && <div><span className="font-medium">E2:</span> {latestHormones.e2} pg/mL</div>}
      </div>
    );
  };

  const getFilteredVisits = () => {
    if (selectedFilter === 'All') return visits;
    if (selectedFilter === 'IVF') return visits.filter(v => v.department?.startsWith('IVF'));
    return visits.filter(v => v.department === selectedFilter);
  };

  const groupFilesByDate = (files: any[]) => {
    const grouped: { [key: string]: any[] } = {};
    files.forEach(file => {
      const date = new Date(file.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      if (!grouped[date]) grouped[date] = [];
      grouped[date].push(file);
    });
    return grouped;
  };

  const generateMedicalReport = () => {
    const filteredVisits = getFilteredVisits();
    const html = `
      <html>
        <head><title>Medical Report - ${selectedPatient?.name}</title></head>
        <body style="font-family: Arial; margin: 20px;">
          <h1>Medical Report</h1>
          <p><strong>Patient:</strong> ${selectedPatient?.name}</p>
          <p><strong>Age:</strong> ${selectedPatient?.age}</p>
          <table border="1" style="width: 100%; border-collapse: collapse;">
            <tr style="background: #f0f0f0;">
              <th style="padding: 8px;">Date</th>
              <th>Department</th>
              <th>Diagnosis</th>
            </tr>
            ${filteredVisits.map(v => `<tr><td style="padding: 8px;">${formatDate(v.date)}</td><td>${getDepartmentName(v.department)}</td><td>${v.diagnosis || 'N/A'}</td></tr>`).join('')}
          </table>
        </body>
      </html>
    `;
    const win = window.open('', '_blank');
    if (win) {
      win.document.write(html);
      win.document.close();
      setTimeout(() => win.print(), 250);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto p-6">
        <div className="mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">Patient Master Record</h1>
          <p className="text-gray-600">Comprehensive Medical Timeline & Archive</p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow-md mb-6">
          <label className="block text-sm font-semibold text-gray-700 mb-2">Select Patient</label>
          <select
            value={selectedPatientId}
            onChange={(e) => setSelectedPatientId(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
          >
            <option value="">-- Select Patient --</option>
            {patients.map(p => (<option key={p.id} value={p.id}>{p.name} - {p.phone}</option>))}
          </select>
        </div>

        {selectedPatient && (
          <div className="bg-white rounded-lg shadow-md overflow-hidden">
            <div className="bg-gradient-to-r from-teal-600 to-teal-700 text-white p-6 flex items-center justify-between sticky top-0 z-10">
              <div className="flex items-center gap-4">
                <div className="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                  <User className="w-7 h-7" />
                </div>
                <div>
                  <h2 className="text-2xl font-bold">{selectedPatient.name}</h2>
                  <p className="text-teal-100">Age: {selectedPatient.age} | ID: {String(selectedPatient.id).slice(0, 8)}</p>
                </div>
              </div>
              <button
                onClick={generateMedicalReport}
                className="flex items-center gap-2 bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition"
              >
                <Download className="w-5 h-5" />
                Report
              </button>
            </div>

            <div className="border-b border-gray-200 px-6 flex">
              <button
                onClick={() => setActiveTab('timeline')}
                className={`py-4 px-4 font-semibold border-b-2 transition ${
                  activeTab === 'timeline'
                    ? 'border-teal-600 text-teal-600'
                    : 'border-transparent text-gray-600'
                }`}
              >
                <Calendar className="w-5 h-5 inline mr-2" />
                Timeline
              </button>
              <button
                onClick={() => setActiveTab('gallery')}
                className={`py-4 px-4 font-semibold border-b-2 transition ${
                  activeTab === 'gallery'
                    ? 'border-teal-600 text-teal-600'
                    : 'border-transparent text-gray-600'
                }`}
              >
                <ImageIcon className="w-5 h-5 inline mr-2" />
                Media Gallery
              </button>
            </div>

            <div className="p-6">
              {activeTab === 'timeline' && (
                <div>
                  <div className="flex gap-2 mb-6 flex-wrap">
                    {(['All', 'GYNA', 'OBS', 'IVF'] as const).map(f => (
                      <button
                        key={f}
                        onClick={() => setSelectedFilter(f)}
                        className={`px-4 py-2 rounded-full font-medium transition ${
                          selectedFilter === f
                            ? 'bg-teal-600 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {f === 'GYNA' ? '‚ô• Gynecology' : f === 'OBS' ? 'üë∂ Obstetrics' : f === 'IVF' ? 'üß¨ IVF' : 'üìã All'}
                      </button>
                    ))}
                  </div>

                  {getFilteredVisits().length > 0 ? (
                    <div className="space-y-4">
                      {getFilteredVisits().map((v) => {
                        const colors = getDepartmentColor(v.department);
                        const isExpanded = expandedVisitId === v.id;

                        return (
                          <div key={v.id} className="flex gap-4">
                            <div className="flex flex-col items-center">
                              <div className={`w-4 h-4 rounded-full ${colors.dot} border-4 border-white shadow-md`} />
                              <div className="w-1 bg-gray-300 flex-1 h-12" />
                            </div>

                            <div
                              className={`flex-1 ${colors.bg} border-2 ${colors.border} rounded-lg p-4 cursor-pointer transition hover:shadow-md`}
                              onClick={() => setExpandedVisitId(isExpanded ? null : v.id)}
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-2">
                                    {getDepartmentIcon(v.department)}
                                    <h3 className="font-semibold text-gray-900">{getDepartmentName(v.department)}</h3>
                                    <span className="text-xs text-gray-500">{formatDate(v.date)}</span>
                                  </div>
                                  <p className="text-sm font-medium text-gray-700">{v.diagnosis || 'No diagnosis'}</p>
                                </div>
                                {isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                              </div>

                              {isExpanded && (
                                <div className="mt-4 pt-4 border-t border-opacity-30">
                                  <div className="bg-white bg-opacity-60 p-3 rounded mb-3">
                                    {renderClinicalData(v.clinical_data, v.department)}
                                  </div>
                                  {v.notes && (
                                    <div className="mb-3">
                                      <p className="text-xs font-medium text-gray-600 mb-1">Notes:</p>
                                      <p className="text-sm text-gray-700 italic">{v.notes}</p>
                                    </div>
                                  )}
                                  {v.prescription && v.prescription.length > 0 && (
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedVisit(v);
                                        setIsPrinterOpen(true);
                                      }}
                                      className="mt-3 flex items-center gap-2 text-sm text-teal-600 hover:text-teal-700 font-medium"
                                    >
                                      <Printer className="w-4 h-4" />
                                      Print Prescription
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center py-12 text-gray-500">
                      <Calendar className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                      No visits found for this filter
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'gallery' && (
                <div>
                  {patientFiles.length > 0 ? (
                    <div>
                      {Object.entries(groupFilesByDate(patientFiles)).map(([date, files]) => (
                        <div key={date} className="mb-8">
                          <h3 className="text-lg font-semibold text-gray-900 mb-4">{date}</h3>
                          <div className="grid grid-cols-4 gap-4">
                            {files.map(f => (
                              <div
                                key={f.id}
                                className="bg-gray-100 rounded-lg overflow-hidden cursor-pointer group hover:shadow-lg transition"
                                onClick={() => setSelectedImage(f)}
                              >
                                <div className="aspect-square bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center group-hover:from-gray-300 group-hover:to-gray-400">
                                  <ImageIcon className="w-8 h-8 text-gray-500" />
                                </div>
                                <p className="text-xs text-gray-600 p-2 truncate">{f.name || 'File'}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}

                      {selectedImage && (
                        <div
                          className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                          onClick={() => setSelectedImage(null)}
                        >
                          <div
                            className="bg-white rounded-lg p-4 max-w-2xl w-full"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <div className="flex items-center justify-between mb-4">
                              <h3 className="text-lg font-semibold">{selectedImage.name || 'File'}</h3>
                              <button onClick={() => setSelectedImage(null)} className="text-gray-600 hover:text-gray-900">
                                <X className="w-6 h-6" />
                              </button>
                            </div>
                            <div className="bg-gray-100 rounded-lg p-4 min-h-96 flex items-center justify-center">
                              <ImageIcon className="w-16 h-16 text-gray-400" />
                            </div>
                            <p className="text-sm text-gray-600 mt-4">{formatDate(selectedImage.created_at)}</p>
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="text-center py-12 text-gray-500">
                      <ImageIcon className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                      No media files available
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {isPrinterOpen && selectedVisit && (
        <PrescriptionPrinter
          patient={selectedPatient || null}
          prescriptions={selectedVisit.prescription || []}
          diagnosis={selectedVisit.diagnosis}
          notes={selectedVisit.notes}
          isOpen={isPrinterOpen}
          onClose={() => {
            setIsPrinterOpen(false);
            setSelectedVisit(null);
          }}
        />
      )}
    </div>
  );
};

export default PatientMasterRecord;
</file>

<file path="services/obstetricsService.ts">
import { supabase } from './supabaseClient';
import { syncManager } from '../src/services/syncService';
import { db as localDB } from '../src/lib/localDb';
import { networkStatus } from '../src/lib/networkStatus';
import { Pregnancy, AntenatalVisit, BiometryScan } from '../types';

// ============================================================================
// CALCULATION FUNCTIONS
// ============================================================================

export const calculateGestationalAge = (lmpDate: string | null | undefined): { weeks: number; days: number } => {
  if (!lmpDate || typeof lmpDate !== 'string' || lmpDate.trim() === '') {
    return { weeks: 0, days: 0 };
  }

  try {
    const timestamp = new Date(lmpDate).getTime();
    if (isNaN(timestamp)) {
      return { weeks: 0, days: 0 };
    }

    const today = new Date();
    const lmp = new Date(timestamp);
    const diffTime = Math.abs(today.getTime() - lmp.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const weeks = Math.max(0, Math.floor(diffDays / 7));
    const days = Math.max(0, diffDays % 7);
    
    if (isNaN(weeks) || isNaN(days)) {
      return { weeks: 0, days: 0 };
    }
    
    return { weeks, days };
  } catch (error) {
    console.warn('Invalid LMP date provided to calculateGestationalAge:', lmpDate);
    return { weeks: 0, days: 0 };
  }
};

export const calculateEDD = (lmpDate: string | null | undefined): string => {
  if (!lmpDate || typeof lmpDate !== 'string' || lmpDate.trim() === '') {
    return '';
  }

  try {
    const timestamp = new Date(lmpDate).getTime();
    if (isNaN(timestamp)) {
      return '';
    }

    const lmp = new Date(timestamp);
    if (!lmp || isNaN(lmp.getTime())) {
      return '';
    }

    lmp.setDate(lmp.getDate() + 280);
    const eddString = lmp.toISOString().split('T')[0];
    
    if (!eddString) {
      return '';
    }
    
    return eddString;
  } catch (error) {
    console.warn('Invalid LMP date provided to calculateEDD:', lmpDate);
    return '';
  }
};

export const calculateGAFromEDD = (eddDate: string): { weeks: number; days: number } => {
  const today = new Date();
  const edd = new Date(eddDate);
  const diffTime = edd.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  const totalDaysToEDD = Math.max(0, diffDays);
  const totalGADays = 40 * 7 - totalDaysToEDD;
  const gaWeeks = Math.floor(totalGADays / 7);
  const gaDays = totalGADays % 7;
  return { weeks: Math.max(0, gaWeeks), days: Math.max(0, gaDays) };
};

// Hadlock formula for Estimated Fetal Weight (EFW)
export const calculateEFW = (
  bpdMm: number | null | undefined,
  hcMm: number | null | undefined,
  acMm: number | null | undefined,
  flMm: number | null | undefined
): number => {
  const inputs = [bpdMm, hcMm, acMm, flMm];
  
  if (inputs.some(input => input === null || input === undefined || isNaN(Number(input)))) {
    return 0;
  }

  const bpd = Number(bpdMm);
  const hc = Number(hcMm);
  const ac = Number(acMm);
  const fl = Number(flMm);

  if (bpd <= 0 || hc <= 0 || ac <= 0 || fl <= 0) {
    return 0;
  }

  try {
    const log10EFW =
      1.3404 +
      0.0438 * hc +
      0.158 * ac +
      0.0061 * bpd -
      0.002322 * ac * bpd;

    if (isNaN(log10EFW) || !isFinite(log10EFW)) {
      return 0;
    }

    const efw = Math.pow(10, log10EFW);

    if (isNaN(efw) || !isFinite(efw) || efw < 100 || efw > 5000) {
      return 0;
    }

    return Math.round(efw);
  } catch (error) {
    console.warn('Error calculating EFW with inputs:', { bpdMm, hcMm, acMm, flMm });
    return 0;
  }
};

// Calculate percentile based on RCOG/NICE standards (simplified)
export const calculatePercentile = (efwGrams: number, gaWeeks: number): number => {
  const expectedWeights: { [key: number]: { p10: number; p50: number; p90: number } } = {
    20: { p10: 300, p50: 330, p90: 370 },
    22: { p10: 430, p50: 475, p90: 540 },
    24: { p10: 600, p50: 660, p90: 750 },
    26: { p10: 760, p50: 850, p90: 980 },
    28: { p10: 1000, p50: 1100, p90: 1270 },
    30: { p10: 1300, p50: 1440, p90: 1680 },
    32: { p10: 1600, p50: 1840, p90: 2150 },
    34: { p10: 2100, p50: 2450, p90: 2850 },
    36: { p10: 2600, p50: 3000, p90: 3500 },
    38: { p10: 3000, p50: 3400, p90: 3900 },
    40: { p10: 3200, p50: 3500, p90: 3900 },
  };

  const weights = expectedWeights[gaWeeks];
  if (!weights) return 50;

  if (efwGrams <= weights.p10) return 10;
  if (efwGrams >= weights.p90) return 90;
  if (efwGrams <= weights.p50) {
    return 10 + ((efwGrams - weights.p10) / (weights.p50 - weights.p10)) * 40;
  }
  return 50 + ((efwGrams - weights.p50) / (weights.p90 - weights.p50)) * 40;
};

// ============================================================================
// RISK ASSESSMENT
// ============================================================================

export interface RiskFactors {
  age_over_40: boolean;
  bmi_over_30: boolean;
  previous_preeclampsia: boolean;
  twins: boolean;
  autoimmune: boolean;
  hypertension: boolean;
  diabetes: boolean;
  kidney_disease: boolean;
}

export const assessRiskLevel = (
  riskFactors: RiskFactors | null | undefined
): {
  level: 'low' | 'moderate' | 'high';
  riskFactorsList: string[];
  aspirinNeeded: boolean;
  thromboprophylaxisNeeded: boolean;
} => {
  // Provide safe defaults if riskFactors is null/undefined
  const safeRiskFactors = riskFactors || {
    age_over_40: false,
    bmi_over_30: false,
    previous_preeclampsia: false,
    twins: false,
    autoimmune: false,
    hypertension: false,
    diabetes: false,
    kidney_disease: false,
  };

  const highRiskFactors = [
    safeRiskFactors.previous_preeclampsia,
    safeRiskFactors.hypertension,
    safeRiskFactors.kidney_disease,
    safeRiskFactors.diabetes,
    safeRiskFactors.autoimmune,
  ].filter(Boolean).length;

  const moderateRiskFactors = [
    safeRiskFactors.age_over_40,
    safeRiskFactors.bmi_over_30,
    safeRiskFactors.twins,
  ].filter(Boolean).length;

  let level: 'low' | 'moderate' | 'high' = 'low';
  let aspirinNeeded = false;
  let thromboprophylaxisNeeded = false;
  const riskFactorsList: string[] = [];

  if (highRiskFactors >= 1) {
    level = 'high';
    aspirinNeeded = true;
  } else if (moderateRiskFactors >= 2) {
    level = 'high';
    aspirinNeeded = true;
  } else if (moderateRiskFactors >= 1 || highRiskFactors === 0) {
    level = 'moderate';
  }

  if (safeRiskFactors.twins) {
    thromboprophylaxisNeeded = true;
  }

  if (safeRiskFactors.age_over_40) riskFactorsList.push('Age > 40');
  if (safeRiskFactors.bmi_over_30) riskFactorsList.push('BMI > 30');
  if (safeRiskFactors.previous_preeclampsia) riskFactorsList.push('Previous Pre-eclampsia');
  if (safeRiskFactors.twins) riskFactorsList.push('Multiple Pregnancy');
  if (safeRiskFactors.autoimmune) riskFactorsList.push('Autoimmune Disease');
  if (safeRiskFactors.hypertension) riskFactorsList.push('Hypertension');
  if (safeRiskFactors.diabetes) riskFactorsList.push('Diabetes');
  if (safeRiskFactors.kidney_disease) riskFactorsList.push('Kidney Disease');

  return { level, riskFactorsList, aspirinNeeded, thromboprophylaxisNeeded };
};

// ============================================================================
// DUE ACTIONS / ALERTS
// ============================================================================

export const getDueActions = (gaWeeks: number): string[] => {
  const actions: string[] = [];

  // Early pregnancy actions
  if (gaWeeks >= 11 && gaWeeks <= 13) {
    actions.push('‚ö†Ô∏è Nuchal Translucency (NT) Scan Due');
  }
  if (gaWeeks >= 15 && gaWeeks <= 20) {
    actions.push('‚ö†Ô∏è Quad Screen / NIPT Results Expected');
  }
  if (gaWeeks >= 20 && gaWeeks <= 22) {
    actions.push('‚ö†Ô∏è Mid-Trimester Anomaly Scan Due');
  }
  if (gaWeeks === 28) {
    actions.push('üíâ Anti-D Prophylaxis Due (if Rh negative)');
    actions.push('üß™ Glucose Tolerance Test (GTT) Due');
    actions.push('üíâ Tetanus Booster if needed');
  }
  if (gaWeeks >= 34 && gaWeeks <= 36) {
    actions.push('‚ö†Ô∏è Growth Scan Recommended');
    actions.push('üß™ Full Blood Count (FBC)');
  }
  if (gaWeeks >= 36 && gaWeeks < 40) {
    actions.push('üë∂ Position Check (Cephalic/Breech)');
    actions.push('üìã Discuss Birth Plan');
  }

  // CRITICAL: Post-term pregnancy alerts
  if (gaWeeks >= 40 && gaWeeks < 42) {
    actions.push('‚ö†Ô∏è Patient Overdue: Discuss Membrane Sweep / Induction - ŸÖŸÜÿßŸÇÿ¥ÿ© ÿ™ŸÖÿ≤ŸäŸÇ ÿßŸÑÿ£ÿ∫ÿ¥Ÿäÿ© / ÿßŸÑÿ≠ÿ´ ÿπŸÑŸâ ÿßŸÑŸàŸÑÿßÿØÿ©');
  }
  if (gaWeeks >= 41 && gaWeeks < 42) {
    actions.push('üü† Late Term: Schedule Induction of Labor - ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ≠ÿ´ ÿπŸÑŸâ ÿßŸÑŸàŸÑÿßÿØÿ©');
  }
  if (gaWeeks >= 42) {
    actions.push('üî¥ POST TERM: CRITICAL - Immediate Delivery/Admission Required - ÿ≠ŸÖŸÑ ŸÖÿ™ÿ£ÿÆÿ± ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ - ŸàŸÑÿßÿØÿ© ŸÅŸàÿ±Ÿäÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©');
  }

  return actions;
};

// ============================================================================
// DATABASE OPERATIONS
// ============================================================================

export const obstetricsService = {
  // PREGNANCIES
  createPregnancy: async (pregnancy: Omit<Pregnancy, 'id' | 'created_at' | 'updated_at'>) => {
    try {
      // Get current user and ensure doctor record exists
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) throw new Error('Not authenticated');

      const doctor = await supabase
        .from('doctors')
        .select('id')
        .eq('user_id', user.id)
        .single();

      if (doctor.error || !doctor.data) {
        throw new Error('Doctor profile missing. Please log out and sign in again.');
      }

      const pregnancyData = {
        ...pregnancy,
        doctor_id: doctor.data.id
      };

      try {
        // Save using sync manager for offline-first support
        return await syncManager.save('pregnancies', pregnancyData);
      } catch (error) {
        console.error('Failed to save pregnancy via sync manager:', error);
        // Fallback to direct Supabase if online
        if (networkStatus.getStatus()) {
          const { data, error: supabaseError } = await supabase
            .from('pregnancies')
            .insert([pregnancyData])
            .select()
            .single();

          if (supabaseError) {
            console.error('Supabase error inserting pregnancy:', supabaseError);
            throw new Error(`Failed to create pregnancy: ${supabaseError.message}`);
          }
          return data;
        }
        throw error;
      }
    } catch (err: any) {
      console.error('Exception in createPregnancy:', err);
      throw err;
    }
  },

  getPregnancyByPatient: async (patientId: string) => {
    try {
      // Try local DB first
      const localPregnancies = await localDB.pregnancies.where('patientId').equals(patientId).toArray();
      
      // Background sync if online
      if (networkStatus.getStatus()) {
        setTimeout(() => syncManager.read('pregnancies'), 0);
      }

      if (localPregnancies.length > 0 && localPregnancies[0].remoteId) {
        return localPregnancies[0];
      }
    } catch (error) {
      console.error('Error fetching local pregnancy, falling back to Supabase:', error);
    }
    
    // Fallback to Supabase
    const { data, error } = await supabase
      .from('pregnancies')
      .select('*')
      .eq('patient_id', patientId)
      .order('created_at', { ascending: false })
      .single();

    if (error && error.code !== 'PGRST116') throw error;
    return data;
  },

  updatePregnancy: async (pregnancyId: string, updates: Partial<Pregnancy>) => {
    const { data, error } = await supabase
      .from('pregnancies')
      .update(updates)
      .eq('id', pregnancyId)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  // ANTENATAL VISITS
  createANCVisit: async (visit: Omit<AntenatalVisit, 'id' | 'created_at'>) => {
    try {
      // Save using sync manager for offline-first support
      return await syncManager.save('antenatal_visits', visit);
    } catch (error) {
      console.error('Failed to save ANC visit via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { data, error: supabaseError } = await supabase
          .from('antenatal_visits')
          .insert([visit])
          .select()
          .single();

        if (supabaseError) throw supabaseError;
        return data;
      }
      throw error;
    }
  },

  getANCVisits: async (pregnancyId: string) => {
    try {
      // Try local DB first
      const localVisits = await localDB.visits.where('patientId').equals(pregnancyId).toArray();
      
      // Background sync
      setTimeout(() => syncManager.read('antenatal_visits'), 0);

      return localVisits.map((v: any) => ({
        id: v.remoteId || `local_${v.id}`,
        patient_id: v.patient_id,
        department: v.department,
        visit_date: v.visit_date,
        clinical_data: v.clinical_data,
        diagnosis: v.diagnosis,
        prescription: v.prescription,
        notes: v.notes,
        doctor_id: v.doctor_id,
        created_at: v.created_at,
        updated_at: v.updated_at
      }));
    } catch (error) {
      console.error('Error fetching local ANC visits, falling back to Supabase:', error);
      
      // Fallback to Supabase
      const { data, error: supabaseError } = await supabase
        .from('antenatal_visits')
        .select('*')
        .eq('pregnancy_id', pregnancyId)
        .order('visit_date', { ascending: false });

      if (supabaseError) throw supabaseError;
      return data;
    }
  },

  updateANCVisit: async (visitId: string, updates: Partial<AntenatalVisit>) => {
    try {
      // Try sync manager for update
      await syncManager.update('antenatal_visits', visitId, updates);
      return updates;
    } catch (error) {
      console.error('Failed to update ANC visit via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { data, error: supabaseError } = await supabase
          .from('antenatal_visits')
          .update(updates)
          .eq('id', visitId)
          .select()
          .single();

        if (supabaseError) throw supabaseError;
        return data;
      }
      throw error;
    }
  },

  deleteANCVisit: async (visitId: string) => {
    try {
      // Try sync manager for delete
      await syncManager.update('antenatal_visits', visitId, { deleted: true });
    } catch (error) {
      console.error('Failed to delete ANC visit via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { error: supabaseError } = await supabase
          .from('antenatal_visits')
          .delete()
          .eq('id', visitId);

        if (supabaseError) throw supabaseError;
      } else {
        throw error;
      }
    }
  },

  // BIOMETRY SCANS
  createBiometryScan: async (scan: Omit<BiometryScan, 'id' | 'created_at'>) => {
    try {
      // Save using sync manager for offline-first support
      return await syncManager.save('biometry_scans', scan);
    } catch (error) {
      console.error('Failed to save biometry scan via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { data, error: supabaseError } = await supabase
          .from('biometry_scans')
          .insert([scan])
          .select()
          .single();

        if (supabaseError) throw supabaseError;
        return data;
      }
      throw error;
    }
  },

  getBiometryScans: async (pregnancyId: string) => {
    try {
      // Try local DB first (would need custom table for biometry scans)
      // For now, fallback to Supabase
      if (networkStatus.getStatus()) {
        setTimeout(() => syncManager.read('biometry_scans'), 0);
      }
    } catch (error) {
      console.error('Error fetching local biometry scans:', error);
    }
    
    // Fallback to Supabase
    const { data, error } = await supabase
      .from('biometry_scans')
      .select('*')
      .eq('pregnancy_id', pregnancyId)
      .order('scan_date', { ascending: false });

    if (error) throw error;
    return data;
  },

  updateBiometryScan: async (scanId: string, updates: Partial<BiometryScan>) => {
    try {
      // Try sync manager for update
      await syncManager.update('biometry_scans', scanId, updates);
      return updates;
    } catch (error) {
      console.error('Failed to update biometry scan via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { data, error: supabaseError } = await supabase
          .from('biometry_scans')
          .update(updates)
          .eq('id', scanId)
          .select()
          .single();

        if (supabaseError) throw supabaseError;
        return data;
      }
      throw error;
    }
  },

  deleteBiometryScan: async (scanId: string) => {
    try {
      // Try sync manager for delete
      await syncManager.update('biometry_scans', scanId, { deleted: true });
    } catch (error) {
      console.error('Failed to delete biometry scan via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { error: supabaseError } = await supabase
          .from('biometry_scans')
          .delete()
          .eq('id', scanId);

        if (supabaseError) throw supabaseError;
      } else {
        throw error;
      }
    }
  },
};
</file>

<file path="pages/Login.tsx">
import React, { useState } from 'react';
import { authService } from '../services/authService';
import toast from 'react-hot-toast';
import { LogIn, AlertCircle, Mail, Lock, User, Phone, Stethoscope, Facebook, MessageCircle } from 'lucide-react';

interface LoginProps {
  onLoginSuccess: () => void;
}

export const Login: React.FC<LoginProps> = ({ onLoginSuccess }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [showSignup, setShowSignup] = useState(false);
  const [signupData, setSignupData] = useState({
    name: '',
    specialization: '',
    phone: '',
  });

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!email || !password) {
      toast.error('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
      return;
    }

    setLoading(true);
    try {
      await authService.login(email, password);
      toast.success('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
      onLoginSuccess();
    } catch (error: any) {
      toast.error(error.message || 'ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
    } finally {
      setLoading(false);
    }
  };

  const handleSignup = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!email || !password || !signupData.name) {
      toast.error('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
      return;
    }

    if (password.length < 6) {
      toast.error('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
      return;
    }

    setLoading(true);
    try {
      await authService.signup(email, password, signupData);
      toast.success('ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä');
      setShowSignup(false);
      setEmail('');
      setPassword('');
      setSignupData({ name: '', specialization: '', phone: '' });
    } catch (error: any) {
      toast.error(error.message || 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ');
    } finally {
      setLoading(false);
    }
  };

  // Fallback branding for login page
  const branding = {
    clinic_name: 'Nile IVF Center',
    logo_url: null
  };

  return (
    <div className="min-h-screen flex font-[Tajawal]" dir="rtl">
      {/* Left Side - Login Form */}
      <div className="flex-1 flex items-center justify-center p-8 bg-white md:w-1/2">
        <div className="w-full max-w-md space-y-8">
          {/* Logo and Branding */}
          <div className="text-center">
            <div className="flex justify-center mb-6">
              {branding?.logo_url ? (
                <img
                  src={branding.logo_url}
                  alt="Nile IVF Center Logo"
                  className="w-20 h-20 rounded-full object-cover border-4 border-teal-100"
                />
              ) : (
                <div className="w-20 h-20 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-full flex items-center justify-center">
                  <Stethoscope className="text-white" size={32} />
                </div>
              )}
            </div>
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              ŸÖÿ±ŸÉÿ≤ ÿØ ÿµŸÑÿßÿ≠ ŸÑŸÑÿÆÿµŸàÿ®ÿ©
            </h1>
            <p className="text-gray-600 text-lg mb-2">
              ŸÖÿπÿßŸÉŸÖ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©
            </p>
            <p className="text-gray-500 text-base">
              {showSignup ? 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ' : 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ'}
            </p>
          </div>

          {/* Login Form */}
          {!showSignup ? (
            <form onSubmit={handleLogin} className="space-y-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
                </label>
                <div className="relative">
                  <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="doctor@example.com"
                    disabled={loading}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                </label>
                <div className="relative">
                  <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    disabled={loading}
                  />
                </div>
              </div>

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-4 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
              >
                {loading ? (
                  <div className="flex items-center justify-center gap-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...
                  </div>
                ) : (
                  'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ'
                )}
              </button>
            </form>
          ) : (
            /* Signup Form */
            <form onSubmit={handleSignup} className="space-y-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ *
                </label>
                <div className="relative">
                  <User className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="text"
                    value={signupData.name}
                    onChange={(e) => setSignupData({ ...signupData, name: e.target.value })}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="ÿØ. ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ"
                    disabled={loading}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ÿßŸÑÿ™ÿÆÿµÿµ
                </label>
                <div className="relative">
                  <Stethoscope className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="text"
                    value={signupData.specialization}
                    onChange={(e) => setSignupData({ ...signupData, specialization: e.target.value })}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÜÿ≥ÿßÿ° ŸàÿßŸÑÿ™ŸàŸÑŸäÿØ"
                    disabled={loading}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
                </label>
                <div className="relative">
                  <Phone className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="tel"
                    value={signupData.phone}
                    onChange={(e) => setSignupData({ ...signupData, phone: e.target.value })}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="+966501234567"
                    disabled={loading}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä *
                </label>
                <div className="relative">
                  <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="doctor@example.com"
                    disabled={loading}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± *
                </label>
                <div className="relative">
                  <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full pr-12 pl-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    disabled={loading}
                  />
                </div>
              </div>

              <div className="bg-rose-50 border border-rose-200 rounded-xl p-4 flex gap-3 items-start">
                <AlertCircle size={20} className="text-rose-600 flex-shrink-0 mt-0.5" />
                <p className="text-sm text-rose-800">
                  ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ© Ÿàÿ≥ŸáŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏
                </p>
              </div>

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-4 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
              >
                {loading ? (
                  <div className="flex items-center justify-center gap-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...
                  </div>
                ) : (
                  'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®'
                )}
              </button>
            </form>
          )}

          {/* Toggle between Login/Signup */}
          <div className="text-center">
            <button
              onClick={() => {
                setShowSignup(!showSignup);
                setEmail('');
                setPassword('');
                setSignupData({ name: '', specialization: '', phone: '' });
              }}
              className="text-teal-600 hover:text-teal-700 font-semibold transition-colors duration-200"
              disabled={loading}
            >
              {showSignup ? 'ŸáŸÑ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ' : 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®'}
            </button>
          </div>

          {/* Footer with Copyright and Developer Credits */}
          <div className="pt-8 border-t border-gray-200 text-center text-gray-500 text-sm">
            <p>Copyright ¬© 2025 ŸÖÿ±ŸÉÿ≤ ÿØ ÿµŸÑÿßÿ≠ ŸÑŸÑÿÆÿµŸàÿ®ÿ©. All Rights Reserved.</p>
            <p className="mt-1">ÿ™ŸÖ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿØ. ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±</p>
            
            <div className="mt-4 flex items-center justify-center gap-4">
              <a
                href="https://www.facebook.com/profile.php?id=100000785193419"
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 transition-colors font-medium"
              >
                <Facebook size={16} />
                <span>ÿ™ÿßÿ®ÿπŸÜÿß ÿπŸÑŸâ ŸÅŸäÿ≥ÿ®ŸàŸÉ</span>
              </a>
              <span className="text-gray-300">|</span>
              <a
                href="https://wa.me/201003418068"
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-1 text-green-600 hover:text-green-700 transition-colors font-medium"
              >
                <MessageCircle size={16} />
                <span>ÿ±ÿßÿ≥ŸÑŸÜÿß ÿπŸÑŸâ Ÿàÿßÿ™ÿ≥ÿßÿ®</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      {/* Right Side - Decorative Banner */}
      <div className="hidden md:flex md:w-1/2 bg-gradient-to-br from-teal-600 to-cyan-700 relative overflow-hidden">
        {/* Background Image */}
        <div
          className="absolute inset-0 bg-cover bg-center opacity-20"
          style={{
            backgroundImage: `url('https://images.unsplash.com/photo-1576091160550-2173dba999ef?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D')`
          }}
        />

        {/* Gradient Overlay */}
        <div className="absolute inset-0 bg-gradient-to-br from-teal-600/80 to-cyan-700/80" />

        {/* Content */}
        <div className="relative z-10 flex flex-col justify-center items-center text-white p-12 text-center">
          <div className="max-w-md">
            <h2 className="text-4xl font-bold mb-6 leading-tight">
              ŸÜÿ±ÿßŸÅŸÇŸÉŸÖ ŸÅŸä ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ£ŸÖŸÑ
            </h2>
            <p className="text-xl mb-8 opacity-90 leading-relaxed">
              ŸÜÿ≠ŸÜ ŸáŸÜÿß ŸÑŸÖÿ≥ÿßÿπÿØÿ™ŸÉŸÖ ŸÅŸä ÿ™ÿ≠ŸÇŸäŸÇ ÿ£ÿ≠ŸÑÿßŸÖŸÉŸÖ ŸÅŸä ÿ®ŸÜÿßÿ° ÿ£ÿ≥ÿ±ÿ© ÿ≥ÿπŸäÿØÿ©
            </p>
            <div className="flex items-center justify-center gap-2 text-lg">
              <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>
              <span>ŸÖÿ±ŸÉÿ≤ ÿØ ÿµŸÑÿßÿ≠ ŸÑŸÑÿÆÿµŸàÿ®ÿ©</span>
              <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            </div>
          </div>
        </div>

        {/* Decorative Elements */}
        <div className="absolute top-10 right-10 w-20 h-20 border-2 border-white/20 rounded-full"></div>
        <div className="absolute bottom-10 left-10 w-16 h-16 bg-white/10 rounded-full"></div>
        <div className="absolute top-1/2 left-10 w-12 h-12 border border-white/30 rounded-full"></div>
      </div>
    </div>
  );
};
</file>

<file path="components/BottomNav.tsx">
import React from 'react';
import { LayoutDashboard, Users, Baby, Heart, Settings, Activity, FileText, LogOut } from 'lucide-react';
import { Page } from '../types';

interface Props {
  activePage: Page;
  setPage: (p: Page) => void;
  onLogout: () => void;
}

const BottomNav: React.FC<Props> = ({ activePage, setPage, onLogout }) => {
  // Consolidated navigation items in logical order
  const navItems = [
    { id: Page.HOME, label: 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', icon: LayoutDashboard, action: null },
    { id: Page.RECEPTION, label: 'ÿßŸÑŸÖÿ±ÿ∂Ÿâ', icon: Users, action: null },
    { id: Page.GYNECOLOGY, label: 'ÿßŸÑŸÜÿ≥ÿßÿ°', icon: Activity, action: null },
    { id: Page.OBSTETRICS, label: 'ÿßŸÑÿ≠ŸÖŸÑ', icon: Heart, action: null },
    { id: Page.IVF, label: 'ÿßŸÑÿÆÿµŸàÿ®ÿ©', icon: Baby, action: null },
    { id: Page.PATIENT_RECORD, label: 'ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™', icon: FileText, action: null },
    { id: Page.SETTINGS, label: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', icon: Settings, action: null },
    { id: 'logout', label: 'ÿÆÿ±Ÿàÿ¨', icon: LogOut, action: onLogout },
  ];

  const NavButton: React.FC<{ item: any, isActive: boolean }> = ({ item, isActive }) => {
    const Icon = typeof item.icon === 'string' ? null : item.icon;
    return (
      <button
        onClick={() => {
          if (item.action) {
            item.action();
          } else {
            setPage(item.id);
          }
        }}
        className={`flex-none flex flex-col items-center justify-center min-w-[4.5rem] py-2 pb-safe transition-colors duration-200 ${
          isActive
            ? 'text-teal-600 bg-teal-50 border-t-4 border-teal-600'
            : item.id === 'logout'
            ? 'text-red-600 hover:bg-red-50'
            : 'text-gray-600 hover:bg-gray-50'
        }`}
        aria-label={item.label}
        aria-current={isActive ? 'page' : undefined}
      >
        {Icon && <Icon className="w-5 h-5 mb-1" />}
        <span className="text-xs font-medium text-center leading-tight">{item.label}</span>
      </button>
    );
  };

  return (
    <>
      {/* Mobile Bottom Navigation - Horizontally Scrollable */}
      <nav className="fixed bottom-0 left-0 right-0 md:hidden bg-white border-t border-gray-200 shadow-xl z-50">
        <div className="flex overflow-x-auto w-full bg-white border-t border-gray-200 no-scrollbar">
          {navItems.map((item) => (
            <NavButton
              key={item.id}
              item={item}
              isActive={activePage === item.id}
            />
          ))}
        </div>
      </nav>
    </>
  );
};

export default BottomNav;
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ŸÖÿ±ŸÉÿ≤ ÿØ ÿµŸÑÿßÿ≠ ŸÑŸÑÿÆÿµŸàÿ®ÿ© - ŸÜÿ∏ÿßŸÖ ÿØ. ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±</title>
    <meta name="author" content="Dr. Mohamed Salah Gabr">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00838f">
    <meta name="description" content="Comprehensive IVF and Obstetrics Management System">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/pwa-192x192.png">
    <!-- ÿ≥ŸÜÿ≥ÿ™ÿÆÿØŸÖ Tailwind ÿπÿ®ÿ± ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸä package.json ŸÑŸÉŸÜ ÿ≥ŸÜÿ®ŸÇŸä ÿßŸÑŸÄ CDN ŸÖÿ§ŸÇÿ™ÿßŸã ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿµŸÖŸäŸÖ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              teal: {
                50: '#e0f2f1', 100: '#b2dfdb', 500: '#009688', 600: '#00897b', 700: '#00838f', 800: '#006064', 900: '#004d40',
              }
            }
          }
        }
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react-hot-toast": "https://aistudiocdn.com/react-hot-toast@^2.6.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.86.2"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>
</file>

<file path="pages/Gynecology.tsx">
import React, { useState, useEffect } from 'react';
import { Save, Stethoscope, ClipboardList, Pill } from 'lucide-react';
import { useLiveQuery } from 'dexie-react-hooks';
import toast from 'react-hot-toast';
import { Patient, PrescriptionItem } from '../types';
import { db } from '../src/db/localDB';
import { visitsService } from '../services/visitsService';
import { authService } from '../services/authService';
import PrescriptionComponent from '../components/PrescriptionComponent';
import PrescriptionPrinter from '../components/PrescriptionPrinter';
import SearchableSelect from '../components/ui/SearchableSelect';
import { COMMON_COMPLAINTS, ICD10_DIAGNOSES, PROCEDURE_ORDERS } from '../data/medical_terms';

interface GynecologyData {
  // Vitals
  vitals: {
    weight?: number;
    height?: number;
    bmi?: number;
    bpSystolic?: number;
    bpDiastolic?: number;
    temperature?: number;
  };

  // Assessment Tab
  complaints: string[];
  pvExamination: {
    vulva: string;
    vagina: string;
    cervix: string;
    adnexa: string;
  };
  ultrasound: {
    uterus: {
      dimensions: string;
      position: string;
      myometrium: string;
      cavity: string;
    };
    endometrium: {
      thickness: string;
      pattern: string;
    };
    adnexa: {
      rightOvary: string;
      leftOvary: string;
      pod: string;
    };
  };

  // Diagnosis & Plan Tab
  diagnosis: string[];
  procedureOrder: string[];
  clinicalNotes: string;

  // Rx Tab
  prescription: PrescriptionItem[];
}

const Gynecology: React.FC = () => {
  const [selectedPatientId, setSelectedPatientId] = useState<string>('');
  const [doctorId, setDoctorId] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<'assessment' | 'diagnosis' | 'rx'>('assessment');
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);

  const patients = useLiveQuery(() => db.patients.toArray(), []) || [];

  const [gynecologyData, setGynecologyData] = useState<GynecologyData>({
    vitals: {
      weight: undefined,
      height: undefined,
      bmi: undefined,
      bpSystolic: undefined,
      bpDiastolic: undefined,
      temperature: undefined,
    },
    complaints: [],
    pvExamination: {
      vulva: '',
      vagina: '',
      cervix: '',
      adnexa: '',
    },
    ultrasound: {
      uterus: {
        dimensions: '',
        position: 'AVF',
        myometrium: 'Homogeneous',
        cavity: 'Empty',
      },
      endometrium: {
        thickness: '',
        pattern: 'Triple Line',
      },
      adnexa: {
        rightOvary: '',
        leftOvary: '',
        pod: 'Clear',
      },
    },
    diagnosis: [],
    procedureOrder: [],
    clinicalNotes: '',
    prescription: [],
  });

  useEffect(() => {
    fetchDoctorProfile();
  }, []);

  const fetchDoctorProfile = async () => {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        const doctor = await authService.getDoctorProfile(user.id);
        setDoctorId(doctor.id);
      }
    } catch (error) {
      console.error('Error fetching doctor profile:', error);
      toast.error('Failed to load doctor profile');
    }
  };

  const selectedPatient = patients.find(p => p.id.toString() === selectedPatientId);

  const handleSaveVisit = async () => {
    if (!selectedPatientId || !doctorId) {
      toast.error('Please select a patient');
      return;
    }

    setIsLoading(true);
    try {
      const clinicalData = {
        vitals: gynecologyData.vitals,
        assessment: {
          complaints: gynecologyData.complaints,
          pvExamination: gynecologyData.pvExamination,
          ultrasound: gynecologyData.ultrasound,
        },
        diagnosis: gynecologyData.diagnosis.join('; '),
        procedureOrder: gynecologyData.procedureOrder.join('; '),
        clinicalNotes: gynecologyData.clinicalNotes,
      };

      await visitsService.saveVisit({
        patientId: selectedPatientId,
        department: 'GYNA',
        clinicalData: clinicalData,
        diagnosis: gynecologyData.diagnosis.join('; '),
        prescription: gynecologyData.prescription,
        notes: gynecologyData.clinicalNotes,
      });

      toast.success('Gynecology visit saved successfully');

      // Reset form
      setGynecologyData({
        vitals: {
          weight: undefined,
          height: undefined,
          bmi: undefined,
          bpSystolic: undefined,
          bpDiastolic: undefined,
          temperature: undefined,
        },
        complaints: [],
        pvExamination: {
          vulva: '',
          vagina: '',
          cervix: '',
          adnexa: '',
        },
        ultrasound: {
          uterus: {
            dimensions: '',
            position: 'AVF',
            myometrium: 'Homogeneous',
            cavity: 'Empty',
          },
          endometrium: {
            thickness: '',
            pattern: 'Triple Line',
          },
          adnexa: {
            rightOvary: '',
            leftOvary: '',
            pod: 'Clear',
          },
        },
        diagnosis: [],
        procedureOrder: [],
        clinicalNotes: '',
        prescription: [],
      });

    } catch (error: any) {
      console.error('Error saving visit:', error);
      toast.error(`Failed to save visit: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  const toggleComplaint = (complaint: string) => {
    setGynecologyData(prev => ({
      ...prev,
      complaints: prev.complaints.includes(complaint)
        ? prev.complaints.filter(c => c !== complaint)
        : [...prev.complaints, complaint]
    }));
  };

  const toggleDiagnosis = (diagnosis: string) => {
    setGynecologyData(prev => ({
      ...prev,
      diagnosis: prev.diagnosis.includes(diagnosis)
        ? prev.diagnosis.filter(d => d !== diagnosis)
        : [...prev.diagnosis, diagnosis]
    }));
  };

  const toggleProcedure = (procedure: string) => {
    setGynecologyData(prev => ({
      ...prev,
      procedureOrder: prev.procedureOrder.includes(procedure)
        ? prev.procedureOrder.filter(p => p !== procedure)
        : [...prev.procedureOrder, procedure]
    }));
  };

  const handleVitalsChange = (field: keyof GynecologyData['vitals'], value: string) => {
    const numValue = value ? parseFloat(value) : undefined;
    
    setGynecologyData(prev => {
      const newVitals = { ...prev.vitals, [field]: numValue };
      
      if (field === 'weight' || field === 'height') {
        if (newVitals.weight && newVitals.height && newVitals.height > 0) {
          const heightInMeters = newVitals.height / 100;
          newVitals.bmi = parseFloat((newVitals.weight / (heightInMeters * heightInMeters)).toFixed(1));
        }
      }
      
      return {
        ...prev,
        vitals: newVitals,
      };
    });
  };

  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-gray-900 mb-2 font-[Tajawal]">
          ÿπŸäÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿßÿ°
        </h1>
        <p className="text-gray-600 font-[Tajawal]">
          Gynecology Station - Diagnosis & Medical Management of Benign Conditions
        </p>
      </div>

      {/* Patient Selector */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-6">
        <label className="block text-sm font-semibold text-gray-700 mb-2">
          Select Patient
        </label>
        <select
          value={selectedPatientId}
          onChange={(e) => setSelectedPatientId(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        >
          <option value="">-- Select Patient --</option>
          {patients.map(patient => (
            <option key={patient.id} value={patient.id}>
              {patient.name} - {patient.phone}
            </option>
          ))}
        </select>
      </div>

      {selectedPatient && (
        <div className="bg-white rounded-lg shadow-md">
          {/* Tab Navigation */}
          <div className="border-b border-gray-200">
            <nav className="flex">
              <button
                onClick={() => setActiveTab('assessment')}
                className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                  activeTab === 'assessment'
                    ? 'border-b-2 border-teal-500 text-teal-600 bg-teal-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <Stethoscope className="w-5 h-5 inline mr-2" />
                Clinical Assessment
              </button>
              <button
                onClick={() => setActiveTab('diagnosis')}
                className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                  activeTab === 'diagnosis'
                    ? 'border-b-2 border-amber-500 text-amber-600 bg-amber-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <ClipboardList className="w-5 h-5 inline mr-2" />
                Diagnosis & Plan
              </button>
              <button
                onClick={() => setActiveTab('rx')}
                className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                  activeTab === 'rx'
                    ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <Pill className="w-5 h-5 inline mr-2" />
                Prescription
              </button>
            </nav>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {/* Assessment Tab */}
            {activeTab === 'assessment' && (
              <div className="grid md:grid-cols-2 gap-6" dir="ltr">
                {/* LEFT COLUMN: Vitals & Complaints */}
                <div className="space-y-6">
                  {/* Vitals Section */}
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Vital Signs</h3>
                    <div className="grid grid-cols-2 gap-3 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.weight || ''}
                          onChange={(e) => handleVitalsChange('weight', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="e.g., 65"
                          step="0.1"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Height (cm)</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.height || ''}
                          onChange={(e) => handleVitalsChange('height', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="e.g., 165"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">BMI</label>
                        <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 font-medium">
                          {gynecologyData.vitals.bmi ? gynecologyData.vitals.bmi.toFixed(1) : '--'}
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Temp (¬∞C)</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.temperature || ''}
                          onChange={(e) => handleVitalsChange('temperature', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="e.g., 37"
                          step="0.1"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">BP Systolic</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.bpSystolic || ''}
                          onChange={(e) => handleVitalsChange('bpSystolic', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="mmHg"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">BP Diastolic</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.bpDiastolic || ''}
                          onChange={(e) => handleVitalsChange('bpDiastolic', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="mmHg"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Complaints */}
                  <div className="text-left">
                    <SearchableSelect
                      label="Chief Complaints"
                      options={COMMON_COMPLAINTS}
                      value={gynecologyData.complaints}
                      onChange={(value) => setGynecologyData(prev => ({
                        ...prev,
                        complaints: Array.isArray(value) ? value : [value]
                      }))}
                      placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ¥ŸÉŸàŸâ ÿ£Ÿà ÿ£ÿ∂ŸÅ ÿ¥ŸÉŸàŸâ ÿ¨ÿØŸäÿØÿ©"
                      multi={true}
                      allowCustom={true}
                    />
                  </div>
                </div>

                {/* RIGHT COLUMN: Investigations & Scans */}
                <div className="space-y-6">
                {/* PV Examination */}
                <div className="bg-green-50 p-4 rounded-lg" dir="ltr">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Vaginal Examination (PV)</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Vulva</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.vulva}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, vulva: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Lesions / etc."
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Vagina</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.vagina}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, vagina: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Discharge / etc."
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Cervix</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.cervix}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, cervix: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Erosion / Motion tenderness"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Adnexa</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.adnexa}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, adnexa: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Mass / Tenderness"
                      />
                    </div>
                  </div>
                </div>

                {/* Office Ultrasound */}
                <div dir="ltr">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Transvaginal Ultrasound (TVS)</h3>

                  {/* Uterus */}
                  <div className="mb-6">
                    <h4 className="text-md font-medium text-gray-800 mb-3">Uterus</h4>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Dimensions (LxWxAP)</label>
                        <input type="text" value={gynecologyData.ultrasound.uterus.dimensions} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, dimensions: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., 7x5x4 cm" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
                        <select value={gynecologyData.ultrasound.uterus.position} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, position: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="AVF">Anteverted Flexed (AVF)</option>
                          <option value="RVF">Retroverted Flexed (RVF)</option>
                          <option value="Axial">Axial</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Myometrium</label>
                        <select value={gynecologyData.ultrasound.uterus.myometrium} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, myometrium: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Homogeneous">Homogeneous</option>
                          <option value="Heterogeneous">Heterogeneous</option>
                          <option value="Fibroid">Fibroid</option>
                          <option value="Adenomyosis">Adenomyosis</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Cavity</label>
                        <select value={gynecologyData.ultrasound.uterus.cavity} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, cavity: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Empty">Empty</option>
                          <option value="Polyp">Polyp</option>
                          <option value="Fibroid">Fibroid</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Endometrium */}
                  <div className="mb-6">
                    <h4 className="text-md font-medium text-gray-800 mb-3">Endometrium</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Thickness (mm)</label>
                        <input type="text" value={gynecologyData.ultrasound.endometrium.thickness} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, endometrium: { ...prev.ultrasound.endometrium, thickness: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., 8-10 mm" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Pattern</label>
                        <select value={gynecologyData.ultrasound.endometrium.pattern} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, endometrium: { ...prev.ultrasound.endometrium, pattern: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Triple Line">Triple Line</option>
                          <option value="Hyperechoic">Hyperechoic</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Adnexa */}
                  <div>
                    <h4 className="text-md font-medium text-gray-800 mb-3">Adnexa</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Right Ovary</label>
                        <select value={gynecologyData.ultrasound.adnexa.rightOvary} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, adnexa: { ...prev.ultrasound.adnexa, rightOvary: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="">Select</option>
                          <option value="Normal">Normal</option>
                          <option value="PCO">Polycystic (PCO)</option>
                          <option value="Cyst">Cyst</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Left Ovary</label>
                        <select value={gynecologyData.ultrasound.adnexa.leftOvary} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, adnexa: { ...prev.ultrasound.adnexa, leftOvary: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="">Select</option>
                          <option value="Normal">Normal</option>
                          <option value="PCO">Polycystic (PCO)</option>
                          <option value="Cyst">Cyst</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">POD (Pouch of Douglas)</label>
                        <select value={gynecologyData.ultrasound.adnexa.pod} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, adnexa: { ...prev.ultrasound.adnexa, pod: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Clear">Clear</option>
                          <option value="Free Fluid">Free Fluid</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            )}

            {/* Diagnosis & Plan Tab */}
            {activeTab === 'diagnosis' && (
              <div className="space-y-6" dir="ltr">
                {/* Diagnosis */}
                <div className="text-left">
                  <SearchableSelect
                    label="ICD-10 ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ (ÿßÿÆÿ™ÿ± ŸÖÿ™ÿπÿØÿØ)"
                    options={ICD10_DIAGNOSES}
                    value={gynecologyData.diagnosis}
                    onChange={(value) => setGynecologyData(prev => ({
                      ...prev,
                      diagnosis: Array.isArray(value) ? value : [value]
                    }))}
                    placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ ÿ£Ÿà ÿ£ÿ∂ŸÅ ÿ™ÿ¥ÿÆŸäÿµ ÿ¨ÿØŸäÿØ"
                    multi={true}
                    allowCustom={true}
                  />
                  {gynecologyData.diagnosis.length > 0 && (
                    <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                      <p className="text-sm text-amber-800 font-medium font-[Tajawal]">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:</p>
                      <p className="text-sm text-amber-700 mt-1 font-[Tajawal]">{gynecologyData.diagnosis.join('; ')}</p>
                    </div>
                  )}
                </div>

                {/* Procedure Order */}
                <div className="text-left">
                  <SearchableSelect
                    label="ÿÆÿ∑ÿ© ÿßŸÑÿπŸÑÿßÿ¨ / ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ (ÿßÿÆÿ™ÿ± ŸÖÿ™ÿπÿØÿØ)"
                    options={PROCEDURE_ORDERS}
                    value={gynecologyData.procedureOrder}
                    onChange={(value) => setGynecologyData(prev => ({
                      ...prev,
                      procedureOrder: Array.isArray(value) ? value : [value]
                    }))}
                    placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ•ÿ¨ÿ±ÿßÿ° ÿ£Ÿà ÿ£ÿ∂ŸÅ ÿ•ÿ¨ÿ±ÿßÿ° ÿ¨ÿØŸäÿØ"
                    multi={true}
                    allowCustom={true}
                  />
                  {gynecologyData.procedureOrder.length > 0 && (
                    <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                      <p className="text-sm text-blue-800 font-medium font-[Tajawal]">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:</p>
                      <p className="text-sm text-blue-700 mt-1 font-[Tajawal]">{gynecologyData.procedureOrder.join('; ')}</p>
                    </div>
                  )}
                </div>

                {/* Clinical Notes */}
                <div className="text-left">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Clinical Notes & Plan</h3>
                  <textarea
                    value={gynecologyData.clinicalNotes}
                    onChange={(e) => setGynecologyData(prev => ({ ...prev, clinicalNotes: e.target.value }))}
                    rows={4}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                    placeholder="Enter clinical observations, management plan, and follow-up..."
                  />
                </div>
              </div>
            )}

            {/* Rx Tab */}
            {activeTab === 'rx' && (
              <PrescriptionComponent
                prescriptions={gynecologyData.prescription}
                onPrescriptionsChange={(prescriptions) =>
                  setGynecologyData(prev => ({ ...prev, prescription: prescriptions }))
                }
                onPrint={() => setIsPrinterOpen(true)}
                showPrintButton={true}
              />
            )}
          </div>

          {/* Save Button */}
          <div className="bg-gray-50 px-6 py-4 border-t border-gray-200">
            <button
              onClick={handleSaveVisit}
              disabled={isLoading}
              className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
            >
              <Save className="w-5 h-5" />
              {isLoading ? 'Saving...' : 'Save Gynecology Visit'}
            </button>
          </div>
        </div>
      )}

      <PrescriptionPrinter
        patient={selectedPatient || null}
        prescriptions={gynecologyData.prescription}
        diagnosis={gynecologyData.diagnosis.join('; ')}
        notes={gynecologyData.clinicalNotes}
        isOpen={isPrinterOpen}
        onClose={() => setIsPrinterOpen(false)}
      />
    </div>
  );
};

export default Gynecology;
</file>

<file path="services/ivfService.ts">
import { supabase } from './supabaseClient';
import { authService } from './authService';
import { syncManager } from '../src/services/syncService';
import { db as localDB } from '../src/lib/localDb';
import { networkStatus } from '../src/lib/networkStatus';
import { Patient, IvfCycle, Visit, StimulationLog } from '../types';

// Utility Functions (Local logic)
export const calculateBMI = (weightKg: number, heightCm: number): { bmi: number; alert: boolean } => {
  if (!weightKg || !heightCm) return { bmi: 0, alert: false };
  const heightM = heightCm / 100;
  const bmi = parseFloat((weightKg / (heightM * heightM)).toFixed(1));
  return { bmi, alert: bmi > 30 };
};

export const calculateTMSC = (volume: number, concentration: number, motility: number): number => {
  if (!volume || !concentration || !motility) return 0;
  return parseFloat(((volume * concentration * motility) / 100).toFixed(2));
};

export const analyzeSemenAnalysis = (vol: number, conc: number, motility: number, morph: number): string => {
  const findings: string[] = [];
  if (vol < 1.5) findings.push("Hypospermia");
  if (conc < 15) findings.push("Oligozoospermia");
  if (motility < 40) findings.push("Asthenozoospermia");
  if (morph < 4) findings.push("Teratozoospermia");
  
  if (findings.length === 0) return "Normozoospermia (WHO 2021)";
  return findings.join(" + ");
};

export const classifyOvarianReserve = (amh?: number, afc?: number): 'Poor Responder' | 'Normal' | 'High Responder' => {
  if (!amh && !afc) return 'Normal';
  
  if ((amh && amh < 0.4) || (afc && afc < 5)) {
    return 'Poor Responder';
  }
  if ((amh && amh > 4.5) || (afc && afc > 25)) {
    return 'High Responder';
  }
  return 'Normal';
};

export const calculateMaturationRate = (totalOocytes: number, mii: number): number => {
  if (!totalOocytes || totalOocytes === 0) return 0;
  return parseFloat(((mii / totalOocytes) * 100).toFixed(1));
};

export const calculateFertilizationRate = (fertilized: number, mii: number): number => {
  if (!mii || mii === 0) return 0;
  return parseFloat(((fertilized / mii) * 100).toFixed(1));
};

// Database Service (Supabase Async)
export const db = {
  // --- Patients ---
  getPatients: async (): Promise<Patient[]> => {
    try {
      // Try local DB first (instant response)
      const localPatients = await localDB.patients.toArray();
      
      // Background sync
      setTimeout(() => syncManager.read('patients'), 0);

      return localPatients
        .map((p: any) => ({
          id: p.remoteId || `local_${p.id}`,
          name: p.name,
          age: p.age || 0,
          phone: p.phone,
          husbandName: p.husband_name || '',
          history: p.history || '',
          createdAt: p.createdAt?.toString() || new Date().toISOString()
        }));
    } catch (error) {
      console.error('Error fetching local patients, falling back to Supabase:', error);
      
      // Fallback to Supabase if local DB fails
      const { data, error: supabaseError } = await supabase
        .from('patients')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (supabaseError) {
        console.error('Error fetching patients from Supabase:', supabaseError);
        return [];
      }
      
      return data.map((p: any) => ({
        id: p.id,
        name: p.name,
        age: p.age,
        phone: p.phone,
        husbandName: p.husband_name,
        history: p.history,
        createdAt: p.created_at
      }));
    }
  },

  savePatient: async (patient: Omit<Patient, 'id' | 'createdAt'>) => {
    const { data: { user }, error: userError } = await supabase.auth.getUser();

    if (userError || !user) throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');

    // Get the correct doctor profile ID
    const doctor = await authService.ensureDoctorRecord(user.id, user.email || '');

    if (!doctor || !doctor.id) {
      throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
    }

    const patientData = {
      name: patient.name,
      age: patient.age,
      phone: patient.phone,
      husband_name: patient.husbandName,
      history: patient.history,
      doctor_id: doctor.id
    };

    try {
      // Save using sync manager for offline-first support
      return await syncManager.save('patients', patientData);
    } catch (error) {
      console.error('Failed to save patient via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { data, error: supabaseError } = await supabase
          .from('patients')
          .insert([patientData])
          .select()
          .single();

        if (supabaseError) throw supabaseError;
        return data;
      }
      throw error;
    }
  },

  // --- Visits ---
  getVisits: async (): Promise<Visit[]> => {
    const { data, error } = await supabase
      .from('visits')
      .select('*')
      .order('date', { ascending: false });
      
    if (error) return [];
    return data as any; // Simplified for brevity
  },

  // --- Cycles ---
  getCycles: async (): Promise<IvfCycle[]> => {
    try {
      // Try local DB first (instant response)
      const localCycles = await localDB.cycles.toArray();
      
      // Background sync
      setTimeout(() => syncManager.read('ivf_cycles'), 0);

      return localCycles
        .map((c: any) => ({
          id: c.remoteId || `local_${c.id}`,
          patientId: c.patientId,
          protocol: c.protocol,
          startDate: c.startDate,
          status: c.status,
          logs: c.logs || [],
          lab: c.lab,
          transfer: c.transfer,
          outcome: c.outcome,
          assessment: c.assessment
        }));
    } catch (error) {
      console.error('Error fetching local cycles, falling back to Supabase:', error);
      
      // Fallback to Supabase if local DB fails
      const { data, error: supabaseError } = await supabase
        .from('ivf_cycles')
        .select(`
          *,
          stimulation_logs (*)
        `)
        .order('start_date', { ascending: false });

      if (supabaseError) {
        console.error(supabaseError);
        return [];
      }

      return data.map((c: any) => ({
        id: c.id,
        patientId: c.patient_id,
        protocol: c.protocol,
        startDate: c.start_date,
        status: c.status,
        logs: c.stimulation_logs?.map((l: any) => ({
          id: l.id,
          date: l.date,
          cycleDay: l.cycle_day,
          fsh: l.fsh,
          hmg: l.hmg,
          e2: l.e2,
          lh: l.lh,
          rtFollicles: l.rt_follicles,
          ltFollicles: l.lt_follicles
        })) || [],
        lab: c.lab_data
      }));
    }
  },

  saveCycle: async (cycle: Partial<IvfCycle> & { patientId: string }) => {
    const { data: { user }, error: userError } = await supabase.auth.getUser();

    if (userError || !user) throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');

    // Get the correct doctor profile ID
    const doctor = await authService.ensureDoctorRecord(user.id, user.email || '');

    if (!doctor || !doctor.id) {
      throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
    }

    const cycleData = {
      patient_id: cycle.patientId,
      protocol: cycle.protocol,
      status: cycle.status,
      start_date: cycle.startDate,
      doctor_id: doctor.id
    };

    try {
      // Save using sync manager for offline-first support
      return await syncManager.save('ivf_cycles', cycleData);
    } catch (error) {
      console.error('Failed to save cycle via sync manager:', error);
      // Fallback to direct Supabase if online
      if (networkStatus.getStatus()) {
        const { data, error: supabaseError } = await supabase
          .from('ivf_cycles')
          .insert([cycleData])
          .select()
          .single();

        if (supabaseError) throw supabaseError;
        return data;
      }
      throw error;
    }
  },

  // --- Logs ---
  addLog: async (cycleId: string, log: Partial<StimulationLog>) => {
    const { data, error } = await supabase
      .from('stimulation_logs')
      .insert([{
        cycle_id: cycleId,
        cycle_day: log.cycleDay,
        date: log.date,
        fsh: log.fsh || '',
        hmg: log.hmg || '',
        e2: log.e2 || '',
        lh: log.lh || '',
        rt_follicles: log.rtFollicles || '',
        lt_follicles: log.ltFollicles || '',
        endometrium_thickness: log.endometriumThickness || ''
      }])
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },

  updateLog: async (logId: string, updates: Partial<StimulationLog>) => {
    const dbUpdates: any = {};
    if (updates.fsh !== undefined) dbUpdates.fsh = updates.fsh;
    if (updates.hmg !== undefined) dbUpdates.hmg = updates.hmg;
    if (updates.e2 !== undefined) dbUpdates.e2 = updates.e2;
    if (updates.lh !== undefined) dbUpdates.lh = updates.lh;
    if (updates.rtFollicles !== undefined) dbUpdates.rt_follicles = updates.rtFollicles;
    if (updates.ltFollicles !== undefined) dbUpdates.lt_follicles = updates.ltFollicles;
    if (updates.endometriumThickness !== undefined) dbUpdates.endometrium_thickness = updates.endometriumThickness;
    
    const { error } = await supabase
      .from('stimulation_logs')
      .update(dbUpdates)
      .eq('id', logId);
    if (error) throw error;
  },

  updateCycleAssessment: async (cycleId: string, assessment: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ assessment_data: assessment, updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating assessment:', error);
        throw new Error(`Failed to update assessment: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleAssessment error:', e);
      throw e;
    }
  },

  updateCycleLabData: async (cycleId: string, labData: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ lab_data: labData, updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating lab data:', error);
        throw new Error(`Failed to update lab data: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleLabData error:', e);
      throw e;
    }
  },

  updateCycleTransfer: async (cycleId: string, transferData: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ transfer_data: transferData, updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating transfer:', error);
        throw new Error(`Failed to update transfer: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleTransfer error:', e);
      throw e;
    }
  },

  updateCycleOutcome: async (cycleId: string, outcomeData: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ outcome_data: outcomeData, status: 'Completed', updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating outcome:', error);
        throw new Error(`Failed to update outcome: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleOutcome error:', e);
      throw e;
    }
  }
};
</file>

<file path="components/Sidebar.tsx">
import React from 'react';
import { LayoutDashboard, Users, Baby, Heart, Settings, LogOut, Activity, FileText } from 'lucide-react';
import { Page } from '../types';
import { useBranding } from '../context/BrandingContext';
import SyncStatus from '../src/components/SyncStatus';

interface SidebarProps {
  activePage: Page;
  setPage: (page: Page) => void;
  onLogout: () => void;
}

export const Sidebar: React.FC<SidebarProps> = ({ activePage, setPage, onLogout }) => {
  const { branding } = useBranding();

  const menuItems = [
    { id: Page.HOME, label: 'Dashboard', arLabel: 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', icon: LayoutDashboard },
    { id: Page.RECEPTION, label: 'Reception', arLabel: 'ÿßŸÑÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ', icon: Users },
    { id: Page.GYNECOLOGY, label: 'Gynecology', arLabel: 'ÿπŸäÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿßÿ°', icon: Activity },
    { id: Page.OBSTETRICS, label: 'Obstetrics', arLabel: 'ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ≠ŸÖŸÑ', icon: Heart },
    { id: Page.IVF, label: 'IVF Center', arLabel: 'ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿÆÿµŸàÿ®ÿ©', icon: Baby },
    { id: Page.PATIENT_RECORD, label: 'Patient Records', arLabel: 'ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', icon: FileText },
    { id: Page.SETTINGS, label: 'Settings', arLabel: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', icon: Settings },
  ];

  return (
    // Hidden on mobile, visible from md and up
    <div className="hidden md:w-64 md:flex md:flex-col bg-white h-screen shadow-lg fixed md:static inset-y-0 right-0 z-10 no-print">
      <div className="p-6 border-b border-gray-100 flex items-center justify-center">
        <div className="flex flex-col items-center">
          {branding?.logo_url ? (
            <img src={branding.logo_url} alt="Logo" className="w-12 h-12 rounded-full mb-2 object-cover" />
          ) : (
            <div className="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center mb-2">
              <Baby className="text-teal-700 w-8 h-8" />
            </div>
          )}
          <h1 className="text-sm font-bold text-gray-800 text-center">{branding?.clinic_name || 'Nile IVF Center'}</h1>
          <p className="text-xs text-gray-400 uppercase tracking-wider">EMR System</p>
        </div>
      </div>
      
      <nav className="flex-1 overflow-y-auto py-4">
        <ul className="space-y-2 px-4">
          {menuItems.map((item) => {
            const Icon = item.icon;
            const isActive = activePage === item.id;
            return (
              <li key={item.id}>
                <button
                  onClick={() => setPage(item.id)}
                  className={`w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 ${
                    isActive 
                      ? 'bg-teal-50 text-teal-700 font-bold shadow-sm' 
                      : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'
                  }`}
                >
                  <Icon className={`w-5 h-5 ${isActive ? 'text-teal-700' : 'text-gray-400'}`} />
                  <span>{item.arLabel || item.label}</span>
                </button>
              </li>
            );
          })}
        </ul>
      </nav>

      <div className="p-4 border-t border-gray-100">
        {/* Sync Status Indicator */}
        <div className="mb-4">
          <SyncStatus />
        </div>

        <button
          onClick={onLogout}
          className="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-500 hover:text-red-600 transition-colors"
        >
          <LogOut className="w-4 h-4" />
          <span>Sign Out</span>
        </button>

        {/* Developer Credits */}
        <div className="mt-4 pt-4 border-t border-gray-200 text-center">
          <p className="text-xs text-gray-400 font-[Tajawal] leading-tight">
            ÿ®ÿ±ŸÖÿ¨ÿ© Ÿàÿ™ÿ∑ŸàŸäÿ±<br />
            ÿØ. ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±
          </p>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="pages/ClinicalStation.tsx">
import React, { useState, useEffect } from 'react';
import { db, calculateBMI, analyzeSemenAnalysis } from '../services/ivfService';
import { EGYPTIAN_DRUGS } from '../constants';
import { PrescriptionItem, Patient } from '../types';
import { AlertTriangle, Plus, Trash2, Printer, FileText, Activity, Microscope, Info } from 'lucide-react';

interface FemaleFactor {
  // Hormones
  fsh: string;
  lh: string;
  e2: string;
  prolactin: string;
  tsh: string;
  amh: string;
  // Ultrasound
  endoThickness: string;
  afcR: string;
  afcL: string;
  uterusPathology: string[];
  ovaryPathology: string[];
  // Tubes & Scope
  tubalStatus: string;
  hydrosalpinx: boolean;
  hysteroscopy: string[];
  laparoscopy: string[];
}

const ClinicalStation: React.FC = () => {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [selectedPatientId, setSelectedPatientId] = useState('');
  
  // Vitals & Male
  const [vitals, setVitals] = useState({ weight: '', height: '' });
  const [maleParams, setMaleParams] = useState({ vol: 0, conc: 0, mot: 0, morph: 0 });
  
  // Female Workup State
  const [activeFemaleTab, setActiveFemaleTab] = useState<'hormones' | 'us' | 'scope'>('hormones');
  const [femaleData, setFemaleData] = useState<FemaleFactor>({
    fsh: '', lh: '', e2: '', prolactin: '', tsh: '', amh: '',
    endoThickness: '', afcR: '', afcL: '',
    uterusPathology: [], ovaryPathology: [],
    tubalStatus: 'Patent', hydrosalpinx: false,
    hysteroscopy: [], laparoscopy: []
  });

  // Rx State
  const [rxItems, setRxItems] = useState<PrescriptionItem[]>([]);
  const [drugCategory, setDrugCategory] = useState('');
  const [selectedDrug, setSelectedDrug] = useState('');

  // Initial Fetch
  useEffect(() => {
    db.getPatients().then(setPatients);
  }, []);

  const selectedPatient = patients.find(p => p.id === selectedPatientId);

  // Computed Values
  const bmiInfo = calculateBMI(Number(vitals.weight), Number(vitals.height));
  const spermDiagnosis = analyzeSemenAnalysis(maleParams.vol, maleParams.conc, maleParams.mot, maleParams.morph);

  // --- Female Logic Engine ---
  const getFemaleDiagnosis = () => {
    const findings: string[] = [];
    const fsh = Number(femaleData.fsh);
    const lh = Number(femaleData.lh);
    const e2 = Number(femaleData.e2);
    const prl = Number(femaleData.prolactin);
    const tsh = Number(femaleData.tsh);
    const amh = Number(femaleData.amh);
    const et = Number(femaleData.endoThickness);
    const afcTotal = Number(femaleData.afcR) + Number(femaleData.afcL);

    // Hormones
    if (fsh > 10) findings.push("Diminished Ovarian Reserve (FSH > 10)");
    if (fsh > 0 && lh / fsh > 2) findings.push("Suspect PCOS (LH/FSH ratio > 2)");
    if (e2 > 80) findings.push("Functional Cyst / Poor Responder Risk (High E2)");
    if (prl > 25) findings.push(prl > 100 ? "Hyperprolactinemia (Check MRI)" : "Hyperprolactinemia");
    if (tsh > 2.5) findings.push("Subclinical Hypothyroidism (Treat for Fertility)");
    if (femaleData.amh && amh < 1.0) findings.push("Low Ovarian Reserve (Poseidon Group)");
    if (amh > 3.5) findings.push("High Reserve (PCOS Risk)");

    // Ultrasound
    if (femaleData.endoThickness && et < 7) findings.push("Thin Endometrium (< 7mm)");
    if ((femaleData.afcR || femaleData.afcL) && afcTotal < 5) findings.push("Low AFC (< 5 Total)");
    if (femaleData.uterusPathology.length > 0) findings.push(`Uterus: ${femaleData.uterusPathology.join(', ')}`);
    if (femaleData.ovaryPathology.length > 0) findings.push(`Ovary: ${femaleData.ovaryPathology.join(', ')}`);

    // Tubes
    if (femaleData.hydrosalpinx) findings.push("CRITICAL: Hydrosalpinx (Clip/Remove before IVF)");
    if (femaleData.tubalStatus !== 'Patent') findings.push(`Tubes: ${femaleData.tubalStatus}`);
    
    // Scopes
    if (femaleData.laparoscopy.includes('Endometriosis')) findings.push("Endometriosis Confirmed");

    return findings;
  };

  const femaleFindings = getFemaleDiagnosis();

  // Handlers
  const handleAddDrug = () => {
    if (!drugCategory || !selectedDrug) return;
    // @ts-ignore
    const drugInfo = EGYPTIAN_DRUGS[drugCategory][selectedDrug];
    const dose = drugInfo ? drugInfo.dose : '';
    setRxItems([...rxItems, { category: drugCategory, drug: selectedDrug, dose }]);
    setSelectedDrug('');
  };

  const removeDrug = (idx: number) => {
    setRxItems(rxItems.filter((_, i) => i !== idx));
  };

  const handlePrint = () => {
    if (!selectedPatient || rxItems.length === 0) return;
    setTimeout(() => {
      window.print();
    }, 100);
  };

  const toggleCheckbox = (field: keyof FemaleFactor, value: string) => {
    const list = femaleData[field] as string[];
    const newList = list.includes(value) 
      ? list.filter(item => item !== value)
      : [...list, value];
    setFemaleData({ ...femaleData, [field]: newList });
  };

  return (
    <div className="space-y-6">
      {/* Patient Selector */}
      <div className="bg-white p-3 md:p-6 rounded-2xl shadow-sm border border-gray-100 no-print">
        <label className="block text-xs md:text-sm font-bold text-gray-700 mb-2">Select Patient</label>
        <select 
          className="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none bg-white text-sm"
          value={selectedPatientId}
          onChange={(e) => setSelectedPatientId(e.target.value)}
        >
          <option value="">-- Choose from Directory --</option>
          {patients.map(p => (
            <option key={p.id} value={p.id}>{p.name} (Husband: {p.husbandName})</option>
          ))}
        </select>
      </div>

      {selectedPatient && (
        <>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-6 no-print">
            
            {/* LEFT COLUMN: Vitals + Male (3 cols on desktop, 1 col on md) */}
            <div className="md:col-span-1 lg:col-span-3 space-y-6">
              {/* BMI Calculator */}
              <div className="bg-white p-3 md:p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 className="text-sm md:text-base font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <Activity className="w-4 h-4 text-teal-600" /> Vitals & BMI
                </h3>
                <div className="space-y-3">
                  <div className="flex gap-2">
                     <div className="flex-1">
                        <label className="text-xs text-gray-500">Weight (kg)</label>
                        <input type="number" className="w-full p-3 md:p-2 border rounded text-sm min-h-[48px]" value={vitals.weight} onChange={e => setVitals({...vitals, weight: e.target.value})} />
                     </div>
                     <div className="flex-1">
                        <label className="text-xs text-gray-500">Height (cm)</label>
                        <input type="number" className="w-full p-3 md:p-2 border rounded text-sm min-h-[48px]" value={vitals.height} onChange={e => setVitals({...vitals, height: e.target.value})} />
                     </div>
                  </div>
                  {bmiInfo.bmi > 0 && (
                    <div className={`p-2 rounded text-xs flex items-center gap-2 ${bmiInfo.alert ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>
                      {bmiInfo.alert ? <AlertTriangle className="w-4 h-4" /> : <div className="w-4 h-4 rounded-full border-2 border-green-600" />}
                      <span className="font-bold">{bmiInfo.bmi} {bmiInfo.alert && "(Obese)"}</span>
                    </div>
                  )}
                </div>
              </div>

              {/* Male Diagnosis */}
              <div className="bg-white p-3 md:p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 className="text-sm md:text-base font-bold text-gray-800 mb-3 flex items-center gap-2">
                   <Microscope className="w-4 h-4 text-blue-600" /> Male Factor
                </h3>
                <div className="space-y-3 text-sm">
                  <div>
                    <label className="text-xs text-gray-500">Volume (ml)</label>
                    <input type="number" placeholder="> 1.5" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, vol: parseFloat(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">Conc (M/ml)</label>
                    <input type="number" placeholder="> 15" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, conc: parseFloat(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">Motility (%)</label>
                    <input type="number" placeholder="> 40" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, mot: parseFloat(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">Morphology (%)</label>
                    <input type="number" placeholder="> 4" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, morph: parseFloat(e.target.value)})} />
                  </div>
                </div>
                <div className="mt-3 p-2 bg-blue-50 rounded text-xs font-bold text-blue-800 border border-blue-100">
                  {spermDiagnosis}
                </div>
              </div>
            </div>

            {/* MIDDLE COLUMN: Female Workup (6 cols on desktop, 1 col on md) */}
            <div className="md:col-span-1 lg:col-span-5 flex flex-col gap-6">
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex-1 overflow-hidden flex flex-col">
                <div className="border-b border-gray-100">
                  <nav className="flex -mb-px">
                    <button
                      onClick={() => setActiveFemaleTab('hormones')}
                      className={`flex-1 py-4 text-center text-sm font-medium border-b-2 transition-colors ${activeFemaleTab === 'hormones' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                    >
                      ÿßŸÑŸáÿ±ŸÖŸàŸÜÿßÿ™ (Hormones)
                    </button>
                    <button
                      onClick={() => setActiveFemaleTab('us')}
                      className={`flex-1 py-4 text-center text-sm font-medium border-b-2 transition-colors ${activeFemaleTab === 'us' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                    >
                      ÿßŸÑÿ≥ŸàŸÜÿßÿ± (Ultrasound)
                    </button>
                    <button
                      onClick={() => setActiveFemaleTab('scope')}
                      className={`flex-1 py-4 text-center text-sm font-medium border-b-2 transition-colors ${activeFemaleTab === 'scope' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                    >
                      ÿßŸÑŸÖŸÜÿßÿ∏Ÿäÿ± (Endoscopy)
                    </button>
                  </nav>
                </div>

                <div className="p-6 flex-1 overflow-y-auto">
                  
                  {/* TAB 1: HORMONES */}
                  {activeFemaleTab === 'hormones' && (
                    <div className="grid grid-cols-2 gap-4">
                      <div className="col-span-2 text-xs text-gray-400 mb-2 font-bold">Day 2-3 Profile</div>
                      
                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">FSH (IU/L)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.fsh) > 10 ? 'border-red-300 bg-red-50' : ''}`} 
                          value={femaleData.fsh} onChange={e => setFemaleData({...femaleData, fsh: e.target.value})} />
                        {Number(femaleData.fsh) > 10 && <span className="text-[10px] text-red-600 absolute bottom-[-16px] right-0">Diminished Reserve</span>}
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">LH (IU/L)</label>
                        <input type="number" className="w-full p-2 border rounded-lg" 
                          value={femaleData.lh} onChange={e => setFemaleData({...femaleData, lh: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">E2 (pg/mL)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.e2) > 80 ? 'border-yellow-300 bg-yellow-50' : ''}`}
                          value={femaleData.e2} onChange={e => setFemaleData({...femaleData, e2: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">Prolactin (ng/mL)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.prolactin) > 25 ? 'border-red-300 bg-red-50' : ''}`}
                          value={femaleData.prolactin} onChange={e => setFemaleData({...femaleData, prolactin: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">TSH (mIU/L)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.tsh) > 2.5 ? 'border-yellow-300 bg-yellow-50' : ''}`}
                          value={femaleData.tsh} onChange={e => setFemaleData({...femaleData, tsh: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">AMH (ng/mL)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.amh) < 1 ? 'border-red-300 bg-red-50' : Number(femaleData.amh) > 3.5 ? 'border-blue-300 bg-blue-50' : ''}`}
                          value={femaleData.amh} onChange={e => setFemaleData({...femaleData, amh: e.target.value})} />
                      </div>
                    </div>
                  )}

                  {/* TAB 2: ULTRASOUND */}
                  {activeFemaleTab === 'us' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">ÿ®ÿ∑ÿßŸÜÿ© ÿßŸÑÿ±ÿ≠ŸÖ (mm)</label>
                          <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.endoThickness) > 0 && Number(femaleData.endoThickness) < 7 ? 'border-red-300 bg-red-50' : ''}`}
                            value={femaleData.endoThickness} onChange={e => setFemaleData({...femaleData, endoThickness: e.target.value})} />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">AFC Right</label>
                          <input type="number" className="w-full p-2 border rounded-lg"
                            value={femaleData.afcR} onChange={e => setFemaleData({...femaleData, afcR: e.target.value})} />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">AFC Left</label>
                          <input type="number" className="w-full p-2 border rounded-lg"
                            value={femaleData.afcL} onChange={e => setFemaleData({...femaleData, afcL: e.target.value})} />
                        </div>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Uterus Pathology (ÿßŸÑÿ±ÿ≠ŸÖ)</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Fibroids', 'Polyps', 'Adenomyosis', 'Septum'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('uterusPathology', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.uterusPathology.includes(item) ? 'bg-pink-600 text-white border-pink-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Ovary Pathology (ÿßŸÑŸÖÿ®Ÿäÿ∂)</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Simple Cyst', 'Endometrioma', 'Dermoid', 'PCO Pattern'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('ovaryPathology', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.ovaryPathology.includes(item) ? 'bg-pink-600 text-white border-pink-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* TAB 3: SCOPES & TUBES */}
                  {activeFemaleTab === 'scope' && (
                    <div className="space-y-6">
                      
                      <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label className="block text-xs font-bold text-gray-700 mb-2">Tubal Patency (HSG/HyCoSy)</label>
                        <select 
                          className="w-full p-2 border rounded-lg mb-3"
                          value={femaleData.tubalStatus}
                          onChange={e => setFemaleData({...femaleData, tubalStatus: e.target.value})}
                        >
                          <option value="Patent">Patent Bilaterally (ÿ≥ŸÑŸäŸÖÿ©)</option>
                          <option value="Right Blocked">Right Blocked (ÿßŸÜÿ≥ÿØÿßÿØ ŸäŸÖŸäŸÜ)</option>
                          <option value="Left Blocked">Left Blocked (ÿßŸÜÿ≥ÿØÿßÿØ Ÿäÿ≥ÿßÿ±)</option>
                          <option value="Bilateral Block">Bilateral Block (ÿßŸÜÿ≥ÿØÿßÿØ ŸÉŸÑŸä)</option>
                        </select>
                        
                        <label className="flex items-center gap-3 p-3 bg-white border border-red-100 rounded-lg cursor-pointer hover:bg-red-50 transition-colors">
                          <input 
                            type="checkbox" 
                            checked={femaleData.hydrosalpinx} 
                            onChange={e => setFemaleData({...femaleData, hydrosalpinx: e.target.checked})} 
                            className="w-5 h-5 text-red-600 rounded focus:ring-red-500" 
                          />
                          <div>
                            <span className="font-bold text-red-800 block text-sm">Hydrosalpinx Detected</span>
                            <span className="text-xs text-red-600">ÿßÿ±ÿ™ÿ¥ÿßÿ≠ ÿ®ŸÇŸÜÿßÿ© ŸÅÿßŸÑŸàÿ® (Must remove before IVF)</span>
                          </div>
                        </label>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2">Hysteroscopy Findings</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Normal Cavity', 'Adhesions', 'Polypectomy', 'Septum Resection'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('hysteroscopy', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.hysteroscopy.includes(item) ? 'bg-purple-600 text-white border-purple-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2">Laparoscopy Findings</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Normal', 'Endometriosis I-II', 'Endometriosis III-IV', 'Adhesions'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('laparoscopy', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.laparoscopy.includes(item) ? 'bg-purple-600 text-white border-purple-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>

                    </div>
                  )}

                </div>
                
                {/* Summary / Diagnosis Box */}
                <div className="bg-pink-50 p-4 border-t border-pink-100 min-h-[100px]">
                  <h4 className="text-xs font-bold text-pink-800 uppercase mb-2 flex items-center gap-2">
                    <Info className="w-4 h-4" /> Diagnosis & Findings
                  </h4>
                  {femaleFindings.length > 0 ? (
                    <ul className="list-disc list-inside space-y-1">
                      {femaleFindings.map((finding, i) => (
                        <li key={i} className="text-sm text-pink-900 font-medium">
                          {finding}
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p className="text-xs text-pink-400 italic">Enter data to generate diagnosis...</p>
                  )}
                </div>
              </div>
            </div>

            {/* RIGHT COLUMN: Smart Rx (4 cols on desktop, 2 cols on md, 1 col on mobile) */}
            <div className="md:col-span-1 lg:col-span-4 bg-white p-3 md:p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
              <h3 className="text-sm md:text-base font-bold text-gray-800 mb-4 flex items-center gap-2">
                <FileText className="w-4 h-4 text-teal-600" /> Smart Prescription
              </h3>
              
              <div className="space-y-3 mb-4">
                <div>
                  <label className="text-xs font-medium text-gray-600">Category</label>
                  <select 
                    className="w-full p-2 border rounded-lg mt-1 text-sm"
                    value={drugCategory}
                    onChange={e => { setDrugCategory(e.target.value); setSelectedDrug(''); }}
                  >
                    <option value="">Select Category</option>
                    {Object.keys(EGYPTIAN_DRUGS).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </select>
                </div>
                
                <div>
                  <label className="text-xs font-medium text-gray-600">Medication</label>
                  <select 
                    className="w-full p-2 border rounded-lg mt-1 text-sm"
                    value={selectedDrug}
                    onChange={e => setSelectedDrug(e.target.value)}
                    disabled={!drugCategory}
                  >
                    <option value="">Select Drug</option>
                    {drugCategory && Object.keys((EGYPTIAN_DRUGS as any)[drugCategory]).map(d => (
                      <option key={d} value={d}>{d}</option>
                    ))}
                  </select>
                </div>

                <button 
                  onClick={handleAddDrug}
                  disabled={!selectedDrug}
                  className="w-full bg-teal-600 text-white py-2 rounded-lg font-bold hover:bg-teal-700 disabled:bg-gray-300 transition-colors flex items-center justify-center gap-2 text-sm"
                >
                  <Plus className="w-4 h-4" /> Add
                </button>
              </div>

              <div className="flex-1 border border-gray-100 rounded-lg p-3 bg-gray-50 overflow-y-auto max-h-[300px]">
                {rxItems.length === 0 ? (
                  <p className="text-center text-gray-400 text-xs mt-10">No items added</p>
                ) : (
                  <ul className="space-y-2">
                    {rxItems.map((item, idx) => (
                      <li key={idx} className="bg-white p-2 rounded shadow-sm flex justify-between items-start">
                        <div>
                          <div className="font-bold text-gray-800 text-sm">{item.drug}</div>
                          <div className="text-xs text-teal-600 font-mono mt-0.5">{item.dose}</div>
                        </div>
                        <button onClick={() => removeDrug(idx)} className="text-red-400 hover:text-red-600">
                          <Trash2 className="w-3 h-3" />
                        </button>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
              
              <div className="mt-4 pt-3 border-t border-gray-100">
                 <button 
                  onClick={handlePrint}
                  disabled={rxItems.length === 0}
                  className="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold hover:bg-gray-900 transition-colors flex items-center justify-center gap-2 text-sm"
                >
                  <Printer className="w-4 h-4" /> Print (A4)
                </button>
              </div>
            </div>
          </div>

          {/* PRINT VIEW - Hidden until print */}
          <div className="print-only w-full bg-white p-8" style={{ direction: 'rtl' }}>
            <div className="border-b-2 border-teal-700 pb-6 mb-8">
              <div className="flex flex-row-reverse justify-between items-end mb-4">
                <div className="text-right">
                  <h1 className="text-3xl font-bold text-teal-800">ŸÖÿ±ŸÉÿ≤ ŸÜŸäŸÑ ŸÑŸÑÿπŸÇŸÖ</h1>
                  <p className="text-gray-600 mt-2 text-sm">Nile IVF Center</p>
                </div>
                <div className="text-left text-sm text-gray-600">
                  <p>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: {new Date().toLocaleDateString('ar-EG')}</p>
                  <p>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©: <strong>{selectedPatient?.name}</strong></p>
                </div>
              </div>
            </div>

            <div className="mb-8">
              <h2 className="text-center text-2xl font-bold text-gray-800 mb-6">ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</h2>
              <h3 className="text-4xl font-serif text-teal-700 text-center mb-8">R/</h3>
              
              <div className="space-y-4">
                {rxItems.map((item, idx) => (
                  <div key={idx} className="border-b border-gray-300 pb-3 flex flex-row-reverse justify-between items-start">
                    <div className="text-right flex-1">
                      <div className="font-bold text-lg text-gray-800">{item.drug}</div>
                      <div className="text-sm text-teal-700 font-medium mt-1">{item.dose}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="border-t border-gray-300 pt-6 mt-12 text-center text-xs text-gray-500">
              <p>Nile IVF Center - Cairo, Egypt</p>
              <p className="mt-1">+20 123 456 7890</p>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default ClinicalStation;
</file>

<file path="App.tsx">
import React, { useState, useEffect } from 'react';
import { Sidebar } from './components/Sidebar';
import BottomNav from './components/BottomNav';
import SyncStatus from './components/SyncStatus';
import { Page } from './types';
import Dashboard from './pages/Dashboard';
import Reception from './pages/Reception';
import Gynecology from './pages/Gynecology';
import IvfJourney from './pages/IvfJourney';
import PatientMasterRecord from './pages/PatientMasterRecord';
import Settings from './pages/Settings';
import ObstetricsDashboard from './pages/ObstetricsDashboard';
import AdminDashboard from './pages/AdminDashboard';
import { Login } from './pages/Login';
import { Toaster } from 'react-hot-toast';
import { authService } from './services/authService';
import { LogOut } from 'lucide-react';
import { BrandingProvider } from './context/BrandingContext';
import { initPWA } from './src/lib/pwa';
import { initLocalDB } from './src/db/localDB';
import { syncService } from './src/services/syncService';

const App: React.FC = () => {
  const [activePage, setActivePage] = useState<Page>(Page.HOME);
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);

    const initializeApp = async () => {
      try {
        // Initialize PWA features
        await initPWA();

        // Initialize local database
        await initLocalDB();

        // Check user authentication
        const currentUser = await authService.getCurrentUser();
        setUser(currentUser);

        // Initialize sync - process any pending items
        if (currentUser) {
          await syncService.initializeSync();
        }

      } catch (error) {
        console.error('App initialization error:', error);
        // Continue with app even if PWA features fail
        try {
          const currentUser = await authService.getCurrentUser();
          setUser(currentUser);
        } catch (authError) {
          console.log('No user logged in');
          setUser(null);
        }
      } finally {
        setLoading(false);
      }
    };

    initializeApp();

    const subscription = authService.onAuthStateChange((user) => {
      setUser(user);
      setLoading(false);
    });

    return () => {
      if (subscription) {
        subscription.unsubscribe();
      }
    };
  }, []);

  const handleLogout = async () => {
    try {
      await authService.logout();
      setUser(null);
      setActivePage(Page.HOME);
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 font-[Tajawal]">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return (
      <>
        <Login onLoginSuccess={() => setActivePage(Page.HOME)} />
        <Toaster position="top-center" reverseOrder={false} />
      </>
    );
  }

  const renderContent = () => {
    switch (activePage) {
      case Page.HOME: return <Dashboard />;
      case Page.RECEPTION: return <Reception />;
      case Page.GYNECOLOGY: return <Gynecology />;
      case Page.IVF: return <IvfJourney />;
      case Page.OBSTETRICS: return <ObstetricsDashboard />;
      case Page.PATIENT_RECORD: return <PatientMasterRecord />;
      case Page.SETTINGS: return <Settings user={user} />;
      case Page.ADMIN: return <AdminDashboard />;
      default: return <Dashboard />;
    }
  };

  return (
    <BrandingProvider>
      <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row-reverse font-[Tajawal]">
        <div className="hidden md:flex">
          <Sidebar activePage={activePage} setPage={setActivePage} onLogout={handleLogout} />
        </div>

        <main className="flex-1 md:mr-64 p-4 md:p-8 transition-all duration-300 no-print pb-20 md:pb-0">
          <div className="max-w-7xl mx-auto">
            {/* Desktop Header with Logout */}
            <div className="hidden md:flex justify-between items-center mb-6">
              <h1 className="text-2xl font-bold text-gray-900">
                ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå {user?.email}
              </h1>
              <div className="flex items-center gap-4">
                <SyncStatus />
                <button
                  onClick={handleLogout}
                  className="flex items-center gap-2 px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition duration-200 font-[Tajawal]"
                >
                  <LogOut size={18} />
                  ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
                </button>
              </div>
            </div>

            {/* Mobile Header - Simplified */}
            <div className="md:hidden mb-4 flex justify-between items-center">
              <SyncStatus />
              <h1 className="text-xl font-bold text-gray-900 text-center flex-1">
                ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå {user?.email?.split('@')[0]}
              </h1>
              <div className="w-5"></div>
            </div>

            {renderContent()}
          </div>
        </main>

        <BottomNav activePage={activePage} setPage={setActivePage} onLogout={handleLogout} />

        <Toaster position="top-center" reverseOrder={false} />
      </div>
    </BrandingProvider>
  );
};

export default App;
</file>

<file path="types.ts">
export interface Patient {
  id?: string | number;
  name: string;
  age?: number;
  phone: string;
  husbandName?: string;
  history?: string;
  createdAt?: string;
}

export interface Visit {
  id: string;
  patientId: string;
  date: string;
  department?: string; // 'GYNA', 'OBS', 'IVF_STIM', 'IVF_LAB'
  diagnosis: string;
  prescription: PrescriptionItem[];
  notes: string;
  clinical_data?: any; // JSONB for structured clinical data
  vitals?: {
    weight?: number;
    height?: number;
    bmi?: number;
  };
}

export interface PrescriptionItem {
  category: string;
  drug: string;
  dose: string;
}

export interface MaleFactorAssessment {
  volume?: number;
  concentration?: number;
  motility?: number;
  morphology?: number;
  tmsc?: number;
  diagnosis?: string;
  icsiIndicated?: boolean;
}

export interface FemaleFactorAssessment {
  amh?: number;
  fsh?: number;
  lh?: number;
  e2?: number;
  afcRight?: number;
  afcLeft?: number;
  ovaryClassification?: 'Poor Responder' | 'Normal' | 'High Responder';
}

export interface TubalUterineAssessment {
  hsgFindings?: string;
  hysteroscopyFindings?: string;
  septate?: boolean;
  polyps?: boolean;
  adhesions?: boolean;
}

export interface CoupleProfileAssessment {
  age?: number;
  infertilityDuration?: number;
  infertilityType?: 'Primary' | 'Secondary';
  previousAttempts?: number;
  height?: number;
  weight?: number;
  bmi?: number;
  bmiAlert?: boolean;
}

export interface ImagingAssessment {
  baselineUltrasound: {
    uterus: { dimensions: string, myometrium: string, cavity: string };
    endometrium: { thickness: number, pattern: string };
    ovaries: {
      afcRight: number;
      afcLeft: number;
      pathology: { cyst: boolean, endometrioma: boolean, dermoid: boolean };
    };
    adnexa: { hydrosalpinx: boolean };
  };
  hysteroscopyHSG: {
    status: string[];
    actionTaken: string;
  };
}

export interface CycleAssessment {
  coupleProfile?: CoupleProfileAssessment;
  maleFactor?: MaleFactorAssessment;
  femaleFactor?: FemaleFactorAssessment;
  tubalUterine?: TubalUterineAssessment;
  imaging?: ImagingAssessment;
}

export interface StimulationLog {
  id: string;
  date: string;
  cycleDay: number;
  fsh: string;
  hmg: string;
  e2: string;
  lh: string;
  rtFollicles: string;
  ltFollicles: string;
  endometriumThickness?: string;
}

export interface OpuLabData {
  opuDate?: string;
  totalOocytes?: number;
  mii?: number;
  mi?: number;
  gv?: number;
  atretic?: number;
  maturationRate?: number;
  fertilizedTwoPN?: number;
  fertilizationRate?: number;
  embryoDay3A?: number;
  embryoDay3B?: number;
  embryoDay3C?: number;
  blastocystsExpanded?: number;
  blastocystsHatching?: number;
}

export interface TransferData {
  transferDate?: string;
  numberTransferred?: number;
  embryoQuality?: string;
  catheterDifficulty?: 'Easy' | 'Moderate' | 'Difficult';
  lutealSupport?: string[];
}

export interface OutcomeData {
  betaHcg?: number;
  betaHcgPositive?: boolean;
  clinicalPregnancy?: boolean;
  gestationalSac?: boolean;
  fHR?: boolean;
}

export interface IvfCycle {
  id: string;
  patientId: string;
  protocol: 'Long' | 'Antagonist' | 'Flare-up' | 'Mini-IVF';
  startDate: string;
  status: 'Active' | 'Completed' | 'Cancelled';
  assessment?: CycleAssessment;
  logs: StimulationLog[];
  lab?: OpuLabData;
  transfer?: TransferData;
  outcome?: OutcomeData;
  cycleData?: any;
}

export interface Doctor {
  id: string;
  user_id: string;
  email: string;
  name: string;
  specialization?: string;
  phone?: string;
  created_at?: string;
  doctor_image?: string;
  clinic_name?: string;
  clinic_address?: string;
  clinic_phone?: string;
  clinic_image?: string;
  clinic_latitude?: string;
  clinic_longitude?: string;
}

export interface Pregnancy {
  id: string;
  patient_id: string;
  lmp_date?: string;
  edd_date?: string;
  edd_by_scan?: string;
  ga_at_booking?: number;
  risk_level: 'low' | 'moderate' | 'high';
  risk_factors: string[];
  aspirin_prescribed: boolean;
  thromboprophylaxis_needed: boolean;
  created_at?: string;
  updated_at?: string;
}

export interface AntenatalVisit {
  id: string;
  pregnancy_id: string;
  visit_date: string;
  gestational_age_weeks: number;
  gestational_age_days: number;
  systolic_bp?: number;
  diastolic_bp?: number;
  weight_kg?: number;
  urine_albuminuria?: string;
  urine_glycosuria?: string;
  fetal_heart_sound?: boolean;
  fundal_height_cm?: number;
  edema?: boolean;
  edema_grade?: string;
  notes?: string;
  next_visit_date?: string;
  created_at?: string;
}

export interface BiometryScan {
  id: string;
  pregnancy_id: string;
  scan_date: string;
  gestational_age_weeks: number;
  gestational_age_days: number;
  bpd_mm?: number;
  hc_mm?: number;
  ac_mm?: number;
  fl_mm?: number;
  efw_grams?: number;
  percentile?: number;
  notes?: string;
  created_at?: string;
}

export interface ObstetricsData {
  id?: string;
  patientId: string;
  lmp: string | null;
  edd: string | null;
  gestationalAge?: string;
  riskFactors: string[];
  isHighRisk: boolean;
  notes?: string;
}

export interface AntenatalVisitData {
  id: string;
  date: string;
  gaWeeks: number;
  bp: string;
  weight: string;
  urine: string;
  fetalHeart: string;
  fundalHeight?: string;
  edema?: string;
  notes: string;
}

export interface FetalBiometryData {
  date: string;
  bpd?: number;
  fl?: number;
  ac?: number;
  hc?: number;
  efw?: number;
  afi?: number;
  placenta?: string;
}

export enum Page {
  HOME = 'home',
  RECEPTION = 'reception',
  CLINICAL = 'clinical',
  GYNECOLOGY = 'gynecology',
  IVF = 'ivf',
  PATIENT_RECORD = 'patient_record',
  SETTINGS = 'settings',
  OBSTETRICS = 'obstetrics',
  ADMIN = 'admin'
}
</file>

<file path="pages/IvfJourney.tsx">
import React, { useState, useEffect } from 'react';
import { useLiveQuery } from 'dexie-react-hooks';
import { db as dexieDB } from '../src/db/localDB';
import { calculateTMSC, analyzeSemenAnalysis, classifyOvarianReserve, calculateMaturationRate, calculateFertilizationRate, db } from '../services/ivfService';
import { Patient } from '../types';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Baby, TestTube, PlusCircle, TrendingUp, PipetteIcon, Heart, Save, AlertCircle, CheckCircle, Pill, Printer, Microscope, Activity, Plus, X } from 'lucide-react';
import toast from 'react-hot-toast';
import PrescriptionPrinter from '../components/PrescriptionPrinter';

const PROTOCOL_OPTIONS = ['Long', 'Antagonist', 'Flare-up', 'Mini-IVF'];

const LOCAL_IVF_DRUGS = {
  'Induction (Stimulation)': ['Gonal-F 75 IU', 'Merional 75 IU', 'Menogon 75 IU', 'Clomid 50mg', 'Femara 2.5mg'],
  'Trigger Shots': ['Ovitrelle 250mcg', 'Choriomon 5000 IU', 'Pregnyl 5000 IU', 'Decapeptyl 0.1mg (Trigger)'],
  'Down-Regulation': ['Cetrotide 0.25mg', 'Orgalutran 0.25mg', 'Decapeptyl 0.1mg Daily', 'Zoladex 3.6mg'],
  'Luteal Support': ['Cyclogest 400mg', 'Cyclogest 200mg', 'Prontogest 100mg', 'Duphaston 10mg', 'Utrogestan 200mg', 'Crinone 8% Gel']
};

const PROTOCOL_INFO: any = {
  'Long': {
    name: 'Long Agonist Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑŸÜÿßŸáÿ∂ÿßÿ™ ÿßŸÑÿ∑ŸàŸäŸÑÿ©',
    bestFor: ['Normal responders', 'Regular cycles', 'PCO patients'],
    duration: '35-42 days',
    stimDays: '10-12 days',
    stimDrugs: ['Gonal-F 75 IU', 'Merional 75 IU', 'Fostimon 75 IU'],
    trigger: ['Ovitrelle 250mcg', 'Choriomon 5000 IU'],
    luteal: ['Cyclogest 400mg', 'Utrogestan 200mg']
  },
  'Antagonist': {
    name: 'Antagonist Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑŸÖÿ∂ÿßÿØÿßÿ™',
    bestFor: ['Poor responders', 'Previous low response'],
    duration: '14-16 days',
    stimDays: '8-10 days',
    stimDrugs: ['Gonal-F 75-150 IU', 'Merional 75 IU', 'Menopur 75 IU'],
    trigger: ['Ovitrelle 250mcg', 'Decapeptyl 0.1mg (Trigger)'],
    luteal: ['Cyclogest 400mg', 'Progynova 2mg']
  },
  'Flare-up': {
    name: 'Flare-up Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ™ŸÜÿ¥Ÿäÿ∑ ÿßŸÑÿ≠ÿßÿØ',
    bestFor: ['Poor responders', 'Diminished ovarian reserve'],
    duration: '10-12 days',
    stimDays: '8-9 days',
    stimDrugs: ['Gonal-F 150-300 IU', 'Merional 150 IU'],
    trigger: ['Ovitrelle 250mcg', 'Choriomon 5000 IU'],
    luteal: ['Cyclogest 400mg', 'Duphaston 10mg']
  },
  'Mini-IVF': {
    name: 'Mini-IVF Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ≠ŸÇŸÜ ÿßŸÑŸÖÿ¨Ÿáÿ±Ÿä ÿßŸÑÿÆŸÅŸäŸÅ',
    bestFor: ['Poor responders', 'Previous OHSS'],
    duration: '10-14 days',
    stimDays: '7-8 days',
    stimDrugs: ['Clomid 50mg', 'Femara 2.5mg', 'Gonal-F 75 IU'],
    trigger: ['Ovitrelle 250mcg'],
    luteal: ['Cyclogest 200mg', 'Utrogestan 200mg']
  }
};

interface StimulationLog {
  id?: string;
  date: string;
  cycleDay: number;
  fsh: string;
  hmg: string;
  e2: string;
  lh: string;
  rtFollicles: string;
  ltFollicles: string;
  endometriumThickness?: string;
}

interface CycleDataState {
  id: string;
  patientId: string;
  protocol: string;
  status: 'Assessment' | 'Active' | 'PickUp' | 'Transfer' | 'Done';
  startDate: string;
  
  // Assessment Tab
  coupleAge?: number;
  coupleBMI?: number;
  amh?: number;
  afc?: number;
  pcosHistory?: boolean;
  maleFactorAnalysis?: string;
  maleFactorDiagnosis?: string;
  recommendedProtocol?: string;
  
  // Stimulation Tab
  stimulationLogs: StimulationLog[];
  triggerDate?: string;
  
  // Lab Tab
  opuDate?: string;
  totalOocytes?: number;
  mii?: number;
  mi?: number;
  gv?: number;
  atretic?: number;
  maturationRate?: number;
  fertilizedTwoPN?: number;
  fertilizationRate?: number;
  
  // Transfer Tab
  transferDate?: string;
  numberTransferred?: number;
  embryoQuality?: string;
  betaHcg?: number;
  clinicalPregnancy?: boolean;
  gestationalSac?: boolean;
  fHR?: boolean;
}

const defaultCycleData: CycleDataState = {
  id: '',
  patientId: '',
  protocol: 'Antagonist',
  status: 'Assessment',
  startDate: new Date().toISOString().split('T')[0],
  stimulationLogs: [],
  coupleAge: undefined,
  coupleBMI: undefined,
  amh: undefined,
  afc: undefined,
  pcosHistory: false,
  maleFactorAnalysis: '',
  maleFactorDiagnosis: '',
  recommendedProtocol: 'GnRH Antagonist',
  triggerDate: undefined,
  opuDate: undefined,
  totalOocytes: undefined,
  mii: undefined,
  mi: undefined,
  gv: undefined,
  atretic: undefined,
  maturationRate: undefined,
  fertilizedTwoPN: undefined,
  fertilizationRate: undefined,
  transferDate: undefined,
  numberTransferred: undefined,
  embryoQuality: '',
  betaHcg: undefined,
  clinicalPregnancy: false,
  gestationalSac: false,
  fHR: false
};

const IvfJourney: React.FC = () => {
  const patients = useLiveQuery(() => dexieDB.patients.toArray(), []) || [];
  const [selectedPatientId, setSelectedPatientId] = useState('');
  const [cycleData, setCycleData] = useState<CycleDataState>(defaultCycleData);
  const [activeTab, setActiveTab] = useState<'assessment' | 'stimulation' | 'lab' | 'transfer'>('assessment');
  const [isLoading, setIsLoading] = useState(false);
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);

  const selectedPatient = patients.find(p => String(p.id) === selectedPatientId);

  useEffect(() => {
    if (selectedPatientId) {
      setCycleData({ ...defaultCycleData, patientId: selectedPatientId });
    }
  }, [selectedPatientId]);

  const handleStartCycle = async () => {
    if (!selectedPatientId) {
      toast.error('Please select a patient');
      return;
    }

    setIsLoading(true);
    try {
      const newCycleId = `cycle_${Date.now()}`;
      setCycleData(prev => ({
        ...prev,
        id: newCycleId,
        patientId: selectedPatientId,
        status: 'Active',
        startDate: new Date().toISOString().split('T')[0]
      }));
      toast.success('New IVF cycle started');
    } catch (error) {
      console.error('Error starting cycle:', error);
      toast.error('Failed to start cycle');
    } finally {
      setIsLoading(false);
    }
  };

  const handleAddStimulationLog = () => {
    const newLog: StimulationLog = {
      date: new Date().toISOString().split('T')[0],
      cycleDay: cycleData.stimulationLogs.length + 1,
      fsh: '',
      hmg: '',
      e2: '',
      lh: '',
      rtFollicles: '',
      ltFollicles: '',
      endometriumThickness: ''
    };
    setCycleData(prev => ({
      ...prev,
      stimulationLogs: [...prev.stimulationLogs, newLog]
    }));
  };

  const handleUpdateLog = (index: number, field: string, value: any) => {
    setCycleData(prev => {
      const newLogs = [...prev.stimulationLogs];
      newLogs[index] = { ...newLogs[index], [field]: value };
      return { ...prev, stimulationLogs: newLogs };
    });
  };

  const handleRemoveLog = (index: number) => {
    setCycleData(prev => ({
      ...prev,
      stimulationLogs: prev.stimulationLogs.filter((_, i) => i !== index)
    }));
  };

  const calculateMaturation = () => {
    if (!cycleData.totalOocytes || cycleData.totalOocytes === 0) return 0;
    if (!cycleData.mii) return 0;
    return ((cycleData.mii / cycleData.totalOocytes) * 100).toFixed(1);
  };

  const calculateFertilization = () => {
    if (!cycleData.mii || cycleData.mii === 0) return 0;
    if (!cycleData.fertilizedTwoPN) return 0;
    return ((cycleData.fertilizedTwoPN / cycleData.mii) * 100).toFixed(1);
  };

  const stimulationChartData = cycleData.stimulationLogs.map(log => ({
    day: `D${log.cycleDay}`,
    e2: parseFloat(log.e2) || 0,
    lh: parseFloat(log.lh) || 0,
    date: log.date
  }));

  return (
    <div className="max-w-7xl mx-auto space-y-6" style={{ fontFamily: 'Tajawal, sans-serif' }} dir="ltr">
      {/* Header */}
      <div className="bg-gradient-to-r from-teal-600 to-indigo-600 text-white p-6 rounded-2xl shadow-lg">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold mb-2">üî¨ IVF Journey</h1>
            <p className="text-teal-100">Comprehensive IVF Cycle Management & Tracking</p>
          </div>
          <TestTube className="w-16 h-16 opacity-20" />
        </div>
      </div>

      {/* Patient Selector */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <label className="block text-sm font-semibold text-gray-700 mb-2">Select Patient</label>
        <select
          value={selectedPatientId}
          onChange={(e) => setSelectedPatientId(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        >
          <option value="">-- Select Patient --</option>
          {patients.map(patient => (
            <option key={patient.id} value={String(patient.id)}>
              {patient.name} - {patient.phone}
            </option>
          ))}
        </select>
      </div>

      {selectedPatient && cycleData.id && (
        <div className="bg-white rounded-lg shadow-md overflow-hidden">
          {/* Cycle Header */}
          <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 border-b border-gray-200">
            <h2 className="text-2xl font-bold text-gray-900">{selectedPatient.name}'s Cycle</h2>
            <p className="text-sm text-gray-600 mt-1">Status: <span className="font-semibold text-teal-600">{cycleData.status}</span></p>
          </div>

          {/* Tabs */}
          <div className="border-b border-gray-200">
            <nav className="flex">
              {['assessment', 'stimulation', 'lab', 'transfer'].map((tab) => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab as any)}
                  className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                    activeTab === tab
                      ? 'border-b-2 border-teal-500 text-teal-600 bg-teal-50'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  {tab.charAt(0).toUpperCase() + tab.slice(1)}
                </button>
              ))}
            </nav>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {/* Assessment Tab */}
            {activeTab === 'assessment' && (
              <div className="grid md:grid-cols-2 gap-6">
                {/* Couple Profile */}
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Heart className="w-5 h-5 text-blue-600" /> Couple Profile
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Age (Wife)</label>
                      <input
                        type="number"
                        value={cycleData.coupleAge || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, coupleAge: parseInt(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Years"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">BMI</label>
                      <input
                        type="number"
                        step="0.1"
                        value={cycleData.coupleBMI || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, coupleBMI: parseFloat(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="kg/m¬≤"
                      />
                    </div>
                    <div className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        id="pcosCheckbox"
                        checked={cycleData.pcosHistory || false}
                        onChange={(e) => setCycleData(prev => ({ ...prev, pcosHistory: e.target.checked }))}
                        className="w-4 h-4"
                      />
                      <label htmlFor="pcosCheckbox" className="text-sm font-medium text-gray-700">PCOS History</label>
                    </div>
                  </div>
                </div>

                {/* Ovarian Reserve */}
                <div className="bg-green-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Microscope className="w-5 h-5 text-green-600" /> Ovarian Reserve
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">AMH (ng/mL)</label>
                      <input
                        type="number"
                        step="0.1"
                        value={cycleData.amh || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, amh: parseFloat(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                        placeholder="0.0"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">AFC</label>
                      <input
                        type="number"
                        value={cycleData.afc || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, afc: parseInt(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                        placeholder="Count"
                      />
                    </div>
                    {cycleData.amh !== undefined && cycleData.afc !== undefined && (
                      <div className="p-3 bg-white rounded border border-green-200 text-sm">
                        <p className="font-medium text-gray-900">
                          Classification: <span className="text-green-600 font-bold">{classifyOvarianReserve(cycleData.amh, cycleData.afc)}</span>
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Male Factor */}
                <div className="bg-purple-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Male Factor Analysis</h3>
                  <textarea
                    value={cycleData.maleFactorAnalysis || ''}
                    onChange={(e) => setCycleData(prev => ({ ...prev, maleFactorAnalysis: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    placeholder="WHO 2021 parameters, TMSC, Morphology..."
                    rows={3}
                  />
                </div>

                {/* Protocol Selection */}
                <div className="bg-amber-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Protocol Selection</h3>
                  <select
                    value={cycleData.protocol}
                    onChange={(e) => setCycleData(prev => ({ ...prev, protocol: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 mb-3"
                  >
                    {PROTOCOL_OPTIONS.map(p => (
                      <option key={p} value={p}>{p}</option>
                    ))}
                  </select>
                  {PROTOCOL_INFO[cycleData.protocol] && (
                    <div className="p-3 bg-white rounded border border-amber-200 text-sm">
                      <p className="font-medium text-gray-900">{PROTOCOL_INFO[cycleData.protocol].name}</p>
                      <p className="text-gray-600 mt-1">Duration: {PROTOCOL_INFO[cycleData.protocol].duration}</p>
                      <p className="text-gray-600">Stimulation: {PROTOCOL_INFO[cycleData.protocol].stimDays}</p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Stimulation Tab */}
            {activeTab === 'stimulation' && (
              <div className="space-y-6">
                {/* Hormone Trends Chart */}
                {stimulationChartData.length > 0 && (
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Hormone Trends</h3>
                    <ResponsiveContainer width="100%" height={300}>
                      <LineChart data={stimulationChartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="day" />
                        <YAxis />
                        <Tooltip />
                        <Legend />
                        <Line type="monotone" dataKey="e2" stroke="#ef4444" name="E2 (pg/mL)" />
                        <Line type="monotone" dataKey="lh" stroke="#3b82f6" name="LH (mIU/mL)" />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                )}

                {/* Daily Stimulation Logs */}
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-semibold text-gray-900">Daily Stimulation Logs</h3>
                    <button
                      onClick={handleAddStimulationLog}
                      className="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg transition"
                    >
                      <Plus className="w-4 h-4" /> Add Day
                    </button>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-white border-b">
                        <tr>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">Date</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">Day</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">FSH</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">HMG</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">E2</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">LH</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">Rt Follicles</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">Lt Follicles</th>
                          <th className="px-3 py-2 text-left font-semibold text-gray-700">Action</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y">
                        {cycleData.stimulationLogs.map((log, idx) => (
                          <tr key={idx} className="bg-white hover:bg-gray-50">
                            <td className="px-3 py-2">
                              <input
                                type="date"
                                value={log.date}
                                onChange={(e) => handleUpdateLog(idx, 'date', e.target.value)}
                                className="w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                              />
                            </td>
                            <td className="px-3 py-2 text-gray-600">{log.cycleDay}</td>
                            <td className="px-3 py-2">
                              <input
                                type="number"
                                value={log.fsh}
                                onChange={(e) => handleUpdateLog(idx, 'fsh', e.target.value)}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                placeholder="IU"
                              />
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="number"
                                value={log.hmg}
                                onChange={(e) => handleUpdateLog(idx, 'hmg', e.target.value)}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                placeholder="IU"
                              />
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="number"
                                value={log.e2}
                                onChange={(e) => handleUpdateLog(idx, 'e2', e.target.value)}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                placeholder="pg/mL"
                              />
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="number"
                                value={log.lh}
                                onChange={(e) => handleUpdateLog(idx, 'lh', e.target.value)}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                placeholder="mIU/mL"
                              />
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="text"
                                value={log.rtFollicles}
                                onChange={(e) => handleUpdateLog(idx, 'rtFollicles', e.target.value)}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                placeholder="e.g., 12,10,8"
                              />
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="text"
                                value={log.ltFollicles}
                                onChange={(e) => handleUpdateLog(idx, 'ltFollicles', e.target.value)}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                placeholder="e.g., 11,9,7"
                              />
                            </td>
                            <td className="px-3 py-2">
                              <button
                                onClick={() => handleRemoveLog(idx)}
                                className="p-1 hover:bg-red-100 text-red-600 rounded transition"
                              >
                                <X className="w-4 h-4" />
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  {cycleData.stimulationLogs.length === 0 && (
                    <p className="text-gray-500 text-center py-6">No stimulation logs yet. Click "Add Day" to start recording.</p>
                  )}
                </div>

                {/* Trigger */}
                <div className="bg-red-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Trigger Shot</h3>
                  <input
                    type="date"
                    value={cycleData.triggerDate || ''}
                    onChange={(e) => setCycleData(prev => ({ ...prev, triggerDate: e.target.value }))}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                  />
                </div>
              </div>
            )}

            {/* Lab Tab */}
            {activeTab === 'lab' && (
              <div className="grid md:grid-cols-2 gap-6">
                {/* OPU Data */}
                <div className="bg-pink-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <PipetteIcon className="w-5 h-5 text-pink-600" /> OPU Data
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">OPU Date</label>
                      <input
                        type="date"
                        value={cycleData.opuDate || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, opuDate: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Total Oocytes</label>
                      <input
                        type="number"
                        value={cycleData.totalOocytes || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, totalOocytes: parseInt(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">MII</label>
                        <input
                          type="number"
                          value={cycleData.mii || ''}
                          onChange={(e) => setCycleData(prev => ({ ...prev, mii: parseInt(e.target.value) || undefined }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">MI</label>
                        <input
                          type="number"
                          value={cycleData.mi || ''}
                          onChange={(e) => setCycleData(prev => ({ ...prev, mi: parseInt(e.target.value) || undefined }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">GV</label>
                        <input
                          type="number"
                          value={cycleData.gv || ''}
                          onChange={(e) => setCycleData(prev => ({ ...prev, gv: parseInt(e.target.value) || undefined }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Atretic</label>
                        <input
                          type="number"
                          value={cycleData.atretic || ''}
                          onChange={(e) => setCycleData(prev => ({ ...prev, atretic: parseInt(e.target.value) || undefined }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                    </div>
                    {cycleData.totalOocytes && cycleData.mii && (
                      <div className="p-3 bg-white rounded border border-pink-200">
                        <p className="text-sm text-gray-700">
                          Maturation Rate: <span className="font-bold text-pink-600">{calculateMaturation()}%</span>
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Fertilization */}
                <div className="bg-cyan-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Microscope className="w-5 h-5 text-cyan-600" /> Fertilization
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">2PN Count</label>
                      <input
                        type="number"
                        value={cycleData.fertilizedTwoPN || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, fertilizedTwoPN: parseInt(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500"
                      />
                    </div>
                    {cycleData.mii && cycleData.fertilizedTwoPN && (
                      <div className="p-3 bg-white rounded border border-cyan-200">
                        <p className="text-sm text-gray-700">
                          Fertilization Rate: <span className="font-bold text-cyan-600">{calculateFertilization()}%</span>
                        </p>
                      </div>
                    )}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Embryo Quality</label>
                      <select
                        value={cycleData.embryoQuality || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, embryoQuality: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500"
                      >
                        <option value="">Select Quality</option>
                        <option value="A">Excellent (A)</option>
                        <option value="B">Good (B)</option>
                        <option value="C">Fair (C)</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Transfer Tab */}
            {activeTab === 'transfer' && (
              <div className="grid md:grid-cols-2 gap-6">
                {/* Transfer Details */}
                <div className="bg-indigo-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Baby className="w-5 h-5 text-indigo-600" /> Transfer Details
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Transfer Date</label>
                      <input
                        type="date"
                        value={cycleData.transferDate || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, transferDate: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Number Transferred</label>
                      <input
                        type="number"
                        value={cycleData.numberTransferred || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, numberTransferred: parseInt(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                  </div>
                </div>

                {/* Outcome */}
                <div className="bg-emerald-50 p-4 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Heart className="w-5 h-5 text-emerald-600" /> Outcome
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Beta-HCG (mIU/mL)</label>
                      <input
                        type="number"
                        value={cycleData.betaHcg || ''}
                        onChange={(e) => setCycleData(prev => ({ ...prev, betaHcg: parseInt(e.target.value) || undefined }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                      />
                    </div>
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          id="clinicalPregnancy"
                          checked={cycleData.clinicalPregnancy || false}
                          onChange={(e) => setCycleData(prev => ({ ...prev, clinicalPregnancy: e.target.checked }))}
                          className="w-4 h-4"
                        />
                        <label htmlFor="clinicalPregnancy" className="text-sm font-medium text-gray-700">Clinical Pregnancy</label>
                      </div>
                      <div className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          id="gestationalSac"
                          checked={cycleData.gestationalSac || false}
                          onChange={(e) => setCycleData(prev => ({ ...prev, gestationalSac: e.target.checked }))}
                          className="w-4 h-4"
                        />
                        <label htmlFor="gestationalSac" className="text-sm font-medium text-gray-700">Gestational Sac Seen</label>
                      </div>
                      <div className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          id="fhr"
                          checked={cycleData.fHR || false}
                          onChange={(e) => setCycleData(prev => ({ ...prev, fHR: e.target.checked }))}
                          className="w-4 h-4"
                        />
                        <label htmlFor="fhr" className="text-sm font-medium text-gray-700">Fetal Heart Rate Detected</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Action Buttons */}
          <div className="bg-gray-50 p-6 border-t border-gray-200 flex gap-4">
            <button
              onClick={() => {
                toast.success('Cycle data saved (Demo)');
                setCycleData(prev => ({ ...prev, status: 'Done' }));
              }}
              className="flex-1 flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-medium py-3 px-4 rounded-lg transition"
            >
              <Save className="w-5 h-5" /> Save Cycle
            </button>
            <button
              onClick={() => setIsPrinterOpen(true)}
              className="flex-1 flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition"
            >
              <Printer className="w-5 h-5" /> Print Report
            </button>
            <button
              onClick={() => {
                setCycleData(defaultCycleData);
                setActiveTab('assessment');
              }}
              className="flex-1 flex items-center justify-center gap-2 bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 px-4 rounded-lg transition"
            >
              <X className="w-5 h-5" /> Reset
            </button>
          </div>
        </div>
      )}

      {!cycleData.id && selectedPatient && (
        <div className="bg-white p-12 rounded-lg shadow-md text-center">
          <TestTube className="w-16 h-16 mx-auto text-gray-300 mb-4" />
          <h2 className="text-2xl font-bold text-gray-900 mb-2">No Active Cycle</h2>
          <p className="text-gray-600 mb-6">Start a new IVF cycle for {selectedPatient.name}</p>
          <button
            onClick={handleStartCycle}
            disabled={isLoading}
            className="bg-teal-600 hover:bg-teal-700 disabled:opacity-50 text-white font-medium py-3 px-8 rounded-lg transition flex items-center justify-center gap-2 mx-auto"
          >
            <PlusCircle className="w-5 h-5" />
            {isLoading ? 'Starting...' : 'Start New Cycle'}
          </button>
        </div>
      )}

      {/* Prescription Printer */}
      <PrescriptionPrinter
        patient={selectedPatient || null}
        prescriptions={[]}
        diagnosis="IVF Cycle"
        notes="Comprehensive IVF Cycle Documentation"
        isOpen={isPrinterOpen}
        onClose={() => setIsPrinterOpen(false)}
      />
    </div>
  );
};

export default IvfJourney;
</file>

</files>

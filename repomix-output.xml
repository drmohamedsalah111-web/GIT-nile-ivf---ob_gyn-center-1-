This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
ADMIN_BRANDING_SETUP.md
AGENTS.md
App.tsx
BRANDING_SETUP.sql
CLAUDE.md
CLINICAL_DATA_MIGRATION.sql
components/BottomNav.tsx
components/PrescriptionComponent.tsx
components/PrescriptionPrinter.tsx
components/Sidebar.tsx
constants.ts
context/BrandingContext.tsx
data/egyptian_drugs.ts
electron/main.js
electron/preload.js
index.html
index.tsx
IVF_CYCLES_SETUP.sql
IVF_MIGRATION_GUIDE.md
metadata.json
OBSTETRICS_IMPLEMENTATION.md
OBSTETRICS_SETUP_V2.sql
OBSTETRICS_SETUP.sql
package.json
pages/AdminDashboard.tsx
pages/ClinicalStation.tsx
pages/components/InfertilityWizard.tsx
pages/components/obstetrics/ANCFlowSheet.tsx
pages/components/obstetrics/FetalGrowthChart.tsx
pages/components/obstetrics/PregnancyHeader.tsx
pages/components/obstetrics/RiskAssessment.tsx
pages/Dashboard.tsx
pages/Gynecology.tsx
pages/IvfJourney.tsx
pages/Login.tsx
pages/ObstetricsDashboard.tsx
pages/PatientMasterRecord.tsx
pages/Reception.tsx
pages/Settings.tsx
README.md
services/authService.ts
services/ivfService.ts
services/obstetricsService.ts
services/supabaseClient.ts
services/visitsService.ts
services/workupService.ts
styles.css
SUPABASE_SETUP.sql
tsconfig.json
types.ts
vercel.json
vite.config.ts
write_file.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="ADMIN_BRANDING_SETUP.md">
# Admin Dashboard & Dynamic Branding - Setup Guide

## üìã Overview

The admin dashboard enables real-time customization of:
- **Clinic name & contact info** (address, phone)
- **Clinic logo** (upload & display)
- **Brand colors** (primary, secondary, accent)
- **Prescription settings** (default templates)
- **Record management** (view & delete clinical records)

Changes are instantly reflected across the entire application (Sidebar, Dashboard, Prescriptions).

---

## üîß Setup Steps

### Step 1: Create Database Table

Execute this SQL in your **Supabase SQL Editor**:

```sql
CREATE TABLE IF NOT EXISTS app_settings (
  id INTEGER PRIMARY KEY DEFAULT 1,
  clinic_name TEXT NOT NULL DEFAULT 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±',
  logo_url TEXT,
  clinic_address TEXT,
  clinic_phone TEXT,
  primary_color TEXT DEFAULT '#2d5a6b',
  secondary_color TEXT DEFAULT '#00838f',
  accent_color TEXT DEFAULT '#00bcd4',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_by UUID,
  CONSTRAINT single_row CHECK (id = 1),
  FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);

ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can read app_settings" ON app_settings;
CREATE POLICY "Users can read app_settings"
  ON app_settings FOR SELECT
  TO authenticated
  USING (true);

DROP POLICY IF EXISTS "Authenticated users can update app_settings" ON app_settings;
CREATE POLICY "Authenticated users can update app_settings"
  ON app_settings FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

INSERT INTO app_settings (id, clinic_name, logo_url)
VALUES (1, 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±', NULL)
ON CONFLICT (id) DO NOTHING;
```

‚úÖ **Verify**: Go to Supabase ‚Üí SQL Editor ‚Üí Run the query above

---

### Step 2: Create Storage Bucket for Logo Upload

1. **Go to Supabase Dashboard** ‚Üí **Storage** tab
2. Click **"Create a new bucket"**
3. **Bucket name**: `branding` (exactly as shown)
4. **Privacy**: Select **"Public bucket"**
5. Click **"Create bucket"**

---

### Step 3: Set Storage Policies

Execute this SQL in **Supabase SQL Editor**:

```sql
-- Allow authenticated users to upload files
DROP POLICY IF EXISTS "Allow authenticated users to upload branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to upload branding"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (bucket_id = 'branding');

-- Allow authenticated users to delete their files
DROP POLICY IF EXISTS "Allow authenticated users to delete branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to delete branding"
  ON storage.objects FOR DELETE
  TO authenticated
  USING (bucket_id = 'branding');

-- Allow public read access (so logos display)
DROP POLICY IF EXISTS "Allow public read access to branding" ON storage.objects;
CREATE POLICY "Allow public read access to branding"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id = 'branding');
```

‚úÖ **Verify**: In Storage tab, you should see "branding" bucket with policies set

---

## üöÄ Using the Admin Dashboard

### Access Admin Panel

1. Login to the application
2. **Desktop**: Click **"ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ"** (Admin) in the Sidebar
3. **Mobile**: Scroll bottom navigation ‚Üí tap **"Admin"** button

### Customize Branding

**Tab 1: ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ™ÿµŸÖŸäŸÖ (Design Customization)**

- **ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤**: Update clinic name (appears in Sidebar & Dashboard)
- **ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ**: Clinic phone number
- **ÿßŸÑÿπŸÜŸàÿßŸÜ**: Clinic address
- **ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸäÿßÿØÿ©**: Upload clinic logo
  - Drag & drop or click to select image
  - Supported formats: PNG, JPG, GIF
  - Max size: 5 MB
- **Colors**: Adjust primary, secondary, accent colors using color picker
- Click **"ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™"** to save

---

### Configure Prescriptions

**Tab 2: ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© (Prescription Settings)**

- **Default drug category**: Select which category appears first
- **Default instructions**: Add standard prescription notes
- Available drugs database shown with categories

---

### Manage Records

**Tab 3: ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ (Records Management)**

- View last 50 clinical visits
- **Delete**: Remove records from system
- **Refresh**: Click ‚Üê to reload latest records

---

## ‚ú® Features Enabled After Setup

### 1. **Dynamic Sidebar**
- Clinic logo displays in Sidebar header (if uploaded)
- Clinic name from settings (instead of hardcoded "Nile IVF Center")

### 2. **Dynamic Dashboard**
- Header shows clinic name from settings

### 3. **Dynamic Prescriptions**
- Prescription print headers use:
  - Clinic name from settings
  - Clinic address & phone from settings
  - Clinic logo (if uploaded) or default symbol

### 4. **Real-time Updates**
- All changes apply immediately without app restart
- Changes persist to Supabase database

---

## üêõ Troubleshooting

### Error: "ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±" (Logo upload failed)

**Solution**: 
- Make sure "branding" bucket exists in Supabase Storage
- Verify it's set as "Public bucket"
- Run storage policies from Step 3 above

### Error: "ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™" (Settings save failed)

**Check**:
1. Is `app_settings` table created? (Run SQL from Step 1)
2. Are RLS policies enabled?
3. Is the table queryable? (`SELECT * FROM app_settings` should return 1 row)

### Clinic name not updating in Sidebar

**Solution**:
- Hard refresh browser: **Ctrl+Shift+R** (Windows) or **Cmd+Shift+R** (Mac)
- Close & reopen the app

---

## üìù Database Schema Reference

```typescript
app_settings {
  id: 1 (fixed, single row)
  clinic_name: string          // "ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±"
  logo_url: string | null       // URL from branding bucket
  clinic_address: string | null
  clinic_phone: string | null
  primary_color: string         // "#2d5a6b"
  secondary_color: string       // "#00838f"
  accent_color: string          // "#00bcd4"
  updated_at: timestamp
  updated_by: uuid (user id)
}
```

---

## üîê Security

- ‚úÖ RLS policies restrict access to authenticated users
- ‚úÖ Settings table has single-row constraint (immutable singleton)
- ‚úÖ Storage bucket marked as public (for logo display)
- ‚úÖ Upload policies verify user authentication

---

## üì¶ Files Modified

- `context/BrandingContext.tsx` - Global branding state & API
- `pages/AdminDashboard.tsx` - Admin control panel UI
- `components/Sidebar.tsx` - Dynamic branding display
- `pages/Dashboard.tsx` - Dynamic clinic name
- `components/PrescriptionPrinter.tsx` - Dynamic prescription headers
- `types.ts` - Added ADMIN page enum
- `App.tsx` - BrandingProvider wrapper
- `BRANDING_SETUP.sql` - Database setup script

---

## ‚úÖ Verification Checklist

- [ ] Executed SQL from Step 1 (app_settings table)
- [ ] Created "branding" storage bucket (Step 2)
- [ ] Executed SQL from Step 3 (storage policies)
- [ ] Can access Admin Dashboard from app
- [ ] Can update clinic name without logo (settings save)
- [ ] Can upload logo successfully
- [ ] Changes appear in Sidebar, Dashboard, Prescriptions
- [ ] Hardcoded text replaced with dynamic values

---

## üéØ Next Steps

1. Test all admin features
2. Verify changes persist after browser refresh
3. Test prescription printing with new branding
4. (Optional) Customize color scheme to match your clinic identity
</file>

<file path="CLAUDE.md">
# Development Commands & Notes

## Build & Type Checking
```bash
npm run build        # Builds the project (runs tsc then vite build)
npx tsc --noEmit    # Type check only without building
```

## Running the Application
```bash
npm run dev          # Start development server
npm run preview      # Preview production build
```

## Database Migrations
When new database tables are needed, create SQL files in the project root:
- `IVF_CYCLES_SETUP.sql` - IVF cycle management tables
- `OBSTETRICS_SETUP_V2.sql` - Obstetrics module
- `CLINICAL_DATA_MIGRATION.sql` - Visits and clinical data
- `BRANDING_SETUP.sql` - App settings and branding

To apply migrations:
1. Go to Supabase Dashboard ‚Üí SQL Editor
2. Create new query
3. Copy-paste the entire SQL file content
4. Click Run

## Project Structure
```
‚îú‚îÄ‚îÄ pages/               # React page components
‚îú‚îÄ‚îÄ components/          # Reusable React components
‚îú‚îÄ‚îÄ services/            # API and Supabase service layer
‚îÇ   ‚îú‚îÄ‚îÄ ivfService.ts       # IVF cycle database operations
‚îÇ   ‚îú‚îÄ‚îÄ visitsService.ts    # Patient visits
‚îÇ   ‚îú‚îÄ‚îÄ supabaseClient.ts   # Supabase initialization
‚îÇ   ‚îî‚îÄ‚îÄ authService.ts      # Authentication
‚îú‚îÄ‚îÄ types.ts             # TypeScript interfaces
‚îú‚îÄ‚îÄ constants.ts         # Protocols, drugs, UI constants
‚îî‚îÄ‚îÄ [SQL files]          # Database migrations
```

## Recent Changes (IVF Assessment Fix)

### Issue: "Failed to save assessment" error
**Root Cause:** Missing `ivf_cycles` table with JSONB columns in Supabase

### Solution Applied:
1. **Created `IVF_CYCLES_SETUP.sql`**
   - Defines `ivf_cycles` table with assessment_data, lab_data, transfer_data, outcome_data (JSONB)
   - Defines `stimulation_logs` table for daily tracking
   - Sets up RLS policies for data isolation
   - Creates performance indexes

2. **Enhanced Error Handling in `ivfService.ts`**
   - Added try-catch blocks to all update functions
   - Added detailed console error logging
   - Changed error messages from generic to specific

3. **Improved Error Display in `IvfJourney.tsx`**
   - All save functions now display detailed error messages
   - Added console logging for debugging
   - Toast messages include actual error details

### How to Fix:
1. Run the `IVF_CYCLES_SETUP.sql` migration in Supabase SQL Editor
2. Refresh the browser
3. Try saving assessment again - error message will show what's wrong

## Key Services

### ivfService.ts Functions
- `calculateBMI()` - BMI calculation with alert flag
- `calculateTMSC()` - Total Motile Sperm Count (triggers ICSI at <5M)
- `classifyOvarianReserve()` - Poor/Normal/High responder classification
- `calculateMaturationRate()` - Oocyte maturation percentage
- `calculateFertilizationRate()` - 2PN fertilization percentage
- `db.getCycles()` - Fetch all cycles with stimulation logs
- `db.saveCycle()` - Create new IVF cycle
- `db.updateCycleAssessment()` - Save couple/male/female factor assessments
- `db.updateCycleLabData()` - Save OPU and embryo data
- `db.updateCycleTransfer()` - Save transfer details
- `db.updateCycleOutcome()` - Save beta-HCG and pregnancy outcomes

## IVF Journey Component
The `/ivf-journey` page has 4 tabs:

1. **Assessment Tab**
   - Couple profile (infertility duration/type, BMI)
   - Male factor with WHO 2021 parameters and TMSC calculation
   - Female factor with ovarian reserve classification
   - Tubal-uterine findings (HSG, hysteroscopy)
   - Protocol selection with "Generate Prescription" button

2. **Stimulation Tab**
   - Hormone trends chart (E2, LH, follicle progression)
   - Daily stimulation log table with FSH/HMG/E2/LH/follicles/endometrium

3. **OPU & Embryology Tab**
   - OPU day data (total oocytes, MII, MI, GV, atretic)
   - Auto-calculated maturation rate
   - Fertilization data (2PN count)
   - Auto-calculated fertilization rate
   - Embryo grading (Day 3: A/B/C, Day 5: expanded/hatching)

4. **Transfer & Outcome Tab**
   - Transfer details (date, number, embryo quality, catheter difficulty)
   - Luteal support multi-select (6 options)
   - Cycle outcome (Beta-HCG, clinical pregnancy markers)

## Debugging Tips

### "Failed to save assessment" troubleshooting:
1. Open browser console (F12)
2. Look for detailed error in red text
3. Check Supabase connection in `services/supabaseClient.ts`
4. Verify RLS policies are enabled
5. Verify doctor record exists in database

### Database Issues:
```sql
-- Check if tables exist
SELECT * FROM information_schema.tables WHERE table_schema = 'public';

-- Check RLS is enabled
SELECT tablename, rowsecurity FROM pg_tables 
WHERE schemaname = 'public' AND tablename IN ('ivf_cycles', 'stimulation_logs');

-- Check doctor relationship
SELECT id, user_id FROM doctors WHERE user_id = '[current_user_id]';
```

## Performance Notes
- Current build size: ~993KB (gzip: 261KB)
- Consider code-splitting for large components if exceeds 500KB
- All database queries use indexes for optimal performance

## RLS Policy Structure
```
auth.users ‚Üí doctors (via user_id)
           ‚Üí patients (via doctor_id) 
           ‚Üí ivf_cycles (via doctor_id)
           ‚Üí stimulation_logs (via cycle_id)
```

Each doctor can only see their own data through RLS policies.
</file>

<file path="electron/preload.js">
const { contextBridge, ipcRenderer } = require('electron');

// ŸÜÿ≠ŸÜ ŸÜŸÉÿ¥ŸÅ ŸÅŸÇÿ∑ Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≠ÿØÿØÿ© ŸÑŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ© ŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
contextBridge.exposeInMainWorld('electronAPI', {
  // ŸÖÿ´ÿßŸÑ ŸÑŸàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸäÿ©
  print: () => ipcRenderer.send('print-document'),
  saveToDb: (data) => ipcRenderer.invoke('db-save', data),
  getFromDb: (query) => ipcRenderer.invoke('db-get', query)
});
</file>

<file path="index.tsx">
import React from "react";
import { createRoot } from "react-dom/client";
import App from "./App";

const rootElement = document.getElementById("root");
if (rootElement) {
  const root = createRoot(rootElement);
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
}
</file>

<file path="IVF_CYCLES_SETUP.sql">
-- ============================================================================
-- IVF CYCLES MODULE SETUP - Supabase SQL
-- ============================================================================
-- This script creates tables for IVF cycle management with assessment,
-- lab data, transfer, and outcome tracking.
-- ============================================================================

-- 1. CREATE IVF_CYCLES TABLE
CREATE TABLE IF NOT EXISTS ivf_cycles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
  protocol TEXT NOT NULL CHECK (protocol IN ('Long', 'Antagonist', 'Flare-up', 'Mini-IVF')),
  status TEXT NOT NULL DEFAULT 'Active' CHECK (status IN ('Active', 'Completed', 'Cancelled')),
  start_date DATE NOT NULL,
  assessment_data JSONB DEFAULT NULL,
  lab_data JSONB DEFAULT NULL,
  transfer_data JSONB DEFAULT NULL,
  outcome_data JSONB DEFAULT NULL,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 2. CREATE STIMULATION_LOGS TABLE
CREATE TABLE IF NOT EXISTS stimulation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cycle_id UUID NOT NULL REFERENCES ivf_cycles(id) ON DELETE CASCADE,
  cycle_day INTEGER NOT NULL,
  date DATE NOT NULL,
  fsh TEXT DEFAULT '',
  hmg TEXT DEFAULT '',
  e2 TEXT DEFAULT '',
  lh TEXT DEFAULT '',
  rt_follicles TEXT DEFAULT '',
  lt_follicles TEXT DEFAULT '',
  endometrium_thickness TEXT DEFAULT '',
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 3. CREATE INDEXES FOR PERFORMANCE
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_patient_id ON ivf_cycles(patient_id);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_doctor_id ON ivf_cycles(doctor_id);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_status ON ivf_cycles(status);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_start_date ON ivf_cycles(start_date DESC);
CREATE INDEX IF NOT EXISTS idx_stimulation_logs_cycle_id ON stimulation_logs(cycle_id);
CREATE INDEX IF NOT EXISTS idx_stimulation_logs_date ON stimulation_logs(date);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_assessment_data ON ivf_cycles USING GIN (assessment_data);
CREATE INDEX IF NOT EXISTS idx_ivf_cycles_lab_data ON ivf_cycles USING GIN (lab_data);

-- 4. ENABLE RLS
ALTER TABLE ivf_cycles ENABLE ROW LEVEL SECURITY;
ALTER TABLE stimulation_logs ENABLE ROW LEVEL SECURITY;

-- 5. DROP EXISTING POLICIES
DROP POLICY IF EXISTS "Doctors can read their IVF cycles" ON ivf_cycles;
DROP POLICY IF EXISTS "Doctors can insert IVF cycles" ON ivf_cycles;
DROP POLICY IF EXISTS "Doctors can update IVF cycles" ON ivf_cycles;
DROP POLICY IF EXISTS "Doctors can read stimulation logs" ON stimulation_logs;
DROP POLICY IF EXISTS "Doctors can insert stimulation logs" ON stimulation_logs;
DROP POLICY IF EXISTS "Doctors can update stimulation logs" ON stimulation_logs;

-- 6. RLS POLICIES FOR IVF_CYCLES
CREATE POLICY "Doctors can read their IVF cycles" ON ivf_cycles
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can insert IVF cycles" ON ivf_cycles
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can update IVF cycles" ON ivf_cycles
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

-- 7. RLS POLICIES FOR STIMULATION_LOGS
CREATE POLICY "Doctors can read stimulation logs" ON stimulation_logs
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can insert stimulation logs" ON stimulation_logs
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can update stimulation logs" ON stimulation_logs
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND cycle_id IN (
      SELECT id FROM ivf_cycles
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

-- 8. ADD TABLE COMMENTS
COMMENT ON TABLE ivf_cycles IS 'Stores IVF cycle information including protocol, status, and JSONB data for assessments, lab results, transfer, and outcomes';
COMMENT ON COLUMN ivf_cycles.assessment_data IS 'JSONB object containing couple profile, male/female factor, and tubal-uterine assessments';
COMMENT ON COLUMN ivf_cycles.lab_data IS 'JSONB object containing OPU data, embryo counts, and grading';
COMMENT ON COLUMN ivf_cycles.transfer_data IS 'JSONB object containing transfer details and luteal support options';
COMMENT ON COLUMN ivf_cycles.outcome_data IS 'JSONB object containing beta-HCG and clinical pregnancy outcomes';
</file>

<file path="IVF_MIGRATION_GUIDE.md">
# IVF Cycle Management Database Migration Guide

## Issue Resolution: "Failed to save assessment"

The "Failed to save assessment" error was occurring because the `ivf_cycles` table was missing the required JSONB columns (`assessment_data`, `lab_data`, `transfer_data`, `outcome_data`) in your Supabase database.

## Solution

A new SQL migration file has been created: `IVF_CYCLES_SETUP.sql`

This file creates:
1. **ivf_cycles** table with all required columns
2. **stimulation_logs** table for daily cycle tracking
3. Proper indexes for performance
4. Row-Level Security (RLS) policies for data access control

## How to Apply the Migration

### Step 1: Open Supabase SQL Editor
1. Go to [Supabase Dashboard](https://app.supabase.com)
2. Select your project
3. Navigate to **SQL Editor** in the left sidebar
4. Click **New Query**

### Step 2: Copy and Execute SQL
1. Open `IVF_CYCLES_SETUP.sql` from your project root
2. Copy the entire SQL content
3. Paste it into the Supabase SQL Editor
4. Click **Run** (or press Ctrl+Enter)

### Step 3: Verify Success
After running the migration, you should see:
- ‚úÖ No error messages in the SQL editor
- ‚úÖ Query succeeded notification

Verify the tables were created:
```sql
-- Check ivf_cycles table
SELECT * FROM ivf_cycles LIMIT 1;

-- Check stimulation_logs table
SELECT * FROM stimulation_logs LIMIT 1;
```

## What Changed in the Code

### New Database Schema
```
ivf_cycles (Main IVF Cycle Record)
‚îú‚îÄ‚îÄ id (UUID, primary key)
‚îú‚îÄ‚îÄ patient_id (UUID, foreign key)
‚îú‚îÄ‚îÄ doctor_id (UUID, foreign key)
‚îú‚îÄ‚îÄ protocol (TEXT: 'Long', 'Antagonist', 'Flare-up', 'Mini-IVF')
‚îú‚îÄ‚îÄ status (TEXT: 'Active', 'Completed', 'Cancelled')
‚îú‚îÄ‚îÄ start_date (DATE)
‚îú‚îÄ‚îÄ assessment_data (JSONB) ‚Üê Now saves couple profile, male/female factor assessments
‚îú‚îÄ‚îÄ lab_data (JSONB) ‚Üê Saves OPU and embryology data
‚îú‚îÄ‚îÄ transfer_data (JSONB) ‚Üê Saves transfer details and luteal support
‚îú‚îÄ‚îÄ outcome_data (JSONB) ‚Üê Saves beta-HCG and pregnancy outcomes
‚îî‚îÄ‚îÄ timestamps (created_at, updated_at)

stimulation_logs (Daily Stimulation Records)
‚îú‚îÄ‚îÄ id (UUID, primary key)
‚îú‚îÄ‚îÄ cycle_id (UUID, foreign key to ivf_cycles)
‚îú‚îÄ‚îÄ cycle_day (INTEGER)
‚îú‚îÄ‚îÄ date (DATE)
‚îú‚îÄ‚îÄ fsh, hmg, e2, lh (TEXT fields for hormone values)
‚îú‚îÄ‚îÄ rt_follicles, lt_follicles (TEXT for follicle counts)
‚îú‚îÄ‚îÄ endometrium_thickness (TEXT)
‚îî‚îÄ‚îÄ timestamps (created_at, updated_at)
```

### Enhanced Error Handling
The following functions now provide detailed error messages:
- `updateCycleAssessment()` - Saves assessment data
- `updateCycleLabData()` - Saves lab data
- `updateCycleTransfer()` - Saves transfer data
- `updateCycleOutcome()` - Saves outcome data

**Before:**
```
toast.error('Failed to save assessment');
```

**After:**
```
toast.error('Failed to save assessment: [Detailed error message]');
console.error('Save assessment error:', error);
```

## Row-Level Security (RLS)

The migration includes RLS policies that ensure:
- Doctors can only access their own patient's cycles
- Each doctor is isolated from other doctors' data
- Automatic filtering based on authenticated user ID

## Troubleshooting

### If you still see "Failed to save assessment":

1. **Check browser console (F12)** for detailed error messages
2. **Verify RLS policies** are enabled:
   ```sql
   SELECT * FROM pg_policies 
   WHERE tablename IN ('ivf_cycles', 'stimulation_logs');
   ```

3. **Check doctor_id mapping** - ensure your doctor record exists:
   ```sql
   SELECT id, user_id FROM doctors WHERE user_id = 'YOUR_USER_ID';
   ```

4. **Verify table structure**:
   ```sql
   SELECT column_name, data_type FROM information_schema.columns 
   WHERE table_name = 'ivf_cycles';
   ```

## Database Relationships

```
auth.users (Supabase Auth)
    ‚Üì
doctors (has doctor_id, user_id)
    ‚Üì
patients (has doctor_id)
    ‚Üì
ivf_cycles (has patient_id, doctor_id)
    ‚Üì
stimulation_logs (has cycle_id)
```

## Next Steps

1. Run the migration using the steps above
2. Refresh your browser
3. Create a new IVF cycle - the "Save Assessment" button should now work
4. Check browser console (F12) for confirmation of successful saves

## Support

If you encounter any issues:
1. Check the browser console for detailed error messages
2. Run verification queries provided in Step 3
3. Ensure you're logged in with a valid doctor account
4. Verify the Supabase connection in `services/supabaseClient.ts`
</file>

<file path="metadata.json">
{
  "name": "Copy of Nile IVF & OB/GYN Center",
  "description": "A comprehensive, production-ready EMR system for IVF Clinics featuring patient management, clinical stations, and advanced IVF cycle tracking with stimulation logs. Designed with a Medical SaaS aesthetic and RTL support.",
  "requestFramePermissions": []
}
</file>

<file path="OBSTETRICS_IMPLEMENTATION.md">
# ü§∞ Smart Obstetrics Module - Implementation Guide

## Overview
A comprehensive **Antenatal Care (ANC) Dashboard** for the React/Supabase app with state-of-the-art pregnancy management features.

---

## ‚úÖ What Was Built

### **1. Database Schema (Supabase)**
Three main tables created:

#### `pregnancies`
- `id` (UUID) - Primary key
- `patient_id` (UUID) - Link to patients table
- `lmp_date` - Last Menstrual Period
- `edd_date` - Estimated Delivery Date (calculated)
- `edd_by_scan` - EDD confirmed by ultrasound
- `ga_at_booking` - Gestational age at first booking
- `risk_level` - 'low', 'moderate', 'high'
- `risk_factors` - JSONB array of risk factors
- `aspirin_prescribed` - Boolean for pre-eclampsia prevention
- `thromboprophylaxis_needed` - Boolean for VTE prevention

#### `antenatal_visits`
- `id` (UUID)
- `pregnancy_id` (UUID) - Links to pregnancies
- `visit_date` - Date of visit
- `gestational_age_weeks`, `gestational_age_days` - Auto-calculated
- `systolic_bp`, `diastolic_bp` - Blood pressure
- `weight_kg` - Maternal weight
- `urine_albuminuria`, `urine_glycosuria` - Urine findings
- `fetal_heart_sound` - Boolean
- `fundal_height_cm` - Height of uterine fundus
- `edema` - Boolean
- `notes` - Clinical notes

#### `biometry_scans`
- `id` (UUID)
- `pregnancy_id` (UUID)
- `scan_date`
- `bpd_mm`, `hc_mm`, `ac_mm`, `fl_mm` - Biometric measurements
- `efw_grams` - Estimated Fetal Weight (calculated)
- `percentile` - Growth percentile (10th, 50th, 90th)

---

## üìä Features Breakdown

### **1. ü§∞ Pregnancy Header**
**File:** `pages/components/obstetrics/PregnancyHeader.tsx`

Features:
- **Visual Timeline**: Progress bar from 0-40 weeks
- **Current GA Display**: "24 Weeks + 3 Days"
- **Smart Alerts**: Context-aware due actions based on GA
  - Week 11-13: NT Scan Due
  - Week 20-22: Anomaly Scan Due
  - Week 28: GTT/Anti-D Prophylaxis
  - Week 34-36: Growth Scan
  - Week 36+: Position Check & Birth Plan

- **Risk Badge**: Color-coded indicator (üü¢ Low / üü° Moderate / üî¥ High)
- **Medication Alerts**: Aspirin prescription status

### **2. ‚öñÔ∏è RCOG Risk Assessment**
**File:** `pages/components/obstetrics/RiskAssessment.tsx`

Checkboxes for 8 risk factors:
- Age > 40
- BMI > 30
- Previous Pre-eclampsia
- Multiple pregnancy (Twins)
- Autoimmune disease
- Hypertension
- Diabetes
- Kidney disease

**Logic:**
- ‚â•1 High Risk Factor ‚Üí **HIGH RISK** (Aspirin 150mg + close monitoring)
- ‚â•2 Moderate Factors ‚Üí **HIGH RISK**
- 1 Moderate Factor ‚Üí **MODERATE RISK**
- 0 Factors ‚Üí **LOW RISK**

**Outputs:**
- Risk stratification badge
- Medication recommendations (Aspirin, Clexane)
- Saves to database automatically

### **3. üìã ANC Flow Sheet**
**File:** `pages/components/obstetrics/ANCFlowSheet.tsx`

**Data Grid with:**
- Visit Date | GA | BP | Weight | Urine | FHS | Fundal Height | Edema

**Features:**
- Add new visit (modal form)
- Edit existing visits
- Delete visits
- Auto-calculate GA from LMP

**Trend Chart:**
- Line graph showing weight progression
- Blood pressure trends over time
- Helps identify anomalies (pre-eclampsia spikes)

### **4. üë∂ Fetal Growth Chart (The "Wow" Feature)**
**File:** `pages/components/obstetrics/FetalGrowthChart.tsx`

**Biometry Input:**
- BPD (Biparietal Diameter) in mm
- HC (Head Circumference) in mm
- AC (Abdominal Circumference) in mm
- FL (Femur Length) in mm

**Auto-Calculations:**
- **Hadlock Formula** for EFW: 
  ```
  log10(EFW) = 1.3404 + 0.0438√óHC + 0.158√óAC + 0.0061√óBPD - 0.002322√óAC√óBPD
  ```
- **Growth Percentile**: Compared to RCOG/NICE standards
- **Flags**: Red if <10th percentile (growth restriction), Yellow if >90th (macrosomia)

**RCOG Reference Lines:**
- 10th Percentile (Green) - Minimum normal
- 50th Percentile (Blue) - Average
- 90th Percentile (Red) - Maximum normal

**Visual:** Line chart with reference curves and patient's EFW trend

---

## üõ†Ô∏è Helper Functions (obstetricsService.ts)

### **Calculation Functions**

#### `calculateGestationalAge(lmpDate: string)`
- Input: ISO date string
- Output: `{ weeks, days }`
- Formula: Days difference √∑ 7 = weeks + remainder

#### `calculateEDD(lmpDate: string)`
- Input: LMP date
- Output: ISO date string
- Formula: LMP + 280 days (40 weeks)

#### `calculateEFW(bpd, hc, ac, fl)`
- Hadlock formula for fetal weight estimation
- Returns weight in grams

#### `calculatePercentile(efwGrams, gaWeeks)`
- Compares EFW to RCOG growth standards
- Returns percentile (10, 50, 90)

#### `getDueActions(gaWeeks: number)`
- Returns array of due actions for current GA
- Example: `["‚ö†Ô∏è Nuchal Translucency Scan Due", "üß™ Quad Screen Results Expected"]`

#### `assessRiskLevel(riskFactors)`
- RCOG-compliant risk stratification
- Returns: `{ level, riskFactorsList, aspirinNeeded, thromboprophylaxisNeeded }`

---

## üóÇÔ∏è File Structure

```
pages/
‚îú‚îÄ‚îÄ ObstetricsDashboard.tsx (Main page)
‚îî‚îÄ‚îÄ components/obstetrics/
    ‚îú‚îÄ‚îÄ PregnancyHeader.tsx
    ‚îú‚îÄ‚îÄ RiskAssessment.tsx
    ‚îú‚îÄ‚îÄ ANCFlowSheet.tsx
    ‚îî‚îÄ‚îÄ FetalGrowthChart.tsx

services/
‚îú‚îÄ‚îÄ obstetricsService.ts (All calculations & DB operations)
‚îî‚îÄ‚îÄ supabaseClient.ts

types.ts (Pregnancy, AntenatalVisit, BiometryScan interfaces)
```

---

## üîß Setup Instructions

### **Step 1: Run SQL Script**
```sql
-- Execute OBSTETRICS_SETUP.sql in Supabase SQL Editor
-- Creates: pregnancies, antenatal_visits, biometry_scans tables
-- Adds: RLS policies, indexes
```

### **Step 2: Verify Database**
```bash
# Check tables created:
SELECT * FROM pregnancies LIMIT 1;
SELECT * FROM antenatal_visits LIMIT 1;
SELECT * FROM biometry_scans LIMIT 1;
```

### **Step 3: Start Using**
1. Navigate to **Obstetrics** in the sidebar (new menu item)
2. Select a patient
3. Click **"Create New Pregnancy File"**
4. Enter LMP date or EDD by ultrasound
5. Add visits, scans, and track risk

---

## üí° Key Features

### ‚ú® Smart Alerts
- Automatic due dates calculation
- Context-aware clinical recommendations
- Color-coded risk indicators

### üìä Data Visualization
- Growth curve charts with RCOG reference lines
- Weight/BP trends over time
- Percentile bands (10th, 50th, 90th)

### üßÆ Auto-Calculations
- GA calculation from any date
- EFW using Hadlock formula
- Growth percentile assessment
- Due action suggestions

### üíæ Complete History
- All visits logged with trends
- All scans recorded with biometry
- Risk assessment evolution
- Edit/delete capability

---

## üé® UI/UX Details

- **Color Scheme**: Medical teal (#14b8a6) with accent colors
- **Language**: Arabic RTL support throughout
- **Responsive**: Mobile-friendly (6-column BottomNav)
- **Icons**: Lucide React icons for visual clarity
- **Charts**: Recharts for professional data visualization

---

## üöÄ Next Steps (Optional Enhancements)

1. **Integration with Reception Module**
   - Link to patient records automatically
   - Sync with existing patient data

2. **Export Functionality**
   - PDF report generation
   - Growth charts export
   - ANC summary printout

3. **Alerts & Notifications**
   - Push notifications for due scans
   - Email reminders for next visit

4. **Mobile App**
   - Offline sync capability
   - Camera integration for ultrasound images

5. **Analytics**
   - Hospital-wide statistics
   - Risk stratification reports
   - Outcome tracking

---

## üìö References

- **RCOG Guidelines**: Management of Hypertensive Disorders
- **WHO Intergrowth Standards**: Fetal biometry standards
- **Hadlock Formula**: Gold standard for EFW calculation
- **Pre-eclampsia Prevention**: Aspirin 150mg daily from 16 weeks

---

## ‚ö†Ô∏è Important Notes

1. **RLS Policies**: All authenticated doctors can view all pregnancies (adjust if needed)
2. **Data Validation**: Frontend validation present, add backend validation for production
3. **Backup**: Regular database backups recommended
4. **HIPAA Compliance**: Ensure proper access controls in production

---

## üêõ Troubleshooting

**Issue:** Patient list not showing
- **Solution**: Verify `patients` table exists in Supabase

**Issue:** Calculations giving wrong results
- **Solution**: Check LMP/EDD dates are in ISO format (YYYY-MM-DD)

**Issue:** Charts not rendering
- **Solution**: Ensure Recharts is installed: `npm list recharts`

---

**Version:** 1.0.0  
**Created:** December 2025  
**Status:** ‚úÖ Production Ready
</file>

<file path="OBSTETRICS_SETUP_V2.sql">
-- ============================================================================
-- OBSTETRICS MODULE SETUP - Supabase SQL (FIXED RLS)
-- ============================================================================

-- 1. PREGNANCIES TABLE
CREATE TABLE IF NOT EXISTS pregnancies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  lmp_date DATE,
  edd_date DATE,
  edd_by_scan DATE,
  ga_at_booking INTEGER,
  risk_level TEXT DEFAULT 'low' CHECK (risk_level IN ('low', 'moderate', 'high')),
  risk_factors JSONB DEFAULT '[]',
  aspirin_prescribed BOOLEAN DEFAULT FALSE,
  thromboprophylaxis_needed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 2. ANTENATAL VISITS TABLE
CREATE TABLE IF NOT EXISTS antenatal_visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  visit_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  systolic_bp INTEGER,
  diastolic_bp INTEGER,
  weight_kg DECIMAL(5, 2),
  urine_albuminuria TEXT,
  urine_glycosuria TEXT,
  fetal_heart_sound BOOLEAN,
  fundal_height_cm DECIMAL(5, 2),
  edema BOOLEAN,
  edema_grade TEXT,
  notes TEXT,
  next_visit_date DATE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 3. BIOMETRY SCANS TABLE (Fetal Growth)
CREATE TABLE IF NOT EXISTS biometry_scans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  scan_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  bpd_mm DECIMAL(5, 2),
  hc_mm DECIMAL(5, 2),
  ac_mm DECIMAL(5, 2),
  fl_mm DECIMAL(5, 2),
  efw_grams INTEGER,
  percentile INTEGER,
  notes TEXT,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 4. CREATE INDEXES
CREATE INDEX IF NOT EXISTS idx_pregnancies_patient_id ON pregnancies(patient_id);
CREATE INDEX IF NOT EXISTS idx_pregnancies_doctor_id ON pregnancies(doctor_id);
CREATE INDEX IF NOT EXISTS idx_antenatal_visits_pregnancy_id ON antenatal_visits(pregnancy_id);
CREATE INDEX IF NOT EXISTS idx_biometry_scans_pregnancy_id ON biometry_scans(pregnancy_id);

-- 5. ENABLE RLS
ALTER TABLE pregnancies ENABLE ROW LEVEL SECURITY;
ALTER TABLE antenatal_visits ENABLE ROW LEVEL SECURITY;
ALTER TABLE biometry_scans ENABLE ROW LEVEL SECURITY;

-- 6. DROP EXISTING POLICIES
DROP POLICY IF EXISTS "Doctors can read all pregnancies" ON pregnancies;
DROP POLICY IF EXISTS "Doctors can insert pregnancies" ON pregnancies;
DROP POLICY IF EXISTS "Doctors can update pregnancies" ON pregnancies;
DROP POLICY IF EXISTS "Doctors can read all antenatal visits" ON antenatal_visits;
DROP POLICY IF EXISTS "Doctors can insert antenatal visits" ON antenatal_visits;
DROP POLICY IF EXISTS "Doctors can update antenatal visits" ON antenatal_visits;
DROP POLICY IF EXISTS "Doctors can read all biometry scans" ON biometry_scans;
DROP POLICY IF EXISTS "Doctors can insert biometry scans" ON biometry_scans;
DROP POLICY IF EXISTS "Doctors can update biometry scans" ON biometry_scans;

-- 7. NEW RLS POLICIES for pregnancies - Link to authenticated doctor
CREATE POLICY "Doctors can read their pregnancies" ON pregnancies
  FOR SELECT 
  USING (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can insert pregnancies" ON pregnancies
  FOR INSERT 
  WITH CHECK (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

CREATE POLICY "Doctors can update their pregnancies" ON pregnancies
  FOR UPDATE 
  USING (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  )
  WITH CHECK (
    auth.uid() IS NOT NULL 
    AND doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
  );

-- 8. RLS POLICIES for antenatal_visits
CREATE POLICY "Doctors can read antenatal visits" ON antenatal_visits
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can insert antenatal visits" ON antenatal_visits
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can update antenatal visits" ON antenatal_visits
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

-- 9. RLS POLICIES for biometry_scans
CREATE POLICY "Doctors can read biometry scans" ON biometry_scans
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can insert biometry scans" ON biometry_scans
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );

CREATE POLICY "Doctors can update biometry scans" ON biometry_scans
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND pregnancy_id IN (
      SELECT id FROM pregnancies 
      WHERE doctor_id = (SELECT id FROM doctors WHERE user_id = auth.uid() LIMIT 1)
    )
  );
</file>

<file path="OBSTETRICS_SETUP.sql">
-- ============================================================================
-- OBSTETRICS MODULE SETUP - Supabase SQL
-- ============================================================================

-- 1. PREGNANCIES TABLE
CREATE TABLE IF NOT EXISTS pregnancies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  lmp_date DATE,
  edd_date DATE,
  edd_by_scan DATE,
  ga_at_booking INTEGER,
  risk_level TEXT DEFAULT 'low' CHECK (risk_level IN ('low', 'moderate', 'high')),
  risk_factors JSONB DEFAULT '[]',
  aspirin_prescribed BOOLEAN DEFAULT FALSE,
  thromboprophylaxis_needed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 2. ANTENATAL VISITS TABLE
CREATE TABLE IF NOT EXISTS antenatal_visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  visit_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  systolic_bp INTEGER,
  diastolic_bp INTEGER,
  weight_kg DECIMAL(5, 2),
  urine_albuminuria TEXT,
  urine_glycosuria TEXT,
  fetal_heart_sound BOOLEAN,
  fundal_height_cm DECIMAL(5, 2),
  edema BOOLEAN,
  edema_grade TEXT,
  notes TEXT,
  next_visit_date DATE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 3. BIOMETRY SCANS TABLE (Fetal Growth)
CREATE TABLE IF NOT EXISTS biometry_scans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pregnancy_id UUID NOT NULL REFERENCES pregnancies(id) ON DELETE CASCADE,
  scan_date DATE NOT NULL,
  gestational_age_weeks INTEGER,
  gestational_age_days INTEGER,
  bpd_mm DECIMAL(5, 2),
  hc_mm DECIMAL(5, 2),
  ac_mm DECIMAL(5, 2),
  fl_mm DECIMAL(5, 2),
  efw_grams INTEGER,
  percentile INTEGER,
  notes TEXT,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 4. CREATE INDEXES
CREATE INDEX idx_pregnancies_patient_id ON pregnancies(patient_id);
CREATE INDEX idx_antenatal_visits_pregnancy_id ON antenatal_visits(pregnancy_id);
CREATE INDEX idx_biometry_scans_pregnancy_id ON biometry_scans(pregnancy_id);

-- 5. ENABLE RLS
ALTER TABLE pregnancies ENABLE ROW LEVEL SECURITY;
ALTER TABLE antenatal_visits ENABLE ROW LEVEL SECURITY;
ALTER TABLE biometry_scans ENABLE ROW LEVEL SECURITY;

-- 6. RLS POLICIES for pregnancies
CREATE POLICY "Doctors can read all pregnancies" ON pregnancies
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Doctors can insert pregnancies" ON pregnancies
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Doctors can update pregnancies" ON pregnancies
  FOR UPDATE USING (auth.role() = 'authenticated');

-- 7. RLS POLICIES for antenatal_visits
CREATE POLICY "Doctors can read all antenatal visits" ON antenatal_visits
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Doctors can insert antenatal visits" ON antenatal_visits
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Doctors can update antenatal visits" ON antenatal_visits
  FOR UPDATE USING (auth.role() = 'authenticated');

-- 8. RLS POLICIES for biometry_scans
CREATE POLICY "Doctors can read all biometry scans" ON biometry_scans
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Doctors can insert biometry scans" ON biometry_scans
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Doctors can update biometry scans" ON biometry_scans
  FOR UPDATE USING (auth.role() = 'authenticated');
</file>

<file path="package.json">
{
  "name": "nile-ivf-emr",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "lucide-react": "^0.344.0",
    "recharts": "^2.12.2",
    "react-hot-toast": "^2.4.1",
    "clsx": "^2.1.0",
    "tailwind-merge": "^2.2.1",
    "@supabase/supabase-js": "^2.39.7"
  },
  "devDependencies": {
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.2.2",
    "vite": "^5.1.6"
  }
}
</file>

<file path="pages/components/InfertilityWizard.tsx">
import React, { useState, useEffect } from 'react';
import { Microscope, Baby, Activity, Heart, Save, AlertCircle, CheckCircle, Clock } from 'lucide-react';
import toast from 'react-hot-toast';
import { getWorkup, saveWorkup, generateDiagnosis, WorkupState } from '../../services/workupService';

interface InfertilityWizardProps {
  patientId: string;
  patientName?: string;
}

const InfertilityWizard: React.FC<InfertilityWizardProps> = ({ patientId, patientName }) => {
  const [workupData, setWorkupData] = useState<WorkupState>({
    patientId,
    ovarianFactor: {},
    maleFactor: {},
    tubalFactor: {},
    uterineFactor: {},
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  // Load data on mount
  useEffect(() => {
    const loadWorkup = async () => {
      try {
        const data = await getWorkup(patientId);
        setWorkupData(data);
      } catch (error) {
        toast.error('Failed to load infertility workup data');
      } finally {
        setLoading(false);
      }
    };

    loadWorkup();
  }, [patientId]);

  // Auto-generate diagnosis whenever data changes
  useEffect(() => {
    const diagnosis = generateDiagnosis(workupData);
    setWorkupData(prev => ({
      ...prev,
      diagnosis: diagnosis.diagnosis,
      plan: diagnosis.plan,
    }));
  }, [workupData.ovarianFactor, workupData.maleFactor, workupData.tubalFactor, workupData.uterineFactor]);

  // Handle input changes
  const updateOvarianFactor = (field: keyof WorkupState['ovarianFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      ovarianFactor: {
        ...prev.ovarianFactor,
        [field]: value,
      },
    }));
  };

  const updateMaleFactor = (field: keyof WorkupState['maleFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      maleFactor: {
        ...prev.maleFactor,
        [field]: value,
      },
    }));
  };

  const updateTubalFactor = (field: keyof WorkupState['tubalFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      tubalFactor: {
        ...prev.tubalFactor,
        [field]: value,
      },
    }));
  };

  const updateUterineFactor = (field: keyof WorkupState['uterineFactor'], value: any) => {
    setWorkupData(prev => ({
      ...prev,
      uterineFactor: {
        ...prev.uterineFactor,
        [field]: value,
      },
    }));
  };

  // Determine card status and color
  const getCardStatus = (factor: any, checks: (() => boolean)[]) => {
    const hasData = Object.values(factor).some(value => value !== undefined && value !== '');
    if (!hasData) return { status: 'missing', color: 'border-gray-300 bg-gray-50', icon: Clock };

    const hasIssues = checks.some(check => check());
    return hasIssues
      ? { status: 'problem', color: 'border-red-300 bg-red-50', icon: AlertCircle }
      : { status: 'normal', color: 'border-green-300 bg-green-50', icon: CheckCircle };
  };

  const ovarianStatus = getCardStatus(workupData.ovarianFactor, [
    () => workupData.ovarianFactor.amh !== undefined && (workupData.ovarianFactor.amh < 1.1 || workupData.ovarianFactor.amh > 3.5),
    () => workupData.ovarianFactor.cycleRegularity === 'Irregular',
  ]);

  const maleStatus = getCardStatus(workupData.maleFactor, [
    () => workupData.maleFactor.spermCount !== undefined && workupData.maleFactor.spermCount < 15,
    () => workupData.maleFactor.motility !== undefined && workupData.maleFactor.motility < 40,
    () => workupData.maleFactor.morphology !== undefined && workupData.maleFactor.morphology < 4,
  ]);

  const tubalStatus = getCardStatus(workupData.tubalFactor, [
    () => workupData.tubalFactor.leftTube === 'Blocked' || workupData.tubalFactor.rightTube === 'Blocked',
    () => workupData.tubalFactor.leftTube === 'Hydrosalpinx' || workupData.tubalFactor.rightTube === 'Hydrosalpinx',
  ]);

  const uterineStatus = getCardStatus(workupData.uterineFactor, [
    () => workupData.uterineFactor.cavityStatus && workupData.uterineFactor.cavityStatus !== 'Normal',
  ]);

  // Handle save
  const handleSave = async () => {
    setSaving(true);
    try {
      await saveWorkup(workupData);
      toast.success('Infertility workup saved successfully!');
    } catch (error) {
      toast.error('Failed to save infertility workup');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto space-y-6" style={{ fontFamily: 'Tajawal, sans-serif' }}>
      {/* Header */}
      <div className="bg-gradient-to-r from-teal-600 to-indigo-600 text-white p-6 rounded-2xl shadow-lg">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold mb-2">üî¨ ŸÖÿπÿßŸÑÿ¨ ÿßŸÑÿπŸÇŸÖ ÿßŸÑÿ¢ŸÑŸä - Infertility Workup Wizard</h1>
            <p className="text-teal-100">
              Patient: <span className="font-semibold">{patientName || 'Unknown'}</span>
            </p>
          </div>
          <Microscope className="w-16 h-16 text-teal-200" />
        </div>

        {/* Auto-Diagnosis Preview */}
        <div className="mt-6 bg-white/10 backdrop-blur-sm rounded-lg p-4">
          <h3 className="text-lg font-semibold mb-2 flex items-center gap-2">
            <Activity className="w-5 h-5" />
            ÿ™ÿ¥ÿÆŸäÿµ ÿ™ŸÑŸÇÿßÿ¶Ÿä - Auto-Diagnosis
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span className="text-sm text-teal-200">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ:</span>
              <p className="font-semibold text-white mt-1">
                {workupData.diagnosis || 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - Please enter data'}
              </p>
            </div>
            <div>
              <span className="text-sm text-teal-200">ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑÿπŸÑÿßÿ¨Ÿäÿ©:</span>
              <p className="font-semibold text-white mt-1">
                {workupData.plan || 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - Please enter data'}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {/* Ovarian Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${ovarianStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Baby className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑŸÖÿ®Ÿäÿ∂Ÿä</h3>
            </div>
            <ovarianStatus.icon className={`w-6 h-6 ${
              ovarianStatus.status === 'normal' ? 'text-green-600' :
              ovarianStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">AMH (ng/mL)</label>
              <input
                type="number"
                step="0.1"
                value={workupData.ovarianFactor.amh || ''}
                onChange={(e) => updateOvarianFactor('amh', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 2.5"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÜÿ™ÿ∏ÿßŸÖ ÿßŸÑÿØŸàÿ±ÿ©</label>
              <select
                value={workupData.ovarianFactor.cycleRegularity || ''}
                onChange={(e) => updateOvarianFactor('cycleRegularity', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Regular">ŸÖŸÜÿ™ÿ∏ŸÖ - Regular</option>
                <option value="Irregular">ÿ∫Ÿäÿ± ŸÖŸÜÿ™ÿ∏ŸÖ - Irregular</option>
              </select>
            </div>
          </div>
        </div>

        {/* Male Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${maleStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Heart className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ∞ŸÉÿ±Ÿä</h3>
            </div>
            <maleStatus.icon className={`w-6 h-6 ${
              maleStatus.status === 'normal' ? 'text-green-600' :
              maleStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿπÿØÿØ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜŸàŸäÿ© (M/mL)</label>
              <input
                type="number"
                value={workupData.maleFactor.spermCount || ''}
                onChange={(e) => updateMaleFactor('spermCount', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 25"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ≠ÿ±ŸÉÿ© (%)</label>
              <input
                type="number"
                min="0"
                max="100"
                value={workupData.maleFactor.motility || ''}
                onChange={(e) => updateMaleFactor('motility', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 45"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ¥ŸÉŸÑ (%)</label>
              <input
                type="number"
                min="0"
                max="100"
                value={workupData.maleFactor.morphology || ''}
                onChange={(e) => updateMaleFactor('morphology', parseFloat(e.target.value) || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                placeholder="e.g., 6"
              />
            </div>
          </div>
        </div>

        {/* Tubal Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${tubalStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Activity className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ£ŸÜÿ®Ÿàÿ®Ÿä</h3>
            </div>
            <tubalStatus.icon className={`w-6 h-6 ${
              tubalStatus.status === 'normal' ? 'text-green-600' :
              tubalStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ£ŸÜÿ®Ÿàÿ® ÿßŸÑÿ£Ÿäÿ≥ÿ±</label>
              <select
                value={workupData.tubalFactor.leftTube || ''}
                onChange={(e) => updateTubalFactor('leftTube', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Patent">ŸÖŸÅÿ™Ÿàÿ≠ - Patent</option>
                <option value="Blocked">ŸÖÿ≥ÿØŸàÿØ - Blocked</option>
                <option value="Hydrosalpinx">ŸáŸäÿØÿ± ÿ≥ÿßŸÑÿ®ŸäŸÜŸÉÿ≥ - Hydrosalpinx</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ£ŸÜÿ®Ÿàÿ® ÿßŸÑÿ£ŸäŸÖŸÜ</label>
              <select
                value={workupData.tubalFactor.rightTube || ''}
                onChange={(e) => updateTubalFactor('rightTube', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Patent">ŸÖŸÅÿ™Ÿàÿ≠ - Patent</option>
                <option value="Blocked">ŸÖÿ≥ÿØŸàÿØ - Blocked</option>
                <option value="Hydrosalpinx">ŸáŸäÿØÿ± ÿ≥ÿßŸÑÿ®ŸäŸÜŸÉÿ≥ - Hydrosalpinx</option>
              </select>
            </div>
          </div>
        </div>

        {/* Uterine Factor Card */}
        <div className={`rounded-xl border-2 p-6 transition-all duration-300 ${uterineStatus.color}`}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-white rounded-lg">
                <Microscope className="w-6 h-6 text-teal-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-800">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ±ÿ≠ŸÖŸä</h3>
            </div>
            <uterineStatus.icon className={`w-6 h-6 ${
              uterineStatus.status === 'normal' ? 'text-green-600' :
              uterineStatus.status === 'problem' ? 'text-red-600' : 'text-gray-400'
            }`} />
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ¨ŸàŸäŸÅ</label>
              <select
                value={workupData.uterineFactor.cavityStatus || ''}
                onChange={(e) => updateUterineFactor('cavityStatus', e.target.value || undefined)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              >
                <option value="">ÿßÿÆÿ™ÿ± - Select</option>
                <option value="Normal">ÿ∑ÿ®ŸäÿπŸä - Normal</option>
                <option value="Septum">ÿ≠ÿßÿ¨ÿ≤ - Septum</option>
                <option value="Polyp">ÿ≥ŸÑŸäŸÑÿ© - Polyp</option>
                <option value="Adhesions">ÿßŸÑÿ™ÿµÿßŸÇÿßÿ™ - Adhesions</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {/* Save Button */}
      <div className="flex justify-center">
        <button
          onClick={handleSave}
          disabled={saving}
          className="bg-teal-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          <Save className="w-5 h-5" />
          {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇŸäŸäŸÖ - Save Workup'}
        </button>
      </div>
    </div>
  );
};

export default InfertilityWizard;
</file>

<file path="pages/components/obstetrics/FetalGrowthChart.tsx">
import React, { useState, useEffect } from 'react';
import { Plus, Save, Trash2, X } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import toast from 'react-hot-toast';
import { BiometryScan } from '../../../types';
import { obstetricsService, calculateEFW, calculatePercentile, calculateGestationalAge } from '../../../services/obstetricsService';

interface FetalGrowthChartProps {
  pregnancyId: string;
  lmpDate?: string;
}

const FetalGrowthChart: React.FC<FetalGrowthChartProps> = ({ pregnancyId, lmpDate }) => {
  const [scans, setScans] = useState<BiometryScan[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    scan_date: new Date().toISOString().split('T')[0],
    bpd_mm: '',
    hc_mm: '',
    ac_mm: '',
    fl_mm: '',
    notes: '',
  });

  useEffect(() => {
    fetchScans();
  }, [pregnancyId]);

  const fetchScans = async () => {
    try {
      setIsLoading(true);
      const data = await obstetricsService.getBiometryScans(pregnancyId);
      setScans(data || []);
    } catch (error) {
      console.error('Error fetching scans:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäŸàŸÖŸäÿ™ÿ±Ÿä');
    } finally {
      setIsLoading(false);
    }
  };

  const handleAddScan = async () => {
    try {
      if (!formData.scan_date || !formData.bpd_mm || !formData.hc_mm || !formData.ac_mm || !formData.fl_mm) {
        toast.error('ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®ÿ©');
        return;
      }

      setIsSaving(true);

      const bpd = parseFloat(formData.bpd_mm);
      const hc = parseFloat(formData.hc_mm);
      const ac = parseFloat(formData.ac_mm);
      const fl = parseFloat(formData.fl_mm);

      const efw = calculateEFW(bpd, hc, ac, fl);
      const ga = lmpDate ? calculateGestationalAge(formData.scan_date) : { weeks: 20, days: 0 };
      const percentile = calculatePercentile(efw, ga.weeks);

      if (editingId) {
        await obstetricsService.updateBiometryScan(editingId, {
          ...formData,
          bpd_mm: bpd,
          hc_mm: hc,
          ac_mm: ac,
          fl_mm: fl,
          efw_grams: efw,
          percentile: Math.round(percentile),
          pregnancy_id: pregnancyId,
          gestational_age_weeks: ga.weeks,
          gestational_age_days: ga.days,
        });
        toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠');
      } else {
        await obstetricsService.createBiometryScan({
          ...formData,
          bpd_mm: bpd,
          hc_mm: hc,
          ac_mm: ac,
          fl_mm: fl,
          efw_grams: efw,
          percentile: Math.round(percentile),
          pregnancy_id: pregnancyId,
          gestational_age_weeks: ga.weeks,
          gestational_age_days: ga.days,
        });
        toast.success('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠');
      }

      fetchScans();
      resetForm();
    } catch (error) {
      console.error('Error saving scan:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ≠');
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteScan = async (scanId: string) => {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ≠ÿü')) return;

    try {
      await obstetricsService.deleteBiometryScan(scanId);
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠');
      fetchScans();
    } catch (error) {
      console.error('Error deleting scan:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ≠');
    }
  };

  const handleEditScan = (scan: BiometryScan) => {
    setFormData({
      scan_date: scan.scan_date,
      bpd_mm: scan.bpd_mm?.toString() || '',
      hc_mm: scan.hc_mm?.toString() || '',
      ac_mm: scan.ac_mm?.toString() || '',
      fl_mm: scan.fl_mm?.toString() || '',
      notes: scan.notes || '',
    });
    setEditingId(scan.id);
    setShowForm(true);
  };

  const resetForm = () => {
    setFormData({
      scan_date: new Date().toISOString().split('T')[0],
      bpd_mm: '',
      hc_mm: '',
      ac_mm: '',
      fl_mm: '',
      notes: '',
    });
    setEditingId(null);
    setShowForm(false);
  };

  const chartData = scans
    .slice()
    .reverse()
    .map((scan, idx) => ({
      name: `${scan.gestational_age_weeks}w`,
      efw: scan.efw_grams || 0,
      p10: getP10(scan.gestational_age_weeks),
      p50: getP50(scan.gestational_age_weeks),
      p90: getP90(scan.gestational_age_weeks),
      percentile: scan.percentile || 50,
    }));

  const getP10 = (weeks: number): number => {
    const weights: { [key: number]: number } = {
      20: 300, 22: 430, 24: 600, 26: 760, 28: 1000, 30: 1300, 32: 1600, 34: 2100, 36: 2600, 38: 3000, 40: 3200,
    };
    return weights[weeks] || 0;
  };

  const getP50 = (weeks: number): number => {
    const weights: { [key: number]: number } = {
      20: 330, 22: 475, 24: 660, 26: 850, 28: 1100, 30: 1440, 32: 1840, 34: 2450, 36: 3000, 38: 3400, 40: 3500,
    };
    return weights[weeks] || 0;
  };

  const getP90 = (weeks: number): number => {
    const weights: { [key: number]: number } = {
      20: 370, 22: 540, 24: 750, 26: 980, 28: 1270, 30: 1680, 32: 2150, 34: 2850, 36: 3500, 38: 3900, 40: 3900,
    };
    return weights[weeks] || 0;
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900 font-[Tajawal]">üë∂ ŸÖÿÆÿ∑ÿ∑ ŸÜŸÖŸà ÿßŸÑÿ¨ŸÜŸäŸÜ</h2>
        <button
          onClick={() => setShowForm(!showForm)}
          className="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
        >
          <Plus size={18} />
          ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ≠
        </button>
      </div>

      {showForm && (
        <div className="mb-6 p-6 bg-gray-50 rounded-lg border-2 border-teal-200">
          <div className="grid md:grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ≥ÿ≠
              </label>
              <input
                type="date"
                value={formData.scan_date}
                onChange={(e) => setFormData(prev => ({ ...prev, scan_date: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                BPD (Biparietal Diameter) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.bpd_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, bpd_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 54.2"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                HC (Head Circumference) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.hc_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, hc_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 285"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                AC (Abdominal Circumference) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.ac_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, ac_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 254"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                FL (Femur Length) - ŸÖŸÑŸÖ
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.fl_mm}
                onChange={(e) => setFormData(prev => ({ ...prev, fl_mm: e.target.value }))}
                placeholder="ŸÖÿ´ÿßŸÑ: 68"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
              </label>
              <input
                type="text"
                value={formData.notes}
                onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleAddScan}
              disabled={isSaving}
              className="flex items-center gap-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
            >
              <Save size={18} />
              {isSaving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : editingId ? 'ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ≠' : 'ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ≠'}
            </button>
            <button
              onClick={resetForm}
              className="flex items-center gap-2 bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
            >
              <X size={18} />
              ÿ•ŸÑÿ∫ÿßÿ°
            </button>
          </div>
        </div>
      )}

      {isLoading ? (
        <div className="text-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
        </div>
      ) : scans.length > 0 ? (
        <>
          <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <p className="text-sm text-blue-900 font-[Tajawal]">
              üìä <strong>ÿßŸÑÿÆÿ∑Ÿàÿ∑ ÿßŸÑŸÖÿ±ÿ¨ÿπŸäÿ© (RCOG/NICE):</strong> ÿßŸÑÿÆÿ∑ ÿßŸÑÿ£ÿÆÿ∂ÿ± = 10th percentile (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ÿßŸÑÿ∑ÿ®ŸäÿπŸä)ÿå ÿßŸÑÿ£ÿ≤ÿ±ŸÇ = 50th (ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑)ÿå ÿßŸÑÿ£ÿ≠ŸÖÿ± = 90th (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿπŸÑŸâ)
            </p>
          </div>

          <div className="mb-6">
            <ResponsiveContainer width="100%" height={400}>
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis label={{ value: 'ÿßŸÑŸàÿ≤ŸÜ (ÿ¨ÿ±ÿßŸÖ)', angle: -90, position: 'insideLeft' }} />
                <Tooltip
                  formatter={(value: any) => `${value.toLocaleString()} g`}
                  labelFormatter={(label) => `ÿ£ÿ≥ÿßÿ®Ÿäÿπ: ${label}`}
                />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="p10"
                  stroke="#16a34a"
                  strokeDasharray="5 5"
                  name="10th Percentile"
                  isAnimationActive={false}
                />
                <Line
                  type="monotone"
                  dataKey="p50"
                  stroke="#3b82f6"
                  strokeDasharray="5 5"
                  name="50th Percentile"
                  isAnimationActive={false}
                />
                <Line
                  type="monotone"
                  dataKey="p90"
                  stroke="#dc2626"
                  strokeDasharray="5 5"
                  name="90th Percentile"
                  isAnimationActive={false}
                />
                <Line
                  type="monotone"
                  dataKey="efw"
                  stroke="#14b8a6"
                  name="Ÿàÿ≤ŸÜ ÿßŸÑÿ¨ŸÜŸäŸÜ ÿßŸÑŸÖŸÇÿØÿ± (EFW)"
                  strokeWidth={2}
                  connectNulls
                />
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full text-sm font-[Tajawal]">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-4 py-2 text-right">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                  <th className="px-4 py-2 text-right">GA</th>
                  <th className="px-4 py-2 text-right">BPD</th>
                  <th className="px-4 py-2 text-right">HC</th>
                  <th className="px-4 py-2 text-right">AC</th>
                  <th className="px-4 py-2 text-right">FL</th>
                  <th className="px-4 py-2 text-right">EFW</th>
                  <th className="px-4 py-2 text-right">ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ©</th>
                  <th className="px-4 py-2 text-right">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                </tr>
              </thead>
              <tbody>
                {scans.map((scan) => (
                  <tr key={scan.id} className="border-b hover:bg-gray-50">
                    <td className="px-4 py-2">
                      {new Date(scan.scan_date).toLocaleDateString('ar-EG')}
                    </td>
                    <td className="px-4 py-2">
                      {scan.gestational_age_weeks}w+{scan.gestational_age_days}d
                    </td>
                    <td className="px-4 py-2">{scan.bpd_mm} ŸÖŸÑŸÖ</td>
                    <td className="px-4 py-2">{scan.hc_mm} ŸÖŸÑŸÖ</td>
                    <td className="px-4 py-2">{scan.ac_mm} ŸÖŸÑŸÖ</td>
                    <td className="px-4 py-2">{scan.fl_mm} ŸÖŸÑŸÖ</td>
                    <td className="px-4 py-2 font-bold text-teal-700">
                      {scan.efw_grams?.toLocaleString()} g
                    </td>
                    <td className="px-4 py-2">
                      <span
                        className={`px-3 py-1 rounded-full text-xs font-bold ${
                          scan.percentile && scan.percentile < 10
                            ? 'bg-red-100 text-red-800'
                            : scan.percentile && scan.percentile > 90
                            ? 'bg-yellow-100 text-yellow-800'
                            : 'bg-green-100 text-green-800'
                        }`}
                      >
                        {scan.percentile || 50}th
                      </span>
                    </td>
                    <td className="px-4 py-2 flex gap-2">
                      <button
                        onClick={() => handleEditScan(scan)}
                        className="text-blue-600 hover:text-blue-800 font-semibold"
                      >
                        ÿ™ÿ≠ÿ±Ÿäÿ±
                      </button>
                      <button
                        onClick={() => handleDeleteScan(scan.id)}
                        className="text-red-600 hover:text-red-800"
                      >
                        <Trash2 size={16} />
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </>
      ) : (
        <p className="text-center text-gray-500 py-8 font-[Tajawal]">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≥Ÿàÿ≠ÿßÿ™ ÿ®ŸäŸàŸÖŸäÿ™ÿ±Ÿäÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</p>
      )}
    </div>
  );
};

export default FetalGrowthChart;
</file>

<file path="pages/components/obstetrics/PregnancyHeader.tsx">
import React from 'react';
import { Calendar, AlertCircle, CheckCircle } from 'lucide-react';
import { Pregnancy } from '../../../types';
import { calculateGestationalAge, getDueActions } from '../../../services/obstetricsService';

interface PregnancyHeaderProps {
  pregnancy: Pregnancy;
}

const PregnancyHeader: React.FC<PregnancyHeaderProps> = ({ pregnancy }) => {
  const lmpDate = pregnancy.lmp_date;
  const ga = lmpDate ? calculateGestationalAge(lmpDate) : { weeks: 0, days: 0 };
  const dueActions = getDueActions(ga.weeks);

  const progressPercentage = ((ga.weeks * 7 + ga.days) / 280) * 100;

  return (
    <div className="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg p-6 mb-6 border border-teal-200">
      <div className="grid md:grid-cols-3 gap-6">
        <div>
          <h2 className="text-sm text-gray-600 font-semibold mb-2 font-[Tajawal]">
            ÿßŸÑÿ≠ŸÖŸÑ ÿßŸÑÿ≠ÿßŸÑŸä
          </h2>
          <p className="text-4xl font-bold text-teal-700 font-[Tajawal]">
            {ga.weeks}
            <span className="text-xl text-gray-500 ml-2">ÿ£ÿ≥ÿ®Ÿàÿπ</span>
            <span className="text-lg text-gray-400 ml-1">+ {ga.days}</span>
          </p>
          <p className="text-xs text-gray-500 mt-2 font-[Tajawal]">
            ÿ¢ÿÆÿ± ÿØŸàÿ±ÿ©: {lmpDate ? new Date(lmpDate).toLocaleDateString('ar-EG') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
          </p>
        </div>

        <div>
          <h3 className="text-sm text-gray-600 font-semibold mb-3 font-[Tajawal]">
            ÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ŸÖŸÑ
          </h3>
          <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div
              className="bg-gradient-to-r from-teal-500 to-cyan-500 h-full rounded-full transition-all duration-500"
              style={{ width: `${Math.min(progressPercentage, 100)}%` }}
            ></div>
          </div>
          <p className="text-xs text-gray-600 mt-2 font-[Tajawal]">
            {progressPercentage.toFixed(0)}% ŸÖŸÜ 40 ÿ£ÿ≥ÿ®Ÿàÿπ
          </p>
        </div>

        <div>
          <h3 className="text-sm text-gray-600 font-semibold mb-2 font-[Tajawal]">
            ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπ
          </h3>
          <p className="text-xl font-bold text-teal-700 font-[Tajawal]">
            {pregnancy.edd_date
              ? new Date(pregnancy.edd_date).toLocaleDateString('ar-EG')
              : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
          </p>
          <p className="text-xs text-gray-500 mt-2 font-[Tajawal]">
            {ga.weeks < 40 && `ÿ®ÿßŸÇŸä ${40 - ga.weeks} ÿ£ÿ≥ÿßÿ®Ÿäÿπ`}
            {ga.weeks >= 40 && '‚è∞ ÿßŸÑŸàŸÑÿßÿØÿ© ŸÖÿ™ŸàŸÇÿπÿ©!'}
          </p>
        </div>
      </div>

      {dueActions.length > 0 && (
        <div className="mt-6 pt-6 border-t border-teal-200">
          <h3 className="text-sm font-semibold text-teal-900 mb-3 flex items-center gap-2 font-[Tajawal]">
            <AlertCircle size={18} className="text-orange-500" />
            ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇÿ©
          </h3>
          <div className="grid md:grid-cols-2 gap-2">
            {dueActions.map((action, idx) => (
              <div
                key={idx}
                className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-orange-200"
              >
                <AlertCircle size={16} className="text-orange-500 flex-shrink-0" />
                <span className="text-sm text-gray-700 font-[Tajawal]">{action}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {pregnancy.risk_level === 'high' && (
        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-red-600 flex-shrink-0 mt-0.5" size={18} />
            <div className="font-[Tajawal]">
              <p className="font-semibold text-red-900">‚ö†Ô∏è ÿ≠ŸÖŸÑ ÿπÿßŸÑŸä ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©</p>
              <p className="text-sm text-red-700 mt-1">
                ÿßŸÑÿ±ŸÇÿßÿ®ÿ© ÿßŸÑŸÖÿ™ŸÇÿßÿ±ÿ®ÿ© ŸàÿßŸÑÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÖÿ™ÿÆÿµÿµÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©
              </p>
              {pregnancy.aspirin_prescribed && (
                <p className="text-sm text-red-600 mt-1">
                  ‚úì Aspirin 150mg ŸÖŸàÿµŸàŸÅ ŸÑŸÑŸàŸÇÿßŸäÿ© ŸÖŸÜ ÿ™ÿ≥ŸÖŸÖ ÿßŸÑÿ≠ŸÖŸÑ
                </p>
              )}
            </div>
          </div>
        </div>
      )}

      {pregnancy.risk_level === 'low' && (
        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
          <CheckCircle className="text-green-600" size={20} />
          <p className="text-sm text-green-800 font-[Tajawal] font-semibold">
            ‚úì ÿ≠ŸÖŸÑ ŸÖŸÜÿÆŸÅÿ∂ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ© - ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ±Ÿàÿ™ŸäŸÜŸäÿ© ÿßŸÑŸÖÿπÿ™ÿßÿØÿ©
          </p>
        </div>
      )}
    </div>
  );
};

export default PregnancyHeader;
</file>

<file path="pages/components/obstetrics/RiskAssessment.tsx">
import React, { useState } from 'react';
import { ChevronDown, ChevronUp, Save } from 'lucide-react';
import { Pregnancy } from '../../../types';
import { assessRiskLevel, RiskFactors } from '../../../services/obstetricsService';
import toast from 'react-hot-toast';

interface RiskAssessmentProps {
  pregnancy: Pregnancy;
  onUpdate: (updates: Partial<Pregnancy>) => Promise<void>;
}

const RiskAssessment: React.FC<RiskAssessmentProps> = ({ pregnancy, onUpdate }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  
  const initialRiskFactors: RiskFactors = {
    age_over_40: pregnancy.risk_factors?.includes('age_over_40') || false,
    bmi_over_30: pregnancy.risk_factors?.includes('bmi_over_30') || false,
    previous_preeclampsia: pregnancy.risk_factors?.includes('previous_preeclampsia') || false,
    twins: pregnancy.risk_factors?.includes('twins') || false,
    autoimmune: pregnancy.risk_factors?.includes('autoimmune') || false,
    hypertension: pregnancy.risk_factors?.includes('hypertension') || false,
    diabetes: pregnancy.risk_factors?.includes('diabetes') || false,
    kidney_disease: pregnancy.risk_factors?.includes('kidney_disease') || false,
  };

  const [riskFactors, setRiskFactors] = useState<RiskFactors>(initialRiskFactors);
  const riskAssessment = assessRiskLevel(riskFactors);

  const riskFactorOptions = [
    { key: 'age_over_40', label: 'ÿßŸÑÿπŸÖÿ± > 40 ÿ≥ŸÜÿ©' },
    { key: 'bmi_over_30', label: 'ŸÖÿ§ÿ¥ÿ± ŸÉÿ™ŸÑÿ© ÿßŸÑÿ¨ÿ≥ŸÖ > 30' },
    { key: 'previous_preeclampsia', label: 'ÿ™ÿ≥ŸÖŸÖ ÿßŸÑÿ≠ŸÖŸÑ ÿßŸÑÿ≥ÿßÿ®ŸÇ' },
    { key: 'twins', label: 'ÿ≠ŸÖŸÑ ŸÖÿ™ÿπÿØÿØ (ÿ™Ÿàÿ£ŸÖ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±)' },
    { key: 'autoimmune', label: 'ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÖŸÜÿßÿπÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ©' },
    { key: 'hypertension', label: 'ÿßÿ±ÿ™ŸÅÿßÿπ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ' },
    { key: 'diabetes', label: 'ÿßŸÑÿ≥ŸÉÿ±Ÿä' },
    { key: 'kidney_disease', label: 'ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÉŸÑŸâ' },
  ];

  const handleFactorChange = (key: keyof RiskFactors) => {
    setRiskFactors(prev => ({
      ...prev,
      [key]: !prev[key],
    }));
  };

  const handleSave = async () => {
    try {
      setIsSaving(true);
      const updatedRiskFactors = Object.keys(riskFactors)
        .filter(key => riskFactors[key as keyof RiskFactors])
        .map(key => key.replace(/_/g, '_'));

      await onUpdate({
        risk_factors: updatedRiskFactors,
        risk_level: riskAssessment.level,
        aspirin_prescribed: riskAssessment.aspirinNeeded,
        thromboprophylaxis_needed: riskAssessment.thromboprophylaxisNeeded,
      });

      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error saving risk assessment:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ±');
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full flex items-center justify-between text-lg font-bold text-gray-900 hover:text-teal-700 transition-colors font-[Tajawal]"
      >
        <span>‚öñÔ∏è ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿ≠ÿ≥ÿ® RCOG</span>
        {isExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
      </button>

      {isExpanded && (
        <div className="mt-6 space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            {riskFactorOptions.map(option => (
              <label
                key={option.key}
                className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors"
              >
                <input
                  type="checkbox"
                  checked={riskFactors[option.key as keyof RiskFactors]}
                  onChange={() => handleFactorChange(option.key as keyof RiskFactors)}
                  className="w-4 h-4 text-teal-600 rounded cursor-pointer"
                />
                <span className="text-sm text-gray-700 font-[Tajawal]">{option.label}</span>
              </label>
            ))}
          </div>

          <div className="mt-6 p-4 rounded-lg border-2" style={{
            borderColor: riskAssessment.level === 'high' ? '#dc2626' : riskAssessment.level === 'moderate' ? '#f97316' : '#16a34a',
            backgroundColor: riskAssessment.level === 'high' ? '#fef2f2' : riskAssessment.level === 'moderate' ? '#fff7ed' : '#f0fdf4',
          }}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-lg font-[Tajawal]" style={{
                color: riskAssessment.level === 'high' ? '#991b1b' : riskAssessment.level === 'moderate' ? '#9a3412' : '#166534',
              }}>
                {riskAssessment.level === 'high' && 'üî¥ ÿ≠ŸÖŸÑ ÿπÿßŸÑŸä ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©'}
                {riskAssessment.level === 'moderate' && 'üü° ÿ≠ŸÖŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©'}
                {riskAssessment.level === 'low' && 'üü¢ ÿ≠ŸÖŸÑ ŸÖŸÜÿÆŸÅÿ∂ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©'}
              </h3>
            </div>

            {riskAssessment.riskFactorsList.length > 0 && (
              <div className="mb-3">
                <p className="text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">ÿπŸàÿßŸÖŸÑ ÿßŸÑÿÆÿ∑Ÿàÿ±ÿ©:</p>
                <ul className="list-disc list-inside space-y-1">
                  {riskAssessment.riskFactorsList.map((factor, idx) => (
                    <li key={idx} className="text-sm text-gray-700 font-[Tajawal]">{factor}</li>
                  ))}
                </ul>
              </div>
            )}

            {riskAssessment.aspirinNeeded && (
              <div className="p-3 bg-white rounded border border-current mb-2">
                <p className="text-sm font-semibold text-gray-900 font-[Tajawal]">
                  üíä ŸàÿµŸÅÿ© ŸÖŸàÿµŸâ ÿ®Ÿáÿß: Aspirin 150mg ŸäŸàŸÖŸäÿßŸã (ŸÑÿ™ŸÇŸÑŸäŸÑ ÿÆÿ∑ÿ± ÿ™ÿ≥ŸÖŸÖ ÿßŸÑÿ≠ŸÖŸÑ)
                </p>
              </div>
            )}

            {riskAssessment.thromboprophylaxisNeeded && (
              <div className="p-3 bg-white rounded border border-current">
                <p className="text-sm font-semibold text-gray-900 font-[Tajawal]">
                  üíâ ÿ™ŸÜÿ®ŸäŸá: ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑŸàŸÇÿßŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ÿ¨ŸÑÿ∑ (Clexane) ŸÖÿ∑ŸÑŸàÿ®ÿ©
                </p>
              </div>
            )}
          </div>

          <button
            onClick={handleSave}
            disabled={isSaving}
            className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            <Save size={18} />
            {isSaving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ±'}
          </button>
        </div>
      )}
    </div>
  );
};

export default RiskAssessment;
</file>

<file path="services/supabaseClient.ts">
import { createClient } from '@supabase/supabase-js';

// Helper to safely access environment variables
// This prevents the "Cannot read properties of undefined" error when running in environments
// where import.meta.env is not fully defined.
const getEnv = (key: string) => {
  try {
    // @ts-ignore
    return import.meta.env?.[key];
  } catch (e) {
    return undefined;
  }
};

// ----------------------------------------------------------------------------------
// üõë ACTION REQUIRED: PASTE YOUR SUPABASE KEYS HERE
// ----------------------------------------------------------------------------------
// 1. Go to https://supabase.com/dashboard
// 2. Select your project -> Project Settings -> API
// 3. Copy the 'Project URL' and 'anon public' Key
const SUPABASE_URL = getEnv('VITE_SUPABASE_URL') || 'https://ladqitwqkkfiijregqlu.supabase.co';
const SUPABASE_ANON_KEY = getEnv('VITE_SUPABASE_ANON_KEY') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhZHFpdHdxa2tmaWlqcmVncWx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4Njk0MDgsImV4cCI6MjA4MDQ0NTQwOH0.qSAjg1kIcAO5DFnz5InlW4u3pxzeDTIbLdB6uN_CEUc';

// Validation to warn developer if keys are missing
if (SUPABASE_URL.includes('INSERT') || SUPABASE_ANON_KEY.includes('INSERT')) {
  console.warn('‚ö†Ô∏è Supabase credentials are missing or invalid! Please update services/supabaseClient.ts');
}

export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</file>

<file path="services/workupService.ts">
import { supabase } from './supabaseClient';

// Database schema interface (snake_case for Supabase)
export interface WorkupData {
  id?: string;
  patient_id: string;
  // Ovarian Factor
  amh?: number;
  cycle_regularity?: 'Regular' | 'Irregular';
  // Male Factor
  sperm_count?: number;
  motility?: number;
  morphology?: number;
  // Tubal Factor
  left_tube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
  right_tube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
  // Uterine Factor
  cavity_status?: 'Normal' | 'Septum' | 'Polyp' | 'Adhesions';
  // Auto-generated
  diagnosis?: string;
  plan?: string;
  created_at?: string;
  updated_at?: string;
}

// TypeScript interface for component state (camelCase)
export interface WorkupState {
  patientId: string;
  ovarianFactor: {
    amh?: number;
    cycleRegularity?: 'Regular' | 'Irregular';
  };
  maleFactor: {
    spermCount?: number;
    motility?: number;
    morphology?: number;
  };
  tubalFactor: {
    leftTube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
    rightTube?: 'Patent' | 'Blocked' | 'Hydrosalpinx';
  };
  uterineFactor: {
    cavityStatus?: 'Normal' | 'Septum' | 'Polyp' | 'Adhesions';
  };
  diagnosis?: string;
  plan?: string;
}

// Convert database format to component state
const dbToState = (dbData: WorkupData): WorkupState => ({
  patientId: dbData.patient_id,
  ovarianFactor: {
    amh: dbData.amh,
    cycleRegularity: dbData.cycle_regularity,
  },
  maleFactor: {
    spermCount: dbData.sperm_count,
    motility: dbData.motility,
    morphology: dbData.morphology,
  },
  tubalFactor: {
    leftTube: dbData.left_tube,
    rightTube: dbData.right_tube,
  },
  uterineFactor: {
    cavityStatus: dbData.cavity_status,
  },
  diagnosis: dbData.diagnosis,
  plan: dbData.plan,
});

// Convert component state to database format
const stateToDb = (state: WorkupState): Omit<WorkupData, 'id' | 'created_at' | 'updated_at'> => ({
  patient_id: state.patientId,
  amh: state.ovarianFactor.amh,
  cycle_regularity: state.ovarianFactor.cycleRegularity,
  sperm_count: state.maleFactor.spermCount,
  motility: state.maleFactor.motility,
  morphology: state.maleFactor.morphology,
  left_tube: state.tubalFactor.leftTube,
  right_tube: state.tubalFactor.rightTube,
  cavity_status: state.uterineFactor.cavityStatus,
});

// Get workup data for a patient
export const getWorkup = async (patientId: string): Promise<WorkupState> => {
  try {
    const { data, error } = await supabase
      .from('infertility_workups')
      .select('*')
      .eq('patient_id', patientId)
      .single();

    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
      throw error;
    }

    if (data) {
      return dbToState(data);
    }

    // Return default empty object if no data exists
    return {
      patientId,
      ovarianFactor: {},
      maleFactor: {},
      tubalFactor: {},
      uterineFactor: {},
    };
  } catch (error) {
    console.error('Error fetching workup data:', error);
    throw new Error('Failed to fetch infertility workup data');
  }
};

// Save workup data (upsert)
export const saveWorkup = async (data: WorkupState): Promise<void> => {
  try {
    const dbData = stateToDb(data);
    const diagnosis = generateDiagnosis(data);

    const workupData: WorkupData = {
      ...dbData,
      diagnosis: diagnosis.diagnosis,
      plan: diagnosis.plan,
      updated_at: new Date().toISOString(),
    };

    const { error } = await supabase
      .from('infertility_workups')
      .upsert(workupData, {
        onConflict: 'patient_id',
        ignoreDuplicates: false
      });

    if (error) {
      throw error;
    }
  } catch (error) {
    console.error('Error saving workup data:', error);
    throw new Error('Failed to save infertility workup data');
  }
};

// Generate diagnosis and plan based on medical logic
export const generateDiagnosis = (data: WorkupState): { diagnosis: string; plan: string } => {
  const factors: string[] = [];
  const plans: string[] = [];

  // Male Factor Assessment
  const hasMaleFactor =
    (data.maleFactor.spermCount !== undefined && data.maleFactor.spermCount < 15) ||
    (data.maleFactor.motility !== undefined && data.maleFactor.motility < 40) ||
    (data.maleFactor.morphology !== undefined && data.maleFactor.morphology < 4);

  if (hasMaleFactor) {
    factors.push('Male Factor Infertility');
    plans.push('IVF/ICSI Recommended');
  }

  // Tubal Factor Assessment
  const hasTubalFactor =
    data.tubalFactor.leftTube === 'Blocked' ||
    data.tubalFactor.rightTube === 'Blocked' ||
    data.tubalFactor.leftTube === 'Hydrosalpinx' ||
    data.tubalFactor.rightTube === 'Hydrosalpinx';

  if (hasTubalFactor) {
    factors.push('Tubal Factor Infertility');
    plans.push('IVF/ICSI Recommended');
  }

  // Ovarian Factor Assessment
  const hasOvarianFactor =
    (data.ovarianFactor.amh !== undefined && (data.ovarianFactor.amh < 1.1 || data.ovarianFactor.amh > 3.5)) ||
    data.ovarianFactor.cycleRegularity === 'Irregular';

  if (hasOvarianFactor) {
    if (data.ovarianFactor.amh !== undefined && data.ovarianFactor.amh < 1.1) {
      factors.push('Diminished Ovarian Reserve (DOR)');
    } else if (data.ovarianFactor.amh !== undefined && data.ovarianFactor.amh > 3.5) {
      factors.push('Polycystic Ovary Syndrome (PCOS)');
    }
    if (data.ovarianFactor.cycleRegularity === 'Irregular') {
      factors.push('Ovulatory Dysfunction');
    }
  }

  // Uterine Factor Assessment
  const hasUterineFactor = data.uterineFactor.cavityStatus && data.uterineFactor.cavityStatus !== 'Normal';

  if (hasUterineFactor) {
    factors.push('Uterine Factor Infertility');
    plans.push('Hysteroscopic Correction Required');
  }

  // Hydrosalpinx specific note
  const hasHydrosalpinx =
    data.tubalFactor.leftTube === 'Hydrosalpinx' ||
    data.tubalFactor.rightTube === 'Hydrosalpinx';

  if (hasHydrosalpinx) {
    plans.push('Salpingectomy Required Before ET');
  }

  // Generate diagnosis string
  let diagnosis = 'Unexplained Infertility';
  if (factors.length > 0) {
    diagnosis = factors.join(' + ');
  }

  // Generate plan string
  let plan = 'Further Investigation Required';
  if (plans.length > 0) {
    plan = plans.join(' + ');
  } else if (hasOvarianFactor && !hasMaleFactor && !hasTubalFactor && !hasUterineFactor) {
    plan = 'Induction + Timed Intercourse';
  }

  return { diagnosis, plan };
};
</file>

<file path="styles.css">
body {
  font-family: 'Tajawal', sans-serif;
  background-color: #f3f4f6;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

.print-only {
  display: none;
}

@media print {
  body, html {
    background: white !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    height: 100% !important;
  }

  .no-print {
    display: none !important;
  }

  .print-only {
    display: block !important;
    position: relative !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 32px !important;
    background: white !important;
  }

  #root {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .print-only * {
    background: white !important;
    color: #000 !important;
  }

  .print-only h1,
  .print-only h2,
  .print-only h3 {
    margin-top: 0 !important;
    page-break-after: avoid !important;
  }
}
</file>

<file path="SUPABASE_SETUP.sql">
-- ============================================================================
-- SUPABASE SETUP FOR NILE IVF EMR - Doctor Settings
-- ============================================================================
-- Run this SQL script in Supabase SQL Editor
-- ============================================================================

-- ============================================================================
-- 1. ALTER DOCTORS TABLE - Add new columns for doctor and clinic info
-- ============================================================================

ALTER TABLE IF EXISTS doctors 
ADD COLUMN IF NOT EXISTS doctor_image TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_name TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_address TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_phone TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_image TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_latitude TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS clinic_longitude TEXT DEFAULT NULL;

-- ============================================================================
-- 2. CREATE INDEX for better query performance
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_doctors_user_id ON doctors(user_id);

-- ============================================================================
-- 3. STORAGE POLICIES - These must be run in SQL Editor or via UI
-- ============================================================================

-- Drop existing policies if they exist
DROP POLICY IF EXISTS "Users can upload files to doctor-files" ON storage.objects;
DROP POLICY IF EXISTS "Anyone can read files from doctor-files" ON storage.objects;
DROP POLICY IF EXISTS "Users can update their own files in doctor-files" ON storage.objects;
DROP POLICY IF EXISTS "Users can delete their own files from doctor-files" ON storage.objects;

-- Policy 1: Allow authenticated users to upload files
CREATE POLICY "Users can upload files to doctor-files"
ON storage.objects
FOR INSERT
WITH CHECK (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
);

-- Policy 2: Allow anyone to read/view files
CREATE POLICY "Anyone can read files from doctor-files"
ON storage.objects
FOR SELECT
USING (bucket_id = 'doctor-files');

-- Policy 3: Allow users to update their own files
CREATE POLICY "Users can update their own files in doctor-files"
ON storage.objects
FOR UPDATE
USING (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
)
WITH CHECK (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
);

-- Policy 4: Allow users to delete their own files
CREATE POLICY "Users can delete their own files from doctor-files"
ON storage.objects
FOR DELETE
USING (
  bucket_id = 'doctor-files'
  AND auth.role() = 'authenticated'
);

-- ============================================================================
-- DONE! 
-- ============================================================================
-- Next steps:
-- 1. Make sure the 'doctor-files' bucket exists in Storage
-- 2. If it doesn't exist, create it manually in the Supabase UI:
--    - Go to Storage ‚Üí New bucket
--    - Name: doctor-files
--    - Access: Public (so images can be viewed by anyone)
-- ============================================================================
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
</file>

<file path="vercel.json">
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": { "distDir": "dist" }
    }
  ]
}
</file>

<file path="write_file.py">
import os  
print(os.getcwd())
</file>

<file path="BRANDING_SETUP.sql">
-- ============================================================================
-- Nile IVF Center - Dynamic Branding Setup
-- ============================================================================
-- This script creates the app_settings table and enables dynamic branding
-- for clinic name, logo, and color customization.
-- ============================================================================

-- 1. Create app_settings table for dynamic branding
CREATE TABLE IF NOT EXISTS app_settings (
  id INTEGER PRIMARY KEY DEFAULT 1,
  clinic_name TEXT NOT NULL DEFAULT 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±',
  logo_url TEXT,
  clinic_address TEXT,
  clinic_phone TEXT,
  primary_color TEXT DEFAULT '#2d5a6b',
  secondary_color TEXT DEFAULT '#00838f',
  accent_color TEXT DEFAULT '#00bcd4',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_by UUID,
  CONSTRAINT single_row CHECK (id = 1),
  FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);

-- 2. Enable RLS on app_settings
ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;

-- 3. RLS Policies for app_settings table
-- Policy: Authenticated users can read app_settings
DROP POLICY IF EXISTS "Users can read app_settings" ON app_settings;
CREATE POLICY "Users can read app_settings"
  ON app_settings FOR SELECT
  TO authenticated
  USING (true);

-- Policy: Authenticated users can update app_settings
DROP POLICY IF EXISTS "Authenticated users can update app_settings" ON app_settings;
CREATE POLICY "Authenticated users can update app_settings"
  ON app_settings FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- 4. Insert default settings row
INSERT INTO app_settings (id, clinic_name, logo_url)
VALUES (1, 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±', NULL)
ON CONFLICT (id) DO NOTHING;

-- ============================================================================
-- NOTE: For Storage Bucket Creation, use Supabase Dashboard:
-- ============================================================================
-- 1. Go to Supabase Dashboard ‚Üí Storage
-- 2. Click "Create new bucket"
-- 3. Enter name: "branding"
-- 4. Choose "Public bucket"
-- 5. Click "Create bucket"
-- 
-- Then run the storage policies below in SQL Editor:
-- ============================================================================

-- 5. Storage Policies (Run these AFTER creating "branding" bucket)
DROP POLICY IF EXISTS "Allow authenticated users to upload branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to upload branding"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (bucket_id = 'branding');

DROP POLICY IF EXISTS "Allow authenticated users to delete branding" ON storage.objects;
CREATE POLICY "Allow authenticated users to delete branding"
  ON storage.objects FOR DELETE
  TO authenticated
  USING (bucket_id = 'branding');

DROP POLICY IF EXISTS "Allow public read access to branding" ON storage.objects;
CREATE POLICY "Allow public read access to branding"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id = 'branding');

-- ============================================================================
-- Verification Queries
-- ============================================================================
-- Verify table was created:
-- SELECT * FROM app_settings;
--
-- Verify bucket exists (use Supabase Dashboard Storage tab):
-- Should see "branding" bucket listed
</file>

<file path="components/PrescriptionComponent.tsx">
import React, { useState } from 'react';
import { Plus, Trash2, Search, Pill, Printer } from 'lucide-react';
import { PrescriptionItem } from '../types';
import { EGYPTIAN_MARKET_DRUGS, DrugEntry, searchDrugs, getDrugsByCategory } from '../data/egyptian_drugs';

interface PrescriptionComponentProps {
  prescriptions: PrescriptionItem[];
  onPrescriptionsChange: (prescriptions: PrescriptionItem[]) => void;
  onPrint?: () => void;
  showPrintButton?: boolean;
}

const PrescriptionComponent: React.FC<PrescriptionComponentProps> = ({
  prescriptions,
  onPrescriptionsChange,
  onPrint,
  showPrintButton = false
}) => {
  const [selectedCategory, setSelectedCategory] = useState<string>('');
  const [selectedDrug, setSelectedDrug] = useState<string>('');
  const [searchQuery, setSearchQuery] = useState<string>('');
  const [customDose, setCustomDose] = useState<string>('');

  const categories = Object.keys(EGYPTIAN_MARKET_DRUGS);
  const categoryDrugs = selectedCategory ? getDrugsByCategory(selectedCategory) : [];
  const searchResults = searchQuery ? searchDrugs(searchQuery) : [];

  const handleAddDrug = () => {
    if (!selectedDrug) return;

    let drugEntry: DrugEntry | undefined;

    // Find the drug entry
    if (searchQuery) {
      drugEntry = searchResults.find(d => d.tradeName === selectedDrug);
    } else {
      drugEntry = categoryDrugs.find(d => d.tradeName === selectedDrug);
    }

    if (!drugEntry) return;

    const dose = customDose || drugEntry.dose;

    const newPrescription: PrescriptionItem = {
      category: drugEntry.category,
      drug: drugEntry.tradeName,
      dose: dose
    };

    onPrescriptionsChange([...prescriptions, newPrescription]);

    // Reset form
    setSelectedDrug('');
    setCustomDose('');
    setSearchQuery('');
  };

  const handleRemoveDrug = (index: number) => {
    const updatedPrescriptions = prescriptions.filter((_, i) => i !== index);
    onPrescriptionsChange(updatedPrescriptions);
  };

  const handleUpdateDose = (index: number, newDose: string) => {
    const updatedPrescriptions = prescriptions.map((prescription, i) =>
      i === index ? { ...prescription, dose: newDose } : prescription
    );
    onPrescriptionsChange(updatedPrescriptions);
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Pill className="w-5 h-5 text-purple-600" />
          <h3 className="text-lg font-semibold text-gray-900">Prescription</h3>
        </div>
        {showPrintButton && prescriptions.length > 0 && onPrint && (
          <button
            onClick={onPrint}
            className="flex items-center gap-2 px-3 py-1 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm transition-colors"
          >
            <Printer className="w-4 h-4" />
            Print Prescription
          </button>
        )}
      </div>

      {/* Search Bar */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
        <input
          type="text"
          placeholder="Search for medication..."
          value={searchQuery}
          onChange={(e) => {
            setSearchQuery(e.target.value);
            setSelectedCategory('');
            setSelectedDrug('');
          }}
          className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        />
      </div>

      {/* Category Selection (only show if not searching) */}
      {!searchQuery && (
        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
          {categories.map(category => (
            <button
              key={category}
              onClick={() => {
                setSelectedCategory(category);
                setSelectedDrug('');
              }}
              className={`px-3 py-2 text-sm rounded-lg border transition-colors ${
                selectedCategory === category
                  ? 'bg-purple-600 text-white border-purple-600'
                  : 'bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100'
              }`}
            >
              {category}
            </button>
          ))}
        </div>
      )}

      {/* Drug Selection */}
      {(selectedCategory || searchQuery) && (
        <div className="space-y-3">
          <select
            value={selectedDrug}
            onChange={(e) => setSelectedDrug(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
          >
            <option value="">
              {searchQuery ? 'Select from search results...' : 'Select medication...'}
            </option>
            {(searchQuery ? searchResults : categoryDrugs).map(drug => (
              <option key={drug.tradeName} value={drug.tradeName}>
                {drug.tradeName} ({drug.active})
              </option>
            ))}
          </select>

          {/* Custom Dose Input */}
          {selectedDrug && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Dose (leave empty for standard dose)
              </label>
              <input
                type="text"
                value={customDose}
                onChange={(e) => setCustomDose(e.target.value)}
                placeholder="Custom dose instructions..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
              />
            </div>
          )}

          <button
            onClick={handleAddDrug}
            disabled={!selectedDrug}
            className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
          >
            <Plus className="w-4 h-4" />
            Add to Prescription
          </button>
        </div>
      )}

      {/* Current Prescriptions */}
      <div className="space-y-3">
        <h4 className="font-medium text-gray-900">Current Prescriptions</h4>

        {prescriptions.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <Pill className="w-12 h-12 mx-auto mb-4 text-gray-300" />
            <p>No medications prescribed yet</p>
          </div>
        ) : (
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {prescriptions.map((prescription, index) => (
              <div key={index} className="bg-white border border-gray-200 rounded-lg p-3">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="font-semibold text-gray-900">{prescription.drug}</div>
                    <div className="text-sm text-purple-600 mt-1">{prescription.category}</div>
                    <input
                      type="text"
                      value={prescription.dose}
                      onChange={(e) => handleUpdateDose(index, e.target.value)}
                      className="w-full mt-2 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500"
                      placeholder="Enter dose..."
                    />
                  </div>
                  <button
                    onClick={() => handleRemoveDrug(index)}
                    className="text-red-500 hover:text-red-700 ml-2"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default PrescriptionComponent;
</file>

<file path="components/PrescriptionPrinter.tsx">
import React, { useState, useEffect, useRef } from 'react';
import { Printer, X } from 'lucide-react';
import { PrescriptionItem, Patient, Doctor } from '../types';
import { authService } from '../services/authService';
import { useBranding } from '../context/BrandingContext';
import toast from 'react-hot-toast';

interface PrescriptionPrinterProps {
  patient: Patient | null;
  prescriptions: PrescriptionItem[];
  diagnosis?: string;
  notes?: string;
  isOpen: boolean;
  onClose: () => void;
}

const PrescriptionPrinter: React.FC<PrescriptionPrinterProps> = ({
  patient,
  prescriptions,
  diagnosis,
  notes,
  isOpen,
  onClose
}) => {
  const { branding } = useBranding();
  const [doctor, setDoctor] = useState<Doctor | null>(null);
  const printRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (isOpen) {
      fetchDoctorInfo();
    }
  }, [isOpen]);

  const fetchDoctorInfo = async () => {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        const doctorData = await authService.getDoctorProfile(user.id);
        setDoctor(doctorData);
      }
    } catch (error) {
      console.error('Error fetching doctor info:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
    }
  };

  const handlePrint = () => {
    const printContent = printRef.current;
    if (!printContent) return;

    const printWindow = window.open('', '', 'height=800,width=1000');
    if (!printWindow) {
      toast.error('ŸÅÿ¥ŸÑ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©');
      return;
    }

    const styles = `
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; padding: 20px; }
        .prescription-container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border: 1px solid #ddd; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2d5a6b; padding-bottom: 20px; margin-bottom: 30px; }
        .clinic-info { flex: 1; }
        .clinic-name { font-size: 24px; font-weight: bold; color: #2d5a6b; margin-bottom: 8px; }
        .clinic-details { font-size: 12px; color: #666; line-height: 1.8; }
        .logo-area { flex: 1; text-align: right; color: #2d5a6b; font-weight: bold; font-size: 14px; }
        .patient-doctor-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .info-block { }
        .info-label { font-weight: bold; color: #2d5a6b; font-size: 13px; margin-bottom: 5px; }
        .info-value { font-size: 14px; color: #333; }
        .rx-title { font-size: 18px; font-weight: bold; color: #2d5a6b; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .prescriptions-list { margin-bottom: 30px; }
        .prescription-item { background: #f9f9f9; border: 1px solid #e0e0e0; padding: 12px 15px; margin-bottom: 10px; border-radius: 4px; }
        .prescription-number { display: inline-block; background: #2d5a6b; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-weight: bold; margin-right: 10px; font-size: 12px; }
        .prescription-content { margin-left: 38px; }
        .drug-name { font-weight: bold; font-size: 14px; color: #333; }
        .drug-dose { font-size: 12px; color: #666; margin-top: 3px; }
        .drug-category { font-size: 11px; color: #999; margin-top: 3px; }
        .diagnosis-section, .notes-section { margin-bottom: 25px; padding: 15px; background: #f5f5f5; border-left: 4px solid #2d5a6b; }
        .section-title { font-weight: bold; color: #2d5a6b; margin-bottom: 8px; font-size: 13px; text-transform: uppercase; }
        .section-content { color: #333; font-size: 13px; line-height: 1.6; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .signature-box { }
        .signature-label { font-size: 12px; font-weight: bold; color: #666; margin-top: 40px; border-top: 1px solid #333; padding-top: 5px; text-align: center; }
        .date-time { font-size: 12px; color: #666; margin-top: 15px; text-align: center; }
        @media print {
          body { padding: 0; }
          .prescription-container { border: none; padding: 0; }
        }
      </style>
    `;

    const content = printContent.innerHTML;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>ÿ±Ÿàÿ¥ÿ™ÿ© ÿ∑ÿ®Ÿäÿ©</title>
          ${styles}
        </head>
        <body>
          ${content}
        </body>
      </html>
    `);

    printWindow.document.close();
    setTimeout(() => {
      printWindow.print();
    }, 250);
  };

  const getCurrentDateTime = () => {
    const now = new Date();
    return {
      date: now.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }),
      time: now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })
    };
  };

  const { date, time } = getCurrentDateTime();

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-teal-600 text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</h2>
          <button
            onClick={onClose}
            className="hover:bg-teal-700 p-2 rounded-lg transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content */}
        <div className="p-6">
          <div ref={printRef} className="prescription-container">
            {/* Header */}
            <div className="header">
              <div className="clinic-info">
                <div className="clinic-name">
                  {branding?.clinic_name || 'ÿπŸäÿßÿØÿ© ŸÖÿ™ÿÆÿµÿµÿ©'}
                </div>
                <div className="clinic-details">
                  {branding?.clinic_address && <div>{branding.clinic_address}</div>}
                  {branding?.clinic_phone && <div>ÿ™: {branding.clinic_phone}</div>}
                  {doctor?.email && <div>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: {doctor.email}</div>}
                </div>
              </div>
              <div className="logo-area">
                {branding?.logo_url ? (
                  <img src={branding.logo_url} alt="Logo" style={{ maxWidth: '80px', maxHeight: '80px' }} />
                ) : (
                  '‚Ñú'
                )}
              </div>
            </div>

            {/* Patient & Doctor Info */}
            <div className="patient-doctor-section">
              <div className="info-block">
                <div className="info-label">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©</div>
                <div className="info-value">{patient?.name || 'N/A'}</div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  ÿßŸÑÿπŸÖÿ±: {patient?.age || 'N/A'} ÿ≥ŸÜÿ©
                </div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  ÿßŸÑŸáÿßÿ™ŸÅ: {patient?.phone || 'N/A'}
                </div>
              </div>
              <div className="info-block">
                <div className="info-label">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®</div>
                <div className="info-value">{doctor?.name || 'N/A'}</div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  {doctor?.specialization || ''}
                </div>
                <div className="info-value" style={{ fontSize: '12px', marginTop: '5px', color: '#666' }}>
                  {date} - {time}
                </div>
              </div>
            </div>

            {/* Diagnosis */}
            {diagnosis && (
              <div className="diagnosis-section">
                <div className="section-title">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ</div>
                <div className="section-content">{diagnosis}</div>
              </div>
            )}

            {/* Prescriptions */}
            {prescriptions.length > 0 && (
              <>
                <div className="rx-title">ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</div>
                <div className="prescriptions-list">
                  {prescriptions.map((prescription, index) => (
                    <div key={index} className="prescription-item">
                      <span className="prescription-number">{index + 1}</span>
                      <div className="prescription-content">
                        <div className="drug-name">{prescription.drug}</div>
                        <div className="drug-dose">
                          {prescription.dose || 'ÿßŸÑÿ¨ÿ±ÿπÿ© ÿßŸÑŸÇŸäÿßÿ≥Ÿäÿ©'}
                        </div>
                        <div className="drug-category">ÿßŸÑÿ™ÿµŸÜŸäŸÅ: {prescription.category}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {/* Notes */}
            {notes && (
              <div className="notes-section">
                <div className="section-title">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</div>
                <div className="section-content">{notes}</div>
              </div>
            )}

            {/* Footer */}
            <div className="footer">
              <div className="signature-box">
                <div className="signature-label">ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿ∑ÿ®Ÿäÿ®</div>
              </div>
              <div className="signature-box">
                <div className="signature-label">ÿ™ŸàŸÇŸäÿπ ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©</div>
              </div>
            </div>

            {/* Date Time */}
            <div className="date-time">
              ÿ™ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: {date} ŸÅŸä {time}
            </div>
          </div>

          {/* Print Button */}
          <div className="mt-6 flex gap-3 justify-end sticky bottom-0 bg-gray-50 p-4 rounded-b-lg">
            <button
              onClick={onClose}
              className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            >
              ÿ•ÿ∫ŸÑÿßŸÇ
            </button>
            <button
              onClick={handlePrint}
              className="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors flex items-center gap-2"
            >
              <Printer className="w-4 h-4" />
              ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PrescriptionPrinter;
</file>

<file path="constants.ts">
// Egyptian IVF Medications Database
export const EGYPTIAN_DRUGS = {
  "Induction (Stimulation)": {
    "Clomid 50mg": { active: "Clomiphene Citrate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Clostilbegyt 50mg": { active: "Clomiphene Citrate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Technovula 50mg": { active: "Clomiphene Citrate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Femara 2.5mg": { active: "Letrozole", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3 ŸÑŸÄ 7 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Letrozole 2.5mg": { active: "Letrozole", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3 ŸÑŸÄ 7 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Nolvadex 10mg": { active: "Tamoxifen", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2 ŸÑŸÄ 6 ŸÑŸÑÿØŸàÿ±ÿ©" },
    "Gonal-F 75 IU": { active: "Follitropin Alpha", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ¨ÿØŸàŸÑ" },
    "Gonal-F 300/450/900 Pen": { active: "Follitropin Alpha", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã (ÿ≠ÿØÿØ ÿßŸÑÿ¨ÿ±ÿπÿ©)" },
    "Fostimon 75 IU": { active: "Urofollitropin (FSH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Fostimon 150 IU": { active: "Urofollitropin (FSH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Merional 75 IU": { active: "HMG (FSH+LH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Merional 150 IU": { active: "HMG (FSH+LH)", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Menogon 75 IU": { active: "HMG", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸäŸàŸÖŸäÿßŸã" },
    "Menopur 75 IU": { active: "HP-HMG", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ/ÿ™ÿ≠ÿ™ ÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Pergoveris Pen": { active: "FSH + LH", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Epigonal 75 IU": { active: "HMG", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸäŸàŸÖŸäÿßŸã" }
  },
  "Trigger Shots": {
    "Choriomon 5000 IU": { active: "HCG", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿπÿ∂ŸÑ ŸÅŸä ÿ™ŸàŸÇŸäÿ™ ŸÖÿ≠ÿØÿØ (36 ÿ≥ÿßÿπÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠ÿ®)" },
    "Epifasi 5000 IU": { active: "HCG", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿπÿ∂ŸÑ ŸÅŸä ÿ™ŸàŸÇŸäÿ™ ŸÖÿ≠ÿØÿØ" },
    "Pregnyl 5000 IU": { active: "HCG", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿπÿ∂ŸÑ ŸÅŸä ÿ™ŸàŸÇŸäÿ™ ŸÖÿ≠ÿØÿØ" },
    "Ovitrelle 250mcg": { active: "Choriogonadotropin Alfa", dose: "ÿ≠ŸÇŸÜÿ© ŸÉÿßŸÖŸÑÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸÅŸä ÿßŸÑŸÖŸäÿπÿßÿØ ÿßŸÑŸÖÿ≠ÿØÿØ" },
    "Decapeptyl 0.1mg (Trigger)": { active: "Triptorelin", dose: "ÿ≠ŸÇŸÜÿ™ŸäŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ (ŸÑŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ OHSS)" }
  },
  "Down-Regulation (Antagonists/Agonists)": {
    "Cetrotide 0.25mg": { active: "Cetrorelix", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖŸäÿπÿßÿØ" },
    "Orgalutran 0.25mg": { active: "Ganirelix", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖŸäÿπÿßÿØ" },
    "Decapeptyl 0.1mg Daily": { active: "Triptorelin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Decapeptyl 3.75mg Depot": { active: "Triptorelin", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© (ÿ™ÿ≠ÿ∂Ÿäÿ±)" },
    "Zoladex 3.6mg": { active: "Goserelin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸÅŸä ÿ¨ÿØÿßÿ± ÿßŸÑÿ®ÿ∑ŸÜ" },
    "Lupron Depot": { active: "Leuprolide", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©" }
  },
  "Luteal Support (Progesterone)": {
    "Cyclogest 400mg": { active: "Progesterone", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖŸáÿ®ŸÑŸäÿ©/ÿ¥ÿ±ÿ¨Ÿäÿ© ÿµÿ®ÿßÿ≠ÿßŸã ŸàŸÖÿ≥ÿßÿ°Ÿã" },
    "Cyclogest 200mg": { active: "Progesterone", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖŸáÿ®ŸÑŸäÿ© ŸÖÿ≥ÿßÿ°Ÿã" },
    "Prontogest 100mg": { active: "Progesterone", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ÿπŸÖŸäŸÇ ŸäŸàŸÖŸäÿßŸã" },
    "Prontogest 200mg": { active: "Progesterone", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖŸáÿ®ŸÑŸäÿ© ŸÖÿ≥ÿßÿ°Ÿã" },
    "Duphaston 10mg": { active: "Dydrogesterone", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "Utrogestan 200mg": { active: "Micronized Progesterone", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖŸáÿ®ŸÑŸäÿ© ÿµÿ®ÿßÿ≠ÿßŸã ŸàŸÖÿ≥ÿßÿ°Ÿã" },
    "Crinone 8% Gel": { active: "Progesterone Gel", dose: "ÿ£ŸÜÿ®Ÿàÿ®ÿ© ŸÖŸáÿ®ŸÑŸäÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ÿµÿ®ÿßÿ≠ÿßŸã" },
    "Endometrin 100mg": { active: "Progesterone", dose: "ŸÇÿ±ÿµ ŸÖŸáÿ®ŸÑŸä 3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäÿßŸã" },
    "Progynova 2mg": { active: "Estradiol Valerate", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã (ŸÑÿØÿπŸÖ ÿßŸÑÿ®ÿ∑ÿßŸÜÿ©)" },
    "Estrimax 2mg": { active: "Estradiol", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" }
  },
  "Vitamins & Supplements": {
    "Folic Acid 5mg": { active: "Folic Acid", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Folicap 0.5mg": { active: "Folic Acid", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã" },
    "Methylfolate 400mcg": { active: "Active Folic Acid", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Ferrotron": { active: "Iron + Multivitamins", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Haemoton": { active: "Iron + Folic", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Feroglobin": { active: "Iron + B12", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Osteocare": { active: "Calcium + Mg + Vit D", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±" },
    "Calcid 500mg": { active: "Calcium Carbonate", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±" },
    "Calcimate": { active: "Calcium", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Omega 3 Plus": { active: "Fish Oil", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã" },
    "Carnivita Forte": { active: "L-Carnitine + Zinc", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "L-Carnitine 350mg": { active: "Levocarnitine", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "DHEA 25mg": { active: "Dehydroepiandrosterone", dose: "ŸÇÿ±ÿµ 3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäÿßŸã (ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ)" },
    "Total Fertility": { active: "Multivitamin", dose: "ŸÉŸäÿ≥ ÿπŸÑŸâ ŸÜÿµŸÅ ŸÉŸàÿ® ŸÖÿßÿ° ŸäŸàŸÖŸäÿßŸã" },
    "Pregnacare": { active: "Multivitamin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã" }
  },
  "Anticoagulants (Blood Thinners)": {
    "Clexane 40mg": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Clexane 20mg": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Clexane 60mg": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Enoxa 4000": { active: "Enoxaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Innohep 3500": { active: "Tinzaparin", dose: "ÿ≠ŸÇŸÜÿ© ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ ŸäŸàŸÖŸäÿßŸã" },
    "Juvespr 81mg": { active: "Aspirin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" },
    "Aspocid 75mg": { active: "Aspirin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ° (ÿ£ÿ∑ŸÅÿßŸÑ)" },
    "Ezacard 75mg": { active: "Aspirin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°" }
  },
  "Antibiotics": {
    "Augmentin 1g": { active: "Amoxicillin/Clav", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© ÿ£ÿ≥ÿ®Ÿàÿπ" },
    "Augmentin 625mg": { active: "Amoxicillin/Clav", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Hibiotic 1g": { active: "Amoxicillin/Clav", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Vibramycin 100mg": { active: "Doxycycline", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ (ŸÑŸÑÿ≤Ÿàÿ¨ ŸàÿßŸÑÿ≤Ÿàÿ¨ÿ©)" },
    "Doxycast 100mg": { active: "Doxycycline", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Zithromax 500mg": { active: "Azithromycin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ" },
    "Dalacin C 300mg": { active: "Clindamycin", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™" },
    "Flagyl 500mg": { active: "Metronidazole", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© 7 ÿ£ŸäÿßŸÖ" },
    "Amrizole 500mg": { active: "Metronidazole", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©" },
    "Diflucan 150mg": { active: "Fluconazole", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© (ŸÑŸÑŸÅÿ∑ÿ±Ÿäÿßÿ™)" },
    "Flucoral 150mg": { active: "Fluconazole", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã" }
  },
  "Misc & Hormonal Adjuncts": {
    "Cidophage 500mg": { active: "Metformin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ" },
    "Cidophage 850mg": { active: "Metformin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ" },
    "Cidophage 1000mg Retard": { active: "Metformin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿπÿ¥ÿßÿ°" },
    "Glucophage XR 1000mg": { active: "Metformin", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸÖÿ≥ÿßÿ°Ÿã" },
    "Dostinex 0.5mg": { active: "Cabergoline", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ŸÉŸÑ 3 ÿ£ŸäÿßŸÖ (ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ®ÿ±ŸàŸÑÿßŸÉÿ™ŸäŸÜ/OHSS)" },
    "Caberglob 0.5mg": { active: "Cabergoline", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã" },
    "Eltroxin 50mcg": { active: "Levothyroxine", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ÿπŸÑŸâ ÿßŸÑÿ±ŸäŸÇ" },
    "Euthyrox 50mcg": { active: "Levothyroxine", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ÿπŸÑŸâ ÿßŸÑÿ±ŸäŸÇ" },
    "Kapron 500mg": { active: "Tranexamic Acid", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ (ÿπŸÜÿØ ÿßŸÑŸÜÿ≤ŸäŸÅ)" },
    "Dicynone 500mg": { active: "Etamsylate", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™" },
    "Daflon 500mg": { active: "Diosmin", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "Primolut Nor 10mg": { active: "Norethisterone", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã (ŸÑÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑÿØŸàÿ±ÿ©)" },
    "Steronate 5mg": { active: "Norethisterone", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã" },
    "Cyclo-Progynova": { active: "Estradiol/Norgestrel", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã (ÿßŸÑÿ£ÿ®Ÿäÿ∂ ÿ´ŸÖ ÿßŸÑÿ®ŸÜŸä)" }
  },
  "Pain Killers & Spasmolytics": {
    "Panadol Extra": { active: "Paracetamol", dose: "ŸÇÿ±ÿµŸäŸÜ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ" },
    "Cataflam 50mg": { active: "Diclofenac Potassium", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ" },
    "Ketolac": { active: "Ketorolac", dose: "ÿ≠ŸÇŸÜÿ© ÿπÿ∂ŸÑ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ (ÿ£ŸÑŸÖ ÿ¥ÿØŸäÿØ)" },
    "Visceralgine": { active: "Tiemonium", dose: "ŸÇÿ±ÿµ 3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäÿßŸã (ŸÑŸÑŸÖÿ∫ÿµ)" },
    "Spasmo-digestin": { active: "Digestive/Spasmolytic", dose: "ŸÇÿ±ÿµ Ÿàÿ≥ÿ∑ ÿßŸÑÿ£ŸÉŸÑ" },
    "Buscopan": { active: "Hyoscine", dose: "ŸÇÿ±ÿµ ÿπŸÜÿØ ÿßŸÑŸÑÿ≤ŸàŸÖ ŸÑŸÑŸÖÿ∫ÿµ" }
  }
};

export const PROTOCOLS = ['Long', 'Antagonist', 'Flare-up', 'Mini-IVF'];

export const PROTOCOL_INFO = {
  'Long': {
    name: 'Long Agonist Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑŸÜÿßŸáÿ∂ÿßÿ™ ÿßŸÑÿ∑ŸàŸäŸÑÿ©',
    description: 'Most commonly used protocol. Down-regulation starts in luteal phase of previous cycle.',
    arabicDescription: 'ÿßŸÑÿ£ŸÉÿ´ÿ± ÿßÿ≥ÿ™ÿÆÿØÿßŸÖÿßŸã. ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸáÿ±ŸÖŸàŸÜÿßÿ™ Ÿäÿ®ÿØÿ£ ŸÖŸÜ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑŸÑŸàÿ™ŸäÿßŸÑŸäÿ© ŸÑŸÑÿØŸàÿ±ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©.',
    bestFor: ['Normal responders', 'Regular cycles', 'PCO patients'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿπÿßÿØŸäŸàŸÜ', 'ÿßŸÑÿØŸàÿ±ÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ∏ŸÖÿ©', 'ŸÖÿ™ŸÑÿßÿ≤ŸÖÿ© ÿ™ŸÉŸäÿ≥ ÿßŸÑŸÖÿ®ÿßŸäÿ∂'],
    duration: '35-42 days total',
    stimDays: '10-12 days',
    downRegDrugs: ['Decapeptyl 0.1mg Daily', 'Zoladex 3.6mg'],
    stimDrugs: ['Gonal-F 75 IU', 'Merional 75 IU', 'Fostimon 75 IU'],
    trigger: ['Ovitrelle 250mcg', 'Choriomon 5000 IU'],
    luteal: ['Cyclogest 400mg', 'Utrogestan 200mg', 'Crinone 8% Gel']
  },
  'Antagonist': {
    name: 'Antagonist Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑŸÖÿ∂ÿßÿØÿßÿ™',
    description: 'Shorter protocol. GnRH antagonists used to prevent premature LH surge. Good for poor responders.',
    arabicDescription: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿ£ŸÇÿµÿ±. ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ∂ÿßÿØÿßÿ™ ŸÑŸÖŸÜÿπ ÿßÿ±ÿ™ŸÅÿßÿπ LH ÿßŸÑŸÖÿ®ŸÉÿ±. ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸäŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°.',
    bestFor: ['Poor responders', 'Previous low response', 'PCOS with high response risk'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°', 'ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ© ÿ≥ÿßÿ®ŸÇÿ©', 'ÿ™ŸÉŸäÿ≥ ŸÖÿ®ÿßŸäÿ∂ ŸÖÿπ ÿÆÿ∑ÿ± ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿπÿßŸÑŸäÿ©'],
    duration: '14-16 days',
    stimDays: '8-10 days',
    downRegDrugs: [],
    stimDrugs: ['Gonal-F 75-150 IU', 'Merional 75 IU', 'Menopur 75 IU'],
    antagonist: ['Cetrotide 0.25mg', 'Orgalutran 0.25mg'],
    trigger: ['Ovitrelle 250mcg', 'Decapeptyl 0.1mg (Trigger)'],
    luteal: ['Cyclogest 400mg', 'Progynova 2mg']
  },
  'Flare-up': {
    name: 'Flare-up Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ™ŸÜÿ¥Ÿäÿ∑ ÿßŸÑÿ≠ÿßÿØ',
    description: 'Short protocol. Initial FSH surge from GnRH agonist boosts recruitment. Faster but needs monitoring.',
    arabicDescription: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ŸÇÿµŸäÿ±. ÿßÿ±ÿ™ŸÅÿßÿπ FSH ÿßŸÑÿ£ŸàŸÑŸä Ÿäÿπÿ≤ÿ≤ ÿ™ÿ¨ŸÜŸäÿØ ÿßŸÑÿ®ŸàŸäÿ∂ÿßÿ™. ÿ£ÿ≥ÿ±ÿπ ŸÑŸÉŸÜ Ÿäÿ≠ÿ™ÿßÿ¨ ŸÖÿ±ÿßŸÇÿ®ÿ©.',
    bestFor: ['Poor responders', 'Diminished ovarian reserve', 'Older patients'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°', 'ŸÇÿµŸàÿ± ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑŸÖÿ®Ÿäÿ∂', 'ÿßŸÑŸÖÿ±Ÿäÿ∂ÿßÿ™ ÿßŸÑÿ£ŸÉÿ®ÿ± ÿ≥ŸÜÿßŸã'],
    duration: '10-12 days',
    stimDays: '8-9 days',
    downRegDrugs: ['Decapeptyl 3.75mg Depot'],
    stimDrugs: ['Gonal-F 150-300 IU', 'Merional 150 IU'],
    trigger: ['Ovitrelle 250mcg', 'Choriomon 5000 IU'],
    luteal: ['Cyclogest 400mg', 'Duphaston 10mg']
  },
  'Mini-IVF': {
    name: 'Mini-IVF Protocol',
    arabicName: 'ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ≠ŸÇŸÜ ÿßŸÑŸÖÿ¨Ÿáÿ±Ÿä ÿßŸÑÿÆŸÅŸäŸÅ',
    description: 'Minimal stimulation. Lower hormone doses, suitable for poor responders and medical contraindications.',
    arabicDescription: 'ÿ™ŸÜÿ¥Ÿäÿ∑ ÿ®ÿ≥Ÿäÿ∑ ÿ¨ÿØÿßŸã. ÿ¨ÿ±ÿπÿßÿ™ Ÿáÿ±ŸÖŸàŸÜŸäÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ©ÿå ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸäŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ° ŸàÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ≥ÿ©.',
    bestFor: ['Poor responders', 'Previous OHSS', 'Medical contraindications'],
    arabicBestFor: ['ÿßŸÑŸÖÿ≥ÿ™ÿ¨Ÿäÿ®ŸàŸÜ ÿßŸÑÿ∂ÿπŸÅÿßÿ°', 'ŸÅÿ±ÿ∑ ÿ™ŸÜÿ®ŸäŸá ÿ≥ÿßÿ®ŸÇ', 'ŸÖŸàÿßŸÜÿπ ÿ∑ÿ®Ÿäÿ©'],
    duration: '10-14 days',
    stimDays: '7-8 days',
    downRegDrugs: [],
    stimDrugs: ['Clomid 50mg', 'Femara 2.5mg', 'Gonal-F 75 IU'],
    trigger: ['Ovitrelle 250mcg'],
    luteal: ['Cyclogest 200mg', 'Utrogestan 200mg']
  }
};

export const WHO_SPERM_PARAMS = {
  volume: 1.5,
  concentration: 15, // M/ml
  motility: 40, // %
  morphology: 4 // %
};
</file>

<file path="context/BrandingContext.tsx">
import React, { createContext, useContext, useState, useEffect } from 'react';
import { supabase } from '../services/supabaseClient';
import { authService } from '../services/authService';

interface BrandingSettings {
  id: number;
  clinic_name: string;
  logo_url: string | null;
  clinic_address: string | null;
  clinic_phone: string | null;
  primary_color: string;
  secondary_color: string;
  accent_color: string;
  updated_at: string;
}

interface BrandingContextType {
  branding: BrandingSettings | null;
  loading: boolean;
  error: string | null;
  updateBranding: (updates: Partial<BrandingSettings>, logoFile?: File) => Promise<void>;
  refreshBranding: () => Promise<void>;
}

const BrandingContext = createContext<BrandingContextType | undefined>(undefined);

export const BrandingProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [branding, setBranding] = useState<BrandingSettings | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchBranding = async () => {
    try {
      setLoading(true);
      setError(null);

      const { data, error: fetchError } = await supabase
        .from('app_settings')
        .select('*')
        .eq('id', 1)
        .single();

      if (fetchError) throw fetchError;

      setBranding(data || getDefaultBranding());
    } catch (err) {
      console.error('Failed to fetch branding:', err);
      setError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ©');
      setBranding(getDefaultBranding());
    } finally {
      setLoading(false);
    }
  };

  const getDefaultBranding = (): BrandingSettings => ({
    id: 1,
    clinic_name: 'ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±',
    logo_url: null,
    clinic_address: null,
    clinic_phone: null,
    primary_color: '#2d5a6b',
    secondary_color: '#00838f',
    accent_color: '#00bcd4',
    updated_at: new Date().toISOString(),
  });

  const updateBranding = async (
    updates: Partial<BrandingSettings>,
    logoFile?: File
  ) => {
    try {
      setError(null);

      let logoUrl = updates.logo_url;

      if (logoFile) {
        try {
          const user = await authService.getCurrentUser();
          if (!user) throw new Error('User not authenticated');

          const fileExt = logoFile.name.split('.').pop();
          const fileName = `clinic_logo_${Date.now()}.${fileExt}`;

          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('branding')
            .upload(fileName, logoFile, { upsert: true });

          if (uploadError) {
            console.error('Upload error:', uploadError);
            throw new Error('ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±: ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° bucket "branding" ŸÅŸä Supabase Storage');
          }

          const { data: urlData } = supabase.storage
            .from('branding')
            .getPublicUrl(fileName);

          logoUrl = urlData.publicUrl;
        } catch (uploadErr: any) {
          console.error('Logo upload failed:', uploadErr);
          throw uploadErr;
        }
      }

      const updateData = {
        clinic_name: updates.clinic_name || branding?.clinic_name,
        clinic_address: updates.clinic_address || branding?.clinic_address,
        clinic_phone: updates.clinic_phone || branding?.clinic_phone,
        primary_color: updates.primary_color || branding?.primary_color,
        secondary_color: updates.secondary_color || branding?.secondary_color,
        accent_color: updates.accent_color || branding?.accent_color,
        ...(logoUrl && { logo_url: logoUrl }),
        updated_at: new Date().toISOString(),
      };

      const { data, error: updateError } = await supabase
        .from('app_settings')
        .update(updateData)
        .eq('id', 1)
        .select()
        .single();

      if (updateError) {
        console.error('Update error:', updateError);
        throw updateError;
      }

      setBranding(data);
    } catch (err) {
      console.error('Failed to update branding:', err);
      setError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ©');
      throw err;
    }
  };

  const refreshBranding = async () => {
    await fetchBranding();
  };

  useEffect(() => {
    fetchBranding();
  }, []);

  return (
    <BrandingContext.Provider
      value={{
        branding: branding || getDefaultBranding(),
        loading,
        error,
        updateBranding,
        refreshBranding,
      }}
    >
      {children}
    </BrandingContext.Provider>
  );
};

export const useBranding = (): BrandingContextType => {
  const context = useContext(BrandingContext);
  if (context === undefined) {
    throw new Error('useBranding must be used within a BrandingProvider');
  }
  return context;
};
</file>

<file path="data/egyptian_drugs.ts">
export interface DrugEntry {
  tradeName: string;   // e.g., "Augmentin 1g"
  active: string;      // e.g., "Amoxicillin/Clavulanate"
  route: string;       // e.g., "ÿ£ŸÇÿ±ÿßÿµ", "ÿ≠ŸÇŸÜ", "ŸÑÿ®Ÿàÿ≥", "ŸÉÿ±ŸäŸÖ"
  dose: string;        // e.g., "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ"
  category: string;    // e.g., "Antibiotics"
}

export const EGYPTIAN_MARKET_DRUGS: Record<string, DrugEntry[]> = {
  "Induction & IVF": [
    // Oral Induction
    { tradeName: "Clomid 50mg", active: "Clomiphene Citrate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2-6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Clostilbegyt 50mg", active: "Clomiphene Citrate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2-6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Technovula 50mg", active: "Clomiphene Citrate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 2-6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Femara 2.5mg", active: "Letrozole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3-7 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Letrozole 2.5mg", active: "Letrozole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 3-7 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },

    // FSH Injectables
    { tradeName: "Gonal-F 75IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Gonal-F 300IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Gonal-F 450IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Gonal-F 900IU Pen", active: "Follitropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Merional 75IU", active: "Menotrophin (FSH/LH)", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Merional 150IU", active: "Menotrophin (FSH/LH)", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Fostimon 75IU", active: "Urofollitropin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Fostimon 150IU", active: "Urofollitropin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Menogon 75IU", active: "Menotrophin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Epigonal 0.5mg", active: "Ganirelix", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },

    // LH/FSH Combinations
    { tradeName: "Pergoveris 150IU", active: "Follitropin Alfa/Lutropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },
    { tradeName: "Luveris 75IU", active: "Lutropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ∑ÿ®Ÿä", category: "Induction & IVF" },

    // GnRH Antagonists
    { tradeName: "Cetrotide 0.25mg", active: "Cetrorelix", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },
    { tradeName: "Orgalutran 0.25mg", active: "Ganirelix", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸäŸàŸÖ 6 ŸÑŸÑÿØŸàÿ±ÿ©", category: "Induction & IVF" },

    // GnRH Agonists
    { tradeName: "Decapeptyl 0.1mg Daily", active: "Triptorelin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },
    { tradeName: "Decapeptyl 3.75mg Depot", active: "Triptorelin", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 28 ŸäŸàŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },
    { tradeName: "Zoladex 3.6mg", active: "Goserelin", route: "ÿ≤ÿ±ÿπ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≤ÿ±ÿπÿ© ŸÉŸÑ 28 ŸäŸàŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },
    { tradeName: "Lupron Depot 3.75mg", active: "Leuprolide", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 28 ŸäŸàŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ", category: "Induction & IVF" },

    // Trigger Injections
    { tradeName: "Choriomon 5000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Choriomon 10000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Epifasi 5000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Pregnyl 5000IU", active: "hCG", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
    { tradeName: "Ovitrelle 250mcg", active: "Choriogonadotropin Alfa", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ•ÿ®ÿßÿ∂ÿ©", category: "Induction & IVF" },
  ],

  "Luteal Support": [
    { tradeName: "Cyclogest 200mg", active: "Progesterone", route: "ŸÑÿ®Ÿàÿ≥ ŸÖŸáÿ®ŸÑŸä", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖÿ≥ÿßÿ°Ÿã ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Cyclogest 400mg", active: "Progesterone", route: "ŸÑÿ®Ÿàÿ≥ ŸÖŸáÿ®ŸÑŸä", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖÿ≥ÿßÿ°Ÿã ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Prontogest 100mg", active: "Progesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Prontogest 200mg", active: "Progesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Prontogest 400mg", active: "Progesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Utrogestan 100mg", active: "Progesterone", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™ ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ™ÿßŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Utrogestan 200mg", active: "Progesterone", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™ ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ™ÿßŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Duphaston 10mg", active: "Dydrogesterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Endometrin 100mg", active: "Progesterone", route: "ŸÑÿ®Ÿàÿ≥ ŸÖŸáÿ®ŸÑŸä", dose: "ŸÑÿ®Ÿàÿ≥ÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Crinone 8% Gel", active: "Progesterone", route: "ÿ¨ŸäŸÑ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
    { tradeName: "Lubgest 200mg", active: "Progesterone", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™ ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Luteal Support" },
  ],

  "Pregnancy Supplements": [
    // Folic Acid
    { tradeName: "Folic Acid 5mg (Nile)", active: "Folic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Folic Acid 5mg (Mepaco)", active: "Folic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Methylfolate 400mcg", active: "L-Methylfolate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },

    // Iron Supplements
    { tradeName: "Ferrotron", active: "Iron/Folic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Haemoton", active: "Iron/Folic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Feroglobin", active: "Iron/Vitamins", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Pravotin", active: "Iron/Folic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },

    // Calcium & Vitamin D
    { tradeName: "Osteocare", active: "Calcium/Vitamin D3", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Calcid", active: "Calcium Carbonate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Pregnancy Supplements" },
    { tradeName: "Calcimate", active: "Calcium/Vitamin D3", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Cal-Mag", active: "Calcium/Magnesium", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },

    // Prenatal Vitamins
    { tradeName: "Pregnacare Original", active: "Multivitamins", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Pregnacare Plus", active: "Multivitamins/Iron", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Elevit", active: "Multivitamins", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ Ÿàÿßÿ≠ÿØ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Limitless Woman", active: "Multivitamins", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },

    // Omega 3
    { tradeName: "Omega 3 Plus", active: "Fish Oil/DHA", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
    { tradeName: "Maxepa", active: "Omega 3", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Pregnancy Supplements" },
  ],

  "Anticoagulants": [
    { tradeName: "Clexane 20mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane 40mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane 60mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane 80mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Enoxa 40mg", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Innohep 4500IU", active: "Tinzaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Clexane T 4000IU", active: "Enoxaparin", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Juvespr 20mg", active: "Rivaroxaban", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Anticoagulants" },
    { tradeName: "Aspocid 75mg", active: "Aspirin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Anticoagulants" },
    { tradeName: "Ezacard 75mg", active: "Aspirin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿ®ÿπÿØ ÿßŸÑÿ∫ÿØÿßÿ°", category: "Anticoagulants" },
  ],

  "Antibiotics": [
    // Penicillins
    { tradeName: "Augmentin 375mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Augmentin 625mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Augmentin 1g", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Hibiotic 375mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Megamox 375mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Curam 625mg", active: "Amoxicillin/Clavulanate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },

    // Cephalosporins
    { tradeName: "Zinnat 250mg", active: "Cefuroxime", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Zinnat 500mg", active: "Cefuroxime", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Cefotax 1g", active: "Cefotaxime", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ/Ÿàÿ±ŸäÿØŸä", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Cefzone 1g", active: "Ceftriaxone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ/Ÿàÿ±ŸäÿØŸä", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Rocephin 1g", active: "Ceftriaxone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ/Ÿàÿ±ŸäÿØŸä", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },
    { tradeName: "Duricef 500mg", active: "Cefadroxil", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Antibiotics" },

    // Macrolides
    { tradeName: "Zithromax 500mg", active: "Azithromycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ", category: "Antibiotics" },
    { tradeName: "Zisrocin 500mg", active: "Azithromycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ", category: "Antibiotics" },

    // Tetracyclines
    { tradeName: "Vibramycin 100mg", active: "Doxycycline", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },
    { tradeName: "Doxycast 100mg", active: "Doxycycline", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antibiotics" },

    // Lincosamides
    { tradeName: "Dalacin C 300mg", active: "Clindamycin", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antibiotics" },

    // Nitroimidazoles
    { tradeName: "Flagyl 500mg", active: "Metronidazole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© ÿ£ÿ≥ÿ®Ÿàÿπ", category: "Antibiotics" },
    { tradeName: "Amrizole 500mg", active: "Metronidazole", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ŸÑŸÖÿØÿ© ÿ£ÿ≥ÿ®Ÿàÿπ", category: "Antibiotics" },

    // Antifungals
    { tradeName: "Diflucan 150mg", active: "Fluconazole", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©", category: "Antibiotics" },

    // UTI Specific
    { tradeName: "Uvamin Retard 400mg", active: "Fosfomycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©", category: "Antibiotics" },
    { tradeName: "Macropur 3g", active: "Nitrofurantoin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Antibiotics" },
    { tradeName: "Monuril 3g", active: "Fosfomycin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©", category: "Antibiotics" },
  ],

  "Vaginal Preparations": [
    // Antifungal
    { tradeName: "Gyno-Daktarin 400mg", active: "Miconazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },
    { tradeName: "Monicure 400mg", active: "Miconazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },
    { tradeName: "Gyno-Zalain 300mg", active: "Sertaconazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },
    { tradeName: "Candistan 100mg", active: "Clotrimazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 3 ÿ£ŸäÿßŸÖ", category: "Vaginal Preparations" },
    { tradeName: "Gyno-Trosyd 100mg", active: "Tioconazole", route: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖŸáÿ®ŸÑŸäÿ©", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ≥ÿßÿ°Ÿã", category: "Vaginal Preparations" },

    // Antibacterial
    { tradeName: "Amrizole N", active: "Metronidazole", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 5 ÿ£ŸäÿßŸÖ", category: "Vaginal Preparations" },
    { tradeName: "Betadine", active: "Povidone Iodine", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
    { tradeName: "Albothyl", active: "Polymyxin/Neomycin", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
    { tradeName: "PolgyneX", active: "Polymyxin/Neomycin", route: "ŸÉÿ±ŸäŸÖ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },

    // Cleansers
    { tradeName: "Vagyl", active: "Lactic Acid", route: "ÿ∫ÿ≥ŸàŸÑ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ∫ÿ≥ŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
    { tradeName: "Tantum Rosa", active: "Benzydamine", route: "ÿ∫ÿ≥ŸàŸÑ ŸÖŸáÿ®ŸÑŸä", dose: "ÿ∫ÿ≥ŸÑ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Vaginal Preparations" },
  ],

  "Antihypertensives": [
    { tradeName: "Aldomet 250mg", active: "Methyldopa", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antihypertensives" },
    { tradeName: "Aldomet 500mg", active: "Methyldopa", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antihypertensives" },
    { tradeName: "Adalat LA 30mg", active: "Nifedipine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antihypertensives" },
    { tradeName: "Adalat LA 60mg", active: "Nifedipine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antihypertensives" },
    { tradeName: "Epilat 30mg", active: "Nifedipine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antihypertensives" },
    { tradeName: "Dopegyt 250mg", active: "Methyldopa", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Antihypertensives" },
  ],

  "Antidiabetics": [
    // Metformin
    { tradeName: "Cidophage 500mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antidiabetics" },
    { tradeName: "Cidophage 850mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antidiabetics" },
    { tradeName: "Cidophage 1000mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ© ÿ®ÿπÿØ ÿßŸÑÿ£ŸÉŸÑ", category: "Antidiabetics" },
    { tradeName: "Glucophage XR 500mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antidiabetics" },
    { tradeName: "Glucophage XR 1000mg", active: "Metformin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antidiabetics" },

    // Sulfonylureas
    { tradeName: "Amaryl 2mg", active: "Glimepiride", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±", category: "Antidiabetics" },
    { tradeName: "Amaryl 4mg", active: "Glimepiride", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±", category: "Antidiabetics" },

    // Insulin
    { tradeName: "Mixtard 30/70", active: "Insulin Human", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Antidiabetics" },
    { tradeName: "Lantus 100IU/ml", active: "Insulin Glargine", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸäŸàŸÖŸäÿßŸã", category: "Antidiabetics" },
    { tradeName: "Apidra 100IU/ml", active: "Insulin Glulisine", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™", category: "Antidiabetics" },
    { tradeName: "Actrapid 100IU/ml", active: "Insulin Human", route: "ÿ≠ŸÇŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ŸÑÿØ", dose: "ÿ≠ŸÇŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™", category: "Antidiabetics" },
  ],

  "Analgesics": [
    // NSAIDs
    { tradeName: "Brufen 400mg", active: "Ibuprofen", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Brufen 600mg", active: "Ibuprofen", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Ponstan 500mg", active: "Mefenamic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Ponstan Forte 500mg", active: "Mefenamic Acid", route: "ŸÉÿ®ÿ≥ŸàŸÑÿßÿ™", dose: "ŸÉÿ®ÿ≥ŸàŸÑÿ© ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Cataflam 50mg", active: "Diclofenac", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 12 ÿ≥ÿßÿπÿ©", category: "Analgesics" },
    { tradeName: "Voltaren 75mg", active: "Diclofenac", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Analgesics" },
    { tradeName: "Ketolac 10mg", active: "Ketorolac", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™ ŸÑŸÖÿØÿ© 5 ÿ£ŸäÿßŸÖ", category: "Analgesics" },

    // Paracetamol
    { tradeName: "Panadol 500mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Panadol Extra 500mg", active: "Paracetamol/Caffeine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Panadol Joint 665mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Abimol 500mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },
    { tradeName: "Pyral 500mg", active: "Paracetamol", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 6 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©", category: "Analgesics" },

    // Antispasmodics
    { tradeName: "Buscopan 10mg", active: "Hyoscine Butylbromide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Visceralgine 10mg", active: "Hyoscine Butylbromide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Spasmo-digestin", active: "Hyoscine/Phenylpropanolamine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Spasmofree", active: "Hyoscine/Phenylpropanolamine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
    { tradeName: "Spasmo-Amrase", active: "Hyoscine/Phenylpropanolamine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Analgesics" },
  ],

  "Contraceptives": [
    // Combined Oral Contraceptives
    { tradeName: "Yasmin", active: "Ethinylestradiol/Drospirenone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Yaz", active: "Ethinylestradiol/Drospirenone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 24 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Gynera", active: "Ethinylestradiol/Gestodene", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Marvelon", active: "Ethinylestradiol/Desogestrel", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Cilest", active: "Ethinylestradiol/Norgestimate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },
    { tradeName: "Microlut", active: "Levonorgestrel", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ±ÿ© ÿ±ÿßÿ≠ÿ©", category: "Contraceptives" },
    { tradeName: "Diane 35", active: "Ethinylestradiol/Cyproterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸäŸàŸÖŸäÿßŸã ŸÑŸÖÿØÿ© 21 ŸäŸàŸÖÿßŸã", category: "Contraceptives" },

    // Injectable Contraceptives
    { tradeName: "Depo-Provera 150mg", active: "Medroxyprogesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 3 ÿ£ÿ¥Ÿáÿ±", category: "Contraceptives" },
    { tradeName: "Mesigyna 150mg", active: "Medroxyprogesterone", route: "ÿ≠ŸÇŸÜ ÿπÿ∂ŸÑ", dose: "ÿ≠ŸÇŸÜÿ© ŸÉŸÑ 3 ÿ£ÿ¥Ÿáÿ±", category: "Contraceptives" },

    // Emergency Contraception
    { tradeName: "Contraceplan II", active: "Levonorgestrel", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÖÿπÿßŸã ÿÆŸÑÿßŸÑ 72 ÿ≥ÿßÿπÿ©", category: "Contraceptives" },
  ],

  "Anti-Emetics": [
    { tradeName: "Navidoxine", active: "Doxylamine/Pyridoxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", category: "Anti-Emetics" },
    { tradeName: "Cortiplex B6", active: "Dexamethasone/Pyridoxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", category: "Anti-Emetics" },
    { tradeName: "Zofran 8mg", active: "Ondansetron", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Zofran 4mg", active: "Ondansetron", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Danset 10mg", active: "Domperidone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Motinorm 10mg", active: "Domperidone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Primperan 10mg", active: "Metoclopramide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
    { tradeName: "Maxolon 10mg", active: "Metoclopramide", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ", category: "Anti-Emetics" },
  ],

  "Hemostatics": [
    { tradeName: "Kapron 500mg", active: "Tranexamic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Cyklokapron 500mg", active: "Tranexamic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Haemostop 500mg", active: "Tranexamic Acid", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Dicynone 250mg", active: "Ethamsylate", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
    { tradeName: "Methergine 0.2mg", active: "Methylergometrine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÉŸÑ 8 ÿ≥ÿßÿπÿßÿ™", category: "Hemostatics" },
  ],

  "Thyroid & Hormonal": [
    // Thyroid
    { tradeName: "Eltroxin 50mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Eltroxin 100mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Euthyrox 50mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Euthyrox 100mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Thyronorm 25mcg", active: "Levothyroxine", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ÿ±ÿ®ÿπ ŸÇÿ±ÿµ ÿµÿ®ÿßÿ≠ÿßŸã", category: "Thyroid & Hormonal" },

    // Dopamine Agonists
    { tradeName: "Dostinex 0.5mg", active: "Cabergoline", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÜÿµŸÅ ŸÇÿ±ÿµ ŸÉŸÑ 3 ÿ£ŸäÿßŸÖ", category: "Thyroid & Hormonal" },

    // Progestins
    { tradeName: "Primolut N 5mg", active: "Norethisterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Provera 10mg", active: "Medroxyprogesterone", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },

    // Venotonics
    { tradeName: "Daflon 500mg", active: "Diosmin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },
    { tradeName: "Reparil 20mg", active: "Aescin", route: "ÿ£ŸÇÿ±ÿßÿµ", dose: "ŸÇÿ±ÿµ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäÿßŸã", category: "Thyroid & Hormonal" },
  ]
};

// Helper function to get all drugs as a flat array
export const getAllDrugs = (): DrugEntry[] => {
  return Object.values(EGYPTIAN_MARKET_DRUGS).flat();
};

// Helper function to get drugs by category
export const getDrugsByCategory = (category: string): DrugEntry[] => {
  return EGYPTIAN_MARKET_DRUGS[category] || [];
};

// Helper function to search drugs by name
export const searchDrugs = (query: string): DrugEntry[] => {
  const allDrugs = getAllDrugs();
  const lowerQuery = query.toLowerCase();
  return allDrugs.filter(drug =>
    drug.tradeName.toLowerCase().includes(lowerQuery) ||
    drug.active.toLowerCase().includes(lowerQuery)
  );
};
</file>

<file path="pages/components/obstetrics/ANCFlowSheet.tsx">
import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Save, X } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import toast from 'react-hot-toast';
import { AntenatalVisit } from '../../../types';
import { obstetricsService, calculateGestationalAge } from '../../../services/obstetricsService';

interface ANCFlowSheetProps {
  pregnancyId: string;
  lmpDate?: string;
}

const ANCFlowSheet: React.FC<ANCFlowSheetProps> = ({ pregnancyId, lmpDate }) => {
  const [visits, setVisits] = useState<AntenatalVisit[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    visit_date: new Date().toISOString().split('T')[0],
    systolic_bp: '',
    diastolic_bp: '',
    weight_kg: '',
    urine_albuminuria: 'negative',
    urine_glycosuria: 'negative',
    fetal_heart_sound: true,
    fundal_height_cm: '',
    edema: false,
    edema_grade: 'none',
    notes: '',
    next_visit_date: '',
  });

  useEffect(() => {
    fetchVisits();
  }, [pregnancyId]);

  const fetchVisits = async () => {
    try {
      setIsLoading(true);
      const data = await obstetricsService.getANCVisits(pregnancyId);
      setVisits(data || []);
    } catch (error) {
      console.error('Error fetching visits:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™');
    } finally {
      setIsLoading(false);
    }
  };

  const handleAddVisit = async () => {
    try {
      if (!formData.visit_date) {
        toast.error('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®');
        return;
      }

      setIsSaving(true);

      const ga = lmpDate ? calculateGestationalAge(formData.visit_date) : { weeks: 0, days: 0 };

      const visitData = {
        visit_date: formData.visit_date,
        pregnancy_id: pregnancyId,
        gestational_age_weeks: ga.weeks,
        gestational_age_days: ga.days,
        systolic_bp: formData.systolic_bp ? parseInt(formData.systolic_bp) : undefined,
        diastolic_bp: formData.diastolic_bp ? parseInt(formData.diastolic_bp) : undefined,
        weight_kg: formData.weight_kg ? parseFloat(formData.weight_kg) : undefined,
        urine_albuminuria: formData.urine_albuminuria,
        urine_glycosuria: formData.urine_glycosuria,
        fetal_heart_sound: formData.fetal_heart_sound,
        fundal_height_cm: formData.fundal_height_cm ? parseFloat(formData.fundal_height_cm) : undefined,
        edema: formData.edema,
        edema_grade: formData.edema_grade,
        notes: formData.notes,
        next_visit_date: formData.next_visit_date || undefined,
      };

      if (editingId) {
        await obstetricsService.updateANCVisit(editingId, visitData);
        toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      } else {
        await obstetricsService.createANCVisit(visitData);
        toast.success('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      }

      fetchVisits();
      resetForm();
    } catch (error) {
      console.error('Error saving visit:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©');
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteVisit = async (visitId: string) => {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©ÿü')) return;

    try {
      await obstetricsService.deleteANCVisit(visitId);
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      fetchVisits();
    } catch (error) {
      console.error('Error deleting visit:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©');
    }
  };

  const handleEditVisit = (visit: AntenatalVisit) => {
    setFormData({
      visit_date: visit.visit_date,
      systolic_bp: visit.systolic_bp?.toString() || '',
      diastolic_bp: visit.diastolic_bp?.toString() || '',
      weight_kg: visit.weight_kg?.toString() || '',
      urine_albuminuria: visit.urine_albuminuria || 'negative',
      urine_glycosuria: visit.urine_glycosuria || 'negative',
      fetal_heart_sound: visit.fetal_heart_sound ?? true,
      fundal_height_cm: visit.fundal_height_cm?.toString() || '',
      edema: visit.edema || false,
      edema_grade: visit.edema_grade || 'none',
      notes: visit.notes || '',
      next_visit_date: visit.next_visit_date || '',
    });
    setEditingId(visit.id);
    setShowForm(true);
  };

  const resetForm = () => {
    setFormData({
      visit_date: new Date().toISOString().split('T')[0],
      systolic_bp: '',
      diastolic_bp: '',
      weight_kg: '',
      urine_albuminuria: 'negative',
      urine_glycosuria: 'negative',
      fetal_heart_sound: true,
      fundal_height_cm: '',
      edema: false,
      edema_grade: 'none',
      notes: '',
      next_visit_date: '',
    });
    setEditingId(null);
    setShowForm(false);
  };

  const chartData = visits
    .slice()
    .reverse()
    .map(visit => ({
      date: new Date(visit.visit_date).toLocaleDateString('ar-EG'),
      weight: visit.weight_kg || 0,
      systolic: visit.systolic_bp || 0,
      diastolic: visit.diastolic_bp || 0,
    }))
    .filter(d => d.weight > 0 || d.systolic > 0);

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-6" dir="ltr">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-gray-900 font-[Tajawal]">üìã ANC Flowsheet</h2>
        <button
          onClick={() => setShowForm(!showForm)}
          className="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
        >
          <Plus size={18} />
          Add Visit
        </button>
      </div>

      {showForm && (
        <div className="mb-6 p-6 bg-gray-50 rounded-lg border-2 border-teal-200" dir="ltr">
          <div className="grid md:grid-cols-2 gap-4 mb-4 text-left">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Visit Date
              </label>
              <input
                type="date"
                value={formData.visit_date}
                onChange={(e) => setFormData(prev => ({ ...prev, visit_date: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Weight (kg)
              </label>
              <input
                type="number"
                step="0.1"
                value={formData.weight_kg}
                onChange={(e) => setFormData(prev => ({ ...prev, weight_kg: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Systolic BP (mmHg)
              </label>
              <input
                type="number"
                value={formData.systolic_bp}
                onChange={(e) => setFormData(prev => ({ ...prev, systolic_bp: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Diastolic BP (mmHg)
              </label>
              <input
                type="number"
                value={formData.diastolic_bp}
                onChange={(e) => setFormData(prev => ({ ...prev, diastolic_bp: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Urine Albuminuria
              </label>
              <select
                value={formData.urine_albuminuria}
                onChange={(e) => setFormData(prev => ({ ...prev, urine_albuminuria: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              >
                <option value="negative">ÿ≥ÿßŸÑÿ®</option>
                <option value="trace">ÿ£ÿ´ÿ±</option>
                <option value="1plus">+1</option>
                <option value="2plus">+2</option>
                <option value="3plus">+3</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Urine Glycosuria
              </label>
              <select
                value={formData.urine_glycosuria}
                onChange={(e) => setFormData(prev => ({ ...prev, urine_glycosuria: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              >
                <option value="negative">ÿ≥ÿßŸÑÿ®</option>
                <option value="trace">ÿ£ÿ´ÿ±</option>
                <option value="1plus">+1</option>
                <option value="2plus">+2</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Fundal Height (cm)
              </label>
              <input
                type="number"
                step="0.5"
                value={formData.fundal_height_cm}
                onChange={(e) => setFormData(prev => ({ ...prev, fundal_height_cm: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Next Visit Date
              </label>
              <input
                type="date"
                value={formData.next_visit_date}
                onChange={(e) => setFormData(prev => ({ ...prev, next_visit_date: e.target.value }))}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
              />
            </div>
          </div>

          <div className="flex items-center gap-4 mb-4">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.fetal_heart_sound}
                onChange={(e) => setFormData(prev => ({ ...prev, fetal_heart_sound: e.target.checked }))}
                className="w-4 h-4"
              />
              <span className="text-sm text-gray-700">Fetal Heart Sound (FHS) Detected</span>
            </label>

            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.edema}
                onChange={(e) => setFormData(prev => ({ ...prev, edema: e.target.checked }))}
                className="w-4 h-4"
              />
              <span className="text-sm text-gray-700">Edema Present</span>
            </label>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Clinical Notes
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
              rows={3}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
            />
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleAddVisit}
              disabled={isSaving}
              className="flex items-center gap-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
            >
              <Save size={18} />
              {isSaving ? 'Saving...' : editingId ? 'Update Visit' : 'Add Visit'}
            </button>
            <button
              onClick={resetForm}
              className="flex items-center gap-2 bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
            >
              <X size={18} />
              Cancel
            </button>
          </div>
        </div>
      )}

      {chartData.length > 1 && (
        <div className="mb-6 p-4 bg-gray-50 rounded-lg" dir="ltr">
          <h3 className="text-sm font-bold text-gray-900 mb-4">üìà Weight & BP Trends</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" />
              <YAxis yAxisId="left" />
              <YAxis yAxisId="right" orientation="right" />
              <Tooltip />
              <Legend />
              <Line yAxisId="left" type="monotone" dataKey="weight" stroke="#14b8a6" name="Weight (kg)" />
              <Line yAxisId="right" type="monotone" dataKey="systolic" stroke="#dc2626" name="Systolic BP (mmHg)" />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}

      {isLoading ? (
        <div className="text-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
        </div>
      ) : visits.length > 0 ? (
        <div className="overflow-x-auto" dir="ltr">
          <table className="w-full text-sm text-left">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-4 py-2">Visit Date</th>
                <th className="px-4 py-2">GA (wks+days)</th>
                <th className="px-4 py-2">Weight (kg)</th>
                <th className="px-4 py-2">BP (mmHg)</th>
                <th className="px-4 py-2">Urine Alb</th>
                <th className="px-4 py-2">Fundal Height (cm)</th>
                <th className="px-4 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              {visits.map((visit) => (
                <tr key={visit.id} className="border-b hover:bg-gray-50">
                  <td className="px-4 py-2">
                    {new Date(visit.visit_date).toLocaleDateString('ar-EG')}
                  </td>
                  <td className="px-4 py-2">
                    {visit.gestational_age_weeks}w+{visit.gestational_age_days}d
                  </td>
                  <td className="px-4 py-2">{visit.weight_kg || '-'}</td>
                  <td className="px-4 py-2">
                    {visit.systolic_bp && visit.diastolic_bp
                      ? `${visit.systolic_bp}/${visit.diastolic_bp}`
                      : '-'}
                  </td>
                  <td className="px-4 py-2">{visit.urine_albuminuria || '-'}</td>
                  <td className="px-4 py-2">{visit.fundal_height_cm || '-'}</td>
                  <td className="px-4 py-2 flex gap-2">
                    <button
                      onClick={() => handleEditVisit(visit)}
                      className="text-blue-600 hover:text-blue-800 font-semibold"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => handleDeleteVisit(visit.id)}
                      className="text-red-600 hover:text-red-800"
                    >
                      <Trash2 size={16} />
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <p className="text-center text-gray-500 py-8">No visits recorded yet</p>
      )}
    </div>
  );
};

export default ANCFlowSheet;
</file>

<file path="pages/Settings.tsx">
import React, { useState, useEffect } from 'react';
import { User, Building2, Lock, Upload, Save, AlertCircle, CheckCircle } from 'lucide-react';
import toast from 'react-hot-toast';
import { authService } from '../services/authService';
import { Doctor } from '../types';

interface SettingsProps {
  user: any;
}

const Settings: React.FC<SettingsProps> = ({ user }) => {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [doctor, setDoctor] = useState<Doctor | null>(null);
  const [activeTab, setActiveTab] = useState<'doctor' | 'clinic' | 'password'>('doctor');
  
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    specialization: '',
    doctor_image: '',
  });

  const [clinicData, setClinicData] = useState({
    clinic_name: '',
    clinic_address: '',
    clinic_phone: '',
    clinic_latitude: '',
    clinic_longitude: '',
    clinic_image: '',
  });

  const [passwordData, setPasswordData] = useState({
    newPassword: '',
    confirmPassword: '',
  });

  useEffect(() => {
    const fetchDoctor = async () => {
      try {
        if (user?.id) {
          await authService.ensureDoctorRecord(user.id, user.email);
          const doctorProfile = await authService.getDoctorProfile(user.id);
          setDoctor(doctorProfile);
          setFormData({
            name: doctorProfile.name || '',
            email: doctorProfile.email || '',
            phone: doctorProfile.phone || '',
            specialization: doctorProfile.specialization || '',
            doctor_image: doctorProfile.doctor_image || '',
          });
          setClinicData({
            clinic_name: doctorProfile.clinic_name || '',
            clinic_address: doctorProfile.clinic_address || '',
            clinic_phone: doctorProfile.clinic_phone || '',
            clinic_latitude: doctorProfile.clinic_latitude || '',
            clinic_longitude: doctorProfile.clinic_longitude || '',
            clinic_image: doctorProfile.clinic_image || '',
          });
        }
      } catch (error) {
        console.error('Failed to fetch doctor profile:', error);
        toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
      } finally {
        setLoading(false);
      }
    };

    fetchDoctor();
  }, [user]);

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>, type: 'doctor' | 'clinic') => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      setSaving(true);
      const imageUrl = await authService.uploadImage(user.id, file, type === 'doctor' ? 'doctor_images' : 'clinic_images');
      
      if (type === 'doctor') {
        setFormData(prev => ({ ...prev, doctor_image: imageUrl }));
      } else {
        setClinicData(prev => ({ ...prev, clinic_image: imageUrl }));
      }
      
      toast.success('ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Upload error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©');
    } finally {
      setSaving(false);
    }
  };

  const handleDoctorSave = async () => {
    try {
      setSaving(true);
      await authService.updateDoctorProfile(user.id, {
        name: formData.name,
        phone: formData.phone,
        specialization: formData.specialization,
        doctor_image: formData.doctor_image,
      });
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Save error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
    } finally {
      setSaving(false);
    }
  };

  const handleClinicSave = async () => {
    try {
      setSaving(true);
      await authService.updateDoctorProfile(user.id, clinicData);
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Save error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤');
    } finally {
      setSaving(false);
    }
  };

  const handlePasswordSave = async () => {
    if (passwordData.newPassword !== passwordData.confirmPassword) {
      toast.error('ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©');
      return;
    }

    if (passwordData.newPassword.length < 6) {
      toast.error('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
      return;
    }

    try {
      setSaving(true);
      await authService.updatePassword(passwordData.newPassword);
      setPasswordData({ newPassword: '', confirmPassword: '' });
      toast.success('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Password update error:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto">
      <h2 className="text-3xl font-bold text-gray-900 mb-8">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>

      <div className="flex gap-4 mb-8 border-b border-gray-200">
        <button
          onClick={() => setActiveTab('doctor')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'doctor'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <User size={20} />
          ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä
        </button>
        <button
          onClick={() => setActiveTab('clinic')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'clinic'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <Building2 size={20} />
          ÿßŸÑŸÖÿ±ŸÉÿ≤
        </button>
        <button
          onClick={() => setActiveTab('password')}
          className={`flex items-center gap-2 px-4 py-3 font-[Tajawal] font-semibold border-b-2 transition-colors ${
            activeTab === 'password'
              ? 'border-teal-600 text-teal-600'
              : 'border-transparent text-gray-500 hover:text-gray-700'
          }`}
        >
          <Lock size={20} />
          ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
        </button>
      </div>

      {activeTab === 'doctor' && (
        <div className="bg-white rounded-lg shadow-md p-8">
          <div className="grid md:grid-cols-2 gap-8">
            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®</h3>
              
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿßŸÑÿßÿ≥ŸÖ</label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                <input
                  type="email"
                  value={formData.email}
                  disabled
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿßŸÑŸáÿßÿ™ŸÅ</label>
                <input
                  type="tel"
                  value={formData.phone}
                  onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿßŸÑÿ™ÿÆÿµÿµ</label>
                <input
                  type="text"
                  value={formData.specialization}
                  onChange={(e) => setFormData(prev => ({ ...prev, specialization: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <button
                onClick={handleDoctorSave}
                disabled={saving}
                className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
              >
                <Save size={18} />
                {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}
              </button>
            </div>

            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6">ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
              
              <div className="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
                {formData.doctor_image ? (
                  <div className="mb-4">
                    <img
                      src={formData.doctor_image}
                      alt="Doctor profile"
                      className="w-40 h-40 rounded-full mx-auto object-cover border-4 border-teal-600 mb-4"
                    />
                  </div>
                ) : (
                  <User size={64} className="mx-auto text-gray-400 mb-4" />
                )}
                
                <label className="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg cursor-pointer font-[Tajawal] font-semibold transition-colors">
                  <Upload size={18} />
                  ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => handleImageUpload(e, 'doctor')}
                    disabled={saving}
                    className="hidden"
                  />
                </label>
                
                <p className="text-xs text-gray-500 mt-4">PNG, JPG ÿ≠ÿ™Ÿâ 10MB</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'clinic' && (
        <div className="bg-white rounded-lg shadow-md p-8">
          <div className="grid md:grid-cols-2 gap-8">
            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤</h3>
              
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤</label>
                <input
                  type="text"
                  value={clinicData.clinic_name}
                  onChange={(e) => setClinicData(prev => ({ ...prev, clinic_name: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                <textarea
                  value={clinicData.clinic_address}
                  onChange={(e) => setClinicData(prev => ({ ...prev, clinic_address: e.target.value }))}
                  rows={3}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                <input
                  type="tel"
                  value={clinicData.clinic_phone}
                  onChange={(e) => setClinicData(prev => ({ ...prev, clinic_phone: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                />
              </div>

              <div className="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">ÿÆÿ∑ ÿßŸÑÿπÿ±ÿ∂</label>
                  <input
                    type="text"
                    value={clinicData.clinic_latitude}
                    onChange={(e) => setClinicData(prev => ({ ...prev, clinic_latitude: e.target.value }))}
                    placeholder="30.0444"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">ÿÆÿ∑ ÿßŸÑÿ∑ŸàŸÑ</label>
                  <input
                    type="text"
                    value={clinicData.clinic_longitude}
                    onChange={(e) => setClinicData(prev => ({ ...prev, clinic_longitude: e.target.value }))}
                    placeholder="31.2357"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
                  />
                </div>
              </div>

              <button
                onClick={handleClinicSave}
                disabled={saving}
                className="w-full flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
              >
                <Save size={18} />
                {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}
              </button>
            </div>

            <div>
              <h3 className="text-xl font-bold text-gray-900 mb-6">ÿ¥ÿπÿßÿ±/ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ±ŸÉÿ≤</h3>
              
              <div className="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
                {clinicData.clinic_image ? (
                  <div className="mb-4">
                    <img
                      src={clinicData.clinic_image}
                      alt="Clinic logo"
                      className="w-40 h-40 rounded-lg mx-auto object-cover border-4 border-teal-600 mb-4"
                    />
                  </div>
                ) : (
                  <Building2 size={64} className="mx-auto text-gray-400 mb-4" />
                )}
                
                <label className="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg cursor-pointer font-[Tajawal] font-semibold transition-colors">
                  <Upload size={18} />
                  ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => handleImageUpload(e, 'clinic')}
                    disabled={saving}
                    className="hidden"
                  />
                </label>
                
                <p className="text-xs text-gray-500 mt-4">PNG, JPG ÿ≠ÿ™Ÿâ 10MB</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'password' && (
        <div className="bg-white rounded-lg shadow-md p-8 max-w-xl">
          <h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
            <AlertCircle size={24} className="text-orange-500" />
            ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
          </h3>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©</label>
            <input
              type="password"
              value={passwordData.newPassword}
              onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©"
            />
          </div>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
            <input
              type="password"
              value={passwordData.confirmPassword}
              onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
              placeholder="ÿ£ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±"
            />
          </div>

          <p className="text-sm text-gray-600 mb-6 flex items-center gap-2">
            <AlertCircle size={16} />
            ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ
          </p>

          <button
            onClick={handlePasswordSave}
            disabled={saving}
            className="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            <Save size={18} />
            {saving ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...' : 'ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±'}
          </button>
        </div>
      )}
    </div>
  );
};

export default Settings;
</file>

<file path="services/obstetricsService.ts">
import { supabase } from './supabaseClient';
import { Pregnancy, AntenatalVisit, BiometryScan } from '../types';

// ============================================================================
// CALCULATION FUNCTIONS
// ============================================================================

export const calculateGestationalAge = (lmpDate: string): { weeks: number; days: number } => {
  const today = new Date();
  const lmp = new Date(lmpDate);
  const diffTime = Math.abs(today.getTime() - lmp.getTime());
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  const weeks = Math.floor(diffDays / 7);
  const days = diffDays % 7;
  return { weeks, days };
};

export const calculateEDD = (lmpDate: string): string => {
  const lmp = new Date(lmpDate);
  lmp.setDate(lmp.getDate() + 280);
  return lmp.toISOString().split('T')[0];
};

export const calculateGAFromEDD = (eddDate: string): { weeks: number; days: number } => {
  const today = new Date();
  const edd = new Date(eddDate);
  const diffTime = edd.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  const weeksRemaining = Math.floor(diffDays / 7);
  const daysRemaining = diffDays % 7;
  const gaWeeks = 40 - weeksRemaining;
  const gaDays = 7 - daysRemaining;
  return { weeks: Math.max(0, gaWeeks), days: Math.max(0, gaDays) };
};

// Hadlock formula for Estimated Fetal Weight (EFW)
export const calculateEFW = (
  bpdMm: number,
  hcMm: number,
  acMm: number,
  flMm: number
): number => {
  const log10EFW =
    1.3404 +
    0.0438 * hcMm +
    0.158 * acMm +
    0.0061 * bpdMm -
    0.002322 * acMm * bpdMm;

  return Math.round(Math.pow(10, log10EFW));
};

// Calculate percentile based on RCOG/NICE standards (simplified)
export const calculatePercentile = (efwGrams: number, gaWeeks: number): number => {
  const expectedWeights: { [key: number]: { p10: number; p50: number; p90: number } } = {
    20: { p10: 300, p50: 330, p90: 370 },
    22: { p10: 430, p50: 475, p90: 540 },
    24: { p10: 600, p50: 660, p90: 750 },
    26: { p10: 760, p50: 850, p90: 980 },
    28: { p10: 1000, p50: 1100, p90: 1270 },
    30: { p10: 1300, p50: 1440, p90: 1680 },
    32: { p10: 1600, p50: 1840, p90: 2150 },
    34: { p10: 2100, p50: 2450, p90: 2850 },
    36: { p10: 2600, p50: 3000, p90: 3500 },
    38: { p10: 3000, p50: 3400, p90: 3900 },
    40: { p10: 3200, p50: 3500, p90: 3900 },
  };

  const weights = expectedWeights[gaWeeks];
  if (!weights) return 50;

  if (efwGrams <= weights.p10) return 10;
  if (efwGrams >= weights.p90) return 90;
  if (efwGrams <= weights.p50) {
    return 10 + ((efwGrams - weights.p10) / (weights.p50 - weights.p10)) * 40;
  }
  return 50 + ((efwGrams - weights.p50) / (weights.p90 - weights.p50)) * 40;
};

// ============================================================================
// RISK ASSESSMENT
// ============================================================================

export interface RiskFactors {
  age_over_40: boolean;
  bmi_over_30: boolean;
  previous_preeclampsia: boolean;
  twins: boolean;
  autoimmune: boolean;
  hypertension: boolean;
  diabetes: boolean;
  kidney_disease: boolean;
}

export const assessRiskLevel = (
  riskFactors: RiskFactors
): {
  level: 'low' | 'moderate' | 'high';
  riskFactorsList: string[];
  aspirinNeeded: boolean;
  thromboprophylaxisNeeded: boolean;
} => {
  const highRiskFactors = [
    riskFactors.previous_preeclampsia,
    riskFactors.hypertension,
    riskFactors.kidney_disease,
    riskFactors.diabetes,
    riskFactors.autoimmune,
  ].filter(Boolean).length;

  const moderateRiskFactors = [
    riskFactors.age_over_40,
    riskFactors.bmi_over_30,
    riskFactors.twins,
  ].filter(Boolean).length;

  let level: 'low' | 'moderate' | 'high' = 'low';
  let aspirinNeeded = false;
  let thromboprophylaxisNeeded = false;
  const riskFactorsList: string[] = [];

  if (highRiskFactors >= 1) {
    level = 'high';
    aspirinNeeded = true;
  } else if (moderateRiskFactors >= 2) {
    level = 'high';
    aspirinNeeded = true;
  } else if (moderateRiskFactors >= 1 || highRiskFactors === 0) {
    level = 'moderate';
  }

  if (riskFactors.twins) {
    thromboprophylaxisNeeded = true;
  }

  if (riskFactors.age_over_40) riskFactorsList.push('Age > 40');
  if (riskFactors.bmi_over_30) riskFactorsList.push('BMI > 30');
  if (riskFactors.previous_preeclampsia) riskFactorsList.push('Previous Pre-eclampsia');
  if (riskFactors.twins) riskFactorsList.push('Multiple Pregnancy');
  if (riskFactors.autoimmune) riskFactorsList.push('Autoimmune Disease');
  if (riskFactors.hypertension) riskFactorsList.push('Hypertension');
  if (riskFactors.diabetes) riskFactorsList.push('Diabetes');
  if (riskFactors.kidney_disease) riskFactorsList.push('Kidney Disease');

  return { level, riskFactorsList, aspirinNeeded, thromboprophylaxisNeeded };
};

// ============================================================================
// DUE ACTIONS / ALERTS
// ============================================================================

export const getDueActions = (gaWeeks: number): string[] => {
  const actions: string[] = [];

  if (gaWeeks >= 11 && gaWeeks <= 13) {
    actions.push('‚ö†Ô∏è Nuchal Translucency (NT) Scan Due');
  }
  if (gaWeeks >= 15 && gaWeeks <= 20) {
    actions.push('‚ö†Ô∏è Quad Screen / NIPT Results Expected');
  }
  if (gaWeeks >= 20 && gaWeeks <= 22) {
    actions.push('‚ö†Ô∏è Mid-Trimester Anomaly Scan Due');
  }
  if (gaWeeks === 28) {
    actions.push('üíâ Anti-D Prophylaxis Due (if Rh negative)');
    actions.push('üß™ Glucose Tolerance Test (GTT) Due');
    actions.push('üíâ Tetanus Booster if needed');
  }
  if (gaWeeks >= 34 && gaWeeks <= 36) {
    actions.push('‚ö†Ô∏è Growth Scan Recommended');
    actions.push('üß™ Full Blood Count (FBC)');
  }
  if (gaWeeks >= 36) {
    actions.push('üë∂ Position Check (Cephalic/Breech)');
    actions.push('üìã Discuss Birth Plan');
  }

  return actions;
};

// ============================================================================
// DATABASE OPERATIONS
// ============================================================================

export const obstetricsService = {
  // PREGNANCIES
  createPregnancy: async (pregnancy: Omit<Pregnancy, 'id' | 'created_at' | 'updated_at'>) => {
    try {
      const { data, error } = await supabase
        .from('pregnancies')
        .insert([pregnancy])
        .select()
        .single();

      if (error) {
        console.error('Supabase error inserting pregnancy:', error);
        throw new Error(`Failed to create pregnancy: ${error.message}`);
      }
      return data;
    } catch (err: any) {
      console.error('Exception in createPregnancy:', err);
      throw err;
    }
  },

  getPregnancyByPatient: async (patientId: string) => {
    const { data, error } = await supabase
      .from('pregnancies')
      .select('*')
      .eq('patient_id', patientId)
      .order('created_at', { ascending: false })
      .single();

    if (error && error.code !== 'PGRST116') throw error;
    return data;
  },

  updatePregnancy: async (pregnancyId: string, updates: Partial<Pregnancy>) => {
    const { data, error } = await supabase
      .from('pregnancies')
      .update(updates)
      .eq('id', pregnancyId)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  // ANTENATAL VISITS
  createANCVisit: async (visit: Omit<AntenatalVisit, 'id' | 'created_at'>) => {
    const { data, error } = await supabase
      .from('antenatal_visits')
      .insert([visit])
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  getANCVisits: async (pregnancyId: string) => {
    const { data, error } = await supabase
      .from('antenatal_visits')
      .select('*')
      .eq('pregnancy_id', pregnancyId)
      .order('visit_date', { ascending: false });

    if (error) throw error;
    return data;
  },

  updateANCVisit: async (visitId: string, updates: Partial<AntenatalVisit>) => {
    const { data, error } = await supabase
      .from('antenatal_visits')
      .update(updates)
      .eq('id', visitId)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  deleteANCVisit: async (visitId: string) => {
    const { error } = await supabase
      .from('antenatal_visits')
      .delete()
      .eq('id', visitId);

    if (error) throw error;
  },

  // BIOMETRY SCANS
  createBiometryScan: async (scan: Omit<BiometryScan, 'id' | 'created_at'>) => {
    const { data, error } = await supabase
      .from('biometry_scans')
      .insert([scan])
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  getBiometryScans: async (pregnancyId: string) => {
    const { data, error } = await supabase
      .from('biometry_scans')
      .select('*')
      .eq('pregnancy_id', pregnancyId)
      .order('scan_date', { ascending: false });

    if (error) throw error;
    return data;
  },

  updateBiometryScan: async (scanId: string, updates: Partial<BiometryScan>) => {
    const { data, error } = await supabase
      .from('biometry_scans')
      .update(updates)
      .eq('id', scanId)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  deleteBiometryScan: async (scanId: string) => {
    const { error } = await supabase
      .from('biometry_scans')
      .delete()
      .eq('id', scanId);

    if (error) throw error;
  },
};
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    rollupOptions: {
      output: {
        manualChunks: undefined
      }
    }
  }
});
</file>

<file path="electron/main.js">
const { app, BrowserWindow, ipcMain } = require('electron');
const path = require('path');

// ŸÖŸÜÿπ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÇŸÅ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ (ŸÅŸä ŸÖÿßŸÉ)
let mainWindow;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1280,
    height: 800,
    minWidth: 1024,
    minHeight: 768,
    title: "Nile IVF Center EMR",
    webPreferences: {
      nodeIntegration: false, // ŸÑŸÑÿ£ŸÖÿßŸÜ
      contextIsolation: true, // ŸÑŸÑÿ£ŸÖÿßŸÜ
      preload: path.join(__dirname, 'preload.js')
    },
    // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿπŸÑŸàŸä ŸÑŸÖÿ∏Ÿáÿ± ÿ£ŸÉÿ´ÿ± ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©
    autoHideMenuBar: true 
  });

  // ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑŸÖÿ≠ŸÑŸä
  // ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ (ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≥ÿ∑Ÿäÿ®)ÿå ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ index.html
  const isDev = !app.isPackaged;
  
  if (isDev) {
    mainWindow.loadURL('http://localhost:5173');
    // ŸÅÿ™ÿ≠ ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
    // mainWindow.webContents.openDevTools();
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));
  }
}

app.whenReady().then(() => {
  createWindow();

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

// ŸáŸÜÿß ÿ≥ŸÜÿ∂ŸäŸÅ ŸÑÿßÿ≠ŸÇÿßŸã (IPC Handlers) ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ∑ÿ®ÿßÿπÿ©
// ŸÖÿ´ÿßŸÑ:
// ipcMain.handle('save-patient', async (event, data) => { ... })
</file>

<file path="pages/AdminDashboard.tsx">
import React, { useState, useEffect } from 'react';
import {
  Settings, Palette, FileText, Database, Upload, Save, AlertCircle,
  CheckCircle, Loader, Trash2, Edit2, X
} from 'lucide-react';
import toast from 'react-hot-toast';
import { useBranding } from '../context/BrandingContext';
import { supabase } from '../services/supabaseClient';
import { EGYPTIAN_DRUGS } from '../constants';

interface TabState {
  active: 'branding' | 'prescription' | 'records';
}

const AdminDashboard: React.FC = () => {
  const { branding, updateBranding, loading: brandingLoading } = useBranding();
  const [activeTab, setActiveTab] = useState<'branding' | 'prescription' | 'records'>('branding');
  const [saving, setSaving] = useState(false);
  const [logoPreview, setLogoPreview] = useState<string | null>(null);

  const [brandingData, setBrandingData] = useState({
    clinic_name: '',
    clinic_address: '',
    clinic_phone: '',
    primary_color: '#2d5a6b',
    secondary_color: '#00838f',
    accent_color: '#00bcd4',
  });

  const [prescriptionDefaults, setPrescriptionDefaults] = useState({
    instructions: '',
    defaultCategory: 'Vitamins & Supplements',
  });

  const [records, setRecords] = useState<any[]>([]);
  const [recordsLoading, setRecordsLoading] = useState(false);

  useEffect(() => {
    if (branding) {
      setBrandingData({
        clinic_name: branding.clinic_name,
        clinic_address: branding.clinic_address || '',
        clinic_phone: branding.clinic_phone || '',
        primary_color: branding.primary_color,
        secondary_color: branding.secondary_color,
        accent_color: branding.accent_color,
      });
      if (branding.logo_url) {
        setLogoPreview(branding.logo_url);
      }
    }
  }, [branding]);

  const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setLogoPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleBrandingSave = async () => {
    try {
      setSaving(true);
      const fileInput = document.querySelector('[type="file"]') as HTMLInputElement;
      const logoFile = fileInput?.files?.[0];
      
      if (!brandingData.clinic_name.trim()) {
        toast.error('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸäÿßÿØÿ©');
        return;
      }

      await updateBranding(
        {
          clinic_name: brandingData.clinic_name,
          clinic_address: brandingData.clinic_address,
          clinic_phone: brandingData.clinic_phone,
          primary_color: brandingData.primary_color,
          secondary_color: brandingData.secondary_color,
          accent_color: brandingData.accent_color,
        },
        logoFile
      );

      toast.success('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      if (fileInput) fileInput.value = '';
    } catch (error: any) {
      console.error('Error saving branding:', error);
      const errorMsg = error?.message || 'ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™';
      toast.error(errorMsg);
    } finally {
      setSaving(false);
    }
  };

  const loadRecords = async () => {
    try {
      setRecordsLoading(true);
      const { data, error } = await supabase
        .from('visits')
        .select('id, date, patient_id, diagnosis, department')
        .order('date', { ascending: false })
        .limit(50);

      if (error) {
        console.error('Error loading records:', error);
        throw error;
      }
      setRecords(data || []);
    } catch (error: any) {
      console.error('Error loading records:', error);
      const errorMsg = error?.message || 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ¨ÿØŸàŸÑ visits ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™';
      toast.error(errorMsg);
    } finally {
      setRecordsLoading(false);
    }
  };

  useEffect(() => {
    if (activeTab === 'records') {
      loadRecords();
    }
  }, [activeTab]);

  const deleteRecord = async (id: string) => {
    if (!window.confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑÿü')) return;

    try {
      const { error } = await supabase
        .from('visits')
        .delete()
        .eq('id', id);

      if (error) throw error;

      setRecords(records.filter(r => r.id !== id));
      toast.success('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error deleting record:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ');
    }
  };

  return (
    <div className="space-y-6" dir="rtl">
      {/* Header */}
      <div className="flex items-center gap-3 mb-8">
        <div className="p-3 bg-indigo-100 rounded-lg">
          <Settings className="w-8 h-8 text-indigo-600" />
        </div>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ•ÿØÿßÿ±ÿ©</h1>
          <p className="text-gray-600">ÿ•ÿØÿßÿ±ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸàÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ© ŸàÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</p>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="flex gap-2 border-b border-gray-200">
        <button
          onClick={() => setActiveTab('branding')}
          className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors ${
            activeTab === 'branding'
              ? 'border-b-2 border-indigo-600 text-indigo-600'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <Palette size={20} />
          ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ™ÿµŸÖŸäŸÖ
        </button>
        <button
          onClick={() => setActiveTab('prescription')}
          className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors ${
            activeTab === 'prescription'
              ? 'border-b-2 border-indigo-600 text-indigo-600'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <FileText size={20} />
          ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©
        </button>
        <button
          onClick={() => setActiveTab('records')}
          className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors ${
            activeTab === 'records'
              ? 'border-b-2 border-indigo-600 text-indigo-600'
              : 'text-gray-600 hover:text-gray-900'
          }`}
        >
          <Database size={20} />
          ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
        </button>
      </div>

      {/* Content */}
      <div className="bg-white rounded-lg shadow-md p-8">
        {/* Branding Tab */}
        {activeTab === 'branding' && (
          <div className="space-y-6">
            {/* Setup Guide */}
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-3">
              <h3 className="font-semibold text-amber-900 flex items-center gap-2">
                <AlertCircle className="w-5 h-5" />
                ÿ•ÿπÿØÿßÿØ ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ¥ÿπÿßÿ±
              </h3>
              <div className="text-sm text-amber-800 space-y-2">
                <p>ŸÑÿ™ŸÖŸÉŸäŸÜ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±ÿßÿ™ÿå ÿ™ÿßÿ®ÿπ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿ∑Ÿàÿßÿ™:</p>
                <ol className="list-decimal list-inside space-y-1 ml-2">
                  <li>ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ <strong>Supabase Dashboard ‚Üí Storage</strong></li>
                  <li>ÿßŸÜŸÇÿ± ÿπŸÑŸâ <strong>Create new bucket</strong></li>
                  <li>ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ: <code className="bg-amber-100 px-2 py-1 rounded">branding</code></li>
                  <li>ÿßÿÆÿ™ÿ± <strong>Public bucket</strong></li>
                  <li>ÿßŸÜŸÇÿ± <strong>Create bucket</strong></li>
                </ol>
              </div>
            </div>
            <div className="grid md:grid-cols-2 gap-6">
              {/* Clinic Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤ / ÿßŸÑÿπŸäÿßÿØÿ©
                </label>
                <input
                  type="text"
                  value={brandingData.clinic_name}
                  onChange={(e) => setBrandingData(prev => ({
                    ...prev,
                    clinic_name: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ŸÖÿ´ÿßŸÑ: ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±"
                />
              </div>

              {/* Clinic Phone */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
                </label>
                <input
                  type="tel"
                  value={brandingData.clinic_phone}
                  onChange={(e) => setBrandingData(prev => ({
                    ...prev,
                    clinic_phone: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ŸÖÿ´ÿßŸÑ: 201001234567+"
                />
              </div>

              {/* Clinic Address */}
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿßŸÑÿπŸÜŸàÿßŸÜ
                </label>
                <textarea
                  value={brandingData.clinic_address}
                  onChange={(e) => setBrandingData(prev => ({
                    ...prev,
                    clinic_address: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸäÿßÿØÿ©"
                  rows={3}
                />
              </div>
            </div>

            {/* Logo Upload */}
            <div className="border-t pt-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <Upload size={20} />
                ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸäÿßÿØÿ©
              </h3>
              <div className="grid md:grid-cols-2 gap-6">
                {/* Upload Area */}
                <div>
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors cursor-pointer">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleLogoUpload}
                      className="hidden"
                      id="logo-upload"
                    />
                    <label htmlFor="logo-upload" className="cursor-pointer">
                      <Upload className="w-12 h-12 text-gray-400 mx-auto mb-2" />
                      <p className="text-sm text-gray-600">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</p>
                      <p className="text-xs text-gray-500">PNG, JPG, GIF (ÿ≠ÿØ ÿ£ŸÇÿµŸâ 5 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™)</p>
                    </label>
                  </div>
                </div>

                {/* Preview */}
                {logoPreview && (
                  <div className="flex flex-col items-center justify-center">
                    <div className="bg-gray-50 rounded-lg p-4 w-full">
                      <img
                        src={logoPreview}
                        alt="Logo Preview"
                        className="w-32 h-32 object-contain mx-auto"
                      />
                    </div>
                    <p className="text-sm text-gray-600 mt-2">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±</p>
                  </div>
                )}
              </div>
            </div>

            {/* Colors */}
            <div className="border-t pt-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">ÿßŸÑÿ£ŸÑŸàÿßŸÜ</h3>
              <div className="grid md:grid-cols-3 gap-6">
                {/* Primary Color */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
                  </label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={brandingData.primary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        primary_color: e.target.value
                      }))}
                      className="w-12 h-12 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      value={brandingData.primary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        primary_color: e.target.value
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>

                {/* Secondary Color */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ´ÿßŸÜŸàŸä
                  </label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={brandingData.secondary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        secondary_color: e.target.value
                      }))}
                      className="w-12 h-12 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      value={brandingData.secondary_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        secondary_color: e.target.value
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>

                {/* Accent Color */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ŸÑŸàŸÜ ÿßŸÑÿ™ŸÖŸäŸäÿ≤
                  </label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={brandingData.accent_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        accent_color: e.target.value
                      }))}
                      className="w-12 h-12 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      value={brandingData.accent_color}
                      onChange={(e) => setBrandingData(prev => ({
                        ...prev,
                        accent_color: e.target.value
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Save Button */}
            <div className="flex gap-4 pt-6 border-t">
              <button
                onClick={handleBrandingSave}
                disabled={saving || brandingLoading}
                className="flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white rounded-lg font-medium transition-colors"
              >
                {saving ? (
                  <>
                    <Loader size={18} className="animate-spin" />
                    ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...
                  </>
                ) : (
                  <>
                    <Save size={18} />
                    ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                  </>
                )}
              </button>
            </div>
          </div>
        )}

        {/* Prescription Tab */}
        {activeTab === 'prescription' && (
          <div className="space-y-6">
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex gap-3">
              <AlertCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
              <div>
                <h4 className="font-semibold text-blue-900">ŸÖÿπŸÑŸàŸÖÿ©</h4>
                <p className="text-sm text-blue-700">
                  Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ŸäŸÖŸÉŸÜŸÉ ŸáŸÜÿß ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ±Ÿàÿ¥ÿ™ÿßÿ™.
                </p>
              </div>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿßŸÑŸÅÿ¶ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ£ÿØŸàŸäÿ©
                </label>
                <select
                  value={prescriptionDefaults.defaultCategory}
                  onChange={(e) => setPrescriptionDefaults(prev => ({
                    ...prev,
                    defaultCategory: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                  {Object.keys(EGYPTIAN_DRUGS).map(category => (
                    <option key={category} value={category}>
                      {category}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ±Ÿàÿ¥ÿ™ÿ©
                </label>
                <textarea
                  value={prescriptionDefaults.instructions}
                  onChange={(e) => setPrescriptionDefaults(prev => ({
                    ...prev,
                    instructions: e.target.value
                  }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ŸÖÿ´ÿßŸÑ: ÿßÿ™ÿ®ÿπ ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ®ÿØŸÇÿ©... ÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿØŸàÿßÿ° ŸÖÿπ ÿßŸÑÿ∑ÿπÿßŸÖ..."
                  rows={4}
                />
              </div>

              <button
                onClick={() => {
                  toast.success('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ©');
                }}
                className="flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
              >
                <Save size={18} />
                ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
              </button>
            </div>

            {/* Available Drugs */}
            <div className="mt-8 border-t pt-8">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h3>
              <div className="grid md:grid-cols-2 gap-4">
                {Object.entries(EGYPTIAN_DRUGS).map(([category, drugs]) => (
                  <div key={category} className="bg-gray-50 rounded-lg p-4">
                    <h4 className="font-semibold text-gray-900 mb-2 text-right">{category}</h4>
                    <ul className="text-sm text-gray-600 space-y-1">
                      {Object.keys(drugs).slice(0, 5).map(drug => (
                        <li key={drug} className="text-right">‚Ä¢ {drug}</li>
                      ))}
                      {Object.keys(drugs).length > 5 && (
                        <li className="text-gray-500">... Ÿà {Object.keys(drugs).length - 5} ÿ£ÿØŸàŸäÿ© ÿ£ÿÆÿ±Ÿâ</li>
                      )}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Records Tab */}
        {activeTab === 'records' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h3 className="text-lg font-semibold text-gray-900">ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ©</h3>
              <button
                onClick={loadRecords}
                className="text-indigo-600 hover:text-indigo-700 text-sm font-medium"
              >
                ‚Üê ÿ™ÿ≠ÿØŸäÿ´
              </button>
            </div>

            {recordsLoading ? (
              <div className="flex items-center justify-center py-12">
                <Loader className="animate-spin w-8 h-8 text-indigo-600" />
              </div>
            ) : records.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑŸÇÿ≥ŸÖ</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {records.map(record => (
                      <tr key={record.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-600">
                          {new Date(record.date).toLocaleDateString('ar-EG')}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600">{record.patient_id}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{record.diagnosis || '-'}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{record.department || 'ÿπÿßŸÖ'}</td>
                        <td className="px-4 py-3 text-sm">
                          <button
                            onClick={() => deleteRecord(record.id)}
                            className="text-red-600 hover:text-red-700 font-medium flex items-center gap-1"
                          >
                            <Trash2 size={16} />
                            ÿ≠ÿ∞ŸÅ
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default AdminDashboard;
</file>

<file path="pages/Dashboard.tsx">
import React, { useEffect, useState } from 'react';
import { Users, Activity, CalendarCheck, TrendingUp, Loader2 } from 'lucide-react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
import { db } from '../services/ivfService';
import { Patient } from '../types';
import { useBranding } from '../context/BrandingContext';

const Dashboard: React.FC = () => {
  const { branding } = useBranding();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    totalPatients: 0,
    activeCycles: 0,
    todayVisits: 0
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const patients = await db.getPatients();
        const cycles = await db.getCycles();
        // In a real app, we'd query visits by date via Supabase directly for performance
        // const visits = await db.getVisits(); 
        
        setStats({
          totalPatients: patients.length,
          activeCycles: cycles.filter(c => c.status === 'Active').length,
          todayVisits: 5 // Mock for now until visits table is fully populated
        });
      } catch (error) {
        console.error("Failed to load dashboard data");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // Mock Data for Charts (Keep static for UI demo)
  const growthData = [
    { name: 'Jan', patients: 30 },
    { name: 'Feb', patients: 45 },
    { name: 'Mar', patients: 60 },
    { name: 'Apr', patients: 90 },
    { name: 'May', patients: 110 },
    { name: 'Jun', patients: 150 },
  ];

  const visitTypes = [
    { name: 'Consultation', value: 400 },
    { name: 'Scan', value: 300 },
    { name: 'Lab', value: 300 },
    { name: 'Procedure', value: 200 },
  ];
  
  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042'];

  if (loading) {
    return (
      <div className="flex h-[80vh] items-center justify-center">
        <Loader2 className="w-10 h-10 animate-spin text-teal-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <header className="mb-6 md:mb-8">
        <h2 className="text-3xl font-bold text-gray-800">{branding?.clinic_name || 'Dashboard Overview'}</h2>
        <p className="text-gray-500">Welcome back to your clinic management system</p>
      </header>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
        <div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-400">Total Patients</p>
            <h3 className="text-3xl font-bold text-gray-800 mt-1">{stats.totalPatients}</h3>
          </div>
          <div className="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
            <Users className="w-6 h-6" />
          </div>
        </div>

        <div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-400">Active Cycles</p>
            <h3 className="text-3xl font-bold text-teal-600 mt-1">{stats.activeCycles}</h3>
          </div>
          <div className="w-12 h-12 rounded-full bg-teal-50 flex items-center justify-center text-teal-600">
            <Activity className="w-6 h-6" />
          </div>
        </div>

        <div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-400">Today's Visits</p>
            <h3 className="text-3xl font-bold text-purple-600 mt-1">{stats.todayVisits}</h3>
          </div>
          <div className="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600">
            <CalendarCheck className="w-6 h-6" />
          </div>
        </div>
      </div>

      {/* Charts Section */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        
        {/* Patient Growth Area Chart */}
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div className="flex items-center justify-between mb-6">
            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-teal-600" />
              Patient Growth
            </h3>
          </div>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={growthData}>
                <defs>
                  <linearGradient id="colorPatients" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#00838f" stopOpacity={0.1}/>
                    <stop offset="95%" stopColor="#00838f" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#eee" />
                <XAxis dataKey="name" axisLine={false} tickLine={false} />
                <YAxis axisLine={false} tickLine={false} />
                <Tooltip 
                  contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                />
                <Area type="monotone" dataKey="patients" stroke="#00838f" fillOpacity={1} fill="url(#colorPatients)" />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Visit Types Donut Chart */}
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold text-gray-800 mb-6">Visit Distribution</h3>
          <div className="h-64 flex items-center justify-center">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={visitTypes}
                  innerRadius={60}
                  outerRadius={80}
                  paddingAngle={5}
                  dataKey="value"
                >
                  {visitTypes.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </div>
          <div className="flex justify-center gap-4 mt-4 flex-wrap">
            {visitTypes.map((entry, index) => (
              <div key={index} className="flex items-center gap-2 text-sm text-gray-600">
                <div className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                {entry.name}
              </div>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
};

export default Dashboard;
</file>

<file path="pages/Reception.tsx">
import React, { useState, useEffect } from 'react';
import { UserPlus, Search, Phone, User, History, Loader2 } from 'lucide-react';
import { db } from '../services/ivfService';
import { Patient } from '../types';
import toast from 'react-hot-toast';

const Reception: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'register' | 'directory'>('register');
  const [formData, setFormData] = useState({
    name: '',
    age: '',
    phone: '',
    husbandName: '',
    history: ''
  });
  const [searchTerm, setSearchTerm] = useState('');
  const [patients, setPatients] = useState<Patient[]>([]);
  const [loading, setLoading] = useState(false);

  // Fetch patients when switching to directory or on mount
  const fetchPatients = async () => {
    setLoading(true);
    const data = await db.getPatients();
    setPatients(data);
    setLoading(false);
  };

  useEffect(() => {
    if (activeTab === 'directory') {
      fetchPatients();
    }
  }, [activeTab]);

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.name || !formData.phone) {
      toast.error("Please fill required fields");
      return;
    }

    const toastId = toast.loading("Registering patient...");

    try {
      await db.savePatient({
        name: formData.name,
        age: parseInt(formData.age),
        phone: formData.phone,
        husbandName: formData.husbandName,
        history: formData.history
      });
      
      toast.success("Patient registered successfully!", { id: toastId });
      setFormData({ name: '', age: '', phone: '', husbandName: '', history: '' });
    } catch (error) {
      // Provide more detailed error feedback for debugging
      const msg = (error && (error as any).message) ? (error as any).message : JSON.stringify(error);
      toast.error(`Failed to register patient: ${msg}`, { id: toastId });
      console.error('Register patient error:', error);
    }
  };

  const filteredPatients = patients.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
    p.phone.includes(searchTerm)
  );

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[600px]">
      <div className="flex border-b border-gray-100">
        <button
          onClick={() => setActiveTab('register')}
          className={`flex-1 py-4 text-center font-medium transition-colors ${activeTab === 'register' ? 'text-teal-700 border-b-2 border-teal-700 bg-teal-50' : 'text-gray-500 hover:text-gray-700'}`}
        >
          New Registration
        </button>
        <button
          onClick={() => setActiveTab('directory')}
          className={`flex-1 py-4 text-center font-medium transition-colors ${activeTab === 'directory' ? 'text-teal-700 border-b-2 border-teal-700 bg-teal-50' : 'text-gray-500 hover:text-gray-700'}`}
        >
          Patient Directory
        </button>
      </div>

      <div className="p-4 md:p-8">
        {activeTab === 'register' ? (
          <form onSubmit={handleRegister} className="max-w-2xl mx-auto space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Patient Name (Wife)</label>
                <div className="relative">
                  <User className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
                  <input
                    type="text"
                    required
                    className="w-full pl-4 pr-10 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
                    placeholder="Full Name"
                    value={formData.name}
                    onChange={e => setFormData({...formData, name: e.target.value})}
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Age</label>
                <input
                  type="number"
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                  placeholder="Years"
                  value={formData.age}
                  onChange={e => setFormData({...formData, age: e.target.value})}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                <div className="relative">
                  <Phone className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
                  <input
                    type="tel"
                    required
                    className="w-full pl-4 pr-10 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                    placeholder="01xxxxxxxxx"
                    value={formData.phone}
                    onChange={e => setFormData({...formData, phone: e.target.value})}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Husband Name</label>
                <input
                  type="text"
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                  placeholder="Husband Name"
                  value={formData.husbandName}
                  onChange={e => setFormData({...formData, husbandName: e.target.value})}
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Medical History (Brief)</label>
              <div className="relative">
                <History className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
                <textarea
                  className="w-full pl-4 pr-10 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none h-32"
                  placeholder="G P A, Previous Operations, Allergies..."
                  value={formData.history}
                  onChange={e => setFormData({...formData, history: e.target.value})}
                />
              </div>
            </div>

            <button
              type="submit"
              className="w-full bg-teal-700 text-white py-3 rounded-xl font-bold hover:bg-teal-800 transition-colors flex items-center justify-center gap-2 shadow-lg shadow-teal-700/20"
            >
              <UserPlus className="w-5 h-5" />
              Register Patient
            </button>
          </form>
        ) : (
          <div className="space-y-6">
            <div className="relative">
              <Search className="absolute right-3 top-3 w-5 h-5 text-gray-400" />
              <input
                type="text"
                className="w-full pl-4 pr-12 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none shadow-sm"
                placeholder="Search by name or phone..."
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
              />
            </div>

            {loading ? (
              <div className="py-12 flex justify-center text-teal-600">
                <Loader2 className="w-8 h-8 animate-spin" />
              </div>
            ) : (
              <>
                {/* Mobile: render cards */}
                <div className="block md:hidden space-y-3">
                  {filteredPatients.length > 0 ? filteredPatients.map(patient => (
                    <div key={patient.id} className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-sm font-bold text-gray-900">{patient.name}</div>
                          <div className="text-xs text-gray-500 mt-1">{patient.phone} ‚Ä¢ Age {patient.age}</div>
                        </div>
                        <div className="text-right text-xs text-gray-400 font-mono">{patient.id.slice(0,6)}</div>
                      </div>
                      <div className="mt-3 text-xs text-gray-600 truncate">{patient.history}</div>
                    </div>
                  )) : (
                    <div className="text-center text-gray-400 py-8">No patients found matching your search.</div>
                  )}
                </div>

                {/* Desktop: table */}
                <div className="hidden md:block overflow-x-auto rounded-xl border border-gray-200">
                  <table className="w-full text-right">
                    <thead className="bg-gray-50 text-gray-600 font-medium text-sm">
                      <tr>
                        <th className="px-6 py-4">ID</th>
                        <th className="px-6 py-4">Patient Name</th>
                        <th className="px-6 py-4">Age</th>
                        <th className="px-6 py-4">Phone</th>
                        <th className="px-6 py-4">Husband</th>
                        <th className="px-6 py-4">History</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {filteredPatients.length > 0 ? (
                        filteredPatients.map((patient) => (
                          <tr key={patient.id} className="hover:bg-teal-50/30 transition-colors text-sm text-gray-700">
                            <td className="px-6 py-4 font-mono text-xs text-gray-400">{patient.id.slice(0, 6)}</td>
                            <td className="px-6 py-4 font-bold text-gray-900">{patient.name}</td>
                            <td className="px-6 py-4">{patient.age}</td>
                            <td className="px-6 py-4">{patient.phone}</td>
                            <td className="px-6 py-4">{patient.husbandName}</td>
                            <td className="px-6 py-4 truncate max-w-xs">{patient.history}</td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan={6} className="px-6 py-12 text-center text-gray-400">
                            No patients found matching your search.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default Reception;
</file>

<file path="services/visitsService.ts">
import { supabase } from './supabaseClient';
import { Visit } from '../types';

export const visitsService = {
  // Unified save visit function for all departments
  saveVisit: async (params: {
    patientId: string;
    department: string;
    clinicalData: any;
    diagnosis?: string;
    prescription?: any[];
    notes?: string;
  }) => {
    try {
      const visitData = {
        patient_id: params.patientId, // snake_case for database
        date: new Date().toISOString().split('T')[0],
        department: params.department,
        diagnosis: params.diagnosis || '',
        prescription: params.prescription || [],
        notes: params.notes || '',
        clinical_data: params.clinicalData,
      };

      const { data, error } = await supabase
        .from('visits')
        .insert([visitData])
        .select()
        .single();

      if (error) {
        console.error('Supabase error inserting visit:', error);
        throw new Error(`Failed to save visit: ${error.message}`);
      }
      return data;
    } catch (err: any) {
      console.error('Exception in saveVisit:', err);
      throw err;
    }
  },

  // Create a new visit with clinical data (legacy - kept for compatibility)
  createVisit: async (visit: Omit<Visit, 'id'>) => {
    try {
      const { data, error } = await supabase
        .from('visits')
        .insert([visit])
        .select()
        .single();

      if (error) {
        console.error('Supabase error inserting visit:', error);
        throw new Error(`Failed to create visit: ${error.message}`);
      }
      return data;
    } catch (err: any) {
      console.error('Exception in createVisit:', err);
      throw err;
    }
  },

  // Get visits for a patient
  getVisitsByPatient: async (patientId: string) => {
    const { data, error } = await supabase
      .from('visits')
      .select('*')
      .eq('patient_id', patientId) // snake_case for database
      .order('date', { ascending: false });

    if (error) throw error;
    return data;
  },

  // Update a visit
  updateVisit: async (visitId: string, updates: Partial<Visit>) => {
    // Convert camelCase to snake_case for database
    const dbUpdates: any = {};
    if (updates.patientId) dbUpdates.patient_id = updates.patientId;
    if (updates.department !== undefined) dbUpdates.department = updates.department;
    if (updates.diagnosis !== undefined) dbUpdates.diagnosis = updates.diagnosis;
    if (updates.prescription !== undefined) dbUpdates.prescription = updates.prescription;
    if (updates.notes !== undefined) dbUpdates.notes = updates.notes;
    if (updates.clinical_data !== undefined) dbUpdates.clinical_data = updates.clinical_data;

    const { data, error } = await supabase
      .from('visits')
      .update(dbUpdates)
      .eq('id', visitId)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  // Delete a visit
  deleteVisit: async (visitId: string) => {
    const { error } = await supabase
      .from('visits')
      .delete()
      .eq('id', visitId);

    if (error) throw error;
  },
};
</file>

<file path="CLINICAL_DATA_MIGRATION.sql">
-- ============================================================================
-- VISITS TABLE MIGRATION - Create visits table and add clinical columns
-- ============================================================================

-- Create visits table if it doesn't exist
CREATE TABLE IF NOT EXISTS visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  department TEXT DEFAULT NULL,
  diagnosis TEXT DEFAULT '',
  prescription JSONB DEFAULT '[]',
  notes TEXT DEFAULT '',
  clinical_data JSONB DEFAULT NULL,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Add department column to visits table (if table already exists)
ALTER TABLE visits ADD COLUMN IF NOT EXISTS department TEXT DEFAULT NULL;

-- Add clinical_data column to visits table (if table already exists)
ALTER TABLE visits ADD COLUMN IF NOT EXISTS clinical_data JSONB DEFAULT NULL;

-- Create index for better query performance on clinical_data
CREATE INDEX IF NOT EXISTS idx_visits_clinical_data ON visits USING GIN (clinical_data);

-- Create index for department queries
CREATE INDEX IF NOT EXISTS idx_visits_department ON visits (department);

-- Create index for patient visits with clinical data
CREATE INDEX IF NOT EXISTS idx_visits_patient_clinical ON visits (patient_id, date DESC) WHERE clinical_data IS NOT NULL;

-- Enable RLS on visits table
ALTER TABLE visits ENABLE ROW LEVEL SECURITY;

-- RLS Policies for visits table
DROP POLICY IF EXISTS "Doctors can read visits" ON visits;
DROP POLICY IF EXISTS "Doctors can insert visits" ON visits;
DROP POLICY IF EXISTS "Doctors can update visits" ON visits;

CREATE POLICY "Doctors can read visits" ON visits
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  );

CREATE POLICY "Doctors can insert visits" ON visits
  FOR INSERT
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  );

CREATE POLICY "Doctors can update visits" ON visits
  FOR UPDATE
  USING (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  )
  WITH CHECK (
    auth.uid() IS NOT NULL
    AND patient_id IN (
      SELECT id FROM patients WHERE doctor_id = auth.uid()
    )
  );

-- Add comments for documentation
COMMENT ON COLUMN visits.department IS 'Department identifier (GYNA, OBS, IVF_STIM, IVF_LAB)';
COMMENT ON COLUMN visits.clinical_data IS 'Structured clinical data stored as JSONB for different departments (gynecology, obstetrics, ivf)';
COMMENT ON INDEX idx_visits_clinical_data IS 'GIN index for efficient JSONB queries on clinical_data';
COMMENT ON INDEX idx_visits_department IS 'Index for filtering visits by department';
COMMENT ON INDEX idx_visits_patient_clinical IS 'Index for patient clinical visits ordered by date';
</file>

<file path="services/authService.ts">
import { supabase } from './supabaseClient';

export const authService = {
  login: async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    
    if (error) throw error;
    return data;
  },

  signup: async (email: string, password: string, doctorData: { name: string; specialization?: string; phone?: string }) => {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
    });
    
    if (error) throw error;

    if (data.user) {
      const { error: dbError } = await supabase
        .from('doctors')
        .insert([
          {
            user_id: data.user.id,
            email: email,
            name: doctorData.name,
            specialization: doctorData.specialization || null,
            phone: doctorData.phone || null,
            doctor_image: null,
            clinic_name: null,
            clinic_address: null,
            clinic_phone: null,
            clinic_image: null,
            clinic_latitude: null,
            clinic_longitude: null,
          }
        ]);

      if (dbError) {
        console.error('Doctor insert error:', dbError);
        throw dbError;
      }
    }

    return data;
  },

  logout: async () => {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  },

  getCurrentUser: async () => {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error) throw error;
    return user;
  },

  getDoctorProfile: async (userId: string) => {
    const { data, error } = await supabase
      .from('doctors')
      .select('*')
      .eq('user_id', userId)
      .single();

    if (error) throw error;
    return data;
  },

  onAuthStateChange: (callback: (user: any) => void) => {
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      callback(session?.user || null);
    });

    return subscription;
  },

  updateDoctorProfile: async (userId: string, updates: any) => {
    const { data, error } = await supabase
      .from('doctors')
      .update(updates)
      .eq('user_id', userId);

    if (error) {
      console.error('Update error details:', error);
      throw new Error(error.message || 'Failed to update profile');
    }
    return data;
  },

  updatePassword: async (newPassword: string) => {
    const { data, error } = await supabase.auth.updateUser({
      password: newPassword
    });

    if (error) throw error;
    return data;
  },

  uploadImage: async (userId: string, file: File, folder: 'doctor_images' | 'clinic_images') => {
    const fileExt = file.name.split('.').pop();
    const fileName = `${userId}_${Date.now()}.${fileExt}`;
    const filePath = `${folder}/${fileName}`;

    const { error: uploadError } = await supabase.storage
      .from('doctor-files')
      .upload(filePath, file, { upsert: true });

    if (uploadError) throw uploadError;

    const { data } = supabase.storage
      .from('doctor-files')
      .getPublicUrl(filePath);

    return data.publicUrl;
  },

  ensureDoctorRecord: async (userId: string, email: string) => {
    const { data: existingDoctor, error: fetchError } = await supabase
      .from('doctors')
      .select('id')
      .eq('user_id', userId)
      .single();

    if (existingDoctor) {
      return existingDoctor;
    }

    const { data: newDoctor, error: insertError } = await supabase
      .from('doctors')
      .insert([
        {
          user_id: userId,
          email: email,
          name: 'ÿßŸÑÿ∑ÿ®Ÿäÿ®',
          specialization: null,
          phone: null,
          doctor_image: null,
          clinic_name: null,
          clinic_address: null,
          clinic_phone: null,
          clinic_image: null,
          clinic_latitude: null,
          clinic_longitude: null,
        }
      ])
      .select()
      .single();

    if (insertError) {
      console.error('Error creating doctor record:', insertError);
      throw insertError;
    }

    return newDoctor;
  }
};
</file>

<file path="pages/Login.tsx">
import React, { useState } from 'react';
import { authService } from '../services/authService';
import toast from 'react-hot-toast';
import { LogIn, AlertCircle } from 'lucide-react';

interface LoginProps {
  onLoginSuccess: () => void;
}

export const Login: React.FC<LoginProps> = ({ onLoginSuccess }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [showSignup, setShowSignup] = useState(false);
  const [signupData, setSignupData] = useState({
    name: '',
    specialization: '',
    phone: '',
  });

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!email || !password) {
      toast.error('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
      return;
    }

    setLoading(true);
    try {
      await authService.login(email, password);
      toast.success('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
      onLoginSuccess();
    } catch (error: any) {
      toast.error(error.message || 'ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
    } finally {
      setLoading(false);
    }
  };

  const handleSignup = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!email || !password || !signupData.name) {
      toast.error('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
      return;
    }

    if (password.length < 6) {
      toast.error('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
      return;
    }

    setLoading(true);
    try {
      await authService.signup(email, password, signupData);
      toast.success('ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä');
      setShowSignup(false);
      setEmail('');
      setPassword('');
      setSignupData({ name: '', specialization: '', phone: '' });
    } catch (error: any) {
      toast.error(error.message || 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <div className="flex items-center justify-center mb-8">
          <div className="bg-indigo-600 rounded-full p-3">
            <LogIn className="text-white" size={24} />
          </div>
        </div>

        <h1 className="text-3xl font-bold text-center text-gray-900 mb-2 font-[Tajawal]">
          ŸÜÿ∏ÿßŸÖ ÿØ ŸÖÿ≠ŸÖÿØ ÿµŸÑÿßÿ≠ ÿ¨ÿ®ÿ±
        </h1>
        <p className="text-center text-gray-600 mb-8 font-[Tajawal]">
          {showSignup ? 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ' : 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ'}
        </p>

        {!showSignup ? (
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="doctor@example.com"
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                disabled={loading}
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-bold py-2 rounded-lg transition duration-200 font-[Tajawal]"
            >
              {loading ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...' : 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ'}
            </button>
          </form>
        ) : (
          <form onSubmit={handleSignup} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ *
              </label>
              <input
                type="text"
                value={signupData.name}
                onChange={(e) => setSignupData({ ...signupData, name: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="ÿØ. ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ"
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ÿßŸÑÿ™ÿÆÿµÿµ
              </label>
              <input
                type="text"
                value={signupData.specialization}
                onChange={(e) => setSignupData({ ...signupData, specialization: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÜÿ≥ÿßÿ° ŸàÿßŸÑÿ™ŸàŸÑŸäÿØ"
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
              </label>
              <input
                type="tel"
                value={signupData.phone}
                onChange={(e) => setSignupData({ ...signupData, phone: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="+966501234567"
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä *
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="doctor@example.com"
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 font-[Tajawal]">
                ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± *
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                disabled={loading}
              />
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex gap-2 items-start">
              <AlertCircle size={18} className="text-blue-600 flex-shrink-0 mt-0.5" />
              <p className="text-xs text-blue-800 font-[Tajawal]">
                ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ© Ÿàÿ≥ŸáŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏
              </p>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-bold py-2 rounded-lg transition duration-200 font-[Tajawal]"
            >
              {loading ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...' : 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®'}
            </button>
          </form>
        )}

        <div className="mt-6 text-center">
          <button
            onClick={() => {
              setShowSignup(!showSignup);
              setEmail('');
              setPassword('');
              setSignupData({ name: '', specialization: '', phone: '' });
            }}
            className="text-indigo-600 hover:text-indigo-700 font-medium font-[Tajawal]"
            disabled={loading}
          >
            {showSignup ? 'ŸáŸÑ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ' : 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®'}
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="pages/ObstetricsDashboard.tsx">
import React, { useState, useEffect } from 'react';
import { Plus, Save } from 'lucide-react';
import toast from 'react-hot-toast';
import { Pregnancy, Patient, PrescriptionItem } from '../types';
import { supabase } from '../services/supabaseClient';
import { obstetricsService, calculateEDD, calculateGestationalAge } from '../services/obstetricsService';
import { authService } from '../services/authService';
import { visitsService } from '../services/visitsService';
import PregnancyHeader from './components/obstetrics/PregnancyHeader';
import RiskAssessment from './components/obstetrics/RiskAssessment';
import ANCFlowSheet from './components/obstetrics/ANCFlowSheet';
import FetalGrowthChart from './components/obstetrics/FetalGrowthChart';
import PrescriptionComponent from '../components/PrescriptionComponent';
import PrescriptionPrinter from '../components/PrescriptionPrinter';

const ObstetricsDashboard: React.FC = () => {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [selectedPatientId, setSelectedPatientId] = useState<string | null>(null);
  const [pregnancy, setPregnancy] = useState<Pregnancy | null>(null);
  const [isLoadingPatients, setIsLoadingPatients] = useState(true);
  const [isLoadingPregnancy, setIsLoadingPregnancy] = useState(false);
  const [showNewPregnancyForm, setShowNewPregnancyForm] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [doctorId, setDoctorId] = useState<string | null>(null);
  const [prescription, setPrescription] = useState<PrescriptionItem[]>([]);
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);

  const [formData, setFormData] = useState({
    lmp_date: '',
    edd_by_scan: '',
  });

  useEffect(() => {
    fetchPatients();
    fetchDoctorProfile();
  }, []);

  useEffect(() => {
    if (selectedPatientId) {
      fetchPregnancy(selectedPatientId);
    }
  }, [selectedPatientId]);

  const fetchPatients = async () => {
    try {
      setIsLoadingPatients(true);
      const { data, error } = await supabase
        .from('patients')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setPatients(data || []);

      if (data && data.length > 0) {
        setSelectedPatientId(data[0].id);
      }
    } catch (error) {
      console.error('Error fetching patients:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ±ÿ∂Ÿâ');
    } finally {
      setIsLoadingPatients(false);
    }
  };

  const fetchPregnancy = async (patientId: string) => {
    try {
      setIsLoadingPregnancy(true);
      const data = await obstetricsService.getPregnancyByPatient(patientId);
      setPregnancy(data || null);
    } catch (error) {
      console.error('Error fetching pregnancy:', error);
      setPregnancy(null);
    } finally {
      setIsLoadingPregnancy(false);
    }
  };

  const fetchDoctorProfile = async () => {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        const doctor = await authService.getDoctorProfile(user.id);
        setDoctorId(doctor.id);
      }
    } catch (error) {
      console.error('Error fetching doctor profile:', error);
      toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
    }
  };

  const handleCreatePregnancy = async () => {
    try {
      if (!selectedPatientId) {
        toast.error('ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿ© ÿ£ŸàŸÑÿßŸã');
        return;
      }

      if (!doctorId) {
        toast.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ®');
        return;
      }

      if (!formData.lmp_date && !formData.edd_by_scan) {
        toast.error('ÿ£ÿØÿÆŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ÿØŸàÿ±ÿ© ÿ£Ÿà ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπ');
        return;
      }

      setIsSaving(true);

      const eddDate = formData.edd_by_scan || calculateEDD(formData.lmp_date);

      const pregnancyData = {
        doctor_id: doctorId,
        patient_id: selectedPatientId,
        lmp_date: formData.lmp_date || undefined,
        edd_date: eddDate,
        edd_by_scan: formData.edd_by_scan || undefined,
        risk_level: 'low' as const,
        risk_factors: [],
        aspirin_prescribed: false,
        thromboprophylaxis_needed: false,
      };

      console.log('Creating pregnancy with data:', pregnancyData);

      const newPregnancy = await obstetricsService.createPregnancy(pregnancyData);

      setPregnancy(newPregnancy);
      setShowNewPregnancyForm(false);
      setFormData({ lmp_date: '', edd_by_scan: '' });
      toast.success('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error: any) {
      console.error('Error creating pregnancy:', error);
      console.error('Error details:', {
        message: error?.message,
        code: error?.code,
        status: error?.status,
        details: error?.details,
        hint: error?.hint,
      });
      toast.error(`ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿßŸÑÿ≠ŸÖŸÑ: ${error?.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleUpdatePregnancy = async (updates: Partial<Pregnancy>) => {
    if (!pregnancy) return;

    try {
      await obstetricsService.updatePregnancy(pregnancy.id, updates);
      const updated = await obstetricsService.getPregnancyByPatient(pregnancy.patient_id);
      setPregnancy(updated || null);
    } catch (error) {
      console.error('Error updating pregnancy:', error);
      throw error;
    }
  };

  const handleSaveVisit = async () => {
    if (!selectedPatientId || !pregnancy) {
      toast.error('Please select a patient and ensure pregnancy data is loaded');
      return;
    }

    setIsSaving(true);
    try {
      const clinicalData = {
        pregnancyId: pregnancy.id,
        gestationalAge: calculateGestationalAge(pregnancy.lmp_date || ''),
        riskAssessment: {
          level: pregnancy.risk_level,
          factors: pregnancy.risk_factors,
          aspirin: pregnancy.aspirin_prescribed,
          thromboprophylaxis: pregnancy.thromboprophylaxis_needed,
        },
        currentStatus: 'Active Pregnancy Monitoring',
      };

      await visitsService.saveVisit({
        patientId: selectedPatientId,
        department: 'OBS',
        clinicalData: clinicalData,
        diagnosis: `Pregnancy - ${pregnancy.risk_level} risk`,
        prescription: prescription,
        notes: `Gestational age: ${calculateGestationalAge(pregnancy.lmp_date || '').weeks} weeks ${calculateGestationalAge(pregnancy.lmp_date || '').days} days`,
      });

      toast.success('Obstetrics visit saved successfully');
      setPrescription([]); // Reset prescription after saving

    } catch (error: any) {
      console.error('Error saving visit:', error);
      toast.error(`Failed to save visit: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const currentPatient = patients.find(p => p.id === selectedPatientId);

  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-gray-900 mb-2 font-[Tajawal]">
          ü§∞ Ÿàÿ≠ÿØÿ© ÿ∑ÿ® ÿßŸÑÿ™ŸàŸÑŸäÿØ ŸàÿßŸÑŸÜÿ≥ÿßÿ¶Ÿäÿ©
        </h1>
        <p className="text-gray-600 font-[Tajawal]">
          ŸÖÿ™ÿßÿ®ÿπÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑÿ≠ŸÖŸÑ ŸàÿßŸÑŸàŸÑÿßÿØÿ© ŸÖÿπ ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ŸàÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäŸàŸÖŸäÿ™ÿ±Ÿä
        </p>
      </div>

      <div className="grid md:grid-cols-4 gap-4 mb-6">
        <div className="md:col-span-3">
          <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
            ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©
          </label>
          {isLoadingPatients ? (
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div>
          ) : (
            <select
              value={selectedPatientId || ''}
              onChange={(e) => setSelectedPatientId(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent font-[Tajawal]"
            >
              <option value="">-- ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿ© --</option>
              {patients.map(patient => (
                <option key={patient.id} value={patient.id}>
                  {patient.name} - {patient.phone}
                </option>
              ))}
            </select>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
            &nbsp;
          </label>
          <button
            onClick={fetchPatients}
            className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-[Tajawal] font-semibold transition-colors"
          >
            üîÑ ÿ™ÿ≠ÿØŸäÿ´
          </button>
        </div>
      </div>

      {isLoadingPregnancy ? (
        <div className="flex items-center justify-center h-96">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600"></div>
        </div>
      ) : pregnancy ? (
        <>
          <PregnancyHeader pregnancy={pregnancy} />
          <RiskAssessment pregnancy={pregnancy} onUpdate={handleUpdatePregnancy} />
          <ANCFlowSheet pregnancyId={pregnancy.id} lmpDate={pregnancy.lmp_date} />
          <FetalGrowthChart pregnancyId={pregnancy.id} lmpDate={pregnancy.lmp_date} />

          {/* Prescription Section */}
          <div className="bg-white rounded-lg shadow-md p-6 mt-6">
            <PrescriptionComponent
              prescriptions={prescription}
              onPrescriptionsChange={setPrescription}
              onPrint={() => setIsPrinterOpen(true)}
              showPrintButton={true}
            />
          </div>

          {/* Save Visit Button */}
          <div className="bg-white rounded-lg shadow-md p-6 mt-6">
            <button
              onClick={handleSaveVisit}
              disabled={isSaving}
              className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
            >
              <Save className="w-5 h-5" />
              {isSaving ? 'Saving...' : 'Save Obstetrics Visit'}
            </button>
          </div>
        </>
      ) : currentPatient ? (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-teal-100 rounded-full mb-4">
            <Plus size={32} className="text-teal-600" />
          </div>
          <h3 className="text-xl font-bold text-gray-900 mb-2 font-[Tajawal]">
            ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ ÿ≠ŸÖŸÑ ŸÑŸÄ {currentPatient.name}
          </h3>
          <p className="text-gray-600 mb-6 font-[Tajawal]">
            ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿ≠ŸÖŸÑ ÿ¨ÿØŸäÿØ ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ¥ÿßŸÖŸÑÿ©
          </p>

          {!showNewPregnancyForm ? (
            <button
              onClick={() => setShowNewPregnancyForm(true)}
              className="inline-flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-[Tajawal] font-semibold transition-colors"
            >
              <Plus size={20} />
              ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿ≠ŸÖŸÑ ÿ¨ÿØŸäÿØ
            </button>
          ) : (
            <div className="bg-gray-50 p-6 rounded-lg border-2 border-teal-200 max-w-md mx-auto">
              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                  ÿ¢ÿÆÿ± ÿØŸàÿ±ÿ© ÿ¥Ÿáÿ±Ÿäÿ© (LMP)
                </label>
                <input
                  type="date"
                  value={formData.lmp_date}
                  onChange={(e) => setFormData(prev => ({ ...prev, lmp_date: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                />
              </div>

              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2 font-[Tajawal]">
                  ÿ£Ÿà ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿ®ÿßŸÑŸÖÿ≥ÿ≠ (EDD by Ultrasound)
                </label>
                <input
                  type="date"
                  value={formData.edd_by_scan}
                  onChange={(e) => setFormData(prev => ({ ...prev, edd_by_scan: e.target.value }))}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleCreatePregnancy}
                  disabled={isSaving}
                  className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
                >
                  {isSaving ? 'ÿ¨ÿßÿ±Ÿä...' : 'ÿ•ŸÜÿ¥ÿßÿ°'}
                </button>
                <button
                  onClick={() => setShowNewPregnancyForm(false)}
                  className="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg font-[Tajawal] font-semibold transition-colors"
                >
                  ÿ•ŸÑÿ∫ÿßÿ°
                </button>
              </div>
            </div>
          )}
        </div>
      ) : (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <p className="text-gray-600 font-[Tajawal]">ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿ© ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©</p>
        </div>
      )}

      <PrescriptionPrinter
        patient={currentPatient || null}
        prescriptions={prescription}
        diagnosis={pregnancy ? `Pregnancy - ${pregnancy.risk_level} risk` : ''}
        notes={pregnancy ? `Gestational age: ${calculateGestationalAge(pregnancy.lmp_date || '').weeks} weeks ${calculateGestationalAge(pregnancy.lmp_date || '').days} days` : ''}
        isOpen={isPrinterOpen}
        onClose={() => setIsPrinterOpen(false)}
      />
    </div>
  );
};

export default ObstetricsDashboard;
</file>

<file path="pages/PatientMasterRecord.tsx">
import React, { useState, useEffect } from 'react';
import {
  Calendar, FileText, User, Heart, Baby, TestTube, Download, ChevronDown, ChevronUp,
  X, Image as ImageIcon, Printer
} from 'lucide-react';
import { Patient, Visit } from '../types';
import { supabase } from '../services/supabaseClient';
import { visitsService } from '../services/visitsService';
import toast from 'react-hot-toast';
import PrescriptionPrinter from '../components/PrescriptionPrinter';

const PatientMasterRecord: React.FC = () => {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [selectedPatientId, setSelectedPatientId] = useState<string>('');
  const [visits, setVisits] = useState<Visit[]>([]);
  const [patientFiles, setPatientFiles] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);
  const [selectedVisit, setSelectedVisit] = useState<Visit | null>(null);
  const [activeTab, setActiveTab] = useState<'timeline' | 'gallery'>('timeline');
  const [selectedFilter, setSelectedFilter] = useState<'All' | 'GYNA' | 'OBS' | 'IVF'>('All');
  const [expandedVisitId, setExpandedVisitId] = useState<string | null>(null);
  const [selectedImage, setSelectedImage] = useState<any | null>(null);

  useEffect(() => {
    fetchPatients();
  }, []);

  useEffect(() => {
    if (selectedPatientId) {
      fetchPatientVisits(selectedPatientId);
      fetchPatientFiles(selectedPatientId);
    } else {
      setVisits([]);
      setPatientFiles([]);
    }
  }, [selectedPatientId]);

  const fetchPatients = async () => {
    try {
      const { data, error } = await supabase
        .from('patients')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setPatients(data || []);
    } catch (error) {
      console.error('Error fetching patients:', error);
      toast.error('Failed to load patients');
    }
  };

  const fetchPatientVisits = async (patientId: string) => {
    setIsLoading(true);
    try {
      const data = await visitsService.getVisitsByPatient(patientId);
      const mappedData = (data || []).map((visit: any) => ({
        ...visit,
        patientId: visit.patient_id,
      }));
      setVisits(mappedData.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()));
    } catch (error) {
      console.error('Error fetching visits:', error);
      toast.error('Failed to load patient visits');
    } finally {
      setIsLoading(false);
    }
  };

  const fetchPatientFiles = async (patientId: string) => {
    try {
      const { data, error } = await supabase
        .from('patient_files')
        .select('*')
        .eq('patient_id', patientId)
        .order('created_at', { ascending: false });

      if (error) {
        setPatientFiles([]);
      } else {
        setPatientFiles(data || []);
      }
    } catch (error) {
      console.error('Error fetching patient files:', error);
      setPatientFiles([]);
    }
  };

  const selectedPatient = patients.find(p => p.id === selectedPatientId);

  const getDepartmentIcon = (department?: string) => {
    switch (department) {
      case 'GYNA': return <Heart className="w-6 h-6 text-pink-600" />;
      case 'OBS': return <Baby className="w-6 h-6 text-blue-600" />;
      case 'IVF_STIM': return <TestTube className="w-6 h-6 text-purple-600" />;
      case 'IVF_LAB': return <TestTube className="w-6 h-6 text-purple-600" />;
      default: return <FileText className="w-6 h-6 text-gray-600" />;
    }
  };

  const getDepartmentName = (department?: string) => {
    switch (department) {
      case 'GYNA': return 'Gynecology';
      case 'OBS': return 'Obstetrics';
      case 'IVF_STIM': return 'IVF Stimulation';
      case 'IVF_LAB': return 'IVF Lab';
      default: return 'General Visit';
    }
  };

  const getDepartmentColor = (department?: string) => {
    switch (department) {
      case 'GYNA': return { bg: 'bg-pink-100', border: 'border-pink-300', dot: 'bg-pink-600' };
      case 'OBS': return { bg: 'bg-blue-100', border: 'border-blue-300', dot: 'bg-blue-600' };
      case 'IVF_STIM': return { bg: 'bg-purple-100', border: 'border-purple-300', dot: 'bg-purple-600' };
      case 'IVF_LAB': return { bg: 'bg-purple-100', border: 'border-purple-300', dot: 'bg-purple-600' };
      default: return { bg: 'bg-gray-100', border: 'border-gray-300', dot: 'bg-gray-600' };
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const renderClinicalData = (data: any, department?: string) => {
    if (!data) return null;
    switch (department) {
      case 'GYNA': return renderGynecologyData(data);
      case 'OBS': return renderObstetricsData(data);
      case 'IVF_STIM': return renderIVFData(data);
      default: return <div className="text-sm text-gray-600"><pre className="whitespace-pre-wrap">{JSON.stringify(data, null, 2)}</pre></div>;
    }
  };

  const renderGynecologyData = (data: any) => {
    const { assessment, diagnosis, procedureOrder, clinicalNotes } = data;
    return (
      <div className="space-y-3">
        {assessment?.complaints && assessment.complaints.length > 0 && (
          <div>
            <span className="font-medium text-gray-700">Complaints:</span>
            <div className="flex flex-wrap gap-1 mt-1">
              {assessment.complaints.map((complaint: string, idx: number) => (
                <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{complaint}</span>
              ))}
            </div>
          </div>
        )}
        {diagnosis && <div><span className="font-medium text-green-700">Diagnosis:</span> {diagnosis}</div>}
        {procedureOrder && <div><span className="font-medium text-purple-700">Procedure:</span> {procedureOrder}</div>}
        {clinicalNotes && <div><span className="font-medium text-gray-700">Notes:</span> {clinicalNotes}</div>}
      </div>
    );
  };

  const renderObstetricsData = (data: any) => {
    const { gestationalAge, riskAssessment, currentStatus } = data;
    return (
      <div className="space-y-2">
        {gestationalAge && <div><span className="font-medium">GA:</span> {gestationalAge.weeks}w {gestationalAge.days}d</div>}
        {riskAssessment && <div><span className="font-medium">Risk:</span> {riskAssessment.level}</div>}
        {currentStatus && <div><span className="font-medium">Status:</span> {currentStatus}</div>}
      </div>
    );
  };

  const renderIVFData = (data: any) => {
    const { protocol, startDate, stimulationDays, latestHormones } = data;
    return (
      <div className="space-y-2">
        {protocol && <div><span className="font-medium">Protocol:</span> {protocol}</div>}
        {startDate && <div><span className="font-medium">Started:</span> {formatDate(startDate)}</div>}
        {stimulationDays && <div><span className="font-medium">Days:</span> {stimulationDays}</div>}
        {latestHormones?.e2 && <div><span className="font-medium">E2:</span> {latestHormones.e2} pg/mL</div>}
      </div>
    );
  };

  const getFilteredVisits = () => {
    if (selectedFilter === 'All') return visits;
    if (selectedFilter === 'IVF') return visits.filter(v => v.department?.startsWith('IVF'));
    return visits.filter(v => v.department === selectedFilter);
  };

  const groupFilesByDate = (files: any[]) => {
    const grouped: { [key: string]: any[] } = {};
    files.forEach(file => {
      const date = new Date(file.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      if (!grouped[date]) grouped[date] = [];
      grouped[date].push(file);
    });
    return grouped;
  };

  const generateMedicalReport = () => {
    const filteredVisits = getFilteredVisits();
    const html = `
      <html>
        <head><title>Medical Report - ${selectedPatient?.name}</title></head>
        <body style="font-family: Arial; margin: 20px;">
          <h1>Medical Report</h1>
          <p><strong>Patient:</strong> ${selectedPatient?.name}</p>
          <p><strong>Age:</strong> ${selectedPatient?.age}</p>
          <table border="1" style="width: 100%; border-collapse: collapse;">
            <tr style="background: #f0f0f0;">
              <th style="padding: 8px;">Date</th>
              <th>Department</th>
              <th>Diagnosis</th>
            </tr>
            ${filteredVisits.map(v => `<tr><td style="padding: 8px;">${formatDate(v.date)}</td><td>${getDepartmentName(v.department)}</td><td>${v.diagnosis || 'N/A'}</td></tr>`).join('')}
          </table>
        </body>
      </html>
    `;
    const win = window.open('', '_blank');
    if (win) {
      win.document.write(html);
      win.document.close();
      setTimeout(() => win.print(), 250);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto p-6">
        <div className="mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">Patient Master Record</h1>
          <p className="text-gray-600">Comprehensive Medical Timeline & Archive</p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow-md mb-6">
          <label className="block text-sm font-semibold text-gray-700 mb-2">Select Patient</label>
          <select
            value={selectedPatientId}
            onChange={(e) => setSelectedPatientId(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
          >
            <option value="">-- Select Patient --</option>
            {patients.map(p => (<option key={p.id} value={p.id}>{p.name} - {p.phone}</option>))}
          </select>
        </div>

        {selectedPatient && (
          <div className="bg-white rounded-lg shadow-md overflow-hidden">
            <div className="bg-gradient-to-r from-teal-600 to-teal-700 text-white p-6 flex items-center justify-between sticky top-0 z-10">
              <div className="flex items-center gap-4">
                <div className="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                  <User className="w-7 h-7" />
                </div>
                <div>
                  <h2 className="text-2xl font-bold">{selectedPatient.name}</h2>
                  <p className="text-teal-100">Age: {selectedPatient.age} | ID: {selectedPatient.id.slice(0, 8)}</p>
                </div>
              </div>
              <button
                onClick={generateMedicalReport}
                className="flex items-center gap-2 bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition"
              >
                <Download className="w-5 h-5" />
                Report
              </button>
            </div>

            <div className="border-b border-gray-200 px-6 flex">
              <button
                onClick={() => setActiveTab('timeline')}
                className={`py-4 px-4 font-semibold border-b-2 transition ${
                  activeTab === 'timeline'
                    ? 'border-teal-600 text-teal-600'
                    : 'border-transparent text-gray-600'
                }`}
              >
                <Calendar className="w-5 h-5 inline mr-2" />
                Timeline
              </button>
              <button
                onClick={() => setActiveTab('gallery')}
                className={`py-4 px-4 font-semibold border-b-2 transition ${
                  activeTab === 'gallery'
                    ? 'border-teal-600 text-teal-600'
                    : 'border-transparent text-gray-600'
                }`}
              >
                <ImageIcon className="w-5 h-5 inline mr-2" />
                Media Gallery
              </button>
            </div>

            <div className="p-6">
              {activeTab === 'timeline' && (
                <div>
                  <div className="flex gap-2 mb-6 flex-wrap">
                    {(['All', 'GYNA', 'OBS', 'IVF'] as const).map(f => (
                      <button
                        key={f}
                        onClick={() => setSelectedFilter(f)}
                        className={`px-4 py-2 rounded-full font-medium transition ${
                          selectedFilter === f
                            ? 'bg-teal-600 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {f === 'GYNA' ? '‚ô• Gynecology' : f === 'OBS' ? 'üë∂ Obstetrics' : f === 'IVF' ? 'üß¨ IVF' : 'üìã All'}
                      </button>
                    ))}
                  </div>

                  {getFilteredVisits().length > 0 ? (
                    <div className="space-y-4">
                      {getFilteredVisits().map((v) => {
                        const colors = getDepartmentColor(v.department);
                        const isExpanded = expandedVisitId === v.id;

                        return (
                          <div key={v.id} className="flex gap-4">
                            <div className="flex flex-col items-center">
                              <div className={`w-4 h-4 rounded-full ${colors.dot} border-4 border-white shadow-md`} />
                              <div className="w-1 bg-gray-300 flex-1 h-12" />
                            </div>

                            <div
                              className={`flex-1 ${colors.bg} border-2 ${colors.border} rounded-lg p-4 cursor-pointer transition hover:shadow-md`}
                              onClick={() => setExpandedVisitId(isExpanded ? null : v.id)}
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-2">
                                    {getDepartmentIcon(v.department)}
                                    <h3 className="font-semibold text-gray-900">{getDepartmentName(v.department)}</h3>
                                    <span className="text-xs text-gray-500">{formatDate(v.date)}</span>
                                  </div>
                                  <p className="text-sm font-medium text-gray-700">{v.diagnosis || 'No diagnosis'}</p>
                                </div>
                                {isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                              </div>

                              {isExpanded && (
                                <div className="mt-4 pt-4 border-t border-opacity-30">
                                  <div className="bg-white bg-opacity-60 p-3 rounded mb-3">
                                    {renderClinicalData(v.clinical_data, v.department)}
                                  </div>
                                  {v.notes && (
                                    <div className="mb-3">
                                      <p className="text-xs font-medium text-gray-600 mb-1">Notes:</p>
                                      <p className="text-sm text-gray-700 italic">{v.notes}</p>
                                    </div>
                                  )}
                                  {v.prescription && v.prescription.length > 0 && (
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedVisit(v);
                                        setIsPrinterOpen(true);
                                      }}
                                      className="mt-3 flex items-center gap-2 text-sm text-teal-600 hover:text-teal-700 font-medium"
                                    >
                                      <Printer className="w-4 h-4" />
                                      Print Prescription
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center py-12 text-gray-500">
                      <Calendar className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                      No visits found for this filter
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'gallery' && (
                <div>
                  {patientFiles.length > 0 ? (
                    <div>
                      {Object.entries(groupFilesByDate(patientFiles)).map(([date, files]) => (
                        <div key={date} className="mb-8">
                          <h3 className="text-lg font-semibold text-gray-900 mb-4">{date}</h3>
                          <div className="grid grid-cols-4 gap-4">
                            {files.map(f => (
                              <div
                                key={f.id}
                                className="bg-gray-100 rounded-lg overflow-hidden cursor-pointer group hover:shadow-lg transition"
                                onClick={() => setSelectedImage(f)}
                              >
                                <div className="aspect-square bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center group-hover:from-gray-300 group-hover:to-gray-400">
                                  <ImageIcon className="w-8 h-8 text-gray-500" />
                                </div>
                                <p className="text-xs text-gray-600 p-2 truncate">{f.name || 'File'}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}

                      {selectedImage && (
                        <div
                          className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                          onClick={() => setSelectedImage(null)}
                        >
                          <div
                            className="bg-white rounded-lg p-4 max-w-2xl w-full"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <div className="flex items-center justify-between mb-4">
                              <h3 className="text-lg font-semibold">{selectedImage.name || 'File'}</h3>
                              <button onClick={() => setSelectedImage(null)} className="text-gray-600 hover:text-gray-900">
                                <X className="w-6 h-6" />
                              </button>
                            </div>
                            <div className="bg-gray-100 rounded-lg p-4 min-h-96 flex items-center justify-center">
                              <ImageIcon className="w-16 h-16 text-gray-400" />
                            </div>
                            <p className="text-sm text-gray-600 mt-4">{formatDate(selectedImage.created_at)}</p>
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="text-center py-12 text-gray-500">
                      <ImageIcon className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                      No media files available
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {isPrinterOpen && selectedVisit && (
        <PrescriptionPrinter
          patient={selectedPatient || null}
          prescriptions={selectedVisit.prescription || []}
          diagnosis={selectedVisit.diagnosis}
          notes={selectedVisit.notes}
          isOpen={isPrinterOpen}
          onClose={() => {
            setIsPrinterOpen(false);
            setSelectedVisit(null);
          }}
        />
      )}
    </div>
  );
};

export default PatientMasterRecord;
</file>

<file path="pages/Gynecology.tsx">
import React, { useState, useEffect } from 'react';
import { Save, Stethoscope, ClipboardList, Pill } from 'lucide-react';
import toast from 'react-hot-toast';
import { Patient, PrescriptionItem } from '../types';
import { supabase } from '../services/supabaseClient';
import { visitsService } from '../services/visitsService';
import { authService } from '../services/authService';
import PrescriptionComponent from '../components/PrescriptionComponent';
import PrescriptionPrinter from '../components/PrescriptionPrinter';

interface GynecologyData {
  // Vitals
  vitals: {
    weight?: number;
    height?: number;
    bmi?: number;
    bpSystolic?: number;
    bpDiastolic?: number;
    temperature?: number;
  };

  // Assessment Tab
  complaints: string[];
  pvExamination: {
    vulva: string;
    vagina: string;
    cervix: string;
    adnexa: string;
  };
  ultrasound: {
    uterus: {
      dimensions: string;
      position: string;
      myometrium: string;
      cavity: string;
    };
    endometrium: {
      thickness: string;
      pattern: string;
    };
    adnexa: {
      rightOvary: string;
      leftOvary: string;
      pod: string;
    };
  };

  // Diagnosis & Plan Tab
  diagnosis: string;
  procedureOrder: string;
  clinicalNotes: string;

  // Rx Tab
  prescription: PrescriptionItem[];
}

const Gynecology: React.FC = () => {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [selectedPatientId, setSelectedPatientId] = useState<string>('');
  const [doctorId, setDoctorId] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<'assessment' | 'diagnosis' | 'rx'>('assessment');
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);

  const [gynecologyData, setGynecologyData] = useState<GynecologyData>({
    vitals: {
      weight: undefined,
      height: undefined,
      bmi: undefined,
      bpSystolic: undefined,
      bpDiastolic: undefined,
      temperature: undefined,
    },
    complaints: [],
    pvExamination: {
      vulva: '',
      vagina: '',
      cervix: '',
      adnexa: '',
    },
    ultrasound: {
      uterus: {
        dimensions: '',
        position: 'AVF',
        myometrium: 'Homogeneous',
        cavity: 'Empty',
      },
      endometrium: {
        thickness: '',
        pattern: 'Triple Line',
      },
      adnexa: {
        rightOvary: '',
        leftOvary: '',
        pod: 'Clear',
      },
    },
    diagnosis: '',
    procedureOrder: '',
    clinicalNotes: '',
    prescription: [],
  });

  useEffect(() => {
    fetchPatients();
    fetchDoctorProfile();
  }, []);

  const fetchPatients = async () => {
    try {
      const { data, error } = await supabase
        .from('patients')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setPatients(data || []);
    } catch (error) {
      console.error('Error fetching patients:', error);
      toast.error('Failed to load patients');
    }
  };

  const fetchDoctorProfile = async () => {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        const doctor = await authService.getDoctorProfile(user.id);
        setDoctorId(doctor.id);
      }
    } catch (error) {
      console.error('Error fetching doctor profile:', error);
      toast.error('Failed to load doctor profile');
    }
  };

  const selectedPatient = patients.find(p => p.id === selectedPatientId);

  const handleSaveVisit = async () => {
    if (!selectedPatientId || !doctorId) {
      toast.error('Please select a patient');
      return;
    }

    setIsLoading(true);
    try {
      const clinicalData = {
        vitals: gynecologyData.vitals,
        assessment: {
          complaints: gynecologyData.complaints,
          pvExamination: gynecologyData.pvExamination,
          ultrasound: gynecologyData.ultrasound,
        },
        diagnosis: gynecologyData.diagnosis,
        procedureOrder: gynecologyData.procedureOrder,
        clinicalNotes: gynecologyData.clinicalNotes,
      };

      await visitsService.saveVisit({
        patientId: selectedPatientId,
        department: 'GYNA',
        clinicalData: clinicalData,
        diagnosis: gynecologyData.diagnosis,
        prescription: gynecologyData.prescription,
        notes: gynecologyData.clinicalNotes,
      });

      toast.success('Gynecology visit saved successfully');

      // Reset form
      setGynecologyData({
        vitals: {
          weight: undefined,
          height: undefined,
          bmi: undefined,
          bpSystolic: undefined,
          bpDiastolic: undefined,
          temperature: undefined,
        },
        complaints: [],
        pvExamination: {
          vulva: '',
          vagina: '',
          cervix: '',
          adnexa: '',
        },
        ultrasound: {
          uterus: {
            dimensions: '',
            position: 'AVF',
            myometrium: 'Homogeneous',
            cavity: 'Empty',
          },
          endometrium: {
            thickness: '',
            pattern: 'Triple Line',
          },
          adnexa: {
            rightOvary: '',
            leftOvary: '',
            pod: 'Clear',
          },
        },
        diagnosis: '',
        procedureOrder: '',
        clinicalNotes: '',
        prescription: [],
      });

    } catch (error: any) {
      console.error('Error saving visit:', error);
      toast.error(`Failed to save visit: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  const toggleComplaint = (complaint: string) => {
    setGynecologyData(prev => ({
      ...prev,
      complaints: prev.complaints.includes(complaint)
        ? prev.complaints.filter(c => c !== complaint)
        : [...prev.complaints, complaint]
    }));
  };

  const handleVitalsChange = (field: keyof GynecologyData['vitals'], value: string) => {
    const numValue = value ? parseFloat(value) : undefined;
    
    setGynecologyData(prev => {
      const newVitals = { ...prev.vitals, [field]: numValue };
      
      if (field === 'weight' || field === 'height') {
        if (newVitals.weight && newVitals.height && newVitals.height > 0) {
          const heightInMeters = newVitals.height / 100;
          newVitals.bmi = parseFloat((newVitals.weight / (heightInMeters * heightInMeters)).toFixed(1));
        }
      }
      
      return {
        ...prev,
        vitals: newVitals,
      };
    });
  };

  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-4xl font-bold text-gray-900 mb-2 font-[Tajawal]">
          ÿπŸäÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿßÿ°
        </h1>
        <p className="text-gray-600 font-[Tajawal]">
          Gynecology Station - Diagnosis & Medical Management of Benign Conditions
        </p>
      </div>

      {/* Patient Selector */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-6">
        <label className="block text-sm font-semibold text-gray-700 mb-2">
          Select Patient
        </label>
        <select
          value={selectedPatientId}
          onChange={(e) => setSelectedPatientId(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        >
          <option value="">-- Select Patient --</option>
          {patients.map(patient => (
            <option key={patient.id} value={patient.id}>
              {patient.name} - {patient.phone}
            </option>
          ))}
        </select>
      </div>

      {selectedPatient && (
        <div className="bg-white rounded-lg shadow-md">
          {/* Tab Navigation */}
          <div className="border-b border-gray-200">
            <nav className="flex">
              <button
                onClick={() => setActiveTab('assessment')}
                className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                  activeTab === 'assessment'
                    ? 'border-b-2 border-teal-500 text-teal-600 bg-teal-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <Stethoscope className="w-5 h-5 inline mr-2" />
                Clinical Assessment
              </button>
              <button
                onClick={() => setActiveTab('diagnosis')}
                className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                  activeTab === 'diagnosis'
                    ? 'border-b-2 border-amber-500 text-amber-600 bg-amber-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <ClipboardList className="w-5 h-5 inline mr-2" />
                Diagnosis & Plan
              </button>
              <button
                onClick={() => setActiveTab('rx')}
                className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                  activeTab === 'rx'
                    ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <Pill className="w-5 h-5 inline mr-2" />
                Prescription
              </button>
            </nav>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {/* Assessment Tab */}
            {activeTab === 'assessment' && (
              <div className="grid md:grid-cols-2 gap-6" dir="ltr">
                {/* LEFT COLUMN: Vitals & Complaints */}
                <div className="space-y-6">
                  {/* Vitals Section */}
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Vital Signs</h3>
                    <div className="grid grid-cols-2 gap-3 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.weight || ''}
                          onChange={(e) => handleVitalsChange('weight', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="e.g., 65"
                          step="0.1"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Height (cm)</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.height || ''}
                          onChange={(e) => handleVitalsChange('height', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="e.g., 165"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">BMI</label>
                        <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 font-medium">
                          {gynecologyData.vitals.bmi ? gynecologyData.vitals.bmi.toFixed(1) : '--'}
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Temp (¬∞C)</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.temperature || ''}
                          onChange={(e) => handleVitalsChange('temperature', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="e.g., 37"
                          step="0.1"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">BP Systolic</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.bpSystolic || ''}
                          onChange={(e) => handleVitalsChange('bpSystolic', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="mmHg"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">BP Diastolic</label>
                        <input
                          type="number"
                          value={gynecologyData.vitals.bpDiastolic || ''}
                          onChange={(e) => handleVitalsChange('bpDiastolic', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="mmHg"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Complaints */}
                  <div className="text-left">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Chief Complaints</h3>
                  <div className="grid grid-cols-2 md:grid-cols-2 gap-2">
                    {[
                      'Menorrhagia', 'Metrorrhagia', 'Dysmenorrhea', 'Amenorrhea', 'Infertility', 'Pelvic Pain', 'Vaginal Discharge'
                    ].map(complaint => (
                      <button
                        key={complaint}
                        onClick={() => toggleComplaint(complaint)}
                        className={`px-3 py-2 text-sm rounded-lg border transition-colors ${
                          gynecologyData.complaints.includes(complaint)
                            ? 'bg-blue-600 text-white border-blue-600'
                            : 'bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100'
                        }`}
                      >
                        {complaint}
                      </button>
                    ))}
                  </div>
                </div>
                </div>

                {/* RIGHT COLUMN: Investigations & Scans */}
                <div className="space-y-6">
                {/* PV Examination */}
                <div className="bg-green-50 p-4 rounded-lg" dir="ltr">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Vaginal Examination (PV)</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Vulva</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.vulva}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, vulva: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Lesions / etc."
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Vagina</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.vagina}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, vagina: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Discharge / etc."
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Cervix</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.cervix}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, cervix: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Erosion / Motion tenderness"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Adnexa</label>
                      <input
                        type="text"
                        value={gynecologyData.pvExamination.adnexa}
                        onChange={(e) => setGynecologyData(prev => ({
                          ...prev,
                          pvExamination: { ...prev.pvExamination, adnexa: e.target.value }
                        }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Normal / Mass / Tenderness"
                      />
                    </div>
                  </div>
                </div>

                {/* Office Ultrasound */}
                <div dir="ltr">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Transvaginal Ultrasound (TVS)</h3>

                  {/* Uterus */}
                  <div className="mb-6">
                    <h4 className="text-md font-medium text-gray-800 mb-3">Uterus</h4>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Dimensions (LxWxAP)</label>
                        <input type="text" value={gynecologyData.ultrasound.uterus.dimensions} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, dimensions: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., 7x5x4 cm" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
                        <select value={gynecologyData.ultrasound.uterus.position} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, position: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="AVF">Anteverted Flexed (AVF)</option>
                          <option value="RVF">Retroverted Flexed (RVF)</option>
                          <option value="Axial">Axial</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Myometrium</label>
                        <select value={gynecologyData.ultrasound.uterus.myometrium} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, myometrium: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Homogeneous">Homogeneous</option>
                          <option value="Heterogeneous">Heterogeneous</option>
                          <option value="Fibroid">Fibroid</option>
                          <option value="Adenomyosis">Adenomyosis</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Cavity</label>
                        <select value={gynecologyData.ultrasound.uterus.cavity} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, uterus: { ...prev.ultrasound.uterus, cavity: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Empty">Empty</option>
                          <option value="Polyp">Polyp</option>
                          <option value="Fibroid">Fibroid</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Endometrium */}
                  <div className="mb-6">
                    <h4 className="text-md font-medium text-gray-800 mb-3">Endometrium</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Thickness (mm)</label>
                        <input type="text" value={gynecologyData.ultrasound.endometrium.thickness} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, endometrium: { ...prev.ultrasound.endometrium, thickness: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., 8-10 mm" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Pattern</label>
                        <select value={gynecologyData.ultrasound.endometrium.pattern} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, endometrium: { ...prev.ultrasound.endometrium, pattern: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Triple Line">Triple Line</option>
                          <option value="Hyperechoic">Hyperechoic</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Adnexa */}
                  <div>
                    <h4 className="text-md font-medium text-gray-800 mb-3">Adnexa</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Right Ovary</label>
                        <select value={gynecologyData.ultrasound.adnexa.rightOvary} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, adnexa: { ...prev.ultrasound.adnexa, rightOvary: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="">Select</option>
                          <option value="Normal">Normal</option>
                          <option value="PCO">Polycystic (PCO)</option>
                          <option value="Cyst">Cyst</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Left Ovary</label>
                        <select value={gynecologyData.ultrasound.adnexa.leftOvary} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, adnexa: { ...prev.ultrasound.adnexa, leftOvary: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="">Select</option>
                          <option value="Normal">Normal</option>
                          <option value="PCO">Polycystic (PCO)</option>
                          <option value="Cyst">Cyst</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">POD (Pouch of Douglas)</label>
                        <select value={gynecologyData.ultrasound.adnexa.pod} onChange={(e) => setGynecologyData(prev => ({ ...prev, ultrasound: { ...prev.ultrasound, adnexa: { ...prev.ultrasound.adnexa, pod: e.target.value } } }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                          <option value="Clear">Clear</option>
                          <option value="Free Fluid">Free Fluid</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            )}

            {/* Diagnosis & Plan Tab */}
            {activeTab === 'diagnosis' && (
              <div className="space-y-6" dir="ltr">
                {/* Diagnosis */}
                <div className="text-left">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">ICD-10 Diagnosis</h3>
                  <select
                    value={gynecologyData.diagnosis}
                    onChange={(e) => setGynecologyData(prev => ({ ...prev, diagnosis: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                  >
                    <option value="">Select Diagnosis</option>
                    <option value="E28.2 - PCOS (Polycystic Ovary Syndrome)">E28.2 - PCOS (Polycystic Ovary Syndrome)</option>
                    <option value="N93.9 - Abnormal Uterine Bleeding (AUB)">N93.9 - Abnormal Uterine Bleeding (AUB)</option>
                    <option value="N80 - Endometriosis">N80 - Endometriosis</option>
                    <option value="D25 - Uterine Leiomyoma (Fibroid)">D25 - Uterine Leiomyoma (Fibroid)</option>
                    <option value="N84 - Polyp of Female Genital Tract">N84 - Polyp of Female Genital Tract</option>
                    <option value="N85.0 - Endometrial Hyperplasia">N85.0 - Endometrial Hyperplasia</option>
                    <option value="N70 - Salpingitis and Oophoritis (PID)">N70 - Salpingitis and Oophoritis (PID)</option>
                    <option value="N71 - Inflammatory Disease of Uterus">N71 - Inflammatory Disease of Uterus</option>
                    <option value="N97 - Female Infertility">N97 - Female Infertility</option>
                  </select>
                </div>

                {/* Procedure Order */}
                <div className="text-left">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Procedure / Management Plan</h3>
                  <select
                    value={gynecologyData.procedureOrder}
                    onChange={(e) => setGynecologyData(prev => ({ ...prev, procedureOrder: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                  >
                    <option value="">Select Procedure</option>
                    <option value="Conservative Management">Conservative Management</option>
                    <option value="Hysteroscopy + D&C">Hysteroscopy + D&C</option>
                    <option value="Diagnostic Laparoscopy">Diagnostic Laparoscopy</option>
                    <option value="Pap Smear Screening">Pap Smear Screening</option>
                    <option value="Endometrial Biopsy">Endometrial Biopsy</option>
                    <option value="Colposcopy">Colposcopy</option>
                    <option value="Myomectomy">Myomectomy</option>
                    <option value="IUD Insertion">IUD Insertion</option>
                  </select>
                </div>

                {/* Clinical Notes */}
                <div className="text-left">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Clinical Notes & Plan</h3>
                  <textarea
                    value={gynecologyData.clinicalNotes}
                    onChange={(e) => setGynecologyData(prev => ({ ...prev, clinicalNotes: e.target.value }))}
                    rows={4}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                    placeholder="Enter clinical observations, management plan, and follow-up..."
                  />
                </div>
              </div>
            )}

            {/* Rx Tab */}
            {activeTab === 'rx' && (
              <PrescriptionComponent
                prescriptions={gynecologyData.prescription}
                onPrescriptionsChange={(prescriptions) =>
                  setGynecologyData(prev => ({ ...prev, prescription: prescriptions }))
                }
                onPrint={() => setIsPrinterOpen(true)}
                showPrintButton={true}
              />
            )}
          </div>

          {/* Save Button */}
          <div className="bg-gray-50 px-6 py-4 border-t border-gray-200">
            <button
              onClick={handleSaveVisit}
              disabled={isLoading}
              className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
            >
              <Save className="w-5 h-5" />
              {isLoading ? 'Saving...' : 'Save Gynecology Visit'}
            </button>
          </div>
        </div>
      )}

      <PrescriptionPrinter
        patient={selectedPatient || null}
        prescriptions={gynecologyData.prescription}
        diagnosis={gynecologyData.diagnosis}
        notes={gynecologyData.clinicalNotes}
        isOpen={isPrinterOpen}
        onClose={() => setIsPrinterOpen(false)}
      />
    </div>
  );
};

export default Gynecology;
</file>

<file path="components/BottomNav.tsx">
import React from 'react';
import { LayoutDashboard, Users, Baby, Heart, Settings, Activity, Shield } from 'lucide-react';
import { Page } from '../types';

interface Props {
  activePage: Page;
  setPage: (p: Page) => void;
}

const BottomNav: React.FC<Props> = ({ activePage, setPage }) => {
  return (
    <nav className="fixed bottom-0 w-full md:hidden bg-white border-t shadow-lg z-50">
      <div className="max-w-3xl mx-auto flex overflow-x-auto">
        <button
          onClick={() => setPage(Page.HOME)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs ${activePage === Page.HOME ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="Home"
        >
          <LayoutDashboard className="w-6 h-6" />
          <span className="mt-1 text-[12px]">Home</span>
        </button>

        <button
          onClick={() => setPage(Page.GYNECOLOGY)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs ${activePage === Page.GYNECOLOGY ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="Gynecology"
        >
          <Activity className="w-6 h-6" />
          <span className="mt-1 text-[12px]">ŸÜÿ≥ÿßÿ°</span>
        </button>

        <button
          onClick={() => setPage(Page.IVF)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs ${activePage === Page.IVF ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="IVF"
        >
          <Baby className="w-6 h-6" />
          <span className="mt-1 text-[12px]">IVF</span>
        </button>

        <button
          onClick={() => setPage(Page.RECEPTION)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs ${activePage === Page.RECEPTION ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="Patients"
        >
          <Users className="w-6 h-6" />
          <span className="mt-1 text-[12px]">Patients</span>
        </button>

        <button
          onClick={() => setPage(Page.OBSTETRICS)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs ${activePage === Page.OBSTETRICS ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="Obstetrics"
        >
          <Heart className="w-6 h-6" />
          <span className="mt-1 text-[12px]">OB/GYN</span>
        </button>

        <button
          onClick={() => setPage(Page.SETTINGS)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs min-w-fit ${activePage === Page.SETTINGS ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="Settings"
        >
          <Settings className="w-6 h-6" />
          <span className="mt-1 text-[12px]">Settings</span>
        </button>

        <button
          onClick={() => setPage(Page.ADMIN)}
          className={`py-2 px-1 flex flex-col items-center justify-center text-xs min-w-fit ${activePage === Page.ADMIN ? 'text-teal-600' : 'text-gray-500'}`}
          aria-label="Admin"
        >
          <Shield className="w-6 h-6" />
          <span className="mt-1 text-[12px]">Admin</span>
        </button>
      </div>
    </nav>
  );
};

export default BottomNav;
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nile IVF Center EMR</title>
    <!-- ÿ≥ŸÜÿ≥ÿ™ÿÆÿØŸÖ Tailwind ÿπÿ®ÿ± ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸä package.json ŸÑŸÉŸÜ ÿ≥ŸÜÿ®ŸÇŸä ÿßŸÑŸÄ CDN ŸÖÿ§ŸÇÿ™ÿßŸã ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿµŸÖŸäŸÖ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              teal: {
                50: '#e0f2f1', 100: '#b2dfdb', 500: '#009688', 600: '#00897b', 700: '#00838f', 800: '#006064', 900: '#004d40',
              }
            }
          }
        }
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react-hot-toast": "https://aistudiocdn.com/react-hot-toast@^2.6.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.86.2"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>
</file>

<file path="services/ivfService.ts">
import { supabase } from './supabaseClient';
import { Patient, IvfCycle, Visit, StimulationLog } from '../types';

// Utility Functions (Local logic)
export const calculateBMI = (weightKg: number, heightCm: number): { bmi: number; alert: boolean } => {
  if (!weightKg || !heightCm) return { bmi: 0, alert: false };
  const heightM = heightCm / 100;
  const bmi = parseFloat((weightKg / (heightM * heightM)).toFixed(1));
  return { bmi, alert: bmi > 30 };
};

export const calculateTMSC = (volume: number, concentration: number, motility: number): number => {
  if (!volume || !concentration || !motility) return 0;
  return parseFloat(((volume * concentration * motility) / 100).toFixed(2));
};

export const analyzeSemenAnalysis = (vol: number, conc: number, motility: number, morph: number): string => {
  const findings: string[] = [];
  if (vol < 1.5) findings.push("Hypospermia");
  if (conc < 15) findings.push("Oligozoospermia");
  if (motility < 40) findings.push("Asthenozoospermia");
  if (morph < 4) findings.push("Teratozoospermia");
  
  if (findings.length === 0) return "Normozoospermia (WHO 2021)";
  return findings.join(" + ");
};

export const classifyOvarianReserve = (amh?: number, afc?: number): 'Poor Responder' | 'Normal' | 'High Responder' => {
  if (!amh && !afc) return 'Normal';
  
  if ((amh && amh < 0.4) || (afc && afc < 5)) {
    return 'Poor Responder';
  }
  if ((amh && amh > 4.5) || (afc && afc > 25)) {
    return 'High Responder';
  }
  return 'Normal';
};

export const calculateMaturationRate = (totalOocytes: number, mii: number): number => {
  if (!totalOocytes || totalOocytes === 0) return 0;
  return parseFloat(((mii / totalOocytes) * 100).toFixed(1));
};

export const calculateFertilizationRate = (fertilized: number, mii: number): number => {
  if (!mii || mii === 0) return 0;
  return parseFloat(((fertilized / mii) * 100).toFixed(1));
};

// Database Service (Supabase Async)
export const db = {
  // --- Patients ---
  getPatients: async (): Promise<Patient[]> => {
    const { data, error } = await supabase
      .from('patients')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('Error fetching patients:', error);
      return [];
    }
    
    // Map snake_case DB columns to camelCase types if needed, 
    // or ensure types match DB. Assuming strict match or mapping here:
    return data.map((p: any) => ({
      id: p.id,
      name: p.name,
      age: p.age,
      phone: p.phone,
      husbandName: p.husband_name,
      history: p.history,
      createdAt: p.created_at
    }));
  },

  savePatient: async (patient: Omit<Patient, 'id' | 'createdAt'>) => {
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    
    if (userError || !user) throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');

    const { data, error } = await supabase
      .from('patients')
      .insert([{
        name: patient.name,
        age: patient.age,
        phone: patient.phone,
        husband_name: patient.husbandName,
        history: patient.history,
        doctor_id: user.id
      }])
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  // --- Visits ---
  getVisits: async (): Promise<Visit[]> => {
    const { data, error } = await supabase
      .from('visits')
      .select('*')
      .order('date', { ascending: false });
      
    if (error) return [];
    return data as any; // Simplified for brevity
  },

  // --- Cycles ---
  getCycles: async (): Promise<IvfCycle[]> => {
    const { data, error } = await supabase
      .from('ivf_cycles')
      .select(`
        *,
        stimulation_logs (*)
      `)
      .order('start_date', { ascending: false });

    if (error) {
      console.error(error);
      return [];
    }

    return data.map((c: any) => ({
      id: c.id,
      patientId: c.patient_id,
      protocol: c.protocol,
      startDate: c.start_date,
      status: c.status,
      logs: c.stimulation_logs.map((l: any) => ({
        id: l.id,
        date: l.date,
        cycleDay: l.cycle_day,
        fsh: l.fsh,
        hmg: l.hmg,
        e2: l.e2,
        lh: l.lh,
        rtFollicles: l.rt_follicles,
        ltFollicles: l.lt_follicles
      })) || [],
      lab: c.lab_data
    }));
  },

  saveCycle: async (cycle: Partial<IvfCycle> & { patientId: string }) => {
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    
    if (userError || !user) throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');

    const { data, error } = await supabase
      .from('ivf_cycles')
      .insert([{
        patient_id: cycle.patientId,
        protocol: cycle.protocol,
        status: cycle.status,
        start_date: cycle.startDate,
        doctor_id: user.id
      }])
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  // --- Logs ---
  addLog: async (cycleId: string, log: Partial<StimulationLog>) => {
    const { data, error } = await supabase
      .from('stimulation_logs')
      .insert([{
        cycle_id: cycleId,
        cycle_day: log.cycleDay,
        date: log.date,
        fsh: log.fsh || '',
        hmg: log.hmg || '',
        e2: log.e2 || '',
        lh: log.lh || '',
        rt_follicles: log.rtFollicles || '',
        lt_follicles: log.ltFollicles || '',
        endometrium_thickness: log.endometriumThickness || ''
      }])
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },

  updateLog: async (logId: string, updates: Partial<StimulationLog>) => {
    const dbUpdates: any = {};
    if (updates.fsh !== undefined) dbUpdates.fsh = updates.fsh;
    if (updates.hmg !== undefined) dbUpdates.hmg = updates.hmg;
    if (updates.e2 !== undefined) dbUpdates.e2 = updates.e2;
    if (updates.lh !== undefined) dbUpdates.lh = updates.lh;
    if (updates.rtFollicles !== undefined) dbUpdates.rt_follicles = updates.rtFollicles;
    if (updates.ltFollicles !== undefined) dbUpdates.lt_follicles = updates.ltFollicles;
    if (updates.endometriumThickness !== undefined) dbUpdates.endometrium_thickness = updates.endometriumThickness;
    
    const { error } = await supabase
      .from('stimulation_logs')
      .update(dbUpdates)
      .eq('id', logId);
    if (error) throw error;
  },

  updateCycleAssessment: async (cycleId: string, assessment: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ assessment_data: assessment, updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating assessment:', error);
        throw new Error(`Failed to update assessment: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleAssessment error:', e);
      throw e;
    }
  },

  updateCycleLabData: async (cycleId: string, labData: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ lab_data: labData, updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating lab data:', error);
        throw new Error(`Failed to update lab data: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleLabData error:', e);
      throw e;
    }
  },

  updateCycleTransfer: async (cycleId: string, transferData: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ transfer_data: transferData, updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating transfer:', error);
        throw new Error(`Failed to update transfer: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleTransfer error:', e);
      throw e;
    }
  },

  updateCycleOutcome: async (cycleId: string, outcomeData: any) => {
    try {
      const { error } = await supabase
        .from('ivf_cycles')
        .update({ outcome_data: outcomeData, status: 'Completed', updated_at: new Date().toISOString() })
        .eq('id', cycleId);
      if (error) {
        console.error('Error updating outcome:', error);
        throw new Error(`Failed to update outcome: ${error.message}`);
      }
    } catch (e) {
      console.error('updateCycleOutcome error:', e);
      throw e;
    }
  }
};
</file>

<file path="App.tsx">
import React, { useState, useEffect } from 'react';
import { Sidebar } from './components/Sidebar';
import BottomNav from './components/BottomNav';
import { Page } from './types';
import Dashboard from './pages/Dashboard';
import Reception from './pages/Reception';
import Gynecology from './pages/Gynecology';
import IvfJourney from './pages/IvfJourney';
import PatientMasterRecord from './pages/PatientMasterRecord';
import Settings from './pages/Settings';
import ObstetricsDashboard from './pages/ObstetricsDashboard';
import AdminDashboard from './pages/AdminDashboard';
import { Login } from './pages/Login';
import { Toaster } from 'react-hot-toast';
import { authService } from './services/authService';
import { LogOut } from 'lucide-react';
import { BrandingProvider } from './context/BrandingContext';

const App: React.FC = () => {
  const [activePage, setActivePage] = useState<Page>(Page.HOME);
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);
    
    const checkUser = async () => {
      try {
        const currentUser = await authService.getCurrentUser();
        setUser(currentUser);
      } catch (error) {
        console.log('No user logged in');
        setUser(null);
      } finally {
        setLoading(false);
      }
    };

    checkUser();

    const subscription = authService.onAuthStateChange((user) => {
      setUser(user);
      setLoading(false);
    });

    return () => {
      if (subscription) {
        subscription.unsubscribe();
      }
    };
  }, []);

  const handleLogout = async () => {
    try {
      await authService.logout();
      setUser(null);
      setActivePage(Page.HOME);
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 font-[Tajawal]">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return (
      <>
        <Login onLoginSuccess={() => setActivePage(Page.HOME)} />
        <Toaster position="top-center" reverseOrder={false} />
      </>
    );
  }

  const renderContent = () => {
    switch (activePage) {
      case Page.HOME: return <Dashboard />;
      case Page.RECEPTION: return <Reception />;
      case Page.GYNECOLOGY: return <Gynecology />;
      case Page.IVF: return <IvfJourney />;
      case Page.OBSTETRICS: return <ObstetricsDashboard />;
      case Page.PATIENT_RECORD: return <PatientMasterRecord />;
      case Page.SETTINGS: return <Settings user={user} />;
      case Page.ADMIN: return <AdminDashboard />;
      default: return <Dashboard />;
    }
  };

  return (
    <BrandingProvider>
      <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row-reverse font-[Tajawal]">
        <div className="hidden md:flex">
          <Sidebar activePage={activePage} setPage={setActivePage} />
        </div>

        <main className="flex-1 md:mr-64 p-4 md:p-8 transition-all duration-300 no-print pb-20 md:pb-0">
          <div className="max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-2xl font-bold text-gray-900">
                ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå {user?.email}
              </h1>
              <button
                onClick={handleLogout}
                className="flex items-center gap-2 px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition duration-200 font-[Tajawal]"
              >
                <LogOut size={18} />
                ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
              </button>
            </div>
            {renderContent()}
          </div>
        </main>

        <BottomNav activePage={activePage} setPage={setActivePage} />

        <Toaster position="top-center" reverseOrder={false} />
      </div>
    </BrandingProvider>
  );
};

export default App;
</file>

<file path="components/Sidebar.tsx">
import React from 'react';
import { LayoutDashboard, Users, Baby, Heart, Settings, LogOut, Activity, FileText } from 'lucide-react';
import { Page } from '../types';
import { useBranding } from '../context/BrandingContext';

interface SidebarProps {
  activePage: Page;
  setPage: (page: Page) => void;
}

export const Sidebar: React.FC<SidebarProps> = ({ activePage, setPage }) => {
  const { branding } = useBranding();

  const menuItems = [
    { id: Page.HOME, label: 'Dashboard', arLabel: 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', icon: LayoutDashboard },
    { id: Page.RECEPTION, label: 'Reception', arLabel: 'ÿßŸÑÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ', icon: Users },
    { id: Page.GYNECOLOGY, label: 'Gynecology', arLabel: 'ÿπŸäÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿßÿ°', icon: Activity },
    { id: Page.OBSTETRICS, label: 'Obstetrics', arLabel: 'ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ≠ŸÖŸÑ', icon: Heart },
    { id: Page.IVF, label: 'IVF Center', arLabel: 'ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿÆÿµŸàÿ®ÿ©', icon: Baby },
    { id: Page.PATIENT_RECORD, label: 'Patient Records', arLabel: 'ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', icon: FileText },
    { id: Page.SETTINGS, label: 'Settings', arLabel: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', icon: Settings },
  ];

  return (
    // Hidden on mobile, visible from md and up
    <div className="hidden md:w-64 md:flex md:flex-col bg-white h-screen shadow-lg fixed md:static inset-y-0 right-0 z-10 no-print">
      <div className="p-6 border-b border-gray-100 flex items-center justify-center">
        <div className="flex flex-col items-center">
          {branding?.logo_url ? (
            <img src={branding.logo_url} alt="Logo" className="w-12 h-12 rounded-full mb-2 object-cover" />
          ) : (
            <div className="w-12 h-12 bg-teal-50 rounded-full flex items-center justify-center mb-2">
              <Baby className="text-teal-700 w-8 h-8" />
            </div>
          )}
          <h1 className="text-sm font-bold text-gray-800 text-center">{branding?.clinic_name || 'Nile IVF Center'}</h1>
          <p className="text-xs text-gray-400 uppercase tracking-wider">EMR System</p>
        </div>
      </div>
      
      <nav className="flex-1 overflow-y-auto py-4">
        <ul className="space-y-2 px-4">
          {menuItems.map((item) => {
            const Icon = item.icon;
            const isActive = activePage === item.id;
            return (
              <li key={item.id}>
                <button
                  onClick={() => setPage(item.id)}
                  className={`w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 ${
                    isActive 
                      ? 'bg-teal-50 text-teal-700 font-bold shadow-sm' 
                      : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'
                  }`}
                >
                  <Icon className={`w-5 h-5 ${isActive ? 'text-teal-700' : 'text-gray-400'}`} />
                  <span>{item.arLabel || item.label}</span>
                </button>
              </li>
            );
          })}
        </ul>
      </nav>

      <div className="p-4 border-t border-gray-100">
        <button className="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-500 hover:text-red-600 transition-colors">
          <LogOut className="w-4 h-4" />
          <span>Sign Out</span>
        </button>
      </div>
    </div>
  );
};
</file>

<file path="pages/ClinicalStation.tsx">
import React, { useState, useEffect } from 'react';
import { db, calculateBMI, analyzeSemenAnalysis } from '../services/ivfService';
import { EGYPTIAN_DRUGS } from '../constants';
import { PrescriptionItem, Patient } from '../types';
import { AlertTriangle, Plus, Trash2, Printer, FileText, Activity, Microscope, Info } from 'lucide-react';

interface FemaleFactor {
  // Hormones
  fsh: string;
  lh: string;
  e2: string;
  prolactin: string;
  tsh: string;
  amh: string;
  // Ultrasound
  endoThickness: string;
  afcR: string;
  afcL: string;
  uterusPathology: string[];
  ovaryPathology: string[];
  // Tubes & Scope
  tubalStatus: string;
  hydrosalpinx: boolean;
  hysteroscopy: string[];
  laparoscopy: string[];
}

const ClinicalStation: React.FC = () => {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [selectedPatientId, setSelectedPatientId] = useState('');
  
  // Vitals & Male
  const [vitals, setVitals] = useState({ weight: '', height: '' });
  const [maleParams, setMaleParams] = useState({ vol: 0, conc: 0, mot: 0, morph: 0 });
  
  // Female Workup State
  const [activeFemaleTab, setActiveFemaleTab] = useState<'hormones' | 'us' | 'scope'>('hormones');
  const [femaleData, setFemaleData] = useState<FemaleFactor>({
    fsh: '', lh: '', e2: '', prolactin: '', tsh: '', amh: '',
    endoThickness: '', afcR: '', afcL: '',
    uterusPathology: [], ovaryPathology: [],
    tubalStatus: 'Patent', hydrosalpinx: false,
    hysteroscopy: [], laparoscopy: []
  });

  // Rx State
  const [rxItems, setRxItems] = useState<PrescriptionItem[]>([]);
  const [drugCategory, setDrugCategory] = useState('');
  const [selectedDrug, setSelectedDrug] = useState('');

  // Initial Fetch
  useEffect(() => {
    db.getPatients().then(setPatients);
  }, []);

  const selectedPatient = patients.find(p => p.id === selectedPatientId);

  // Computed Values
  const bmiInfo = calculateBMI(Number(vitals.weight), Number(vitals.height));
  const spermDiagnosis = analyzeSemenAnalysis(maleParams.vol, maleParams.conc, maleParams.mot, maleParams.morph);

  // --- Female Logic Engine ---
  const getFemaleDiagnosis = () => {
    const findings: string[] = [];
    const fsh = Number(femaleData.fsh);
    const lh = Number(femaleData.lh);
    const e2 = Number(femaleData.e2);
    const prl = Number(femaleData.prolactin);
    const tsh = Number(femaleData.tsh);
    const amh = Number(femaleData.amh);
    const et = Number(femaleData.endoThickness);
    const afcTotal = Number(femaleData.afcR) + Number(femaleData.afcL);

    // Hormones
    if (fsh > 10) findings.push("Diminished Ovarian Reserve (FSH > 10)");
    if (fsh > 0 && lh / fsh > 2) findings.push("Suspect PCOS (LH/FSH ratio > 2)");
    if (e2 > 80) findings.push("Functional Cyst / Poor Responder Risk (High E2)");
    if (prl > 25) findings.push(prl > 100 ? "Hyperprolactinemia (Check MRI)" : "Hyperprolactinemia");
    if (tsh > 2.5) findings.push("Subclinical Hypothyroidism (Treat for Fertility)");
    if (femaleData.amh && amh < 1.0) findings.push("Low Ovarian Reserve (Poseidon Group)");
    if (amh > 3.5) findings.push("High Reserve (PCOS Risk)");

    // Ultrasound
    if (femaleData.endoThickness && et < 7) findings.push("Thin Endometrium (< 7mm)");
    if ((femaleData.afcR || femaleData.afcL) && afcTotal < 5) findings.push("Low AFC (< 5 Total)");
    if (femaleData.uterusPathology.length > 0) findings.push(`Uterus: ${femaleData.uterusPathology.join(', ')}`);
    if (femaleData.ovaryPathology.length > 0) findings.push(`Ovary: ${femaleData.ovaryPathology.join(', ')}`);

    // Tubes
    if (femaleData.hydrosalpinx) findings.push("CRITICAL: Hydrosalpinx (Clip/Remove before IVF)");
    if (femaleData.tubalStatus !== 'Patent') findings.push(`Tubes: ${femaleData.tubalStatus}`);
    
    // Scopes
    if (femaleData.laparoscopy.includes('Endometriosis')) findings.push("Endometriosis Confirmed");

    return findings;
  };

  const femaleFindings = getFemaleDiagnosis();

  // Handlers
  const handleAddDrug = () => {
    if (!drugCategory || !selectedDrug) return;
    // @ts-ignore
    const drugInfo = EGYPTIAN_DRUGS[drugCategory][selectedDrug];
    const dose = drugInfo ? drugInfo.dose : '';
    setRxItems([...rxItems, { category: drugCategory, drug: selectedDrug, dose }]);
    setSelectedDrug('');
  };

  const removeDrug = (idx: number) => {
    setRxItems(rxItems.filter((_, i) => i !== idx));
  };

  const handlePrint = () => {
    if (!selectedPatient || rxItems.length === 0) return;
    setTimeout(() => {
      window.print();
    }, 100);
  };

  const toggleCheckbox = (field: keyof FemaleFactor, value: string) => {
    const list = femaleData[field] as string[];
    const newList = list.includes(value) 
      ? list.filter(item => item !== value)
      : [...list, value];
    setFemaleData({ ...femaleData, [field]: newList });
  };

  return (
    <div className="space-y-6">
      {/* Patient Selector */}
      <div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 no-print">
        <label className="block text-sm font-bold text-gray-700 mb-2">Select Patient</label>
        <select 
          className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none bg-white"
          value={selectedPatientId}
          onChange={(e) => setSelectedPatientId(e.target.value)}
        >
          <option value="">-- Choose from Directory --</option>
          {patients.map(p => (
            <option key={p.id} value={p.id}>{p.name} (Husband: {p.husbandName})</option>
          ))}
        </select>
      </div>

      {selectedPatient && (
        <>
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 no-print">
            
            {/* LEFT COLUMN: Vitals + Male (3 cols) */}
            <div className="lg:col-span-3 space-y-6">
              {/* BMI Calculator */}
              <div className="bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 className="text-md font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <Activity className="w-4 h-4 text-teal-600" /> Vitals & BMI
                </h3>
                <div className="space-y-3">
                  <div className="flex gap-2">
                     <div className="flex-1">
                        <label className="text-xs text-gray-500">Weight (kg)</label>
                        <input type="number" className="w-full p-3 md:p-2 border rounded text-sm min-h-[48px]" value={vitals.weight} onChange={e => setVitals({...vitals, weight: e.target.value})} />
                     </div>
                     <div className="flex-1">
                        <label className="text-xs text-gray-500">Height (cm)</label>
                        <input type="number" className="w-full p-3 md:p-2 border rounded text-sm min-h-[48px]" value={vitals.height} onChange={e => setVitals({...vitals, height: e.target.value})} />
                     </div>
                  </div>
                  {bmiInfo.bmi > 0 && (
                    <div className={`p-2 rounded text-xs flex items-center gap-2 ${bmiInfo.alert ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>
                      {bmiInfo.alert ? <AlertTriangle className="w-4 h-4" /> : <div className="w-4 h-4 rounded-full border-2 border-green-600" />}
                      <span className="font-bold">{bmiInfo.bmi} {bmiInfo.alert && "(Obese)"}</span>
                    </div>
                  )}
                </div>
              </div>

              {/* Male Diagnosis */}
              <div className="bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 className="text-md font-bold text-gray-800 mb-3 flex items-center gap-2">
                   <Microscope className="w-4 h-4 text-blue-600" /> Male Factor
                </h3>
                <div className="space-y-3 text-sm">
                  <div>
                    <label className="text-xs text-gray-500">Volume (ml)</label>
                    <input type="number" placeholder="> 1.5" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, vol: parseFloat(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">Conc (M/ml)</label>
                    <input type="number" placeholder="> 15" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, conc: parseFloat(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">Motility (%)</label>
                    <input type="number" placeholder="> 40" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, mot: parseFloat(e.target.value)})} />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">Morphology (%)</label>
                    <input type="number" placeholder="> 4" className="w-full p-3 md:p-2 border rounded min-h-[48px]" onChange={e => setMaleParams({...maleParams, morph: parseFloat(e.target.value)})} />
                  </div>
                </div>
                <div className="mt-3 p-2 bg-blue-50 rounded text-xs font-bold text-blue-800 border border-blue-100">
                  {spermDiagnosis}
                </div>
              </div>
            </div>

            {/* MIDDLE COLUMN: Female Workup (6 cols) */}
            <div className="lg:col-span-5 flex flex-col gap-6">
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex-1 overflow-hidden flex flex-col">
                <div className="border-b border-gray-100">
                  <nav className="flex -mb-px">
                    <button
                      onClick={() => setActiveFemaleTab('hormones')}
                      className={`flex-1 py-4 text-center text-sm font-medium border-b-2 transition-colors ${activeFemaleTab === 'hormones' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                    >
                      ÿßŸÑŸáÿ±ŸÖŸàŸÜÿßÿ™ (Hormones)
                    </button>
                    <button
                      onClick={() => setActiveFemaleTab('us')}
                      className={`flex-1 py-4 text-center text-sm font-medium border-b-2 transition-colors ${activeFemaleTab === 'us' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                    >
                      ÿßŸÑÿ≥ŸàŸÜÿßÿ± (Ultrasound)
                    </button>
                    <button
                      onClick={() => setActiveFemaleTab('scope')}
                      className={`flex-1 py-4 text-center text-sm font-medium border-b-2 transition-colors ${activeFemaleTab === 'scope' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                    >
                      ÿßŸÑŸÖŸÜÿßÿ∏Ÿäÿ± (Endoscopy)
                    </button>
                  </nav>
                </div>

                <div className="p-6 flex-1 overflow-y-auto">
                  
                  {/* TAB 1: HORMONES */}
                  {activeFemaleTab === 'hormones' && (
                    <div className="grid grid-cols-2 gap-4">
                      <div className="col-span-2 text-xs text-gray-400 mb-2 font-bold">Day 2-3 Profile</div>
                      
                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">FSH (IU/L)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.fsh) > 10 ? 'border-red-300 bg-red-50' : ''}`} 
                          value={femaleData.fsh} onChange={e => setFemaleData({...femaleData, fsh: e.target.value})} />
                        {Number(femaleData.fsh) > 10 && <span className="text-[10px] text-red-600 absolute bottom-[-16px] right-0">Diminished Reserve</span>}
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">LH (IU/L)</label>
                        <input type="number" className="w-full p-2 border rounded-lg" 
                          value={femaleData.lh} onChange={e => setFemaleData({...femaleData, lh: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">E2 (pg/mL)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.e2) > 80 ? 'border-yellow-300 bg-yellow-50' : ''}`}
                          value={femaleData.e2} onChange={e => setFemaleData({...femaleData, e2: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">Prolactin (ng/mL)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.prolactin) > 25 ? 'border-red-300 bg-red-50' : ''}`}
                          value={femaleData.prolactin} onChange={e => setFemaleData({...femaleData, prolactin: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">TSH (mIU/L)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.tsh) > 2.5 ? 'border-yellow-300 bg-yellow-50' : ''}`}
                          value={femaleData.tsh} onChange={e => setFemaleData({...femaleData, tsh: e.target.value})} />
                      </div>

                      <div className="relative">
                        <label className="block text-xs font-medium text-gray-700 mb-1">AMH (ng/mL)</label>
                        <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.amh) < 1 ? 'border-red-300 bg-red-50' : Number(femaleData.amh) > 3.5 ? 'border-blue-300 bg-blue-50' : ''}`}
                          value={femaleData.amh} onChange={e => setFemaleData({...femaleData, amh: e.target.value})} />
                      </div>
                    </div>
                  )}

                  {/* TAB 2: ULTRASOUND */}
                  {activeFemaleTab === 'us' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">ÿ®ÿ∑ÿßŸÜÿ© ÿßŸÑÿ±ÿ≠ŸÖ (mm)</label>
                          <input type="number" className={`w-full p-2 border rounded-lg ${Number(femaleData.endoThickness) > 0 && Number(femaleData.endoThickness) < 7 ? 'border-red-300 bg-red-50' : ''}`}
                            value={femaleData.endoThickness} onChange={e => setFemaleData({...femaleData, endoThickness: e.target.value})} />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">AFC Right</label>
                          <input type="number" className="w-full p-2 border rounded-lg"
                            value={femaleData.afcR} onChange={e => setFemaleData({...femaleData, afcR: e.target.value})} />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">AFC Left</label>
                          <input type="number" className="w-full p-2 border rounded-lg"
                            value={femaleData.afcL} onChange={e => setFemaleData({...femaleData, afcL: e.target.value})} />
                        </div>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Uterus Pathology (ÿßŸÑÿ±ÿ≠ŸÖ)</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Fibroids', 'Polyps', 'Adenomyosis', 'Septum'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('uterusPathology', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.uterusPathology.includes(item) ? 'bg-pink-600 text-white border-pink-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Ovary Pathology (ÿßŸÑŸÖÿ®Ÿäÿ∂)</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Simple Cyst', 'Endometrioma', 'Dermoid', 'PCO Pattern'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('ovaryPathology', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.ovaryPathology.includes(item) ? 'bg-pink-600 text-white border-pink-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* TAB 3: SCOPES & TUBES */}
                  {activeFemaleTab === 'scope' && (
                    <div className="space-y-6">
                      
                      <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label className="block text-xs font-bold text-gray-700 mb-2">Tubal Patency (HSG/HyCoSy)</label>
                        <select 
                          className="w-full p-2 border rounded-lg mb-3"
                          value={femaleData.tubalStatus}
                          onChange={e => setFemaleData({...femaleData, tubalStatus: e.target.value})}
                        >
                          <option value="Patent">Patent Bilaterally (ÿ≥ŸÑŸäŸÖÿ©)</option>
                          <option value="Right Blocked">Right Blocked (ÿßŸÜÿ≥ÿØÿßÿØ ŸäŸÖŸäŸÜ)</option>
                          <option value="Left Blocked">Left Blocked (ÿßŸÜÿ≥ÿØÿßÿØ Ÿäÿ≥ÿßÿ±)</option>
                          <option value="Bilateral Block">Bilateral Block (ÿßŸÜÿ≥ÿØÿßÿØ ŸÉŸÑŸä)</option>
                        </select>
                        
                        <label className="flex items-center gap-3 p-3 bg-white border border-red-100 rounded-lg cursor-pointer hover:bg-red-50 transition-colors">
                          <input 
                            type="checkbox" 
                            checked={femaleData.hydrosalpinx} 
                            onChange={e => setFemaleData({...femaleData, hydrosalpinx: e.target.checked})} 
                            className="w-5 h-5 text-red-600 rounded focus:ring-red-500" 
                          />
                          <div>
                            <span className="font-bold text-red-800 block text-sm">Hydrosalpinx Detected</span>
                            <span className="text-xs text-red-600">ÿßÿ±ÿ™ÿ¥ÿßÿ≠ ÿ®ŸÇŸÜÿßÿ© ŸÅÿßŸÑŸàÿ® (Must remove before IVF)</span>
                          </div>
                        </label>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2">Hysteroscopy Findings</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Normal Cavity', 'Adhesions', 'Polypectomy', 'Septum Resection'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('hysteroscopy', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.hysteroscopy.includes(item) ? 'bg-purple-600 text-white border-purple-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div>
                        <h4 className="text-xs font-bold text-gray-500 mb-2">Laparoscopy Findings</h4>
                        <div className="flex flex-wrap gap-2">
                          {['Normal', 'Endometriosis I-II', 'Endometriosis III-IV', 'Adhesions'].map(item => (
                            <button
                              key={item}
                              onClick={() => toggleCheckbox('laparoscopy', item)}
                              className={`px-3 py-1 text-xs rounded-full border transition-colors ${femaleData.laparoscopy.includes(item) ? 'bg-purple-600 text-white border-purple-600' : 'bg-gray-50 text-gray-600 border-gray-200'}`}
                            >
                              {item}
                            </button>
                          ))}
                        </div>
                      </div>

                    </div>
                  )}

                </div>
                
                {/* Summary / Diagnosis Box */}
                <div className="bg-pink-50 p-4 border-t border-pink-100 min-h-[100px]">
                  <h4 className="text-xs font-bold text-pink-800 uppercase mb-2 flex items-center gap-2">
                    <Info className="w-4 h-4" /> Diagnosis & Findings
                  </h4>
                  {femaleFindings.length > 0 ? (
                    <ul className="list-disc list-inside space-y-1">
                      {femaleFindings.map((finding, i) => (
                        <li key={i} className="text-sm text-pink-900 font-medium">
                          {finding}
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p className="text-xs text-pink-400 italic">Enter data to generate diagnosis...</p>
                  )}
                </div>
              </div>
            </div>

            {/* RIGHT COLUMN: Smart Rx (3 cols) */}
            <div className="lg:col-span-4 bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
              <h3 className="text-md font-bold text-gray-800 mb-4 flex items-center gap-2">
                <FileText className="w-4 h-4 text-teal-600" /> Smart Prescription
              </h3>
              
              <div className="space-y-3 mb-4">
                <div>
                  <label className="text-xs font-medium text-gray-600">Category</label>
                  <select 
                    className="w-full p-2 border rounded-lg mt-1 text-sm"
                    value={drugCategory}
                    onChange={e => { setDrugCategory(e.target.value); setSelectedDrug(''); }}
                  >
                    <option value="">Select Category</option>
                    {Object.keys(EGYPTIAN_DRUGS).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </select>
                </div>
                
                <div>
                  <label className="text-xs font-medium text-gray-600">Medication</label>
                  <select 
                    className="w-full p-2 border rounded-lg mt-1 text-sm"
                    value={selectedDrug}
                    onChange={e => setSelectedDrug(e.target.value)}
                    disabled={!drugCategory}
                  >
                    <option value="">Select Drug</option>
                    {drugCategory && Object.keys((EGYPTIAN_DRUGS as any)[drugCategory]).map(d => (
                      <option key={d} value={d}>{d}</option>
                    ))}
                  </select>
                </div>

                <button 
                  onClick={handleAddDrug}
                  disabled={!selectedDrug}
                  className="w-full bg-teal-600 text-white py-2 rounded-lg font-bold hover:bg-teal-700 disabled:bg-gray-300 transition-colors flex items-center justify-center gap-2 text-sm"
                >
                  <Plus className="w-4 h-4" /> Add
                </button>
              </div>

              <div className="flex-1 border border-gray-100 rounded-lg p-3 bg-gray-50 overflow-y-auto max-h-[300px]">
                {rxItems.length === 0 ? (
                  <p className="text-center text-gray-400 text-xs mt-10">No items added</p>
                ) : (
                  <ul className="space-y-2">
                    {rxItems.map((item, idx) => (
                      <li key={idx} className="bg-white p-2 rounded shadow-sm flex justify-between items-start">
                        <div>
                          <div className="font-bold text-gray-800 text-sm">{item.drug}</div>
                          <div className="text-xs text-teal-600 font-mono mt-0.5">{item.dose}</div>
                        </div>
                        <button onClick={() => removeDrug(idx)} className="text-red-400 hover:text-red-600">
                          <Trash2 className="w-3 h-3" />
                        </button>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
              
              <div className="mt-4 pt-3 border-t border-gray-100">
                 <button 
                  onClick={handlePrint}
                  disabled={rxItems.length === 0}
                  className="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold hover:bg-gray-900 transition-colors flex items-center justify-center gap-2 text-sm"
                >
                  <Printer className="w-4 h-4" /> Print (A4)
                </button>
              </div>
            </div>
          </div>

          {/* PRINT VIEW - Hidden until print */}
          <div className="print-only w-full bg-white p-8" style={{ direction: 'rtl' }}>
            <div className="border-b-2 border-teal-700 pb-6 mb-8">
              <div className="flex flex-row-reverse justify-between items-end mb-4">
                <div className="text-right">
                  <h1 className="text-3xl font-bold text-teal-800">ŸÖÿ±ŸÉÿ≤ ŸÜŸäŸÑ ŸÑŸÑÿπŸÇŸÖ</h1>
                  <p className="text-gray-600 mt-2 text-sm">Nile IVF Center</p>
                </div>
                <div className="text-left text-sm text-gray-600">
                  <p>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: {new Date().toLocaleDateString('ar-EG')}</p>
                  <p>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±Ÿäÿ∂ÿ©: <strong>{selectedPatient?.name}</strong></p>
                </div>
              </div>
            </div>

            <div className="mb-8">
              <h2 className="text-center text-2xl font-bold text-gray-800 mb-6">ÿßŸÑÿ±Ÿàÿ¥ÿ™ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©</h2>
              <h3 className="text-4xl font-serif text-teal-700 text-center mb-8">R/</h3>
              
              <div className="space-y-4">
                {rxItems.map((item, idx) => (
                  <div key={idx} className="border-b border-gray-300 pb-3 flex flex-row-reverse justify-between items-start">
                    <div className="text-right flex-1">
                      <div className="font-bold text-lg text-gray-800">{item.drug}</div>
                      <div className="text-sm text-teal-700 font-medium mt-1">{item.dose}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="border-t border-gray-300 pt-6 mt-12 text-center text-xs text-gray-500">
              <p>Nile IVF Center - Cairo, Egypt</p>
              <p className="mt-1">+20 123 456 7890</p>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default ClinicalStation;
</file>

<file path="types.ts">
export interface Patient {
  id: string;
  name: string;
  age: number;
  phone: string;
  husbandName: string;
  history: string;
  createdAt: string;
}

export interface Visit {
  id: string;
  patientId: string;
  date: string;
  department?: string; // 'GYNA', 'OBS', 'IVF_STIM', 'IVF_LAB'
  diagnosis: string;
  prescription: PrescriptionItem[];
  notes: string;
  clinical_data?: any; // JSONB for structured clinical data
  vitals?: {
    weight?: number;
    height?: number;
    bmi?: number;
  };
}

export interface PrescriptionItem {
  category: string;
  drug: string;
  dose: string;
}

export interface MaleFactorAssessment {
  volume?: number;
  concentration?: number;
  motility?: number;
  morphology?: number;
  tmsc?: number;
  diagnosis?: string;
  icsiIndicated?: boolean;
}

export interface FemaleFactorAssessment {
  amh?: number;
  fsh?: number;
  lh?: number;
  e2?: number;
  afcRight?: number;
  afcLeft?: number;
  ovaryClassification?: 'Poor Responder' | 'Normal' | 'High Responder';
}

export interface TubalUterineAssessment {
  hsgFindings?: string;
  hysteroscopyFindings?: string;
  septate?: boolean;
  polyps?: boolean;
  adhesions?: boolean;
}

export interface CoupleProfileAssessment {
  infertilityDuration?: number;
  infertilityType?: 'Primary' | 'Secondary';
  previousAttempts?: number;
  height?: number;
  weight?: number;
  bmi?: number;
  bmiAlert?: boolean;
}

export interface ImagingAssessment {
  baselineUltrasound: {
    uterus: { dimensions: string, myometrium: string, cavity: string };
    endometrium: { thickness: number, pattern: string };
    ovaries: {
      afcRight: number;
      afcLeft: number;
      pathology: { cyst: boolean, endometrioma: boolean, dermoid: boolean };
    };
    adnexa: { hydrosalpinx: boolean };
  };
  hysteroscopyHSG: {
    status: string[];
    actionTaken: string;
  };
}

export interface CycleAssessment {
  coupleProfile?: CoupleProfileAssessment;
  maleFactor?: MaleFactorAssessment;
  femaleFactor?: FemaleFactorAssessment;
  tubalUterine?: TubalUterineAssessment;
  imaging?: ImagingAssessment;
}

export interface StimulationLog {
  id: string;
  date: string;
  cycleDay: number;
  fsh: string;
  hmg: string;
  e2: string;
  lh: string;
  rtFollicles: string;
  ltFollicles: string;
  endometriumThickness?: string;
}

export interface OpuLabData {
  opuDate?: string;
  totalOocytes?: number;
  mii?: number;
  mi?: number;
  gv?: number;
  atretic?: number;
  maturationRate?: number;
  fertilizedTwoPN?: number;
  fertilizationRate?: number;
  embryoDay3A?: number;
  embryoDay3B?: number;
  embryoDay3C?: number;
  blastocystsExpanded?: number;
  blastocystsHatching?: number;
}

export interface TransferData {
  transferDate?: string;
  numberTransferred?: number;
  embryoQuality?: string;
  catheterDifficulty?: 'Easy' | 'Moderate' | 'Difficult';
  lutealSupport?: string[];
}

export interface OutcomeData {
  betaHcg?: number;
  betaHcgPositive?: boolean;
  clinicalPregnancy?: boolean;
  gestationalSac?: boolean;
  fHR?: boolean;
}

export interface IvfCycle {
  id: string;
  patientId: string;
  protocol: 'Long' | 'Antagonist' | 'Flare-up' | 'Mini-IVF';
  startDate: string;
  status: 'Active' | 'Completed' | 'Cancelled';
  assessment?: CycleAssessment;
  logs: StimulationLog[];
  lab?: OpuLabData;
  transfer?: TransferData;
  outcome?: OutcomeData;
  cycleData?: any;
}

export interface Doctor {
  id: string;
  user_id: string;
  email: string;
  name: string;
  specialization?: string;
  phone?: string;
  created_at?: string;
  doctor_image?: string;
  clinic_name?: string;
  clinic_address?: string;
  clinic_phone?: string;
  clinic_image?: string;
  clinic_latitude?: string;
  clinic_longitude?: string;
}

export interface Pregnancy {
  id: string;
  patient_id: string;
  lmp_date?: string;
  edd_date?: string;
  edd_by_scan?: string;
  ga_at_booking?: number;
  risk_level: 'low' | 'moderate' | 'high';
  risk_factors: string[];
  aspirin_prescribed: boolean;
  thromboprophylaxis_needed: boolean;
  created_at?: string;
  updated_at?: string;
}

export interface AntenatalVisit {
  id: string;
  pregnancy_id: string;
  visit_date: string;
  gestational_age_weeks: number;
  gestational_age_days: number;
  systolic_bp?: number;
  diastolic_bp?: number;
  weight_kg?: number;
  urine_albuminuria?: string;
  urine_glycosuria?: string;
  fetal_heart_sound?: boolean;
  fundal_height_cm?: number;
  edema?: boolean;
  edema_grade?: string;
  notes?: string;
  next_visit_date?: string;
  created_at?: string;
}

export interface BiometryScan {
  id: string;
  pregnancy_id: string;
  scan_date: string;
  gestational_age_weeks: number;
  gestational_age_days: number;
  bpd_mm?: number;
  hc_mm?: number;
  ac_mm?: number;
  fl_mm?: number;
  efw_grams?: number;
  percentile?: number;
  notes?: string;
  created_at?: string;
}

export interface ObstetricsData {
  id?: string;
  patientId: string;
  lmp: string | null;
  edd: string | null;
  gestationalAge?: string;
  riskFactors: string[];
  isHighRisk: boolean;
  notes?: string;
}

export interface AntenatalVisitData {
  id: string;
  date: string;
  gaWeeks: number;
  bp: string;
  weight: string;
  urine: string;
  fetalHeart: string;
  fundalHeight?: string;
  edema?: string;
  notes: string;
}

export interface FetalBiometryData {
  date: string;
  bpd?: number;
  fl?: number;
  ac?: number;
  hc?: number;
  efw?: number;
  afi?: number;
  placenta?: string;
}

export enum Page {
  HOME = 'home',
  RECEPTION = 'reception',
  CLINICAL = 'clinical',
  GYNECOLOGY = 'gynecology',
  IVF = 'ivf',
  PATIENT_RECORD = 'patient_record',
  SETTINGS = 'settings',
  OBSTETRICS = 'obstetrics',
  ADMIN = 'admin'
}
</file>

<file path="pages/IvfJourney.tsx">
import React, { useState, useEffect } from 'react';
import { db, calculateTMSC, analyzeSemenAnalysis, classifyOvarianReserve, calculateMaturationRate, calculateFertilizationRate } from '../services/ivfService';
import { Patient, PrescriptionItem, CycleAssessment, OpuLabData, TransferData, OutcomeData } from '../types';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Baby, TestTube, PlusCircle, TrendingUp, PipetteIcon, Heart, Save, AlertCircle, CheckCircle, Pill, Printer } from 'lucide-react';
import toast from 'react-hot-toast';
import PrescriptionComponent from '../components/PrescriptionComponent';
import PrescriptionPrinter from '../components/PrescriptionPrinter';
import { supabase } from '../services/supabaseClient';

// Comprehensive Cycle Data Interface using existing types
interface CycleData {
  id: string;
  protocol: string;
  status: 'Assessment' | 'Active' | 'PickUp' | 'Transfer' | 'Frozen' | 'Done';
  assessment: CycleAssessment & {
    plan?: {
      recommendedProtocol: string;
      startingDose: string;
      trigger: string;
      hint: string;
      suggestedMeds: string[];
    };
  };
  stimulation: {
    logs: Array<{ date: string, cd: number, fsh: number, hmg: number, e2: number, lh: number, folliclesRt: string, folliclesLt: string }>;
    trigger: { date: string, type: string, hours: number };
    prescription: Array<string>;
  };
  lab: OpuLabData;
  transfer: TransferData;
  outcome: OutcomeData;
}

// Smart Protocol Recommender Engine
const recommendProtocol = (age: number, bmi: number, amh: number, afc: number, pcosHistory: boolean) => {
  // High Responder Criteria (PCOS or AMH > 3.5 or AFC > 20)
  if (pcosHistory || amh > 3.5 || afc > 20) {
    return {
      recommendedProtocol: 'GnRH Antagonist',
      trigger: 'Agonist Trigger (Decapeptyl) or Dual Trigger',
      startingDose: '150 IU',
      hint: 'High risk of OHSS. Avoid hCG trigger alone. Freeze-all strategy preferred.',
      suggestedMeds: ['Gonal-F 75 IU', 'Merional 75 IU', 'Cetrotide 0.25mg', 'Decapeptyl 0.1mg (Trigger)']
    };
  }

  // Poor Responder Criteria (AMH < 1.1)
  if (amh < 1.1) {
    return {
      recommendedProtocol: 'GnRH Antagonist or Short Flare',
      trigger: 'Ovitrelle 250mcg',
      startingDose: '300 - 450 IU',
      hint: 'Expect low oocyte yield. Consider accumulation cycles. Adjuvants: DHEA/Growth Hormone priming.',
      suggestedMeds: ['Gonal-F 300 IU', 'Merional 150 IU', 'Cetrotide 0.25mg', 'Ovitrelle 250mcg']
    };
  }

  // Normal Responder (AMH 1.2 - 3.5)
  return {
    recommendedProtocol: 'GnRH Antagonist',
    trigger: 'Ovitrelle 250mcg',
    startingDose: '225 IU',
    hint: 'Standard response expected.',
    suggestedMeds: ['Gonal-F 75 IU', 'Merional 75 IU', 'Cetrotide 0.25mg', 'Ovitrelle 250mcg']
  };
};

// Utility function for safe nested state updates
const updateNestedState = <T extends Record<string, any>>(
  obj: T,
  path: string[],
  value: any
): T => {
  if (path.length === 0) return obj;

  const [head, ...tail] = path;
  if (tail.length === 0) {
    return { ...obj, [head]: value };
  }

  const nested = obj[head] || {};
  return {
    ...obj,
    [head]: updateNestedState(nested, tail, value)
  };
};

// Input validation utilities
const validateNumericInput = (value: string, min: number = 0, max?: number): number => {
  const num = parseFloat(value);
  if (isNaN(num) || num < min || (max !== undefined && num > max)) {
    throw new Error(`Invalid input: must be a number between ${min} and ${max || 'unlimited'}`);
  }
  return num;
};

const safeParseInt = (value: string, defaultValue: number = 0): number => {
  const parsed = parseInt(value, 10);
  return isNaN(parsed) ? defaultValue : parsed;
};

const defaultImaging = {
  baselineUltrasound: {
    uterus: { dimensions: '', myometrium: '', cavity: '' },
    endometrium: { thickness: 0, pattern: '' },
    ovaries: {
      afcRight: 0,
      afcLeft: 0,
      pathology: { cyst: false, endometrioma: false, dermoid: false }
    },
    adnexa: { hydrosalpinx: false }
  },
  hysteroscopyHSG: {
    status: [],
    actionTaken: ''
  }
};

const IvfJourney: React.FC = () => {
  const [patients, setPatients] = useState<Patient[]>([]);
  const [selectedPatientId, setSelectedPatientId] = useState('');
  const [cycleData, setCycleData] = useState<CycleData | null>(null);
  const [activeTab, setActiveTab] = useState<'assessment' | 'stimulation' | 'lab' | 'transfer'>('assessment');
  const [prescription, setPrescription] = useState<PrescriptionItem[]>([]);
  const [isPrinterOpen, setIsPrinterOpen] = useState(false);

  // Load patients on mount
  useEffect(() => {
    const loadPatients = async () => {
      try {
        const pats = await db.getPatients();
        setPatients(pats);
      } catch (error) {
        toast.error('Failed to load patients');
      }
    };
    loadPatients();
  }, []);

  // Load cycle data when patient changes
  useEffect(() => {
    const loadCycle = async () => {
      if (selectedPatientId) {
        try {
          const cycles = await db.getCycles();
          const activeCycle = cycles.find(c => c.patientId === selectedPatientId && c.status === 'Active');

          if (activeCycle) {
            // Load existing cycle data
            setCycleData({
              id: activeCycle.id,
              protocol: activeCycle.protocol,
              status: activeCycle.status as any,
              assessment: {
                ...(activeCycle.assessment || {
                  coupleProfile: {},
                  maleFactor: {},
                  femaleFactor: {},
                  tubalUterine: {}
                }),
                imaging: activeCycle.assessment?.imaging || defaultImaging
              },
              stimulation: {
                logs: activeCycle.logs.map(log => ({
                  date: log.date,
                  cd: log.cycleDay,
                  fsh: parseFloat(log.fsh) || 0,
                  hmg: parseFloat(log.hmg) || 0,
                  e2: parseFloat(log.e2) || 0,
                  lh: parseFloat(log.lh) || 0,
                  folliclesRt: log.rtFollicles,
                  folliclesLt: log.ltFollicles
                })),
                trigger: { date: '', type: '', hours: 0 },
                prescription: []
              },
              lab: activeCycle.lab || {},
              transfer: activeCycle.transfer || { lutealSupport: [] },
              outcome: activeCycle.outcome || {}
            });
          } else {
            // Initialize new cycle
            setCycleData(null);
          }
        } catch (error) {
          toast.error('Failed to load cycle data');
        }
      }
    };
    loadCycle();
  }, [selectedPatientId]);

  // Start new cycle
  const startNewCycle = async (protocol: string) => {
    if (!selectedPatientId) {
      toast.error('Select a patient first');
      return;
    }

    const toastId = toast.loading('Starting new cycle...');
    try {
      const newCycle = await db.saveCycle({
        patientId: selectedPatientId,
        protocol: protocol as any,
        startDate: new Date().toISOString().split('T')[0],
        status: 'Active'
      });

      setCycleData({
        id: newCycle.id,
        protocol: protocol,
        status: 'Active',
        assessment: {
          coupleProfile: {},
          maleFactor: {},
          femaleFactor: {},
          tubalUterine: {},
          imaging: defaultImaging
        },
        stimulation: {
          logs: [],
          trigger: { date: '', type: '', hours: 0 },
          prescription: []
        },
        lab: {},
        transfer: { lutealSupport: [] },
        outcome: {}
      });

      setActiveTab('assessment');
      toast.success('New IVF Cycle Started', { id: toastId });
    } catch (error) {
      toast.error('Error starting cycle', { id: toastId });
    }
  };

  // Save cycle data to Supabase
  const saveCycleData = async (section: keyof CycleData, data: any) => {
    if (!cycleData) return;

    try {
      const updateData: any = {};
      updateData[`${section}_data`] = data;
      updateData.updated_at = new Date().toISOString();

      const { error } = await supabase
        .from('ivf_cycles')
        .update(updateData)
        .eq('id', cycleData.id);

      if (error) throw error;

      setCycleData({ ...cycleData, [section]: data });
      toast.success(`${section.charAt(0).toUpperCase() + section.slice(1)} saved successfully`);
    } catch (error) {
      toast.error(`Failed to save ${section} data`);
    }
  };

  // Auto-calculations
  const maleTMSC = calculateTMSC(
    cycleData?.assessment.maleFactor?.volume || 0,
    cycleData?.assessment.maleFactor?.concentration || 0,
    cycleData?.assessment.maleFactor?.motility || 0
  );

  const maleDiagnosis = analyzeSemenAnalysis(
    cycleData?.assessment.maleFactor?.volume || 0,
    cycleData?.assessment.maleFactor?.concentration || 0,
    cycleData?.assessment.maleFactor?.motility || 0,
    cycleData?.assessment.maleFactor?.morphology || 0
  );

  const ovarianReserve = classifyOvarianReserve(
    cycleData?.assessment.femaleFactor?.amh,
    cycleData?.assessment.femaleFactor?.afcRight
  );

  const maturationRate = calculateMaturationRate(
    cycleData?.lab.totalOocytes || 0,
    cycleData?.lab.mii || 0
  );

  const fertilizationRate = calculateFertilizationRate(
    cycleData?.lab.fertilizedTwoPN || 0,
    cycleData?.lab.mii || 0
  );

  // Chart data for stimulation
  const chartData = cycleData?.stimulation.logs.map(log => ({
    day: `D${log.cd}`,
    e2: log.e2,
    follicles: (log.folliclesRt.split(',').length + log.folliclesLt.split(',').length) || 0
  })) || [];

  const selectedPatient = patients.find(p => p.id === selectedPatientId);

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      {/* Header */}
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100" dir="ltr">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Select Patient</label>
            <select
              className="w-full px-4 py-2 border border-gray-200 rounded-lg outline-none focus:border-teal-500"
              value={selectedPatientId}
              onChange={(e) => setSelectedPatientId(e.target.value)}
            >
              <option value="">-- Select Patient --</option>
              {patients.map(p => (
                <option key={p.id} value={p.id}>{p.name}</option>
              ))}
            </select>
          </div>

          {selectedPatientId && !cycleData && (
            <>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">Protocol</label>
                <select
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg outline-none focus:border-teal-500"
                  id="protocol-select"
                >
                  <option value="Long">Long Protocol</option>
                  <option value="Antagonist">Antagonist Protocol</option>
                  <option value="Flare-up">Flare-up Protocol</option>
                </select>
              </div>
              <button
                onClick={() => {
                  const protocol = (document.getElementById('protocol-select') as HTMLSelectElement).value;
                  startNewCycle(protocol);
                }}
                className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors"
              >
                Start New Cycle
              </button>
            </>
          )}
        </div>
      </div>

      {cycleData ? (
        <>
          {/* Tabs Navigation */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div className="flex flex-wrap border-b border-gray-100 bg-gray-50">
              {[
                { id: 'assessment', label: 'üìã ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ∞ŸÉŸä', icon: 'üìã' },
                { id: 'stimulation', label: 'üíâ ÿßŸÑÿ™ÿ≠ŸÅŸäÿ≤ ŸàÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©', icon: 'üíâ' },
                { id: 'lab', label: 'üî¨ ÿßŸÑŸÖÿπŸÖŸÑ ŸàÿßŸÑÿ£ÿ¨ŸÜÿ©', icon: 'üî¨' },
                { id: 'transfer', label: 'üë∂ ÿßŸÑŸÜŸÇŸÑ ŸàÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©', icon: 'üë∂' }
              ].map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`flex-1 px-4 py-3 font-bold text-sm transition-colors ${
                    activeTab === tab.id
                      ? 'border-b-4 border-teal-600 text-teal-700 bg-teal-50'
                      : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            <div className="p-6">
              {/* Tab 1: Smart Assessment */}
              {activeTab === 'assessment' && (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-gray-800">üìã ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ∞ŸÉŸä - Smart Assessment</h3>

                  {/* Male Factor */}
                  <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h4 className="text-lg font-semibold text-blue-800 mb-4">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ∞ŸÉÿ±Ÿä - Male Factor (WHO 2021)</h4>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Volume (mL)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={cycleData.assessment.maleFactor?.volume || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              maleFactor: { ...cycleData.assessment.maleFactor, volume: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Concentration (M/mL)</label>
                        <input
                          type="number"
                          value={cycleData.assessment.maleFactor?.concentration || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              maleFactor: { ...cycleData.assessment.maleFactor, concentration: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Motility (%)</label>
                        <input
                          type="number"
                          value={cycleData.assessment.maleFactor?.motility || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              maleFactor: { ...cycleData.assessment.maleFactor, motility: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Morphology (%)</label>
                        <input
                          type="number"
                          value={cycleData.assessment.maleFactor?.morphology || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              maleFactor: { ...cycleData.assessment.maleFactor, morphology: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>

                    <div className="mt-4 p-4 bg-blue-100 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <TrendingUp className="w-5 h-5 text-blue-600" />
                        <span className="font-semibold text-blue-800">TMSC: {maleTMSC}M</span>
                      </div>
                      <div className="text-sm text-blue-700">Diagnosis: {maleDiagnosis}</div>
                      {maleTMSC < 5 && (
                        <div className="flex items-center gap-2 mt-2 text-red-600">
                          <AlertCircle className="w-4 h-4" />
                          <span className="font-semibold">üî¥ Severe Male Factor (ICSI Required)</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Female Factor */}
                  <div className="bg-pink-50 p-6 rounded-lg border border-pink-200">
                    <h4 className="text-lg font-semibold text-pink-800 mb-4">ÿßŸÑÿπÿßŸÖŸÑ ÿßŸÑÿ£ŸÜÿ´ŸàŸä - Female Factor (Ovarian Reserve)</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">AMH (ng/mL)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={cycleData.assessment.femaleFactor?.amh || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              femaleFactor: { ...cycleData.assessment.femaleFactor, amh: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">FSH (IU/L)</label>
                        <input
                          type="number"
                          value={cycleData.assessment.femaleFactor?.fsh || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              femaleFactor: { ...cycleData.assessment.femaleFactor, fsh: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">AFC</label>
                        <input
                          type="number"
                          value={cycleData.assessment.femaleFactor?.afcRight || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              femaleFactor: { ...cycleData.assessment.femaleFactor, afcRight: parseFloat(e.target.value) || 0 }
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        />
                      </div>
                    </div>

                    <div className="mt-4 p-4 bg-pink-100 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <CheckCircle className="w-5 h-5 text-pink-600" />
                        <span className="font-semibold text-pink-800">Ovarian Classification: {ovarianReserve}</span>
                      </div>
                      {ovarianReserve === 'High Responder' && (
                        <div className="flex items-center gap-2 mt-2 text-purple-600">
                          <AlertCircle className="w-4 h-4" />
                          <span className="font-semibold">‚ö†Ô∏è High Responder (PCOS Risk - OHSS Prevention)</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Advanced Imaging Section */}
                  <div className="bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                    <h4 className="text-lg font-semibold text-indigo-800 mb-4 flex items-center gap-2">
                      üì∫ ÿßŸÑÿ™ÿµŸàŸäÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖ - Advanced Imaging
                    </h4>

                    {/* Baseline Ultrasound */}
                    <div className="mb-6">
                      <h5 className="text-md font-semibold text-indigo-700 mb-3">Baseline Ultrasound (TVS)</h5>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Uterus */}
                        <div className="space-y-3">
                          <h6 className="font-medium text-gray-700">Uterus</h6>
                          <div>
                            <label className="block text-sm text-gray-600">Dimensions</label>
                            <input
                              value={cycleData.assessment.imaging?.baselineUltrasound.uterus.dimensions || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                assessment: {
                                  ...cycleData.assessment,
                                  imaging: {
                                    ...cycleData.assessment.imaging,
                                    baselineUltrasound: {
                                      ...cycleData.assessment.imaging?.baselineUltrasound,
                                      uterus: { ...cycleData.assessment.imaging?.baselineUltrasound?.uterus, dimensions: e.target.value }
                                    }
                                  }
                                }
                              })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                              placeholder="e.g., 7.2 x 4.1 x 5.8 cm"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-gray-600">Myometrium</label>
                            <select
                              value={cycleData.assessment.imaging?.baselineUltrasound.uterus.myometrium || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                assessment: {
                                  ...cycleData.assessment,
                                  imaging: {
                                    ...cycleData.assessment.imaging,
                                    baselineUltrasound: {
                                      ...cycleData.assessment.imaging?.baselineUltrasound,
                                      uterus: { ...cycleData.assessment.imaging?.baselineUltrasound?.uterus, myometrium: e.target.value }
                                    }
                                  }
                                }
                              })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                              <option value="">Select</option>
                              <option value="Normal">Normal</option>
                              <option value="Adenomyosis">Adenomyosis</option>
                              <option value="Fibroids">Fibroids</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm text-gray-600">Cavity</label>
                            <select
                              value={cycleData.assessment.imaging?.baselineUltrasound.uterus.cavity || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                assessment: {
                                  ...cycleData.assessment,
                                  imaging: {
                                    ...cycleData.assessment.imaging,
                                    baselineUltrasound: {
                                      ...cycleData.assessment.imaging?.baselineUltrasound,
                                      uterus: { ...cycleData.assessment.imaging?.baselineUltrasound?.uterus, cavity: e.target.value }
                                    }
                                  }
                                }
                              })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                              <option value="">Select</option>
                              <option value="Normal">Normal</option>
                              <option value="Polyp">Polyp</option>
                            </select>
                          </div>
                        </div>

                        {/* Endometrium */}
                        <div className="space-y-3">
                          <h6 className="font-medium text-gray-700">Endometrium</h6>
                          <div>
                            <label className="block text-sm text-gray-600">Thickness (mm)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={cycleData.assessment.imaging?.baselineUltrasound.endometrium.thickness || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                assessment: {
                                  ...cycleData.assessment,
                                  imaging: {
                                    ...cycleData.assessment.imaging,
                                    baselineUltrasound: {
                                      ...cycleData.assessment.imaging?.baselineUltrasound,
                                      endometrium: { ...cycleData.assessment.imaging?.baselineUltrasound?.endometrium, thickness: parseFloat(e.target.value) || 0 }
                                    }
                                  }
                                }
                              })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-gray-600">Pattern</label>
                            <select
                              value={cycleData.assessment.imaging?.baselineUltrasound.endometrium.pattern || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                assessment: {
                                  ...cycleData.assessment,
                                  imaging: {
                                    ...cycleData.assessment.imaging,
                                    baselineUltrasound: {
                                      ...cycleData.assessment.imaging?.baselineUltrasound,
                                      endometrium: { ...cycleData.assessment.imaging?.baselineUltrasound?.endometrium, pattern: e.target.value }
                                    }
                                  }
                                }
                              })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                              <option value="">Select</option>
                              <option value="Triple Line">Triple Line</option>
                              <option value="Homogeneous">Homogeneous</option>
                              <option value="Echogenic">Echogenic</option>
                            </select>
                          </div>
                        </div>
                      </div>

                      {/* Ovaries */}
                      <div className="mt-4">
                        <h6 className="font-medium text-gray-700 mb-3">Ovaries</h6>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm text-gray-600">AFC Right</label>
                            <input
                              type="number"
                              value={cycleData.assessment.imaging?.baselineUltrasound.ovaries.afcRight || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                assessment: {
                                  ...cycleData.assessment,
                                  imaging: {
                                    ...cycleData.assessment.imaging,
                                    baselineUltrasound: {
                                      ...cycleData.assessment.imaging?.baselineUltrasound,
                                      ovaries: { ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries, afcRight: parseInt(e.target.value) || 0 }
                                    }
                                  }
                                }
                              })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-gray-600">AFC Left</label>
                            <input
                              type="number"
                              min="0"
                              max="50"
                              value={cycleData?.assessment?.imaging?.baselineUltrasound?.ovaries?.afcLeft || ''}
                              onChange={(e) => {
                                try {
                                  const value = safeParseInt(e.target.value, 0);
                                  if (cycleData) {
                                    setCycleData(updateNestedState(
                                      cycleData,
                                      ['assessment', 'imaging', 'baselineUltrasound', 'ovaries', 'afcLeft'],
                                      value
                                    ));
                                  }
                                } catch (error) {
                                  toast.error('Invalid AFC value');
                                }
                              }}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-gray-600">Total AFC</label>
                            <input
                              type="number"
                              value={(cycleData.assessment.imaging?.baselineUltrasound.ovaries.afcRight || 0) + (cycleData.assessment.imaging?.baselineUltrasound.ovaries.afcLeft || 0)}
                              readOnly
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                            />
                          </div>
                        </div>

                        {/* Pathology Checkboxes */}
                        <div className="mt-3">
                          <label className="block text-sm text-gray-600 mb-2">Pathology</label>
                          <div className="flex gap-4">
                            <label className="flex items-center gap-2">
                              <input
                                type="checkbox"
                                checked={cycleData.assessment.imaging?.baselineUltrasound.ovaries.pathology.cyst || false}
                                onChange={(e) => setCycleData({
                                  ...cycleData,
                                  assessment: {
                                    ...cycleData.assessment,
                                    imaging: {
                                      ...cycleData.assessment.imaging,
                                      baselineUltrasound: {
                                        ...cycleData.assessment.imaging?.baselineUltrasound,
                                        ovaries: {
                                          ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries,
                                          pathology: { ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries.pathology, cyst: e.target.checked }
                                        }
                                      }
                                    }
                                  }
                                })}
                                className="rounded"
                              />
                              <span className="text-sm">Cyst</span>
                            </label>
                            <label className="flex items-center gap-2">
                              <input
                                type="checkbox"
                                checked={cycleData.assessment.imaging?.baselineUltrasound.ovaries.pathology.endometrioma || false}
                                onChange={(e) => setCycleData({
                                  ...cycleData,
                                  assessment: {
                                    ...cycleData.assessment,
                                    imaging: {
                                      ...cycleData.assessment.imaging,
                                      baselineUltrasound: {
                                        ...cycleData.assessment.imaging?.baselineUltrasound,
                                        ovaries: {
                                          ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries,
                                          pathology: { ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries.pathology, endometrioma: e.target.checked }
                                        }
                                      }
                                    }
                                  }
                                })}
                                className="rounded"
                              />
                              <span className="text-sm">Endometrioma</span>
                            </label>
                            <label className="flex items-center gap-2">
                              <input
                                type="checkbox"
                                checked={cycleData.assessment.imaging?.baselineUltrasound.ovaries.pathology.dermoid || false}
                                onChange={(e) => setCycleData({
                                  ...cycleData,
                                  assessment: {
                                    ...cycleData.assessment,
                                    imaging: {
                                      ...cycleData.assessment.imaging,
                                      baselineUltrasound: {
                                        ...cycleData.assessment.imaging?.baselineUltrasound,
                                        ovaries: {
                                          ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries,
                                          pathology: { ...cycleData.assessment.imaging?.baselineUltrasound?.ovaries.pathology, dermoid: e.target.checked }
                                        }
                                      }
                                    }
                                  }
                                })}
                                className="rounded"
                              />
                              <span className="text-sm">Dermoid</span>
                            </label>
                          </div>
                        </div>
                      </div>

                      {/* Adnexa */}
                      <div className="mt-4">
                        <h6 className="font-medium text-gray-700 mb-3">Adnexa</h6>
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={cycleData.assessment.imaging?.baselineUltrasound.adnexa.hydrosalpinx || false}
                            onChange={(e) => setCycleData({
                              ...cycleData,
                              assessment: {
                                ...cycleData.assessment,
                                imaging: {
                                  ...cycleData.assessment.imaging,
                                  baselineUltrasound: {
                                    ...cycleData.assessment.imaging?.baselineUltrasound,
                                    adnexa: { hydrosalpinx: e.target.checked }
                                  }
                                }
                              }
                            })}
                            className="rounded"
                          />
                          <span className="text-sm font-medium text-red-600">Hydrosalpinx (Critical - Requires Surgery)</span>
                        </label>
                        {cycleData.assessment.imaging?.baselineUltrasound.adnexa.hydrosalpinx && (
                          <div className="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
                            <div className="flex items-center gap-2 text-red-700">
                              <AlertCircle className="w-5 h-5" />
                              <span className="font-semibold">‚ö†Ô∏è Critical Finding: Hydrosalpinx detected</span>
                            </div>
                            <p className="text-sm text-red-600 mt-1">
                              Surgical intervention required before IVF. Hydrosalpinx significantly reduces pregnancy rates.
                            </p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Hysteroscopy / HSG Findings */}
                    <div className="border-t pt-4">
                      <h5 className="text-md font-semibold text-indigo-700 mb-3">Hysteroscopy / HSG Findings</h5>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-sm text-gray-600 mb-2">Status</label>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {['Patent Tubes', 'Blocked', 'Septum', 'Adhesions', 'Cavity Normal'].map(status => (
                              <label key={status} className="flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  checked={cycleData.assessment.imaging?.hysteroscopyHSG.status?.includes(status) || false}
                                  onChange={(e) => {
                                    const currentStatus = cycleData.assessment.imaging?.hysteroscopyHSG.status || [];
                                    const newStatus = e.target.checked
                                      ? [...currentStatus, status]
                                      : currentStatus.filter(s => s !== status);
                                    setCycleData({
                                      ...cycleData,
                                      assessment: {
                                        ...cycleData.assessment,
                                        imaging: {
                                          ...cycleData.assessment.imaging,
                                          hysteroscopyHSG: {
                                            ...cycleData.assessment.imaging?.hysteroscopyHSG,
                                            status: newStatus
                                          }
                                        }
                                      }
                                    });
                                  }}
                                  className="rounded"
                                />
                                <span className="text-sm">{status}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm text-gray-600">Action Taken</label>
                          <textarea
                            value={cycleData.assessment.imaging?.hysteroscopyHSG.actionTaken || ''}
                            onChange={(e) => setCycleData({
                              ...cycleData,
                              assessment: {
                                ...cycleData.assessment,
                                imaging: {
                                  ...cycleData.assessment.imaging,
                                  hysteroscopyHSG: {
                                    ...cycleData.assessment.imaging?.hysteroscopyHSG,
                                    actionTaken: e.target.value
                                  }
                                }
                              }
                            })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            rows={2}
                            placeholder="e.g., Septum resected on [date], Tubes patent after intervention"
                          />
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Smart Protocol Recommender */}
                  <div className="bg-green-50 p-6 rounded-lg border border-green-200">
                    <h4 className="text-lg font-semibold text-green-800 mb-4 flex items-center gap-2">
                      ü§ñ ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ™ŸàÿµŸäÿ© ÿßŸÑÿ∞ŸÉŸä - Smart Protocol Recommender
                    </h4>

                    <div className="flex gap-4 mb-4">
                      <button
                        onClick={() => {
                          const age = selectedPatient?.age || 0;
                          const bmi = cycleData.assessment.coupleProfile?.weight && cycleData.assessment.coupleProfile?.height
                            ? (cycleData.assessment.coupleProfile.weight / Math.pow(cycleData.assessment.coupleProfile.height / 100, 2))
                            : 0;
                          const amh = cycleData.assessment.femaleFactor?.amh || 0;
                          const afc = (cycleData.assessment.imaging?.baselineUltrasound.ovaries.afcRight || 0) +
                                     (cycleData.assessment.imaging?.baselineUltrasound.ovaries.afcLeft || 0);
                          const pcosHistory = false; // This would come from patient history

                          const recommendation = recommendProtocol(age, bmi, amh, afc, pcosHistory);

                          setCycleData({
                            ...cycleData,
                            assessment: {
                              ...cycleData.assessment,
                              plan: recommendation
                            }
                          });

                          toast.success('Protocol recommendation generated!');
                        }}
                        className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center gap-2"
                      >
                        <Pill className="w-5 h-5" />
                        ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ - Suggest Protocol
                      </button>
                    </div>

                    {cycleData.assessment.plan && (
                      <div className="bg-white p-4 rounded-lg border border-green-200">
                        <h5 className="font-semibold text-green-800 mb-3">üìã Recommended Protocol</h5>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div>
                            <span className="font-medium text-gray-700">Protocol:</span>
                            <span className="ml-2 font-bold text-green-700">{cycleData.assessment.plan.recommendedProtocol}</span>
                          </div>
                          <div>
                            <span className="font-medium text-gray-700">Starting Dose:</span>
                            <span className="ml-2 font-bold text-blue-700">{cycleData.assessment.plan.startingDose}</span>
                          </div>
                          <div>
                            <span className="font-medium text-gray-700">Trigger:</span>
                            <span className="ml-2 text-gray-700">{cycleData.assessment.plan.trigger}</span>
                          </div>
                        </div>

                        <div className="mb-4">
                          <span className="font-medium text-gray-700">Clinical Hint:</span>
                          <p className="mt-1 text-sm text-gray-600 bg-yellow-50 p-3 rounded border border-yellow-200">
                            üí° {cycleData.assessment.plan.hint}
                          </p>
                        </div>

                        <div className="mb-4">
                          <span className="font-medium text-gray-700 mb-2 block">Suggested Medications:</span>
                          <div className="flex flex-wrap gap-2">
                            {cycleData.assessment.plan.suggestedMeds.map((med, index) => (
                              <span key={index} className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                {med}
                              </span>
                            ))}
                          </div>
                        </div>

                        <button
                          onClick={() => {
                            setCycleData({
                              ...cycleData,
                              protocol: cycleData.assessment.plan!.recommendedProtocol
                            });
                            toast.success('Protocol applied to cycle!');
                          }}
                          className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors text-sm"
                        >
                          Apply to Plan
                        </button>
                      </div>
                    )}
                  </div>

                  <button
                    onClick={() => saveCycleData('assessment', cycleData.assessment)}
                    className="w-full bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition-colors"
                  >
                    <Save className="w-5 h-5 inline mr-2" />
                    ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇŸäŸäŸÖ - Save Assessment
                  </button>
                </div>
              )}

              {/* Tab 2: Stimulation & Monitoring */}
              {activeTab === 'stimulation' && (
                <div className="space-y-6">
                  <div className="flex justify-between items-center">
                    <h3 className="text-xl font-bold text-gray-800">üíâ ÿßŸÑÿ™ÿ≠ŸÅŸäÿ≤ ŸàÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© - Stimulation & Monitoring</h3>
                    <div className="text-sm text-gray-600">
                      Protocol: {cycleData.protocol} | Start: {cycleData.stimulation.logs[0]?.date || 'Not started'}
                    </div>
                  </div>

                  {/* Charts */}
                  {chartData.length > 0 && (
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                      <h4 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <TrendingUp className="w-5 h-5 text-teal-600" />
                        E2 Levels & Follicle Growth
                      </h4>
                      <div className="h-64">
                        <ResponsiveContainer width="100%" height="100%">
                          <LineChart data={chartData}>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#eee" />
                            <XAxis dataKey="day" axisLine={false} tickLine={false} />
                            <YAxis yAxisId="left" axisLine={false} tickLine={false} />
                            <YAxis yAxisId="right" orientation="right" axisLine={false} tickLine={false} />
                            <Tooltip />
                            <Legend />
                            <Line yAxisId="left" type="monotone" dataKey="e2" stroke="#00838f" strokeWidth={2} dot={{r: 3}} name="E2 (pg/mL)" />
                            <Line yAxisId="right" type="monotone" dataKey="follicles" stroke="#ff6b6b" strokeWidth={2} dot={{r: 3}} name="Follicles >14mm" />
                          </LineChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                  )}

                  {/* Stimulation Table */}
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm border border-gray-200 rounded-lg">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-4 py-3">CD</th>
                          <th className="px-4 py-3">Date</th>
                          <th className="px-4 py-3">FSH</th>
                          <th className="px-4 py-3">HMG</th>
                          <th className="px-4 py-3">E2</th>
                          <th className="px-4 py-3">LH</th>
                          <th className="px-4 py-3">Rt Follicles</th>
                          <th className="px-4 py-3">Lt Follicles</th>
                        </tr>
                      </thead>
                      <tbody>
                        {cycleData.stimulation.logs.map((log, index) => (
                          <tr key={index} className="border-t border-gray-200">
                            <td className="px-4 py-3 font-bold">D{log.cd}</td>
                            <td className="px-4 py-3">{log.date}</td>
                            <td className="px-4 py-3">
                              <input
                                type="number"
                                value={log.fsh || ''}
                                onChange={(e) => {
                                  const newLogs = [...cycleData.stimulation.logs];
                                  newLogs[index].fsh = parseFloat(e.target.value) || 0;
                                  setCycleData({
                                    ...cycleData,
                                    stimulation: { ...cycleData.stimulation, logs: newLogs }
                                  });
                                }}
                                className="w-16 px-2 py-1 border rounded text-center"
                              />
                            </td>
                            <td className="px-4 py-3">
                              <input
                                type="number"
                                value={log.hmg || ''}
                                onChange={(e) => {
                                  const newLogs = [...cycleData.stimulation.logs];
                                  newLogs[index].hmg = parseFloat(e.target.value) || 0;
                                  setCycleData({
                                    ...cycleData,
                                    stimulation: { ...cycleData.stimulation, logs: newLogs }
                                  });
                                }}
                                className="w-16 px-2 py-1 border rounded text-center"
                              />
                            </td>
                            <td className="px-4 py-3">
                              <input
                                type="number"
                                value={log.e2 || ''}
                                onChange={(e) => {
                                  const newLogs = [...cycleData.stimulation.logs];
                                  newLogs[index].e2 = parseFloat(e.target.value) || 0;
                                  setCycleData({
                                    ...cycleData,
                                    stimulation: { ...cycleData.stimulation, logs: newLogs }
                                  });
                                }}
                                className="w-16 px-2 py-1 border rounded text-center"
                              />
                            </td>
                            <td className="px-4 py-3">
                              <input
                                type="number"
                                value={log.lh || ''}
                                onChange={(e) => {
                                  const newLogs = [...cycleData.stimulation.logs];
                                  newLogs[index].lh = parseFloat(e.target.value) || 0;
                                  setCycleData({
                                    ...cycleData,
                                    stimulation: { ...cycleData.stimulation, logs: newLogs }
                                  });
                                }}
                                className="w-16 px-2 py-1 border rounded text-center"
                              />
                            </td>
                            <td className="px-4 py-3">
                              <input
                                value={log.folliclesRt}
                                onChange={(e) => {
                                  const newLogs = [...cycleData.stimulation.logs];
                                  newLogs[index].folliclesRt = e.target.value;
                                  setCycleData({
                                    ...cycleData,
                                    stimulation: { ...cycleData.stimulation, logs: newLogs }
                                  });
                                }}
                                className="w-24 px-2 py-1 border rounded text-center"
                                placeholder="18,20,22"
                              />
                            </td>
                            <td className="px-4 py-3">
                              <input
                                value={log.folliclesLt}
                                onChange={(e) => {
                                  const newLogs = [...cycleData.stimulation.logs];
                                  newLogs[index].folliclesLt = e.target.value;
                                  setCycleData({
                                    ...cycleData,
                                    stimulation: { ...cycleData.stimulation, logs: newLogs }
                                  });
                                }}
                                className="w-24 px-2 py-1 border rounded text-center"
                                placeholder="18,20,22"
                              />
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <button
                    onClick={() => {
                      const lastDay = cycleData.stimulation.logs.length > 0
                        ? cycleData.stimulation.logs[cycleData.stimulation.logs.length - 1].cd
                        : 0;
                      const newLog = {
                        date: new Date().toISOString().split('T')[0],
                        cd: lastDay + 1,
                        fsh: 0,
                        hmg: 0,
                        e2: 0,
                        lh: 0,
                        folliclesRt: '',
                        folliclesLt: ''
                      };
                      setCycleData({
                        ...cycleData,
                        stimulation: {
                          ...cycleData.stimulation,
                          logs: [...cycleData.stimulation.logs, newLog]
                        }
                      });
                    }}
                    className="flex items-center gap-2 text-green-700 font-bold hover:bg-green-100 px-4 py-2 rounded-lg transition-colors"
                  >
                    <PlusCircle className="w-5 h-5" />
                    ÿ•ÿ∂ÿßŸÅÿ© ŸäŸàŸÖ - Add Day
                  </button>

                  {/* Prescription Integration */}
                  <div className="bg-white p-6 rounded-lg border border-gray-200">
                    <PrescriptionComponent
                      prescriptions={prescription}
                      onPrescriptionsChange={setPrescription}
                      onPrint={() => setIsPrinterOpen(true)}
                      showPrintButton={true}
                    />
                  </div>

                  <button
                    onClick={() => saveCycleData('stimulation', cycleData.stimulation)}
                    className="w-full bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition-colors"
                  >
                    <Save className="w-5 h-5 inline mr-2" />
                    ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÅŸäÿ≤ - Save Stimulation Data
                  </button>
                </div>
              )}

              {/* Tab 3: OPU & Embryology */}
              {activeTab === 'lab' && (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-gray-800">üî¨ ÿßŸÑŸÖÿπŸÖŸÑ ŸàÿßŸÑÿ£ÿ¨ŸÜÿ© - OPU & Embryology</h3>

                  {/* OPU Procedure */}
                  <div className="bg-green-50 p-6 rounded-lg border border-green-200">
                    <h4 className="text-lg font-semibold text-green-800 mb-4">ÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑÿ≥ÿ≠ÿ® - OPU Procedure</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">OPU Date</label>
                        <input
                          type="date"
                          value={cycleData.lab.opuDate}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            lab: { ...cycleData.lab, opuDate: e.target.value }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Oocyte Data */}
                  <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h4 className="text-lg font-semibold text-blue-800 mb-4">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ŸàŸäÿ∂ÿßÿ™ - Oocyte Data</h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Total Oocytes</label>
                        <input
                          type="number"
                          value={cycleData.lab.totalOocytes || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            lab: { ...cycleData.lab, totalOocytes: parseInt(e.target.value) || 0 }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">MII</label>
                        <input
                          type="number"
                          value={cycleData.lab.mii || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            lab: { ...cycleData.lab, mii: parseInt(e.target.value) || 0 }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">MI</label>
                        <input
                          type="number"
                          value={cycleData.lab.mi || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            lab: { ...cycleData.lab, mi: parseInt(e.target.value) || 0 }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">GV</label>
                        <input
                          type="number"
                          value={cycleData.lab.gv || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            lab: { ...cycleData.lab, gv: parseInt(e.target.value) || 0 }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>

                    <div className="mt-4 p-4 bg-blue-100 rounded-lg">
                      <div className="text-lg font-semibold text-blue-800">
                        Maturation Rate: {maturationRate}%
                      </div>
                      <div className="text-sm text-blue-600">
                        ({cycleData.lab.mii || 0} / {cycleData.lab.totalOocytes || 0} oocytes)
                      </div>
                    </div>
                  </div>

                  {/* Fertilization */}
                  <div className="bg-purple-50 p-6 rounded-lg border border-purple-200">
                    <h4 className="text-lg font-semibold text-purple-800 mb-4">ÿßŸÑÿ•ÿÆÿµÿßÿ® - Fertilization (Day 1)</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">2PN Count</label>
                        <input
                          type="number"
                          value={cycleData.lab.fertilizedTwoPN || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            lab: { ...cycleData.lab, fertilizedTwoPN: parseInt(e.target.value) || 0 }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        />
                      </div>
                      <div className="p-4 bg-purple-100 rounded-lg">
                        <div className="text-lg font-semibold text-purple-800">
                          Fertilization Rate: {fertilizationRate}%
                        </div>
                        <div className="text-sm text-purple-600">
                          ({cycleData.lab.fertilizedTwoPN || 0} / {cycleData.lab.mii || 0} MII oocytes)
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Embryo Grading */}
                  <div className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h4 className="text-lg font-semibold text-yellow-800 mb-4">ÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ÿ¨ŸÜÿ© - Embryo Grading</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Day 3 Embryos</label>
                        <div className="grid grid-cols-3 gap-2">
                          <div>
                            <label className="block text-xs text-gray-600">Grade A</label>
                            <input
                              type="number"
                              value={cycleData.lab.embryoDay3A || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                lab: { ...cycleData.lab, embryoDay3A: parseInt(e.target.value) || 0 }
                              })}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-center"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-600">Grade B</label>
                            <input
                              type="number"
                              value={cycleData.lab.embryoDay3B || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                lab: { ...cycleData.lab, embryoDay3B: parseInt(e.target.value) || 0 }
                              })}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-center"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-600">Grade C</label>
                            <input
                              type="number"
                              value={cycleData.lab.embryoDay3C || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                lab: { ...cycleData.lab, embryoDay3C: parseInt(e.target.value) || 0 }
                              })}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-center"
                            />
                          </div>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Day 5 Blastocysts</label>
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-xs text-gray-600">Expanded</label>
                            <input
                              type="number"
                              value={cycleData.lab.blastocystsExpanded || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                lab: { ...cycleData.lab, blastocystsExpanded: parseInt(e.target.value) || 0 }
                              })}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-center"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-600">Hatching</label>
                            <input
                              type="number"
                              value={cycleData.lab.blastocystsHatching || ''}
                              onChange={(e) => setCycleData({
                                ...cycleData,
                                lab: { ...cycleData.lab, blastocystsHatching: parseInt(e.target.value) || 0 }
                              })}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-center"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={() => saveCycleData('lab', cycleData.lab)}
                    className="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors"
                  >
                    <Save className="w-5 h-5 inline mr-2" />
                    ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÖŸÑ - Save Lab Data
                  </button>
                </div>
              )}

              {/* Tab 4: Transfer & Outcome */}
              {activeTab === 'transfer' && (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-gray-800">üë∂ ÿßŸÑŸÜŸÇŸÑ ŸàÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© - Transfer & Outcome</h3>

                  {/* Transfer Details */}
                  <div className="bg-red-50 p-6 rounded-lg border border-red-200">
                    <h4 className="text-lg font-semibold text-red-800 mb-4">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÜŸÇŸÑ - Transfer Details</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Transfer Date</label>
                        <input
                          type="date"
                          value={cycleData.transfer.transferDate || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            transfer: { ...cycleData.transfer, transferDate: e.target.value }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Embryos Transferred</label>
                        <input
                          type="number"
                          value={cycleData.transfer.numberTransferred || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            transfer: { ...cycleData.transfer, numberTransferred: parseInt(e.target.value) || 0 }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Embryo Quality</label>
                        <input
                          value={cycleData.transfer.embryoQuality || ''}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            transfer: { ...cycleData.transfer, embryoQuality: e.target.value }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                          placeholder="e.g., Day 5 expanded blastocyst"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Outcome */}
                  <div className="bg-purple-50 p-6 rounded-lg border border-purple-200">
                    <h4 className="text-lg font-semibold text-purple-800 mb-4">ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© - Outcome</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Beta-HCG Result</label>
                        <select
                          value={cycleData.outcome.betaHcgPositive ? 'Positive' : cycleData.outcome.betaHcgPositive === false ? 'Negative' : 'Pending'}
                          onChange={(e) => setCycleData({
                            ...cycleData,
                            outcome: {
                              ...cycleData.outcome,
                              betaHcgPositive: e.target.value === 'Positive' ? true : e.target.value === 'Negative' ? false : undefined
                            }
                          })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        >
                          <option value="Pending">Pending</option>
                          <option value="Positive">Positive</option>
                          <option value="Negative">Negative</option>
                        </select>
                      </div>
                      <div className="flex items-center justify-center">
                        <div className={`text-2xl font-bold ${
                          cycleData.outcome.betaHcgPositive === true ? 'text-green-600' :
                          cycleData.outcome.betaHcgPositive === false ? 'text-red-600' : 'text-gray-600'
                        }`}>
                          {cycleData.outcome.betaHcgPositive === true ? '‚úÖ Pregnancy!' :
                           cycleData.outcome.betaHcgPositive === false ? '‚ùå No Pregnancy' : '‚è≥ Pending'}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="flex gap-4">
                    <button
                      onClick={() => saveCycleData('transfer', cycleData.transfer)}
                      className="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-colors"
                    >
                      <Save className="w-5 h-5 inline mr-2" />
                      ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜŸÇŸÑ - Save Transfer Data
                    </button>

                    <button
                      onClick={async () => {
                        try {
                          await saveCycleData('transfer', cycleData.transfer);
                          setCycleData({ ...cycleData, status: 'Done' });
                          toast.success('Cycle archived successfully!');
                        } catch (error) {
                          toast.error('Failed to archive cycle');
                        }
                      }}
                      className="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition-colors"
                    >
                      üìÅ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿØŸàÿ±ÿ© - Archive Cycle
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </>
      ) : (
        <div className="flex flex-col items-center justify-center min-h-[400px] bg-white rounded-2xl shadow-sm border border-gray-100 text-gray-400">
          <Baby className="w-16 h-16 mb-4 opacity-20" />
          <p className="text-gray-600">Select a patient and start a new IVF cycle to begin tracking.</p>
        </div>
      )}

      {/* Prescription Printer */}
      <PrescriptionPrinter
        patient={selectedPatient || null}
        prescriptions={prescription}
        diagnosis={`IVF Cycle - ${cycleData?.protocol || 'Unknown Protocol'}`}
        notes={`Cycle ID: ${cycleData?.id || 'N/A'}`}
        isOpen={isPrinterOpen}
        onClose={() => setIsPrinterOpen(false)}
      />
    </div>
  );
};

export default IvfJourney;
</file>

</files>

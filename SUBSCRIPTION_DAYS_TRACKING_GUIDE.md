# ๐ ุฏููู ูุธุงู ุชุชุจุน ุงูุฃูุงู ุงููุชุจููุฉ ูู ุงูุงุดุชุฑุงูุงุช
# SUBSCRIPTION DAYS REMAINING TRACKING GUIDE

**ุงูุชุงุฑูุฎ:** 4 ููุงูุฑ 2026  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ

---

## ๐ ุฌุฏูู ุงููุญุชููุงุช

1. [ูุธุฑุฉ ุนุงูุฉ](#overview)
2. [ุงูููููุงุช ุงูุฃุณุงุณูุฉ](#components)
3. [ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ](#installation)
4. [ููููุฉ ุงูุงุณุชุฎุฏุงู](#usage)
5. [ุงูุฏูุงู ูุงูู Views ุงููุชุงุญุฉ](#functions)
6. [ุงูุชูุงุฑูุฑ ูุงูุงุณุชุนูุงูุงุช](#reports)
7. [ูุธุงู ุงูุชูุจููุงุช](#notifications)
8. [ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ](#faq)

---

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ {#overview}

### ุงููุฏู ูู ุงููุธุงู

ูุธุงู ูุชูุงูู ูุญุณุงุจ ูุชุชุจุน ุงูุฃูุงู ุงููุชุจููุฉ ูู ุงุดุชุฑุงูุงุช ุงูุนูุงุฏุงุชุ ูุน ุชูููุฑ:

โ ุญุณุงุจ ุฏููู ููุฃูุงู ุงููุชุจููุฉ ููู ุงุดุชุฑุงู  
โ ุชุตููู ุงูุงุดุชุฑุงูุงุช ุญุณุจ ุฏุฑุฌุฉ ุงูุฅูุญุงุญ (ุนุงุฌูุ ุชุญุฐูุฑุ ุทุจูุนู)  
โ ูุงุฌูุฉ ูุฑุฆูุฉ ูุชูุฏูุฉ ูุชุชุจุน ุญุงูุฉ ุงูุงุดุชุฑุงูุงุช  
โ ุชูุงุฑูุฑ ุชูุตูููุฉ ูุฅุญุตุงุฆูุงุช ุดุงููุฉ  
โ ูุธุงู ุชูุจููุงุช ุชููุงุฆู  
โ ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจุตูุบุฉ CSV  

### ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

#### 1. ุญุณุงุจ ุฐูู ููุฃูุงู ุงููุชุจููุฉ
- ุญุณุงุจ ุชููุงุฆู ููุฃูุงู ุงููุชุจููุฉ ุจูู ุงูุชุงุฑูุฎ ุงูุญุงูู ูุชุงุฑูุฎ ุงูุงูุชูุงุก
- ุญุณุงุจ ูุณุจุฉ ุงูุงุณุชููุงู ูู ุงููุฏุฉ ุงูุฅุฌูุงููุฉ
- ุชุญุฏูุซ ุชููุงุฆู ููุญุงูุงุช ุงูููุชููุฉ

#### 2. ุชุตููู ูุชุฏุฑุฌ ููุญุงูุงุช
```
๐ด ุนุงุฌู ุฌุฏุงู (CRITICAL): โค 3 ุฃูุงู
๐ ุนุงุฌู (URGENT): 4-7 ุฃูุงู
๐ก ุชุญุฐูุฑ (WARNING): 8-15 ููู
๐ต ุงูุชุจู (ATTENTION): 16-30 ููู
๐ข ุทุจูุนู (NORMAL): > 30 ููู
โซ ููุชูู ุงูููู (EXPIRES_TODAY): 0 ุฃูุงู
```

#### 3. ูุงุฌูุฉ ูุชูุฏูุฉ
- ุนุฑุถ ุฌุฏููู ุดุงูู ูุฌููุน ุงูุงุดุชุฑุงูุงุช
- ุจุทุงูุงุช ุฅุญุตุงุฆูุฉ ููููุฉ
- ููุชุฑุฉ ูุชุฑุชูุจ ูุชุนุฏุฏ ุงูุฎูุงุฑุงุช
- ุชุตุฏูุฑ ุชูุงุฑูุฑ CSV

---

## ๐๏ธ ุงูููููุงุช ุงูุฃุณุงุณูุฉ {#components}

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช (SQL)

#### ุงูููู: `SUBSCRIPTION_DAYS_TRACKING_SYSTEM.sql`

ูุญุชูู ุนูู:

##### ุฃ. ุงูุฏูุงู (Functions)
1. **`get_days_remaining(p_end_date DATE)`**
   - ุญุณุงุจ ุงูุฃูุงู ุงููุชุจููุฉ ูุชุงุฑูุฎ ุงูุชูุงุก ูุญุฏุฏ
   - ุงูุฅุฏุฎุงู: ุชุงุฑูุฎ ุงูุงูุชูุงุก
   - ุงูุฅุฎุฑุงุฌ: ุนุฏุฏ ุงูุฃูุงู ุงููุชุจููุฉ (0 ุฅุฐุง ููุชูู)

2. **`get_subscription_usage_percentage(p_start_date DATE, p_end_date DATE)`**
   - ุญุณุงุจ ูุณุจุฉ ุงุณุชููุงู ูุฏุฉ ุงูุงุดุชุฑุงู
   - ุงูุฅุฎุฑุงุฌ: ูุณุจุฉ ูุฆููุฉ (0-100)

3. **`auto_expire_subscriptions()`**
   - ุชุญุฏูุซ ุชููุงุฆู ูุญุงูุฉ ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ
   - ูุฌุจ ุชุดุบููู ุฏูุฑูุงู (ููููุงู)

4. **`get_clinic_subscription_summary(p_clinic_id UUID)`**
   - ุงูุญุตูู ุนูู ููุฎุต ุดุงูู ูุงุดุชุฑุงู ุนูุงุฏุฉ ูุญุฏุฏุฉ

5. **`get_subscriptions_by_days_range(p_min_days, p_max_days)`**
   - ุงูุญุตูู ุนูู ุงูุงุดุชุฑุงูุงุช ุถูู ูุทุงู ุฃูุงู ูุญุฏุฏ

##### ุจ. ุงูู Views (ุนุฑูุถ ุงูุจูุงูุงุช)
1. **`subscription_tracking_details`**
   - ุนุฑุถ ุดุงูู ูุฌููุน ุงูุงุดุชุฑุงูุงุช ูุน ูุงูุฉ ุงูุชูุงุตูู
   - ูุชุถูู: ุงูุฃูุงู ุงููุชุจููุฉุ ูุณุจุฉ ุงูุงุณุชููุงูุ ุญุงูุฉ ุงูุงูุชูุงุก

2. **`active_subscriptions_expiring_soon`**
   - ุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ ุงูุชู ุชูุชูู ุฎูุงู 30 ููู

3. **`critical_expiring_subscriptions`**
   - ุงูุงุดุชุฑุงูุงุช ุงูุนุงุฌูุฉ (โค 7 ุฃูุงู)

4. **`subscription_expiry_statistics`**
   - ุฅุญุตุงุฆูุงุช ููุตูุฉ ุญุณุจ ุญุงูุฉ ุงูุงูุชูุงุก

##### ุฌ. ุงูุฌุฏุงูู (Tables)
1. **`subscription_expiry_notifications`**
   - ุณุฌู ุงูุชูุจููุงุช ุงููุฑุณูุฉ ููุนูุงุฏุงุช
   - ูุชุชุจุน: ููุน ุงูุชูุจููุ ุชุงุฑูุฎ ุงูุฅุฑุณุงูุ ุทุฑููุฉ ุงูุฅุฑุณุงูุ ุงูุญุงูุฉ

### 2. ูุงุฌูุฉ ุงููุณุชุฎุฏู (React Component)

#### ุงูููู: `src/pages/admin/SubscriptionExpiryTracker.tsx`

ูููู React ูุชูุฏู ูููุฑ:

##### ุฃ. ุจุทุงูุงุช ุฅุญุตุงุฆูุฉ (Statistics Cards)
- ุนุฑุถ ูููู ุญุณุจ ุญุงูุฉ ุงูุงูุชูุงุก
- ุฃุฑูุงู ูุจูุฑุฉ ููุงุถุญุฉ
- ูุชูุณุท ุงูุฃูุงู ุงููุชุจููุฉ

##### ุจ. ูุธุงู ููุชุฑุฉ ูุชูุฏู
- ุงูููุชุฑุฉ ุญุณุจ ุญุงูุฉ ุงูุงูุชูุงุก
- ุงูููุชุฑุฉ ุญุณุจ ุงูุชุฌุฏูุฏ ุงูุชููุงุฆู
- ุงูุชุฑุชูุจ ุญุณุจ ุนุฏุฉ ูุนุงููุฑ

##### ุฌ. ุฌุฏูู ุชูุงุนูู
- ุนุฑุถ ุดุงูู ูุฌููุน ุงูุจูุงูุงุช
- ุฃููุงู ุชูุงุนููุฉ ุญุณุจ ุฏุฑุฌุฉ ุงูุฅูุญุงุญ
- ุฃุฒุฑุงุฑ ููุฅุฌุฑุงุกุงุช ุงูุณุฑูุนุฉ

##### ุฏ. ููุฎุต ููุงุฆู
- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ
- ุนุฏุงุฏ ุงูุงุดุชุฑุงูุงุช ุงูุนุงุฌูุฉ
- ูุชูุณุท ุงูุฃูุงู ุงููุชุจููุฉ

### 3. ุงูุชูุงูู ูุน ููุญุฉ ุงูุณูุจุฑ ุงุฏูู

#### ุงูููู: `pages/SuperAdminDashboard.tsx`

ุชู ุฅุถุงูุฉ ุชุจููุจ ุฌุฏูุฏ:
- ุงูุฃููููุฉ: ๐ Calendar
- ุงูุนููุงู: "ุชุชุจุน ุงูุฃูุงู ุงููุชุจููุฉ"
- ุงูููู: ุฃุญูุฑ (ูููุช ุงูุงูุชุจุงู)

---

## ๐ง ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ {#installation}

### ุงูุฎุทูุฉ 1: ุชูููุฐ ุณูุฑูุจุช SQL

```sql
-- ูู Supabase SQL Editorุ ูู ุจุชูููุฐ:
\i SUBSCRIPTION_DAYS_TRACKING_SYSTEM.sql
```

ุฃู ุงูุณุฎ ูุญุชูู ุงูููู ูุงูุตูู ูุจุงุดุฑุฉ ูู SQL Editor.

### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ุงูุชุซุจูุช

```sql
-- 1. ุชุญูู ูู ูุฌูุฏ ุงูุฏูุงู
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
  AND routine_name LIKE '%days%';

-- 2. ุชุญูู ูู ูุฌูุฏ ุงูู Views
SELECT table_name 
FROM information_schema.views 
WHERE table_schema = 'public' 
  AND table_name LIKE '%subscription%';

-- 3. ุงุฎุชุจุฑ ุฏุงูุฉ ุญุณุงุจ ุงูุฃูุงู
SELECT get_days_remaining(CURRENT_DATE + INTERVAL '10 days');
-- ูุฌุจ ุฃู ุชุฑุฌุน: 10
```

### ุงูุฎุทูุฉ 3: ุฅุฏุฎุงู ุจูุงูุงุช ุชุฌุฑูุจูุฉ (ุงุฎุชูุงุฑู)

```sql
-- ุงุฎุชุจุฑ ุงููุธุงู ุจุจูุงูุงุช ุชุฌุฑูุจูุฉ
SELECT 
  clinic_name,
  plan_name_ar,
  days_remaining,
  expiry_status_ar
FROM subscription_tracking_details
LIMIT 5;
```

### ุงูุฎุทูุฉ 4: ุชูุนูู ุงููููู ูู ููุญุฉ ุงูุณูุจุฑ ุงุฏูู

ุงููููู ุฌุงูุฒ ุชููุงุฆูุงู! ููุท:
1. ุงูุชุญ ููุญุฉ ุงูุณูุจุฑ ุงุฏูู
2. ุณุชุฌุฏ ุชุจููุจ ุฌุฏูุฏ: **"๐ ุชุชุจุน ุงูุฃูุงู ุงููุชุจููุฉ"**
3. ุงุถุบุท ุนููู ููุจุฏุก

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู {#usage}

### 1. ุงููุตูู ุฅูู ุงููุธุงู

```
ุงูุทุฑููุฉ 1: ูู ููุญุฉ ุงูุณูุจุฑ ุงุฏูู
- ุณุฌู ุฏุฎูู ูู Super Admin
- ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉุ ุงุฎุชุฑ "ุชุชุจุน ุงูุฃูุงู ุงููุชุจููุฉ"
```

### 2. ููู ุงููุงุฌูุฉ

#### ุฃ. ุงูุจุทุงูุงุช ุงูุฅุญุตุงุฆูุฉ (ุฃุนูู ุงูุตูุญุฉ)
ุชุนุฑุถ ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช ููู ุญุงูุฉ:
- **ุนุงุฌู ุฌุฏุงู** (ุฃุญูุฑ): ุชุญุชุงุฌ ุชุฏุฎู ููุฑู
- **ุนุงุฌู** (ุจุฑุชูุงูู): ุฎูุงู ุฃุณุจูุน
- **ุชุญุฐูุฑ** (ุฃุตูุฑ): ุฎูุงู ุฃุณุจูุนูู
- **ุงูุชุจู** (ุฃุฒุฑู): ุฎูุงู ุดูุฑ
- **ุทุจูุนู** (ุฃุฎุถุฑ): ุฃูุซุฑ ูู ุดูุฑ

#### ุจ. ูุณู ุงูููุงุชุฑ
- **ุญุงูุฉ ุงูุงูุชูุงุก**: ุงุฎุชุฑ ูุฆุฉ ูุนููุฉ
- **ุงูุชุฌุฏูุฏ ุงูุชููุงุฆู**: ููุนูู/ุบูุฑ ููุนูู/ุงููู
- **ุงูุชุฑุชูุจ ุญุณุจ**: ุฃูุงูุ ุงุณูุ ุงุณุชููุงู

#### ุฌ. ุงูุฌุฏูู ุงูุฑุฆูุณู
ูุนุฑุถ ููู ุงุดุชุฑุงู:
- ุงุณู ุงูุนูุงุฏุฉ + ุงูุชูุงุตู
- ุงูุจุงูุฉ ูุงูุณุนุฑ
- ุญุงูุฉ ุงูุงูุชูุงุก (ููููุฉ)
- ุงูุฃูุงู ุงููุชุจููุฉ (ูุจูุฑุฉ ููุงุถุญุฉ)
- ูุณุจุฉ ุงูุงุณุชููุงู (ุดุฑูุท ูููู)
- ุชุงุฑูุฎ ุงูุงูุชูุงุก
- ุญุงูุฉ ุงูุชุฌุฏูุฏ ุงูุชููุงุฆู
- ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช

### 3. ุงูุฅุฌุฑุงุกุงุช ุงููุชุงุญุฉ

#### ุชุญุฏูุซ ุงูุจูุงูุงุช
```tsx
// ุงุถุบุท ุฒุฑ "ุชุญุฏูุซ" ูู ุฃุนูู ูููู ุงูุตูุญุฉ
```

#### ุชุตุฏูุฑ ุชูุฑูุฑ CSV
```tsx
// ุงุถุบุท ุฒุฑ "ุชุตุฏูุฑ CSV"
// ุณูุชู ุชุญููู ููู ูุญุชูู ุนูู:
// - ุฌููุน ุงูุจูุงูุงุช ุงููููุชุฑุฉ ุญุงููุงู
// - ุจุตูุบุฉ CSV ูููู ูุชุญูุง ูู Excel
```

#### ุฅุฑุณุงู ุชูุจูู ูุนูุงุฏุฉ
```tsx
// ูู ุงูุฌุฏููุ ุงุถุบุท ุฃููููุฉ ุงูุฌุฑุณ ๐
// (ุณูุชู ุชูุนูู ูุฐู ุงูููุฒุฉ ูุฑูุจุงู)
```

### 4. ุฃูุซูุฉ ุงุณุชุฎุฏุงู ุนูููุฉ

#### ูุซุงู 1: ูุชุงุจุนุฉ ุงูุงุดุชุฑุงูุงุช ุงูุนุงุฌูุฉ
```
1. ุงูุชุญ ุตูุญุฉ ุงูุชุชุจุน
2. ูู ููุชุฑ "ุญุงูุฉ ุงูุงูุชูุงุก"ุ ุงุฎุชุฑ "ุนุงุฌู ุฌุฏุงู"
3. ุณุชุธูุฑ ููุท ุงูุงุดุชุฑุงูุงุช โค 3 ุฃูุงู
4. ุงุชุตู ุจุงูุนูุงุฏุงุช ูุชุงุจุน ุงูุชุฌุฏูุฏ
```

#### ูุซุงู 2: ูุฑุงุฌุนุฉ ุฃุณุจูุนูุฉ
```
1. ูู ุฃุณุจูุนุ ุงูุชุญ ุงูุตูุญุฉ
2. ุงุถุบุท "ุชุญุฏูุซ" ููุญุตูู ุนูู ุฃุญุฏุซ ุงูุจูุงูุงุช
3. ุฑุงุฌุน ุงูุจุทุงูุงุช ุงูุฅุญุตุงุฆูุฉ
4. ุตุฏูุฑ ุชูุฑูุฑ CSV ููุฃุฑุดูุฉ
```

#### ูุซุงู 3: ูุชุงุจุนุฉ ุนูุงุฏุฉ ูุญุฏุฏุฉ
```
1. ุงุณุชุฎุฏู ูุฑุจุน ุงูุจุญุซ ูู ุงูููุงุชุฑ
2. ุงูุชุจ ุงุณู ุงูุนูุงุฏุฉ ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
3. ุณุชุธูุฑ ููุท ูุชุงุฆุฌ ุงูุจุญุซ
```

---

## ๐ ุงูุฏูุงู ูุงูู Views ุงููุชุงุญุฉ {#functions}

### ุงุณุชุฎุฏุงู ุงูุฏูุงู ูู SQL

#### 1. ุญุณุงุจ ุงูุฃูุงู ุงููุชุจููุฉ ูุชุงุฑูุฎ ูุญุฏุฏ
```sql
SELECT get_days_remaining('2026-02-15'::DATE);
-- ูุซุงู: ุฅุฐุง ูุงู ุงูููู 2026-01-04ุ ุณุชุฑุฌุน 42
```

#### 2. ุญุณุงุจ ูุณุจุฉ ุงูุงุณุชููุงู
```sql
SELECT get_subscription_usage_percentage(
  '2025-12-01'::DATE,  -- ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
  '2026-06-01'::DATE   -- ุชุงุฑูุฎ ุงูููุงูุฉ
);
-- ุณุชุฑุฌุน ุงููุณุจุฉ ุงููุฆููุฉ ููุงุณุชููุงู
```

#### 3. ุงูุญุตูู ุนูู ููุฎุต ุนูุงุฏุฉ ูุญุฏุฏุฉ
```sql
SELECT * FROM get_clinic_subscription_summary('clinic-uuid-here');
-- ุณุชุฑุฌุน ุฌููุน ุชูุงุตูู ุงุดุชุฑุงู ุงูุนูุงุฏุฉ
```

#### 4. ุงูุญุตูู ุนูู ุงุดุชุฑุงูุงุช ุถูู ูุทุงู ุฃูุงู
```sql
-- ุงูุงุดุชุฑุงูุงุช ุงูุชู ุชูุชูู ุฎูุงู 1-7 ุฃูุงู
SELECT * FROM get_subscriptions_by_days_range(1, 7);

-- ุงูุงุดุชุฑุงูุงุช ุงูุชู ุชูุชูู ุฎูุงู 8-30 ููู
SELECT * FROM get_subscriptions_by_days_range(8, 30);
```

#### 5. ุชุญุฏูุซ ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ ุชููุงุฆูุงู
```sql
-- ูุฌุจ ุชุดุบูู ูุฐุง ููููุงู (ูููู ุฌุฏููุชู)
SELECT auto_expire_subscriptions();
```

### ุงุณุชุฎุฏุงู ุงูู Views

#### 1. ุนุฑุถ ุฌููุน ุงูุงุดุชุฑุงูุงุช ูุน ุงูุชูุงุตูู
```sql
SELECT 
  clinic_name,
  plan_name_ar,
  status,
  days_remaining,
  usage_percentage,
  expiry_status_ar
FROM subscription_tracking_details
ORDER BY days_remaining ASC
LIMIT 20;
```

#### 2. ุนุฑุถ ุงูุงุดุชุฑุงูุงุช ุงููุฑูุจุฉ ูู ุงูุงูุชูุงุก ููุท
```sql
SELECT * FROM active_subscriptions_expiring_soon;
```

#### 3. ุนุฑุถ ุงูุงุดุชุฑุงูุงุช ุงูุนุงุฌูุฉ ููุท
```sql
SELECT * FROM critical_expiring_subscriptions;
```

#### 4. ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงููุฌููุนุฉ
```sql
SELECT * FROM subscription_expiry_statistics;
```

---

## ๐ ุงูุชูุงุฑูุฑ ูุงูุงุณุชุนูุงูุงุช {#reports}

### ุชูุงุฑูุฑ ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู

#### ุงูุชูุฑูุฑ 1: ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช ุญุณุจ ุงูุญุงูุฉ
```sql
SELECT 
  expiry_status_ar AS "ุญุงูุฉ ุงูุงูุชูุงุก",
  COUNT(*) AS "ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช",
  ROUND(AVG(days_remaining), 0) AS "ูุชูุณุท ุงูุฃูุงู ุงููุชุจููุฉ"
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
GROUP BY expiry_status_ar
ORDER BY COUNT(*) DESC;
```

#### ุงูุชูุฑูุฑ 2: ุงูุนูุงุฏุงุช ุงูุชู ุชุญุชุงุฌ ูุชุงุจุนุฉ ุนุงุฌูุฉ
```sql
SELECT 
  clinic_name AS "ุงุณู ุงูุนูุงุฏุฉ",
  clinic_email AS "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู",
  clinic_phone AS "ุฑูู ุงููุงุชู",
  plan_name_ar AS "ุงูุจุงูุฉ",
  days_remaining AS "ุงูุฃูุงู ุงููุชุจููุฉ",
  end_date AS "ุชุงุฑูุฎ ุงูุงูุชูุงุก",
  expiry_status_ar AS "ุงูุญุงูุฉ"
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
  AND days_remaining <= 7
  AND days_remaining >= 0
ORDER BY days_remaining ASC;
```

#### ุงูุชูุฑูุฑ 3: ุงูุงุดุชุฑุงูุงุช ุญุณุจ ุงูุจุงูุฉ
```sql
SELECT 
  plan_name_ar AS "ุงูุจุงูุฉ",
  COUNT(*) AS "ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช",
  ROUND(AVG(days_remaining), 0) AS "ูุชูุณุท ุงูุฃูุงู ุงููุชุจููุฉ",
  MIN(days_remaining) AS "ุฃูู ุนุฏุฏ ุฃูุงู",
  MAX(days_remaining) AS "ุฃูุซุฑ ุนุฏุฏ ุฃูุงู"
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
GROUP BY plan_name_ar
ORDER BY "ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช" DESC;
```

#### ุงูุชูุฑูุฑ 4: ุงูุงุดุชุฑุงูุงุช ุงูุชู ุณุชูุชูู ูู ุดูุฑ ูุญุฏุฏ
```sql
SELECT 
  clinic_name,
  plan_name_ar,
  end_date,
  days_remaining
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
  AND EXTRACT(YEAR FROM end_date) = 2026
  AND EXTRACT(MONTH FROM end_date) = 2  -- ุดูุฑ ูุจุฑุงูุฑ
ORDER BY end_date ASC;
```

#### ุงูุชูุฑูุฑ 5: ููุงุฑูุฉ ุงูุชุฌุฏูุฏ ุงูุชููุงุฆู
```sql
SELECT 
  CASE 
    WHEN auto_renew THEN 'ููุนูู'
    ELSE 'ุบูุฑ ููุนูู'
  END AS "ุญุงูุฉ ุงูุชุฌุฏูุฏ ุงูุชููุงุฆู",
  COUNT(*) AS "ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช",
  ROUND(AVG(days_remaining), 0) AS "ูุชูุณุท ุงูุฃูุงู ุงููุชุจููุฉ"
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
GROUP BY auto_renew;
```

### ุชูุงุฑูุฑ ูุชูุฏูุฉ

#### ุงูุชูุฑูุฑ 6: ุชูุฒูุน ุงูุงุดุชุฑุงูุงุช ุญุณุจ ุงูุฃุณุงุจูุน ุงููุงุฏูุฉ
```sql
SELECT 
  CASE 
    WHEN days_remaining <= 7 THEN 'ุงูุฃุณุจูุน ุงููุงุฏู'
    WHEN days_remaining <= 14 THEN 'ุงูุฃุณุจูุนูู ุงููุงุฏููู'
    WHEN days_remaining <= 21 THEN 'ุซูุงุซุฉ ุฃุณุงุจูุน'
    WHEN days_remaining <= 30 THEN 'ุงูุดูุฑ ุงููุงุฏู'
    ELSE 'ุฃูุซุฑ ูู ุดูุฑ'
  END AS "ุงููุชุฑุฉ ุงูุฒูููุฉ",
  COUNT(*) AS "ุนุฏุฏ ุงูุงุดุชุฑุงูุงุช"
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
  AND days_remaining >= 0
GROUP BY 
  CASE 
    WHEN days_remaining <= 7 THEN 'ุงูุฃุณุจูุน ุงููุงุฏู'
    WHEN days_remaining <= 14 THEN 'ุงูุฃุณุจูุนูู ุงููุงุฏููู'
    WHEN days_remaining <= 21 THEN 'ุซูุงุซุฉ ุฃุณุงุจูุน'
    WHEN days_remaining <= 30 THEN 'ุงูุดูุฑ ุงููุงุฏู'
    ELSE 'ุฃูุซุฑ ูู ุดูุฑ'
  END
ORDER BY MIN(days_remaining);
```

#### ุงูุชูุฑูุฑ 7: ุงูุนูุงุฏุงุช ุงูุชู ุชุณุชููู ุฃูุซุฑ ูู 80% ูู ุงุดุชุฑุงููุง
```sql
SELECT 
  clinic_name,
  plan_name_ar,
  usage_percentage,
  days_remaining,
  auto_renew
FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
  AND usage_percentage >= 80
ORDER BY usage_percentage DESC;
```

---

## ๐ ูุธุงู ุงูุชูุจููุงุช {#notifications}

### ุชุณุฌูู ุงูุชูุจููุงุช

#### ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ
```sql
-- ุชุณุฌูู ุชูุจูู ุนูุฏ ุฅุฑุณุงูู
SELECT log_expiry_notification(
  'clinic-uuid-here',           -- ูุนุฑู ุงูุนูุงุฏุฉ
  '7_days',                     -- ููุน ุงูุชูุจูู
  7,                            -- ุงูุฃูุงู ุงููุชุจููุฉ
  'email',                      -- ุทุฑููุฉ ุงูุฅุฑุณุงู
  'ุงุดุชุฑุงูู ุณููุชูู ุฎูุงู 7 ุฃูุงู' -- ูุญุชูู ุงูุฑุณุงูุฉ
);
```

#### ุฃููุงุน ุงูุชูุจููุงุช
- `30_days`: ูุจู ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจู 30 ููู
- `15_days`: ูุจู ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจู 15 ููู
- `7_days`: ูุจู ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจู 7 ุฃูุงู
- `3_days`: ูุจู ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจู 3 ุฃูุงู
- `1_day`: ูุจู ุงูุชูุงุก ุงูุงุดุชุฑุงู ุจููู ูุงุญุฏ
- `expired`: ุจุนุฏ ุงูุชูุงุก ุงูุงุดุชุฑุงู

#### ุทุฑู ุงูุฅุฑุณุงู
- `email`: ุจุฑูุฏ ุฅููุชุฑููู
- `sms`: ุฑุณุงูุฉ ูุตูุฉ
- `whatsapp`: ูุงุชุณุงุจ
- `in_app`: ุฅุดุนุงุฑ ุฏุงุฎู ุงูุชุทุจูู

### ุนุฑุถ ุณุฌู ุงูุชูุจููุงุช

```sql
-- ุนุฑุถ ุฌููุน ุงูุชูุจููุงุช ุงููุฑุณูุฉ
SELECT 
  n.clinic_id,
  d.name AS clinic_name,
  n.notification_type,
  n.days_remaining,
  n.sent_via,
  n.notification_status,
  n.sent_at
FROM subscription_expiry_notifications n
JOIN doctors d ON n.clinic_id = d.id
ORDER BY n.sent_at DESC
LIMIT 50;
```

### ุฅุญุตุงุฆูุงุช ุงูุชูุจููุงุช

```sql
-- ุนุฏุฏ ุงูุชูุจููุงุช ุญุณุจ ุงูููุน
SELECT 
  notification_type,
  sent_via,
  COUNT(*) AS total_sent,
  COUNT(*) FILTER (WHERE notification_status = 'delivered') AS delivered,
  COUNT(*) FILTER (WHERE notification_status = 'failed') AS failed
FROM subscription_expiry_notifications
WHERE sent_at >= NOW() - INTERVAL '30 days'
GROUP BY notification_type, sent_via
ORDER BY notification_type;
```

---

## โ๏ธ ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ

### ููุงู ููููุฉ

#### 1. ุชุญุฏูุซ ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ
```sql
-- ุถุน ูุฐุง ูู Cron Job ูููู
SELECT auto_expire_subscriptions();
```

#### 2. ุฅุฑุณุงู ุชูุจููุงุช ููุงุดุชุฑุงูุงุช ุงููุฑูุจุฉ ูู ุงูุงูุชูุงุก
```sql
-- ุงูุงุดุชุฑุงูุงุช ุงูุชู ุชูุชูู ุบุฏุงู
SELECT * FROM subscription_tracking_details
WHERE status IN ('active', 'trial')
  AND days_remaining = 1;

-- ุฃุฑุณู ููู ุชูุจูู
```

### ููุงู ุฃุณุจูุนูุฉ

#### 1. ูุฑุงุฌุนุฉ ุงูุฅุญุตุงุฆูุงุช
```sql
SELECT * FROM subscription_expiry_statistics;
```

#### 2. ุชุตุฏูุฑ ุชูุฑูุฑ ุฃุณุจูุนู
- ุงูุชุญ ุตูุญุฉ ุงูุชุชุจุน
- ุงุถุบุท "ุชุตุฏูุฑ CSV"
- ุงุญูุธ ุงูููู ุจุชุงุฑูุฎ ุงูุฃุณุจูุน

### ููุงู ุดูุฑูุฉ

#### 1. ุชุญููู ุงูุงุชุฌุงูุงุช
```sql
-- ููุงุฑูุฉ ุงูุดูุฑ ุงูุญุงูู ุจุงูุดูุฑ ุงููุงุถู
SELECT 
  DATE_TRUNC('month', end_date) AS month,
  COUNT(*) AS expiring_count
FROM clinic_subscriptions
WHERE status IN ('active', 'trial')
  AND end_date >= CURRENT_DATE
  AND end_date <= CURRENT_DATE + INTERVAL '60 days'
GROUP BY month
ORDER BY month;
```

#### 2. ุชูุธูู ุณุฌู ุงูุชูุจููุงุช ุงููุฏูู
```sql
-- ุญุฐู ุงูุชูุจููุงุช ุงูุฃูุฏู ูู 6 ุฃุดูุฑ
DELETE FROM subscription_expiry_notifications
WHERE sent_at < NOW() - INTERVAL '6 months';
```

---

## โ ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ {#faq}

### ุณ1: ููู ูุชู ุญุณุงุจ ุงูุฃูุงู ุงููุชุจููุฉุ
**ุฌ:** ูุชู ุญุณุงุจ ุงููุฑู ุจูู ุชุงุฑูุฎ ุงูุงูุชูุงุก (`end_date`) ูุงูุชุงุฑูุฎ ุงูุญุงูู. ุฅุฐุง ูุงู ุงูุฑูู ุณุงูุจุงู (ุงูุงุดุชุฑุงู ููุชูู)ุ ูุชู ุฅุฑุฌุงุน 0.

### ุณ2: ูุชู ูุชู ุชุญุฏูุซ ุงูุจูุงูุงุชุ
**ุฌ:** ุงูุจูุงูุงุช ูุชู ุงุณุชุฑุฌุงุนูุง ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ููููู ุงูุถุบุท ุนูู ุฒุฑ "ุชุญุฏูุซ" ูู ุฃู ููุช ููุญุตูู ุนูู ุฃุญุฏุซ ุงูุจูุงูุงุช.

### ุณ3: ูู ูููู ุชุฎุตูุต ุงูุชุตูููุงุช (ุนุงุฌูุ ุชุญุฐูุฑุ ุฅูุฎ)ุ
**ุฌ:** ูุนู! ููููู ุชุนุฏูู ุงูุฏุงูุฉ ูู SQL:
```sql
-- ูู View: subscription_tracking_details
CASE
  WHEN get_days_remaining(cs.end_date) <= 3 THEN 'ุนุงุฌู ุฌุฏุงู'
  WHEN get_days_remaining(cs.end_date) <= 7 THEN 'ุนุงุฌู'
  -- ุบููุฑ ุงูุฃุฑูุงู ุญุณุจ ุญุงุฌุชู
```

### ุณ4: ููู ุฃุฌุฏูู ุชุดุบูู `auto_expire_subscriptions` ุชููุงุฆูุงูุ
**ุฌ:** ุงุณุชุฎุฏู Supabase Edge Functions ุฃู pg_cron:
```sql
-- ูุซุงู ุจุงุณุชุฎุฏุงู pg_cron (ูุฌุจ ุชูุนููู ุฃููุงู)
SELECT cron.schedule(
  'expire-subscriptions-daily',
  '0 0 * * *',  -- ูู ููู ูู ููุชุตู ุงูููู
  $$SELECT auto_expire_subscriptions();$$
);
```

### ุณ5: ูู ูููู ุชููู ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉุ
**ุฌ:** ูุนูุ ูููู ุจูุงุก ูุธุงู ุฅุดุนุงุฑุงุช ุจุงุณุชุฎุฏุงู:
- Supabase Triggers
- Edge Functions
- ุฎุฏูุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (SendGrid, Mailgun)
- ุฎุฏูุงุช SMS

### ุณ6: ูุงุฐุง ุนู ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉุ
**ุฌ:** ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ ูุง ุชุธูุฑ ุจุดูู ุงูุชุฑุงุถู ูู ุตูุญุฉ ุงูุชุชุจุน (ูุฃููุง ุชุฑูุฒ ุนูู ุงููุดุทุฉ). ููููู ุฑุคูุชูุง ูู:
```sql
SELECT * FROM subscription_tracking_details
WHERE status = 'expired';
```

### ุณ7: ููู ุฃุถูู ุนููุฏ ุฌุฏูุฏ ููุฌุฏููุ
**ุฌ:** ููููู ุชุนุฏูู ุงูู View:
```sql
CREATE OR REPLACE VIEW subscription_tracking_details AS
SELECT 
  -- ุงูุฃุนูุฏุฉ ุงูุญุงููุฉ...
  cs.your_new_column,  -- ุฃุถู ุงูุนููุฏ ุงูุฌุฏูุฏ
  -- ...
FROM clinic_subscriptions cs
-- ...
```

### ุณ8: ูู ุงููุธุงู ูุนูู ูุน ุงุดุชุฑุงูุงุช ุชุฌุฑูุจูุฉุ
**ุฌ:** ูุนู! ุงููุธุงู ูุชุนุงูู ูุน ุฌููุน ุญุงูุงุช ุงูุงุดุชุฑุงูุงุช:
- `active`: ูุดุท
- `trial`: ุชุฌุฑูุจู
- `expired`: ููุชูู
- `suspended`: ููููู
- `cancelled`: ููุบู

### ุณ9: ููู ุฃุตุฏุฑ ุชูุฑูุฑ ูุนูุงุฏุฉ ูุงุญุฏุฉ ููุทุ
**ุฌ:** ุงุณุชุฎุฏู ุงูููุชุฑุฉ ูู ุงููุงุฌูุฉุ ุฃู:
```sql
SELECT * FROM subscription_tracking_details
WHERE clinic_id = 'clinic-uuid-here';
```

### ุณ10: ูุงุฐุง ูู ุฃุฑุฏุช ุชุบููุฑ ุงูุฃููุงูุ
**ุฌ:** ุนุฏู ููู `SubscriptionExpiryTracker.tsx`:
```typescript
const getStatusColor = (status: string): string => {
  const colorMap: Record<string, string> = {
    'CRITICAL': 'bg-red-50 text-red-700',  // ุบููุฑ ููุง
    // ...
  };
  return colorMap[status];
};
```

---

## ๐ ูุตุงุฆุญ ูุชูุฏูุฉ

### 1. ุฅูุดุงุก Dashboard ูุฎุตุต
ููููู ุฅูุดุงุก ููุญุฉ ูููุตูุฉ ุชุณุชุนุฑุถ ููุท ุงูุงุดุชุฑุงูุงุช ุงูุนุงุฌูุฉ:
```tsx
const CriticalSubscriptionsDashboard = () => {
  const [criticalSubs, setCriticalSubs] = useState([]);

  useEffect(() => {
    const fetchCritical = async () => {
      const { data } = await supabase
        .from('critical_expiring_subscriptions')
        .select('*');
      setCriticalSubs(data || []);
    };
    fetchCritical();
  }, []);

  // ุนุฑุถ ุงูุจูุงูุงุช...
};
```

### 2. ุฅุถุงูุฉ ุฑุณูู ุจูุงููุฉ
ุงุณุชุฎุฏู ููุชุจุฉ ูุซู `recharts`:
```tsx
import { PieChart, Pie, Cell } from 'recharts';

const data = statistics.map(stat => ({
  name: stat.expiry_status_ar,
  value: stat.subscription_count
}));

<PieChart width={400} height={400}>
  <Pie data={data} dataKey="value" nameKey="name" />
</PieChart>
```

### 3. ุฅุดุนุงุฑุงุช ูู ุงูููุช ุงููุนูู
ุงุณุชุฎุฏู Supabase Realtime:
```tsx
useEffect(() => {
  const subscription = supabase
    .channel('subscriptions')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'clinic_subscriptions'
    }, (payload) => {
      console.log('ุชุบููุฑ ูู ุงูุงุดุชุฑุงูุงุช:', payload);
      fetchData(); // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, []);
```

---

## ๐ ุงูุฏุนู ูุงูุชูุงุตู

ูุฃู ุงุณุชูุณุงุฑุงุช ุฃู ูุดุงูู:
1. ุฑุงุฌุน ูุฐุง ุงูุฏููู ุฃููุงู
2. ุชุญูู ูู ุงูุฃุฎุทุงุก ูู SQL Editor
3. ุฑุงุฌุน Console ูู ุงููุชุตูุญ (F12)
4. ุชูุงุตู ูุน ูุฑูู ุงูุฏุนู ุงูููู

---

## โ ุงูุฎูุงุตุฉ

ุงูุขู ูุฏูู ูุธุงู ูุชูุงูู ูุชุชุจุน ุงูุฃูุงู ุงููุชุจููุฉ ูู ุงูุงุดุชุฑุงูุงุช:

โ ุฏูุงู SQL ูููุฉ ููุฎุชุจุฑุฉ  
โ Views ุฌุงูุฒุฉ ููุงุณุชุนูุงู  
โ ูุงุฌูุฉ ูุณุชุฎุฏู ูุชูุฏูุฉ  
โ ุชูุงุฑูุฑ ุดุงููุฉ  
โ ูุธุงู ุชูุจููุงุช ูุงุจู ููุชูุณุน  
โ ุชูุงูู ูุงูู ูุน ููุญุฉ ุงูุณูุจุฑ ุงุฏูู  

**ุงุณุชูุชุน ุจุงุณุชุฎุฏุงู ุงููุธุงู! ๐**

---

**ุขุฎุฑ ุชุญุฏูุซ:** 4 ููุงูุฑ 2026  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุญููู:** Nile IVF & OB/GYN Center
